

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Â§±ËêΩ‰πãÊÑüÊÄß</title>

  <!-- ‚ñº‚ñº‚ñº Ê≠•È©ü 1ÔºöË≤º‰∏äÊàñÊõøÊèõÁÇ∫ÈÄôÊÆµÊñ∞ÁöÑ CSP Ë¶èÂâá ‚ñº‚ñº‚ñº -->
   <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://www.gstatic.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' https: data:;
    media-src 'self';
    connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com;
    object-src 'none';
    base-uri 'self';
    form-action 'none';
">


    
      <!-- ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëË´ãÂ∞áÈÄô‰∏âË°å Google Fonts ÈÄ£ÁµêÂä†Âú®ÈÄôË£° ‚ñº‚ñº‚ñº -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
   <style>
/* =================================================================== */
/* ====== 1. ÂÖ®ÂüüËàáÂü∫Á§éÊ®£Âºè (Global & Base Styles) ====== */
/* =================================================================== */

/* --- È°èËâ≤Ëàá‰∏ªÈ°åËÆäÊï∏ --- */
:root {
    /* "ÊòüÂÖâÊÆøÂ†Ç" ‰∏ªÈ°å */
    --starlight-bg: linear-gradient(145deg, #fdfbfb 0%, #ebedee 100%);
    --starlight-accent: #b48f5a;
    --starlight-accent-glow: rgba(180, 143, 90, 0.35);
    --starlight-text-primary: #3a332a;
    --starlight-text-secondary: #8c7d6b;
    --starlight-border: rgba(180, 143, 90, 0.4);
    --starlight-item-bg: rgba(255, 255, 255, 0.6);
    --starlight-item-hover-bg: #ffffff;
    /* "ÊòüÂ°µÊ¶ÆËÄÄ" ÊéíË°åÊ¶ú‰∏ªÈ°å */
    --rank-gold: #D4AF37;
    --rank-silver: #C0C0C0;
    --rank-bronze: #CD7F32;
    --rank-item-bg: rgba(235, 237, 238, 0.5);
    --rank-item-hover-bg: rgba(255, 255, 255, 0.9);
    --rank-icon-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}

/* --- ÈÄöÁî®ÈÅ∏ÊìáÂô® --- */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* --- Body Âü∫Á§éÊ®£Âºè (ÂåÖÂê´Â≠óÈ´îË®≠ÂÆö) --- */
body {
    background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
    font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
    touch-action: manipulation;
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background:
        radial-gradient(circle at 10% 20%, rgba(255, 200, 124, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(108, 99, 255, 0.1) 0%, transparent 20%);
    z-index: -1;
}

/* --- ËÉåÊôØÂúñËàáÂÆπÂô® --- */
.background-image {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('https://i.ibb.co/W4yhM5v0/image.png');
    background-size: cover;
    background-position: center;
    opacity: 0.6;
    z-index: -2;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px;
    position: relative;
    z-index: 1;
}

.main-game-container {
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.15);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    margin-bottom: 20px;
}

/* --- Ê®ôÈ°åËàáÂâØÊ®ôÈ°å --- */
header {
    text-align: center;
    padding: 10px 0;
    margin-bottom: 10px;
}

h1 {
    font-size: 2.5rem;
    margin-bottom: 5px;
    background: linear-gradient(45deg, #ff8a00, #e52e71);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.subtitle {
    font-size: 1rem;
    opacity: 0.8;
    margin-bottom: 10px;
}

/* =================================================================== */
/* ====== 2. ÈÅäÊà≤‰∏ª‰ªãÈù¢ (Game UI) ====== */
/* =================================================================== */
.game-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.game-ui {
    position: relative;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 10px;
    padding-bottom: 60px; /* ÁÇ∫ÈÄ≤Â∫¶Ê¢ùÂíåÊ≠åË©ûÈ†êÁïôÁ©∫Èñì */
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}
/* ÈÅäÊà≤ÈÅãË°å‰∏≠Èö±ËóèÈÅ∏ÊìáÂô®ÔºåÈÅøÂÖçÈáçÁñä */
.game-running .music-selector,
.game-running .difficulty-selector {
    display: none;
}
.game-running .unlock-progress-container {
    opacity: 1;
    transform: translateY(0);
}

/* --- Áµ±Ë®àÊï∏Êìö (ÂàÜÊï∏Á≠â) --- */
.stats {
    display: flex;
    gap: 10px;
}

.stat-box {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 8px 12px;
    min-width: 90px;
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #ffcc00;
}

.stat-label {
    font-size: 1rem;
    color: #fff;
    opacity: 1;
}

/* --- ÊéßÂà∂È†Ö (ÈñãÂßã„ÄÅË®≠ÂÆöÁ≠âÊåâÈàï) --- */
.controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

.svg-button {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    width: 80px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
}
.svg-button:hover {
    transform: translateY(-2px);
}
.svg-button:active {
    transform: translateY(1px);
}
.svg-button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
    transform: none;
}
.start-button-svg {
    width: 100%;
    height: 100%;
}

.settings-btn, .music-player-btn {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.settings-icon, .music-player-icon {
    width: 100%;
    height: 100%;
    fill: white;
}
.music-player-btn {
    margin-left: 10px;
}

/* --- Ê≠åÊõ≤ËàáÈõ£Â∫¶ÈÅ∏ÊìáÂô® --- */
.music-selector, .difficulty-selector {
    display: flex;
    gap: 8px;
    align-items: center;
}

.music-select-wrapper {
    position: relative;
    display: inline-block;
}

.music-select-wrapper select, .difficulty-selector select {
    background: rgba(0, 0, 0, 0.3);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50px;
    font-size: 0.9rem;
    min-width: 0;
    flex: 1;
    appearance: none;
    cursor: pointer;
}
.music-select-wrapper select {
    padding: 8px 35px 8px 12px;
}
.difficulty-selector select {
    border-radius: 5px;
    padding: 5px 10px;
}

.music-select-wrapper select:disabled, .difficulty-selector select:disabled {
    color: #888;
    cursor: not-allowed;
}

.music-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    fill: white;
    width: 16px;
    height: 16px;
}

/* --- ÂÄã‰∫∫ÂàÜÊï∏/ÊéíË°åÊ¶úÊåâÈàï --- */
.personal-high-score-btn {
    background: none;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: background 0.3s ease, border-color 0.3s ease;
}
.personal-high-score-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.5);
}
.personal-high-score-icon {
    width: 18px;
    height: 18px;
    fill: white;
}

/* --- ÈÄ≤Â∫¶Ê¢ù --- */
.progress-container {
    position: absolute;
    bottom: 5px;
    left: 10px;
    right: 10px;
    width: auto;
    height: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    overflow: hidden;
    z-index: 10;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ff8a00, #e52e71);
    width: 0%;
    transition: width 0.1s linear;
}

.unlock-progress-container {
    position: absolute;
    bottom: 22px; /* 5px(Èü≥Ê®ÇÈÄ≤Â∫¶Ê¢ù) + 12px(È´òÂ∫¶) + 5px(ÈñìË∑ù) */
    left: 10px;
    right: 10px;
    width: auto;
    height: 12px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
    z-index: 10;
    opacity: 0;
    transform: translateY(100%);
    transition: opacity 0.5s ease, transform 0.5s ease;
    display: flex;
    align-items: center;
    flex-direction: row;
}

.unlock-progress-bar {
    height: 100%;
    min-height: 12px;
    width: 0%;
    background: linear-gradient(90deg, #1D976C, #93F9B9);
    transition: width 0.2s ease-out, box-shadow 0.3s ease;
    box-shadow: 0 0 10px rgba(147, 249, 185, 0);
}

.unlock-progress-bar.glowing {
    box-shadow: 0 0 15px 5px rgba(147, 249, 185, 0.8);
}

.unlock-progress-marker {
    position: absolute;
    top: -5px;
    bottom: -5px;
    width: 2px;
    height: auto;
    z-index: 2;
}

.unlock-progress-marker.song-marker {
    background: #FFD700;
    box-shadow: 0 0 8px #FFD700;
}

.unlock-progress-marker.difficulty-marker {
    background: #F96666;
    box-shadow: 0 0 8px #F96666;
}

/* =================================================================== */
/* ====== 3. ÈÅäÊà≤ÈÄ≤Ë°åÂçÄÂüü (Game Area) ====== */
/* =================================================================== */
.game-area {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.tracks {
    display: flex;
    justify-content: center;
    gap: 8px;
    position: relative;
    height: 600px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    overflow: hidden;
    padding: 15px 0;
    transition: box-shadow 0.3s ease;
}

/* --- Combo ÂÖâÊöàÊïàÊûú --- */
.tracks.combo-blue { box-shadow: 0 0 20px 5px rgba(30, 144, 255, 0.7); }
.tracks.combo-orange { box-shadow: 0 0 25px 8px rgba(255, 165, 0, 0.7); }
.tracks.combo-pink { box-shadow: 0 0 30px 10px rgba(255, 105, 180, 0.7); }
.tracks.combo-purple { box-shadow: 0 0 35px 12px rgba(147, 112, 219, 0.7); }
.tracks.combo-rainbow {
    box-shadow: 0 0 40px 15px;
    animation: rainbowGlow 1.5s infinite;
}

/* --- ËªåÈÅìËàáÈü≥Á¨¶ --- */
.track {
    width: 80px;
    height: 100%;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    position: relative;
}

.track::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, transparent 0%, rgba(255, 255, 255, 0.2) 100%);
    pointer-events: none;
}
.track.hit-effect { animation: trackFlash 0.2s ease-out; }
.track.flash-perfect { animation: trackFlashPerfect 0.3s ease-out; }
.track.flash-great { animation: trackFlashGreat 0.3s ease-out; }
.track.flash-good { animation: trackFlashGood 0.3s ease-out; }

.hit-line {
    position: absolute;
    bottom: 100px;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #ff8a00, #e52e71);
    border-radius: 2px;
    box-shadow: 0 0 10px rgba(229, 46, 113, 0.7);
    z-index: 10;
}
.hit-line.pulse-effect { animation: hitLinePulse 0.2s ease-out; }

.note {
    position: absolute;
    width: 70px;
    height: 25px;
    background: linear-gradient(45deg, #00c9ff, #92fe9d);
    border-radius: 12px;
    top: -50px;
    left: 5px;
    box-shadow: 0 0 10px rgba(0, 201, 255, 0.7);
    animation: fall linear;
    z-index: 5;
}

.long-note {
    position: absolute;
    width: 70px;
    background: linear-gradient(45deg, #ff416c, #ff4b2b);
    border-radius: 12px;
    top: -50px;
    left: 5px;
    box-shadow: 0 0 10px rgba(255, 65, 108, 0.7);
    animation: fall linear;
    z-index: 5;
    transition: background 0.1s ease, box-shadow 0.1s ease;
}

.long-note.held {
    background: linear-gradient(45deg, #ffdd4b, #ff8c4b);
    box-shadow: 0 0 15px rgba(255, 221, 75, 0.9);
}

.key-hint {
    position: absolute;
    bottom: 50px;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 1.3rem;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.7);
}

/* --- ÈÅäÊà≤ÂèçÈ•ã (Âà§ÂÆö„ÄÅÈÄ£Êìä) --- */
.judgment {
    position: absolute;
    bottom: 150px;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
    opacity: 0;
    z-index: 20;
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
    animation: judgmentFade 1s ease-out;
}
.perfect { color: #ffcc00; }
.great { color: #00ccff; }
.good { color: #00ff99; }
.miss { color: #ff3366; }

.combo-display {
    position: absolute;
    top: 20%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    font-weight: bold;
    opacity: 0;
    z-index: 15;
    animation: comboFlash 0.5s ease-out;
    pointer-events: none;
}
.combo-display.combo-base { color: #e0e0e0; text-shadow: 0 0 10px rgba(224, 224, 224, 0.7); }
.combo-display.combo-blue { color: #1e90ff; text-shadow: 0 0 15px rgba(30, 144, 255, 0.8); }
.combo-display.combo-orange { color: #ffa500; text-shadow: 0 0 15px rgba(255, 165, 0, 0.8); }
.combo-display.combo-pink { color: #ff69b4; text-shadow: 0 0 15px rgba(255, 105, 180, 0.8); }
.combo-display.combo-purple { color: #9370db; text-shadow: 0 0 15px rgba(147, 112, 219, 0.8); }
.combo-display.combo-rainbow {
    background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
    background-size: 400% 400%;
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    animation: comboFlashRainbow 0.5s ease-out, rainbowText 2s linear infinite;
}

/* --- ÈÅäÊà≤‰∏≠Ê≠åË©ûÈ°ØÁ§∫ --- */
.lyrics-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    display: none; /* Áî± JS ÊéßÂà∂È°ØÁ§∫ */
    flex-wrap: wrap;
    align-content: flex-start;
    justify-content: space-around;
    gap: 2px;
    margin: 0;
    padding: 0;
    opacity: 0.25;
    color: #fff;
    font-size: 5rem;
    pointer-events: none;
    text-align: center;
    overflow: hidden;
}

.lyrics-background span {
    margin: 0;
    padding: 0;
    line-height: 1.1;
    word-spacing: 0;
    letter-spacing: 0;
    white-space: nowrap;
    flex: 0 0 auto;
    min-width: 10%;
    min-height: 10vh;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    word-break: break-word;
    overflow: hidden;
}

/* =================================================================== */
/* ====== 4. Á≤íÂ≠êÊïàÊûú (Particle Effects) ====== */
/* =================================================================== */
.hit-particle {
    position: absolute;
    bottom: 100px;
    width: var(--size, 10px);
    height: var(--size, 10px);
    border-radius: 50%;
    pointer-events: none;
    z-index: 30;
    opacity: 0;
    will-change: transform, opacity;
}
.hit-particle.animate {
    animation: particleBurst 0.6s ease-out forwards;
}

.note-particle {
    position: absolute;
    width: var(--size, 8px);
    height: var(--size, 8px);
    border-radius: 30%;
    pointer-events: none;
    z-index: 30;
    opacity: 0;
    will-change: transform, opacity;
}
.note-particle.animate {
    animation: noteDecompose 0.5s ease-out forwards;
}

/* =================================================================== */
/* ====== 5. Ëß∏ÊéßÊåâÈçµ (Touch Controls) ====== */
/* =================================================================== */
.touch-controls {
    display: none; /* Áî± JS ÊéßÂà∂È°ØÁ§∫ */
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
    padding: 10px 0;
    width: 100%;
    z-index: 100;
}

.touch-key {
    width: 70px;
    height: 70px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.95);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    cursor: pointer;
    user-select: none;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 2px solid;
    transition: box-shadow 0.15s ease, transform 0.1s ease, filter 0.1s ease, background 0.15s ease;
}

/* --- ÊåâÈçµÈ°èËâ≤ --- */
.touch-key[data-key="65"] { background: linear-gradient(135deg, rgba(0, 220, 220, 0.7), rgba(0, 100, 120, 0.8)); border-color: rgba(80, 230, 230, 0.8); box-shadow: 0 0 15px rgba(0, 220, 220, 0.6); }
.touch-key[data-key="83"] { background: linear-gradient(135deg, rgba(0, 201, 255, 0.7), rgba(0, 123, 255, 0.75)); border-color: rgba(100, 220, 255, 0.8); box-shadow: 0 0 15px rgba(0, 201, 255, 0.6); }
.touch-key[data-key="68"] { background: linear-gradient(135deg, rgba(210, 240, 255, 0.7), rgba(150, 210, 255, 0.8)); border-color: rgba(220, 245, 255, 0.85); box-shadow: 0 0 18px rgba(180, 225, 255, 0.7); }
.touch-key[data-key="70"] { background: linear-gradient(135deg, rgba(225, 230, 235, 0.7), rgba(170, 180, 190, 0.8)); border-color: rgba(230, 235, 240, 0.8); box-shadow: 0 0 15px rgba(210, 215, 220, 0.7); }

/* --- Êåâ‰∏ãÊïàÊûú --- */
.touch-key:active, .touch-key.pressed {
    filter: brightness(1.3) saturate(1.2);
    box-shadow: 0 0 28px 5px;
}
.touch-key[data-key="65"]:active, .touch-key[data-key="65"].pressed { box-shadow: 0 0 28px 5px rgba(0, 220, 220, 0.8); }
.touch-key[data-key="83"]:active, .touch-key[data-key="83"].pressed { box-shadow: 0 0 28px 5px rgba(0, 201, 255, 0.8); }
.touch-key[data-key="68"]:active, .touch-key[data-key="68"].pressed { box-shadow: 0 0 28px 5px rgba(180, 225, 255, 0.85); }
.touch-key[data-key="70"]:active, .touch-key[data-key="70"].pressed { box-shadow: 0 0 28px 5px rgba(225, 230, 235, 0.9); }

/* =================================================================== */
/* ====== 6. ÂΩàÂá∫Ë¶ñÁ™ó (Modals) ====== */
/* =================================================================== */

/* --- ÂΩàÂá∫Ë¶ñÁ™óÂü∫Á§éÊ®£Âºè (ÈÅÆÁΩ©) --- */
.notification-modal, .game-over-modal, .lyrics-quiz-modal, .settings-modal, .personal-high-score-modal, .unlock-modal, .copyright-disclaimer-modal, .music-player-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
}
.notification-modal.active, .game-over-modal.active, .lyrics-quiz-modal.active, .settings-modal.active, .personal-high-score-modal.active, .unlock-modal.active, .copyright-disclaimer-modal.active, .music-player-modal.active {
    opacity: 1;
    pointer-events: all;
}

/* --- Áµ±‰∏ÄÈóúÈñâÊåâÈàïÊ®£Âºè --- */
.close-settings, .close-personal-high-score, .close-disclaimer, .close-notification, .quiz-close-btn, .close-unlock {
    position: absolute;
    top: 15px;
    right: 20px;
    background: transparent;
    border: none;
    font-size: 2.2rem;
    font-weight: 400;
    line-height: 1;
    color: var(--starlight-text-secondary, #8c7d6b);
    cursor: pointer;
    transition: color 0.3s ease, transform 0.3s ease;
}
.close-settings:hover, .close-personal-high-score:hover, .close-disclaimer:hover, .close-notification:hover, .quiz-close-btn:hover, .close-unlock:hover {
    color: var(--starlight-text-primary, #3a332a);
    transform: rotate(90deg);
}

/* --- "Clean HUD" ‰∏ªÈ°å: ÈÄöÁü•Ë¶ñÁ™ó --- */
.notification-modal { background: rgba(25, 40, 60, 0.7); backdrop-filter: blur(5px); z-index: 2000; }
.notification-content {
    width: 90%;
    max-width: 400px;
    box-sizing: border-box;
    background: #f0f4f8;
    color: #334155;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    padding: 25px 30px;
    border-left: 5px solid #64748b;
    transform: scale(0.8) translateY(20px);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
    text-align: center;
    position: relative;
}
.notification-modal.active .notification-content { transform: scale(1) translateY(0); opacity: 1; }
.notification-icon { font-size: 3.5rem; margin-bottom: 15px; animation: icon-pop 0.5s ease-out 0.3s backwards; }
.notification-title { font-size: 1.6rem; font-weight: 700; margin-bottom: 8px; }
.notification-message { font-size: 1rem; color: #64748b; line-height: 1.6; }
.notification-message strong { font-weight: 700; color: #334155; }
.notification-content.success { border-left-color: #10b981; }
.notification-content.success .notification-icon { color: #10b981; }
.notification-content.success .notification-title { color: #059669; }
.notification-content.info { border-left-color: #3b82f6; }
.notification-content.info .notification-icon { color: #3b82f6; }
.notification-content.info .notification-title { color: #2563eb; }

/* --- "Hall of Fame" ‰∏ªÈ°å: ÈÅäÊà≤ÁµêÊùüË¶ñÁ™ó --- */
.game-over-modal { background: rgba(10, 20, 40, 0.7); backdrop-filter: blur(5px); }
.game-over-content {
    width: 90%;
    max-width: 450px;
    box-sizing: border-box;
    background: linear-gradient(160deg, #1d2b4a, #11182c);
    border: 1px solid rgba(255, 204, 0, 0.3);
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5), 0 0 25px rgba(255, 204, 0, 0.2) inset;
    border-radius: 20px;
    padding: 30px 40px;
    transform: scale(0.8);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
    text-align: center;
}
.game-over-modal.active .game-over-content { transform: scale(1); opacity: 1; }
.game-over-title { font-size: 2.8rem; margin-bottom: 20px; color: #ffcc00; text-shadow: 0 0 15px rgba(255, 204, 0, 0.6); }
.game-over-stats { display: flex; justify-content: space-around; margin: 25px 0; gap: 15px; }
.game-over-stat { background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 12px; flex: 1; min-width: 100px; }
.stat-number { font-size: 2.2rem; font-weight: bold; color: #ff8a00; }
.restart-btn {
    background: linear-gradient(45deg, #00c9ff, #92fe9d);
    color: #fff;
    border: none;
    padding: 14px 35px;
    border-radius: 50px;
    font-size: 1.2rem;
    font-weight: bold;
    cursor: pointer;
    margin-top: 20px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    text-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.restart-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 201, 255, 0.3); }

/* --- "Lyrics Quiz" ‰∏ªÈ°å: Ê≠åË©ûÊ∏¨È©óË¶ñÁ™ó --- */
.lyrics-quiz-modal { background: rgba(25, 40, 60, 0.85); backdrop-filter: blur(8px); z-index: 2500; }
.quiz-content {
    width: 90%;
    max-width: 500px;
    box-sizing: border-box;
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    color: #343a40;
    padding: 30px 40px;
    border-radius: 20px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
    text-align: center;
    position: relative;
}
.lyrics-quiz-modal.active .quiz-content { transform: scale(1); opacity: 1; }
.quiz-title { font-size: 2.2rem; color: #17a2b8; margin-bottom: 10px; font-weight: 700; }
.quiz-instructions { font-size: 1rem; color: #6c757d; margin-bottom: 20px; }
.quiz-progress { background: #17a2b820; padding: 8px 12px; border-radius: 8px; margin-bottom: 25px; font-size: 1.1rem; font-weight: bold; color: #17a2b8; transition: all 0.3s ease; border: 1px solid #17a2b880; }
.quiz-question-container { margin: 25px 0; padding: 25px; background: #ffffff; border-radius: 15px; min-height: 100px; display: flex; align-items: center; justify-content: center; border: 1px solid #dee2e6; }
#quizQuestionText { font-size: 1.6rem; color: #212529; line-height: 1.6; letter-spacing: 1px; font-weight: 500; }
.quiz-blank { display: inline-block; width: 100px; border-bottom: 2px solid #6c757d; margin: 0 4px; vertical-align: baseline; }
.quiz-answer-input { width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 12px; border: 2px solid #ced4da; background: #f8f9fa; color: #495057; text-align: center; transition: all 0.3s ease; box-sizing: border-box; }
.quiz-answer-input:focus { outline: none; border-color: #17a2b8; box-shadow: 0 0 0 4px rgba(23, 162, 184, 0.25); }
.quiz-answer-input.correct { border-color: #28a745; background-color: #e9f7ec; }
.quiz-answer-input.incorrect { border-color: #dc3545; background-color: #fbebed; animation: shake 0.5s ease-in-out; }
.quiz-submit-btn { width: 100%; padding: 15px 20px; font-size: 1.2rem; font-weight: bold; color: #fff; background: linear-gradient(45deg, #17a2b8, #138496); border: none; border-radius: 12px; cursor: pointer; margin-top: 20px; transition: all 0.2s ease; }
.quiz-submit-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3); }
.quiz-submit-btn:disabled { background: #adb5bd; cursor: not-allowed; transform: none; box-shadow: none; }

/* --- "Starlight Hall" ‰∏ªÈ°å: Ë®≠ÂÆö„ÄÅÊéíË°åÊ¶ú„ÄÅÂÄã‰∫∫ÂàÜÊï∏„ÄÅËß£ÈéñË¶ñÁ™ó --- */
.settings-modal, .personal-high-score-modal, .unlock-modal { background: rgba(0, 0, 0, 0.8); z-index: 1001; }
.settings-content, .personal-high-score-content, .unlock-content {
    width: 90%;
    max-width: 500px;
    box-sizing: border-box;
    background: var(--starlight-bg);
    color: var(--starlight-text-primary);
    border-radius: 16px;
    border: 1px solid var(--starlight-border);
    box-shadow: 0 10px 35px rgba(0, 0, 0, 0.08), 0 0 20px var(--starlight-accent-glow) inset;
    padding: 30px;
    position: relative;
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
    text-align: center;
}
.settings-modal.active .settings-content, .personal-high-score-modal.active .personal-high-score-content, .unlock-modal.active .unlock-content { transform: scale(1); opacity: 1; }

.settings-title, .personal-high-score-title, .unlock-message { font-size: 2rem; color: var(--starlight-accent); font-weight: 700; text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8); margin-bottom: 25px; }
.unlock-icon { font-size: 4rem; margin-bottom: 20px; color: var(--starlight-accent); }
.unlock-requirement { font-size: 1rem; color: #00c9ff; margin-bottom: 30px; }

/* --- Ë°®ÂñÆÂÖÉÁ¥† (Ë®≠ÂÆöÈ†Å) --- */
.setting-group { margin-bottom: 20px; text-align: left; }
.setting-label { color: var(--starlight-text-secondary); font-weight: bold; font-size: 1.1rem; display: block; margin-bottom: 8px; }
.setting-control { width: 100%; padding: 10px; font-size: 1rem; background: #f0f2f5; border: 1px solid #dde0e4; color: var(--starlight-text-primary); border-radius: 8px; }
.setting-control::placeholder { color: #a0a8b1; }
.setting-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #dde0e4; border-radius: 5px; outline: none; cursor: pointer; }
.setting-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #fff; border-radius: 50%; border: 2px solid #a0a8b1; box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
.setting-slider::-moz-range-thumb { width: 20px; height: 20px; background: #fff; border-radius: 50%; border: 2px solid #a0a8b1; box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
.setting-group .restart-btn, .close-unlock { background: var(--starlight-accent); color: white; border-radius: 50px; border: none; text-shadow: none; box-shadow: 0 4px 15px var(--starlight-accent-glow); transition: transform 0.2s ease, box-shadow 0.2s ease; padding: 10px 20px; }
.setting-group .restart-btn:hover, .close-unlock:hover { transform: translateY(-3px); box-shadow: 0 8px 20px var(--starlight-accent-glow); }

/* --- "Stardust Glory" ‰∏ªÈ°å: ÊéíË°åÊ¶ú --- */
#playerNameGroup { display: flex; align-items: center; gap: 12px; border: 1px solid var(--starlight-border); padding: 10px; border-radius: 50px; background: rgba(255, 255, 255, 0.5); margin-bottom: 25px; }
#playerNameGroup .setting-label { display: none; }
#playerNameGroup .setting-control { flex-grow: 1; border: none; background: transparent; padding: 8px 15px; font-size: 1.1rem; color: var(--starlight-text-primary); }
#playerNameGroup .setting-control:focus { outline: none; }
#savePlayerNameBtn { width: 48px; height: 48px; padding: 0; flex-shrink: 0; border-radius: 50%; background: #6a8eae; color: white; font-size: 1.5rem; border: none; box-shadow: 0 4px 12px rgba(106, 142, 174, 0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; }
#savePlayerNameBtn::before { content: '‚úî'; font-weight: bold; }
#savePlayerNameBtn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 18px rgba(106, 142, 174, 0.4); }
#savePlayerNameBtn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
#savePlayerNameBtn.loading::before { content: ''; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
.leaderboard-display { margin-top: 20px; }
#leaderboardTitle { color: #6a8eae; }

.personal-high-score-list, .leaderboard-list { list-style: none; padding: 0; margin: 0; }
.personal-high-score-item, .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 10px; background: var(--starlight-item-bg); border-left: 4px solid var(--starlight-accent); border-radius: 8px; transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; }
.personal-high-score-item:hover, .leaderboard-item:hover { background: var(--starlight-item-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
.personal-high-score-label, .leaderboard-name { color: var(--starlight-text-primary); font-weight: 500; }
.personal-high-score-value, .leaderboard-score { color: var(--starlight-accent); font-weight: bold; }
.leaderboard-item { gap: 15px; border: 1px solid transparent; border-left-width: 5px; }
.leaderboard-rank { flex-basis: 50px; flex-shrink: 0; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; justify-content: center; position: relative; color: var(--starlight-text-secondary); }
.leaderboard-name { flex-grow: 1; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1.1rem; }
.leaderboard-score { flex-basis: 100px; flex-shrink: 0; font-size: 1.4rem; text-align: right; }
.leaderboard-item:first-child, .leaderboard-item:nth-child(1) { background: linear-gradient(100deg, rgba(212, 175, 55, 0.15), transparent 70%); border-color: var(--rank-gold); box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2); }
.leaderboard-item:first-child .leaderboard-rank, .leaderboard-item:nth-child(1) .leaderboard-rank { color: var(--rank-gold); text-shadow: 0 0 8px rgba(212, 175, 55, 0.7); font-size: 0; }
.leaderboard-item:first-child .leaderboard-rank::before, .leaderboard-item:nth-child(1) .leaderboard-rank::before { content: 'üëë'; position: absolute; font-size: 1.8rem; opacity: 0.9; filter: drop-shadow(var(--rank-icon-shadow)); }
.leaderboard-item:nth-child(2) { background: linear-gradient(100deg, rgba(192, 192, 192, 0.15), transparent 70%); border-color: var(--rank-silver); }
.leaderboard-item:nth-child(2) .leaderboard-rank { color: var(--rank-silver); text-shadow: 0 0 6px rgba(192, 192, 192, 0.7); font-size: 0; }
.leaderboard-item:nth-child(2) .leaderboard-rank::before { content: 'ü•à'; position: absolute; font-size: 1.6rem; filter: drop-shadow(var(--rank-icon-shadow)); }
.leaderboard-item:nth-child(3) { background: linear-gradient(100deg, rgba(205, 127, 50, 0.15), transparent 70%); border-color: var(--rank-bronze); }
.leaderboard-item:nth-child(3) .leaderboard-rank { color: var(--rank-bronze); text-shadow: 0 0 5px rgba(205, 127, 50, 0.7); font-size: 0; }
.leaderboard-item:nth-child(3) .leaderboard-rank::before { content: 'ü•â'; position: absolute; font-size: 1.6rem; filter: drop-shadow(var(--rank-icon-shadow)); }

/* --- ÁâàÊ¨äËÅ≤ÊòéË¶ñÁ™ó --- */
.copyright-disclaimer-modal { background: rgba(0, 0, 0, 0.85); z-index: 1005; }
.disclaimer-content { background: linear-gradient(135deg, #2c1810, #1a1a2e); padding: 40px; border-radius: 20px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.3); max-width: 500px; width: 90%; position: relative; text-align: left; border: 1px solid rgba(255, 215, 0, 0.2); animation: modalPop 0.5s ease-out; }
.disclaimer-title { font-size: 2rem; margin-bottom: 30px; text-align: center; color: #FFD700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
.disclaimer-section { margin-bottom: 25px; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 15px; border-left: 4px solid #FFD700; }
.disclaimer-section h3 { color: #FFD700; margin-bottom: 10px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }
.disclaimer-section p { color: #e0e0e0; line-height: 1.6; font-size: 1.1rem; }

/* --- Èü≥Ê®ÇÊí≠ÊîæÂô®Ë¶ñÁ™ó --- */
.music-player-modal { background-color: #0b192f; background-image: radial-gradient(at 20% 80%, hsla(190, 80%, 50%, 0.3), transparent 50%), radial-gradient(at 80% 10%, hsla(170, 70%, 60%, 0.25), transparent 50%), radial-gradient(at 90% 20%, hsla(40, 90%, 70%, 0.35), transparent 60%), radial-gradient(at 10% 40%, hsla(45, 80%, 75%, 0.25), transparent 70%); flex-direction: column; z-index: 1003; }
.music-player-content { width: 90%; max-width: 800px; text-align: center; padding: 30px; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-radius: 20px; border: 1px solid rgba(230, 180, 80, 0.5); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2), 0 0 20px rgba(230, 180, 80, 0.2); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
.music-player-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
.close-music-player { background: none; border: none; color: white; font-size: 2rem; cursor: pointer; padding: 5px 10px; border-radius: 5px; transition: background 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
.close-music-player:hover { background: rgba(255, 255, 255, 0.1); }
.close-music-player-icon { width: 100%; height: 100%; fill: white; }
.cd-cover-container { width: 100%; display: flex; justify-content: center; margin-bottom: 20px; padding: 0 10px; }
.cd-cover-wrapper { position: relative; width: 100%; max-width: 300px; aspect-ratio: 1 / 1; border-radius: 50%; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); background: rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: center; }
.cd-cover-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; border-radius: 50%; transform-origin: center; }
.cd-cover-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0) 100%); pointer-events: none; }
.cd-cover-img.playing { animation: cdSpin 15s linear infinite; }
.now-playing { font-size: 1.5rem; margin-bottom: 20px; color: #2c3e50; font-weight: 600; }
.lyrics-container { overflow-y: auto; margin-bottom: 20px; padding: 10px; flex: 1 1 0; min-height: 120px; }
.lyric-line { margin: 10px 0; color: #a3a3a3; opacity: 0.7; transition: all 0.3s ease; }
.lyric-line.active { opacity: 1; font-weight: bold; color: #17a2b8; transform: scale(1.05); text-shadow: 0 1px 3px rgba(0, 0, 0, 0.15); }
.no-lyrics { color: #aaa; font-style: italic; }
.player-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }
.player-btn { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: #2c3e50; font-size: 2rem; cursor: pointer; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; padding: 0; border-radius: 50%; transition: background 0.3s ease, transform 0.2s ease; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
.player-btn:hover { background: rgba(255, 255, 255, 0.4); }
.progress-slider { width: 100%; height: 8px; -webkit-appearance: none; appearance: none; background: rgba(140, 115, 70, 0.3); border-radius: 4px; outline: none; }
.progress-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #17a2b8; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; }
.time-display { display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px; font-size: 0.9rem; color: #ccc; }
.volume-control-player { display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; }
.volume-control-player input[type="range"] { width: 150px; }
.playlist { list-style: none; padding: 10px; margin-top: 30px; max-height: 200px; overflow-y: auto; background: rgba(0, 0, 0, 0.2); border-radius: 10px; flex-shrink: 0; }
.playlist-item { padding: 12px 15px; border-radius: 8px; cursor: pointer; transition: background 0.3s ease; text-align: left; color: #e1d4dd; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
.playlist-item:last-child { border-bottom: none; }
.playlist-item:hover { background: rgba(255, 255, 255, 0.1); }
.playlist-item.active { background: rgba(23, 162, 184, 0.2); color: #2c3e50; font-weight: bold; }
.playlist-item.locked { color: #888; cursor: not-allowed; opacity: 0.7; }
.playlist-item.disabled { opacity: 0.5; color: #888; text-decoration: line-through; }

/* =================================================================== */
/* ====== 7. ÂãïÁï´ÊïàÊûú (@keyframes) ====== */
/* =================================================================== */
@keyframes rainbowGlow {
    0% { box-shadow-color: rgba(255, 0, 0, 0.7); }
    16.66% { box-shadow-color: rgba(255, 255, 0, 0.7); }
    33.33% { box-shadow-color: rgba(0, 255, 0, 0.7); }
    50% { box-shadow-color: rgba(0, 255, 255, 0.7); }
    66.66% { box-shadow-color: rgba(0, 0, 255, 0.7); }
    83.33% { box-shadow-color: rgba(255, 0, 255, 0.7); }
    100% { box-shadow-color: rgba(255, 0, 0, 0.7); }
}
@keyframes fall {
    from { transform: translateY(-50px); }
    to { transform: translateY(650px); }
}
@keyframes judgmentFade {
    0% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-40px); }
}
@keyframes comboFlash {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
}
@keyframes comboFlashRainbow {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(1.5); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
}
@keyframes rainbowText {
    0% { background-position: 0% 50%; }
    100% { background-position: 100% 50%; }
}
@keyframes trackFlash {
    0% { background-color: rgba(255, 255, 255, 0.35); }
    100% { background-color: rgba(255, 255, 255, 0.15); }
}
@keyframes trackFlashPerfect {
    0% { background-color: rgba(255, 204, 0, 0.5); }
    100% { background-color: rgba(255, 255, 255, 0.15); }
}
@keyframes trackFlashGreat {
    0% { background-color: rgba(0, 204, 255, 0.5); }
    100% { background-color: rgba(255, 255, 255, 0.15); }
}
@keyframes trackFlashGood {
    0% { background-color: rgba(0, 255, 153, 0.5); }
    100% { background-color: rgba(255, 255, 255, 0.15); }
}
@keyframes hitLinePulse {
    0% { transform: scaleX(1); box-shadow: 0 0 10px rgba(229, 46, 113, 0.7); }
    50% { transform: scaleX(1.1); box-shadow: 0 0 30px 8px rgba(255, 204, 0, 1); }
    100% { transform: scaleX(1); box-shadow: 0 0 10px rgba(229, 46, 113, 0.7); }
}
@keyframes particleBurst {
    0% { transform: translateY(0) scale(1) rotate(var(--rot, 0deg)); opacity: 1; }
    100% { transform: translateY(var(--y)) translateX(var(--x)) scale(0) rotate(var(--rot-end, 360deg)); opacity: 0; }
}
@keyframes noteDecompose {
    0% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; }
    100% { transform: translate(var(--x), var(--y)) scale(0.2) rotate(var(--rot-end, 360deg)); opacity: 0; }
}
@keyframes modalPop {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
@keyframes icon-pop {
    0% { transform: scale(0); }
    80% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
    20%, 40%, 60%, 80% { transform: translateX(8px); }
}
@keyframes cdSpin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* =================================================================== */
/* ====== 8. ÈüøÊáâÂºèË®≠Ë®à (Responsive Design) ====== */
/* =================================================================== */

/* --- ÈõªËÖ¶Â§ßËû¢Âπï (1025px+) --- */
@media (min-width: 1025px) {
    .playlist { max-height: 400px; }
    .lyrics-background { font-size: 4.5rem; }
    .lyrics-background span { min-width: 8.33%; min-height: 8vh; }
}

/* --- Âπ≥Êùø (769px - 1024px) --- */
@media (max-width: 1024px) {
    .lyrics-background { font-size: 4rem; }
    .lyrics-background span { min-width: 12.5%; min-height: 12vh; }
}
@media (min-width: 769px) {
    h1 { font-size: 2.2rem; }
    .subtitle { font-size: 1.1rem; }
    .game-ui { flex-wrap: nowrap; gap: 15px; }
    .tracks { height: 550px; }
    .track { width: 70px; }
    .note, .long-note { width: 60px; height: 30px; }
    .hit-line { bottom: 100px; }
    .music-select-wrapper select { max-width: none; }
    .cd-cover-wrapper { max-width: 230px; }
    .music-player-content { width: 92%; max-width: 700px; padding: 25px 30px; }
    .lyrics-container { font-size: 1.4rem; min-height: 150px; }
    .playlist { max-height: 300px; min-height: 150px; }
}

/* --- ÊâãÊ©ü (up to 768px) --- */
@media (max-width: 768px) {
    h1 { font-size: 2rem; }
    .tracks { height: 500px; }
    .track { width: 60px; }
    .note, .long-note { width: 50px; }
    .hit-line { bottom: 90px; }
    .music-select-wrapper select { max-width: 150px; }
    .cd-cover-wrapper { max-width: 220px; }
    .lyrics-background { font-size: 3.5rem; }
    .lyrics-background span { min-width: 16.66%; min-height: 15vh; }
    .game-ui { padding-bottom: 50px; }
}

/* --- Â∞èËû¢ÂπïÊâãÊ©ü (up to 480px) --- */
@media (max-width: 480px) {
    h1 { font-size: 1.7rem; }
    .game-ui { justify-content: space-around; gap: 5px; flex-wrap: wrap; }
    .stats, .controls { flex-shrink: 1; flex-wrap: wrap; justify-content: center; }
    .music-select-wrapper select { padding: 6px 30px 6px 10px; font-size: 0.8rem; max-width: 120px; }
    .difficulty-selector select { max-width: 80px; font-size: 0.8rem; padding: 4px 6px; }
    .stat-box { padding: 6px 10px; min-width: 80px; }
    .stat-value { font-size: 1.3rem; }
    .tracks { height: 400px; }
    .track { width: 50px; }
    .note, .long-note { width: 40px; }
    .hit-line { bottom: 80px; }
    .cd-cover-wrapper { max-width: 180px; margin-bottom: 15px; }
    .lyrics-background { font-size: 3rem; }
    .lyrics-background span { min-width: 25%; min-height: 20vh; }
    
    /* Èü≥Ê®ÇÊí≠ÊîæÂô® */
    .music-player-content { padding: 10px 15px; max-height: 90vh; }
    .now-playing { font-size: 1.1rem; }
    .player-controls { gap: 15px; }
    .player-btn { width: 45px; height: 45px; font-size: 1.2rem; }
    .play-pause-btn { width: 60px; height: 60px; font-size: 1.8rem; }
    .lyrics-container { font-size: 1.2rem; margin-bottom: 15px; min-height: 120px; }
    .playlist { max-height: 150px; }

    /* ÂΩàÂá∫Ë¶ñÁ™ó */
    .notification-content, .game-over-content, .quiz-content, .settings-content, .personal-high-score-content, .unlock-content { padding: 20px 15px; }
    .notification-title, .quiz-title, .settings-title, .personal-high-score-title, .unlock-message { font-size: 1.8rem; }
    .game-over-title { font-size: 2.2rem; }
    .notification-message, .quiz-instructions, .stat-label { font-size: 0.95rem; }
    .game-over-stats { flex-direction: column; gap: 10px; }
    .stat-number { font-size: 2rem; }
    .restart-btn { padding: 12px 30px; font-size: 1.1rem; }
    #quizQuestionText { font-size: 1.3rem; }
    .quiz-answer-input, .quiz-submit-btn { font-size: 1.1rem; padding: 12px; }
    .quiz-blank { width: 70px; }
    .leaderboard-name, .personal-high-score-label { font-size: 0.9rem; }
    #playerNameGroup { flex-direction: column; border-radius: 20px; padding: 15px; }
    #playerNameInput { width: 100%; text-align: center; }
    #savePlayerNameBtn { width: 100%; border-radius: 25px; }
    #savePlayerNameBtn::before { content: 'ÂÑ≤Â≠ò'; }
}

</style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
</head>
<body>
    <div class="lyrics-background" id="lyricsBackground"></div>  <!-- ÁßªÂà∞ÈÄôË£° -->
    <!-- Background Image -->
    <div class="background-image"></div>
    <div class="container">
        <div class="main-game-container" id="mainGameContainer">
            <div class="game-container">
                <div class="game-ui">
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value" id="score">0</div>
                            <div class="stat-label">ÂàÜÊï∏</div>
                        </div>


<!-- ‚ñº‚ñº‚ñº „Äê‰øÆË®Ç„ÄëÂ∞áÂéüÊúâÁöÑÂñÆ‰∏ÄÊ®ôË®òÁ∑öÊîπÁÇ∫ÂÖ©ÂÄãÁç®Á´ãÁöÑÊ®ôË®òÁ∑ö ‚ñº‚ñº‚ñº -->
<div id="unlockProgressContainer" class="unlock-progress-container">
    <!-- Ê≠åÊõ≤Ëß£ÈéñÁ∑ö (ÈªÉËâ≤) -->
    <div id="songUnlockMarker" class="unlock-progress-marker song-marker"></div>
    <!-- Èõ£Â∫¶Ëß£ÈéñÁ∑ö (Á¥ÖËâ≤) -->
    <div id="difficultyUnlockMarker" class="unlock-progress-marker difficulty-marker"></div>
    
    <div id="unlockProgressBar" class="unlock-progress-bar"></div>

</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ‰øÆË®ÇÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤ -->


                    </div>




                    <div class="controls">
                        <button class="svg-button" id="startBtn" title="ÈñãÂßãÈÅäÊà≤">
                            <svg class="start-button-svg" viewBox="0 0 80 40">
                                <defs>
                                    <linearGradient id="startButtonGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#ff8a00;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#e52e71;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect x="0" y="0" width="80" height="40" rx="20" ry="20" fill="url(#startButtonGradient)" />
                                <path d="M30 12 L30 28 L50 20 Z" fill="white"/>
                            </svg>
                        </button>
                        <button class="settings-btn" id="settingsBtn" title="Ë®≠ÂÆö">
                            <svg class="settings-icon" viewBox="0 0 24 24">
                                <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                            </svg>
                        </button>


                        
                        <button class="music-player-btn" id="musicPlayerBtn" title="Èü≥Ê®ÇÊí≠ÊîæÂô®">
                             <svg class="music-player-icon" viewBox="0 0 24 24">
                                <path d="M12,3V13.55C11.41,13.21 10.73,13 10,13C7.79,13 6,14.79 6,17C6,19.21 7.79,21 10,21C12.21,21 14,19.21 14,17V7H18V3H12Z" />
                            </svg>
                        </button>
                    </div>
                    <div class="music-selector">
                        <div class="music-select-wrapper">
                            <select id="musicSelect">
                                <option value="ÁôΩÂΩ±.mp3">ÁôΩÂΩ±</option>
                                <option value="Á≠âÂæÖ.mp3">Á≠âÂæÖ</option>
                                <option value="‰∏ã‰∏ÄÊûùÁöÑÊÉÜÊÇµ.mp3">‰∏ã‰∏ÄÊûùÁöÑÊÉÜÊÇµ</option>
                                <option value="È§òÁáºËêΩÂÖ•ËôõÁÑ°.mp3">È§òÁáºËêΩÂÖ•ËôõÁÑ°</option>
                                <option value="ËÄÅÂ±ãÂõûÊÜ∂.mp3">ËÄÅÂ±ãÂõûÊÜ∂</option>
                                <option value="battle-abysswalker.mp3">The Abysswalker</option>
                                <option value="Battle-Rosemoon.mp3">ÈÉΩÊà∞‰πôÂ•≥</option>
                                <option value="Battle-deadly.mp3">‰∫îÂ§ßÁΩ™</option>
                                <option value="Battle-rapier.mp3">ÁπºÊâøÂäçÁöÑÂ∞ëÂ•≥</option>
                                <option value="Ariadne-Battle.mp3">‰∏çÂ±àÊÑèÂøó‰πãÂàÉ</option>
                                <option value="battle-arms.mp3">Ë•øÈÉ®Êà∞È¨•</option>
                                <option value="Battle.mp3">Battle Theme</option>
                                <option value="Wanderers-City.mp3">ÊµÅÊµ™ÂüéÈéÆ</option>
                                <option value="Remotest-Liblary.mp3">Ê≤âÁù°ÁöÑË®òÊÜ∂</option>
                                <option value="Nostalgia.mp3">È∫•Áî∞Êá∑Ëàä</option>
                                <option value="sunbeams.mp3">ÊîæÂ≠∏Âæå</option>
                                <option value="village.mp3">ÈÑâÊùëÁîüÊ¥ª</option>
                                <option value="Take-a-Rest.mp3">‰ºëÊÅØ‰∏Ä‰∏ã</option>
                                <option value="winter-snow.mp3">Èõ™ÈÑâ</option>
                                <option value="Forgotten-Place.mp3">Ë¢´ÈÅ∫ÂøòÁöÑÂú∞Êñπ</option>
                                <option value="Rest-in-Peace.mp3">ÂÆâÊÅØ</option>
                                <option value="Farewell.mp3">ÂëäÂà•</option>
                                <option value="reminiscence.mp3">ÂõûÊÜ∂</option>
                                <option value="starry-night.mp3">ÊòüÂ§ú</option>
                                <option value="last-wish.mp3">Áï∂ÊÄùÂøµÂÇ≥Âà∞Êüê‰∫∫ËÄ≥Áïî</option>
                                <option value="sorrow.mp3">Ë∂ÖË∂äÊÇ≤ÂÇ∑</option>
                                <option value="hotarumichi.mp3">Ëû¢ÁÅ´Ëü≤‰πãË∑Ø</option>
                                <option value="Sky-Airship.mp3">È£õËâá</option>
                                <option value="Voyage_SE.mp3">Ë∑®Ë∂äÁ•ûÁßò‰πãÊµ∑</option>
                                <option value="main-theme01.mp3">ÁõºÊúõ</option>
                                <option value="saikai637.mp3">Á¥ÑÂÆö‰πãÂú∞</option>
                            </select>
                            <svg class="music-icon" viewBox="0 0 24 24">
                                <path d="M12,3V13.55C11.41,13.21 10.73,13 10,13C7.79,13 6,14.79 6,17C6,19.21 7.79,21 10,21C12.21,21 14,19.21 14,17V7H18V3H12Z" />
                            </svg>
                        </div>
                        <button class="personal-high-score-btn" id="personalHighScoreBtn" title="Êü•ÁúãÂÄã‰∫∫ÊúÄÈ´òÂàÜÊï∏">
                            <svg class="personal-high-score-icon" viewBox="0 0 24 24">
                                <path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" />
                            </svg>
                        </button>

<!-- Âú® id="settingsBtn" ÁöÑÊåâÈàïÂæåÈù¢Âä†ÂÖ•ÈÄôÊÆµ -->
<button class="personal-high-score-btn" id="leaderboardBtn" title="Ê≠åÊõ≤ÊéíË°åÊ¶ú">
    <svg class="personal-high-score-icon" viewBox="0 0 24 24">
        <path d="M16 11V3H8V11H2V21H22V11H16M14 5H10V9H14V5M20 13H18V15H20V13M20 17H18V19H20V17M12 13H4V19H12V13Z" />
    </svg>
</button>



                        
                    </div>
                    <div class="difficulty-selector">
                        
                        <select id="difficultySelect">
                            <option value="easy">Á∞°ÂñÆ</option>
                            <option value="normal" selected>ÊôÆÈÄö</option>
                            <option value="hard">Âõ∞Èõ£</option>
                            <option value="hell">Âú∞ÁçÑ</option>
                        </select>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
               <div class="game-area">
    <div class="tracks" id="tracksContainer"></div>
   
    
    <!-- Ëß∏ÊéßÊåâÈçµ (ÂÉÖÂú®Ëß∏ÊéßË£ùÁΩÆ‰∏äÈ°ØÁ§∫) -->
    <div class="touch-controls" id="touchControls">
        <div class="touch-key" data-key="65">A</div>
        <div class="touch-key" data-key="83">S</div>
        <div class="touch-key" data-key="68">D</div>
        <div class="touch-key" data-key="70">F</div>
    </div>
</div>
            </div>
        </div>
    </div>

<!-- Notification Modal -->
    <div class="notification-modal" id="notificationModal">
        <div class="notification-content">
            <button class="close-notification" id="closeNotification">&times;</button>
            <div class="notification-icon" id="notificationIcon"></div>
            <h2 class="notification-title" id="notificationTitle"></h2>
            <p class="notification-message" id="notificationMessage"></p>
        </div>
    </div>


    
    <div class="game-over-modal" id="gameOverModal">
        <div class="game-over-content">
            <h2 class="game-over-title">ÈÅäÊà≤ÁµêÊùü</h2>
            <div class="game-over-stats">
                <div class="game-over-stat">
                    <div class="stat-label">ÊúÄÁµÇÂàÜÊï∏</div>
                    <div class="stat-number" id="finalScore">0</div>
                </div>
                <div class="game-over-stat">
                    <div class="stat-label">ÊúÄÈ´òÈÄ£Êìä</div>
                    <div class="stat-number" id="finalCombo">0</div>
                </div>
            </div>
            <button class="restart-btn" id="restartBtn">ÂÜçÁé©‰∏ÄÊ¨°</button>
        </div>
    </div>
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <button class="close-settings" id="closeSettings">&times;</button>
            <h2 class="settings-title">ÈÅäÊà≤Ë®≠ÂÆö</h2>
           
            <div class="setting-group">
                <label class="setting-label" for="volumeControlModal">Èü≥Ê®ÇÈü≥Èáè:</label>
                <input type="range" class="setting-control setting-slider" id="volumeControlModal" min="0" max="1" step="0.01" value="0.7">
            </div>
            <div class="setting-group">
                <label class="setting-label" for="sfxVolumeControl">Èü≥ÊïàÈü≥Èáè:</label>
                <input type="range" class="setting-control setting-slider" id="sfxVolumeControl" min="0" max="1" step="0.01" value="0.5">
            </div>

<div class="setting-group">
    <button class="setting-control" id="showDisclaimerBtn">Êü•ÁúãÈü≥Ê®ÇÁâàÊ¨äËÅ≤Êòé</button>
</div>




        </div>
    </div>

    <!-- Personal High Score Modal -->
    <div class="personal-high-score-modal" id="personalHighScoreModal">
        <div class="personal-high-score-content">
            <button class="close-personal-high-score" id="closePersonalHighScore">&times;</button>
            <h2 class="personal-high-score-title">ÂÄã‰∫∫ÊúÄÈ´òÂàÜÊï∏</h2>
            <ul class="personal-high-score-list" id="personalHighScoreList">
                <!-- Scores will be populated here -->
            </ul>
        </div>
    </div>

    <!-- Music Player Modal -->
    <div class="music-player-modal" id="musicPlayerModal">
        <div class="music-player-content">
            <div class="music-player-header">
                <!-- Removed <h1 class="music-player-title">Èü≥Ê®ÇÊí≠ÊîæÂô®</h1> -->
                <button class="close-music-player" id="closeMusicPlayer" title="ËøîÂõû">
                    <svg class="close-music-player-icon" viewBox="0 0 24 24">
                        <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
                    </svg>
                </button>
            </div>


<!-- CD Cover Container -->
<div class="cd-cover-container">
    <div class="cd-cover-wrapper">
        <img id="cdCoverImage" src="https://i.ibb.co/G4Rmgzjt/image.png" alt="CD Cover" class="cd-cover-img">
        <div class="cd-cover-overlay"></div>
    </div>
</div>


            <div class="now-playing" id="nowPlaying">Ê≠£Âú®Êí≠Êîæ: ÁÑ°</div>
            <div class="lyrics-container" id="lyricsContainer">
                <div class="no-lyrics">ÁÑ°Ê≠åË©û</div>
            </div>
            <div class="player-controls">
                <button class="player-btn" id="prevBtn" title="‰∏ä‰∏ÄÈ¶ñ" disabled>&#9664;&#9664;</button>
                <button class="player-btn play-pause-btn" id="playPauseBtn" title="Êí≠Êîæ/Êö´ÂÅú">&#9658;</button>
                <button class="player-btn" id="nextBtn" title="‰∏ã‰∏ÄÈ¶ñ" disabled>&#9654;&#9654;</button>
            </div>
            <div class="progress-slider-container">
                <input type="range" class="progress-slider" id="progressSlider" min="0" max="100" value="0">
            </div>
            <div class="time-display">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
            </div>
            <div class="volume-control-player">
                <label for="volumeSliderPlayer">Èü≥Èáè:</label>
                <input type="range" class="setting-slider" id="volumeSliderPlayer" min="0" max="1" step="0.01" value="0.7">
            </div>
            <ul class="playlist" id="playlist">
                <!-- Playlist items will be populated here -->
            </ul>
        </div>
    </div>

    <!-- Unlock Modal -->
    <div class="unlock-modal" id="unlockModal">
        <div class="unlock-content">
            <div class="unlock-icon">&#128274;</div> <!-- Lock Emoji -->
            <h2 class="unlock-message">Ê≠§È†ÖÁõÆÂ∞öÊú™Ëß£Èéñ</h2>
            <p class="unlock-requirement" id="unlockRequirement">Âú®ÊôÆÈÄöÊ®°Âºè‰∏ãÈÅîÂà∞ 40000 ÂàÜ‰ª•Ëß£Èéñ„ÄÇ</p>
            <button class="close-unlock" id="closeUnlock">ÊàëÁü•ÈÅì‰∫Ü</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

// ==========================================================
// ====== „ÄêÊñ∞Â¢û„ÄëFirebase ÂàùÂßãÂåñËàáÊéíË°åÊ¶úÁõ∏ÈóúË®≠ÂÆö ======
// ==========================================================

// ‰Ω†ÁöÑ Firebase Ë®≠ÂÆöÁâ©‰ª∂
const firebaseConfig = {
  apiKey: "AIzaSyD0J56yq_QjjzAZuhAEqE3SVU0GePS2l-0",
  authDomain: "musicgame-7dad1.firebaseapp.com",
  projectId: "musicgame-7dad1",
  storageBucket: "musicgame-7dad1.firebasestorage.app",
  messagingSenderId: "720961310659",
  appId: "1:720961310659:web:4959c7269b0adbed5ab776"
};

// ÂàùÂßãÂåñ Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// È´íË©±ÈÅéÊøæÂàóË°® (ÂèØÊåÅÁ∫åÊì¥ÂÖÖ)
const profanityList = [
    // Á≤µË™û
    "Â±å", "Â±å‰Ω†", "‰ªÜË°ó", "ÂÜöÂÆ∂Ââ∑", "on9", "Êíö", "È≥©", "Êüí", "onL9",
    // ÊôÆÈÄöË©±
    "Êìç", "ËçâÊ≥•È©¨", "ÂÇªÈÄº", "ËÇè", "Â™ΩÁöÑ", "‰ªñÂ™ΩÁöÑ", "ÊàëÈù†", "Â∞ºÁéõ"
];

// Áé©ÂÆ∂ÁãÄÊÖãËÆäÊï∏
let playerName = localStorage.getItem('musicGamePlayerName') || '';

// ==========================================================
// ====== „ÄêÊñ∞Â¢ûÁµêÊùü„Äë ========================================
// ==========================================================

            
           // --- Constants and Configuration ---
// [‰øÆË®Ç] Ê≠åÊõ≤Ëß£ÈéñÊ¢ù‰ª∂ÔºöÈúÄË¶ÅÈÅîÂà∞ÊôÆÈÄöÈõ£Â∫¶ÊúÄÈ´òÂàÜÁöÑ 80%
const SONG_UNLOCK_PERCENTAGE = 0.75; 
// [‰øÆË®Ç] Èõ£Â∫¶Ëß£ÈéñÊ¢ù‰ª∂ÔºöÈúÄË¶ÅÈÅîÂà∞Áï∂ÂâçÈõ£Â∫¶ÊúÄÈ´òÂàÜÁöÑ 100%
const DIFFICULTY_UNLOCK_PERCENTAGE = 0.85;

const difficultySettings = {
    // Easy Èõ£Â∫¶ÔºöÈï∑Èü≥Á¨¶ËºÉÈï∑ÔºåÈü≥Á¨¶ÈñìË∑ùÂ§ßÔºåÈÅäÁé©È´îÈ©óËºïÈ¨Ü
    easy: { 
        speedMultiplier: 0.9, longNoteChance: 0.2, noteDensity: 2.0, maxSimultaneous: 3, cooldown: 400,
        longNoteMinMultiplier: 2.5, // Èï∑Èü≥Á¨¶ÊúÄÁü≠ÊòØ 2.5 ÂÄçÂü∫Á§éÈñìÈöî
        longNoteMaxMultiplier: 8,   // Èï∑Èü≥Á¨¶ÊúÄÈï∑ÊòØ 8 ÂÄçÂü∫Á§éÈñìÈöî
        visualGap: 70               // Áâ©ÁêÜÈñìÈöô 70 ÂÉèÁ¥†
    },
    // Normal Èõ£Â∫¶ÔºöÊ®ôÊ∫ñË®≠ÂÆö
    normal: { 
        speedMultiplier: 1.1, longNoteChance: 0.25, noteDensity: 3.5, maxSimultaneous: 8, cooldown: 150,
        longNoteMinMultiplier: 2,
        longNoteMaxMultiplier: 6,
        visualGap: 50
    },
    // „Äê‰øÆË®Ç„ÄëHard Èõ£Â∫¶ÔºöÈÄ≤‰∏ÄÊ≠•Á∏ÆÁü≠Èï∑Èü≥Á¨¶ÊúÄÂ§ßÈï∑Â∫¶
    hard: { 
        speedMultiplier: 1.6, longNoteChance: 0.30, noteDensity: 4.5, maxSimultaneous: 4, cooldown: 100,
        longNoteMinMultiplier: 2,
        longNoteMaxMultiplier: 3.5,   // Âæû 4 Á∏ÆÁü≠Ëá≥ 3.5
        visualGap: 25               
    },
    // „Äê‰øÆË®Ç„ÄëHell Èõ£Â∫¶ÔºöÂ§ßÂπÖÁ∏ÆÁü≠Èï∑Èü≥Á¨¶ÊúÄÂ§ßÈï∑Â∫¶Ôºå‰ΩøÂÖ∂Êõ¥ÂÉè‰∏ÄÂÄã„ÄåÁ®çÈï∑ÁöÑÁü≠Èü≥Á¨¶„Äç
    hell: { 
        speedMultiplier: 2.2, longNoteChance: 0.35, noteDensity: 5.0, maxSimultaneous: 4, cooldown: 50,
        longNoteMinMultiplier: 1.5, 
        longNoteMaxMultiplier: 2.5,   // Âæû 3 Â§ßÂπÖÁ∏ÆÁü≠Ëá≥ 2.5ÔºåÊé•ËøëÊÇ®ÊèêÂà∞ÁöÑ baseInterval * 2
        visualGap: 10               
    }
};
            // Max possible scores for each song and difficulty (for display purposes)
            const maxPossibleScores = {
                "Battle-Abysswalker.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle-Rosemoon.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle-deadly.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle-rapier.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Ariadne-Battle.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "battle-arms.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Wanderers-City.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Remotest-Liblary.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Nostalgia.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "sunbeams.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "village.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Take-a-Rest.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "winter-snow.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Forgotten-Place.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Rest-in-Peace.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Farewell.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "reminiscence.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "starry-night.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "last-wish.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "sorrow.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "hotarumichi.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Sky-Airship.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Voyage_SE.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "main-theme01.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "saikai637.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                }
            };

           // Ë´ãÁî®ÈÄôÊÆµÁ®ãÂºèÁ¢ºÂÆåÊï¥ÊõøÊèõËàäÁöÑ songLyrics Áâ©‰ª∂
const songData = {
    "Á≠âÂæÖ.mp3": {
        lyrics: [
            { "time": 9, "text": "Êúà‰∫ÆÈ´òÊéõÂú®Â§úÁ©∫‰πã‰∏ä" },
            { "time": 13, "text": "ÂÆõÂ¶Ç‰∏çÁú†ÁöÑÁúºÁùõ‰∏ÄÊ®£" },
            { "time": 17, "text": "ÈùúÈùúÊ≥®Ë¶ñËëóÂñßÂõÇÁöÑ‰∫∫Èñì" },
            { "time": 21, "text": "ÊúâÂ§öÂ∞ëÊÇ≤Ê≠°Èõ¢ÂêàÂú®‰∏äÊºî" },
            { "time": 27, "text": "ÂÆÉÂÆàÊúõËëóÂ§úÁöÑËíºËå´" },
            { "time": 29, "text": "‰πüÂÆàÊúõËëóÈªéÊòéÁöÑÊõôÂÖâ" },
            { "time": 33, "text": "Âú®Êº´Èï∑Ê≠≤ÊúàË£°Á≠âÂæÖËëó" },
            { "time": 36, "text": "Á≠âÂæÖËëóÊüêÂÄã‰∫∫ÁöÑÂá∫Áèæ" },
            { "time": 49, "text": "Â•πÂ∑≤Á∂ìË®ò‰∏çÊ∏Ö‰Ω†ÁöÑÊ®°Ê®£" },
            { "time": 54, "text": "Âçª‰æùÁÑ∂Âú®ÂéüÂú∞ÈªòÈªòÂÆàÊúõ" },
            { "time": 58, "text": "ÈÇ£ÊòØ‰∏ÄÁ®ÆÊÄéÊ®£ÁöÑÊ∑±ÊÉÖ" },
            { "time": 61, "text": "ÊâçËÉΩÂ¶ÇÊ≠§Âü∑ËëóÂèàÊº´Èï∑" },
            { "time": 67, "text": "‰πüË®±‰Ω†Êó©Â∑≤ÊääÂÆÉÈÅ∫Âøò" },
            { "time": 72, "text": "ËÄåÂ•πÂçªÈÇÑÂú®ÁÇ∫‰Ω†ÁÖß‰∫Æ" },
            { "time": 76, "text": "Âú®ÈÄôÂüéÂ∏ÇÁöÑÂñßÂõÇ‰πã‰∏≠" },
            { "time": 80, "text": "ÈÇÑÊúâÂ§öÂ∞ë‰∫∫Âú®Á≠âÂæÖËëó" }
        ],
        quiz: [
            { "line": "Êúà‰∫ÆÈ´òÊéõÂú®__‰πã‰∏ä", "answer": "Â§úÁ©∫" },
            { "line": "ÈùúÈùúÊ≥®Ë¶ñËëóÂñßÂõÇÁöÑ__", "answer": "‰∫∫Èñì" },
            { "line": "‰πüÂÆàÊúõËëóÈªéÊòéÁöÑ__", "answer": "ÊõôÂÖâ" },
            { "line": "Â•πÂ∑≤Á∂ìË®ò‰∏çÊ∏Ö‰Ω†ÁöÑ__", "answer": "Ê®°Ê®£" },
            { "line": "ÊâçËÉΩÂ¶ÇÊ≠§Âü∑ËëóÂèà__", "answer": "Êº´Èï∑" }
        ]
    },
    "ÁôΩÂΩ±.mp3": {
        lyrics: [
            { "time": 12, "text": "‰ªñËµ∞ÈÄ≤‰∫Ü‰∏ÄÂÄãËçíË™ïÁöÑÂ§¢Â¢É" },
            { "time": 18, "text": "Â§¢Ë£°ÊúâÂÄãÈáçË§áÂá∫ÁèæÁöÑÁôΩÂΩ±" },
            { "time": 24, "text": "ÁôΩÂΩ±ÂæÆÁ¨ëËëóÊ∫ñÂÇôÁôª‰∏ä" },
            { "time": 30, "text": "ÊúâÁç†ÁâôÁöÑÁÅ´ËªäÂªÇÈ†Ç" },
            { "time": 35, "text": "ÈªÉÊòè‰∏ÄÊ¨°Ê¨°ÁöÑÊääÁôΩÂΩ±ÊìÑËµ∞" },
            { "time": 41, "text": "‰ªñ‰∏ÄÊ¨°Ê¨°ÁöÑÁ´ôÂú®ÂéüÂú∞ÁõÆÈÄÅ" },
            { "time": 47, "text": "‰ªñÊ≤íÊúâËæ¶Ê≥ïÊåΩÁïô" },
            { "time": 51, "text": "‰ªñÊ≤íÊúâËæ¶Ê≥ï‰º∏Âá∫Êâã" },
            { "time": 71, "text": "Â§öÂπ¥Âæå‰ªñÈÇÑÊòØÊúÉÂ∏∏Â∏∏È©öÈÜí" },
            { "time": 77, "text": "ÊûïÈÇäÁ∏ΩÊòØÊøïÊΩ§ÁöÑ‰∏ÄÁâáÁãºËóâ" },
            { "time": 83, "text": "ÁôΩÂΩ±ÂÉèÈ§ÉÂ≠êÁöÆ‰∏ÄÊ®£ÂåÖË£πËëó‰ªñ" },
            { "time": 90, "text": "Ë∂äÊéôÊâéË∂äÈô∑ÈÄ≤Âéª" },
            { "time": 95, "text": "ÈªÉÊòè‰∏ÄÊ¨°Ê¨°ÁöÑÊääÁôΩÂΩ±ÊìÑËµ∞" },
            { "time": 101, "text": "‰ªñ‰∏ÄÊ¨°Ê¨°ÁöÑÁ´ôÂú®ÂéüÂú∞ÁõÆÈÄÅ" },
            { "time": 107, "text": "‰ªñÂè™ËÉΩÈªòÈªòÂú∞Áúã" },
            { "time": 112, "text": "‰ªñÂè™ËÉΩÈªòÈªòÂú∞Âêê" }
        ],
        quiz: [
            { "line": "‰ªñËµ∞ÈÄ≤‰∫Ü‰∏ÄÂÄãËçíË™ïÁöÑ__", "answer": "Â§¢Â¢É" },
            { "line": "Â§¢Ë£°ÊúâÂÄãÈáçË§áÂá∫ÁèæÁöÑ__", "answer": "ÁôΩÂΩ±" },
            { "line": "__‰∏ÄÊ¨°Ê¨°ÁöÑÊääÁôΩÂΩ±ÊìÑËµ∞", "answer": "ÈªÉÊòè" },
            { "line": "ÊûïÈÇäÁ∏ΩÊòØÊøïÊΩ§ÁöÑ‰∏ÄÁâá__", "answer": "ÁãºËóâ" },
            { "line": "‰ªñÊ≤íÊúâËæ¶Ê≥ï‰º∏Âá∫__", "answer": "Êâã" }
        ]
    },
    "‰∏ã‰∏ÄÊûùÁöÑÊÉÜÊÇµ.mp3": {
        lyrics: [
            { "time": 16, "text": "Âåó‰∫¨ÁöÑÈõ®ÊòØ" },
            { "time": 18, "text": "ÂõõÊúàÊú™ÂÅúÊ≠áÁöÑÂÇæË®¥" },
            { "time": 23, "text": "ËÉ°ÂêåÁöÑË∑ØÊòØÊàë" },
            { "time": 26, "text": "ÁÑ°Ê≥ïÂøòÂçªÁöÑÂ≠§Áç®" },
            { "time": 31, "text": "ÊãÜÈÅ∑ÁöÑÈÄöÁü•" },
            { "time": 34, "text": "ÊòØÊàëÈÇÑÊú™Êî∂ÊãæÁöÑÂåÖË¢±" },
            { "time": 39, "text": "È®éË°åÁöÑÂ§ñË≥£" },
            { "time": 42, "text": "ÊòØÊàëÂîØ‰∏ÄËÉΩÂÅöÁöÑÊïëË¥ñ" },
            { "time": 46, "text": "ÊúâÈÇ£È∫º‰∏ÄÂàªÊàë‰ª•ÁÇ∫Êàë" },
            { "time": 50, "text": "ÂøòË®ò‰∫ÜÂì≠" },
            { "time": 53, "text": "Áõ¥Âà∞ÂèàËÅûÂà∞‰∏≠ËèØÁâåÈ¶ôËè∏ÁöÑÊ∫´Â∫¶" },
            { "time": 59, "text": "ÊúâÈÇ£È∫º‰∏ÄÂàªÊàë‰ª•ÁÇ∫Êàë" },
            { "time": 62, "text": "ÁøíÊÖ£‰∫ÜÂì≠" },
            { "time": 65, "text": "Áõ¥Âà∞ÂèàÁúãÂà∞‰∏≠ËèØÁâåÈ¶ôËè∏ÁöÑÈñÉÁàç" },
            { "time": 82, "text": "‰Ω†Ë™™Ê≠≤ÊúàÊº´Èï∑" },
            { "time": 86, "text": "ÂÖ´Âπ¥È¢®Â°µÂÉïÂÉïÂçª‰πüËΩâÁúº‰∏ÄÊôÉ" },
            { "time": 89, "text": "ÊàëË™™ÂÖâÈô∞ÂåÜÂøô" },
            { "time": 91, "text": "ÊàëÂè™ÊòØÂøò‰∫ÜÊàëÊòØË™∞ÁöÑÂÖíÈÉé" },
            { "time": 97, "text": "‰Ω†Ë™™Êú™‰æÜÈï∑Ê≤≥" },
            { "time": 101, "text": "‰Ω†ÂèàÈªûËµ∑‰∫Ü‰∏ã‰∏ÄÊîØÁöÑÊÉÜÊÇµ" },
            { "time": 104, "text": "ÊàëË™™‰∫∫ÁîüÂåÜÂøô" },
            { "time": 106, "text": "ÂèØÊàëÂèàË∫≤‰∏çÈÅé" },
            { "time": 108, "text": "Ê≠≤ÊúàÁöÑËíºËå´" }
        ],
        quiz: [
            { "line": "__ÁöÑË∑ØÊòØÊàë", "answer": "ËÉ°Âêå" },
            { "line": "È®éË°åÁöÑ__ÊòØÊàëÂîØ‰∏ÄËÉΩÂÅöÁöÑÊïëË¥ñ", "answer": "Â§ñË≥£" },
            { "line": "Áõ¥Âà∞ÂèàËÅûÂà∞__È¶ôËè∏ÁöÑÊ∫´Â∫¶", "answer": "‰∏≠ËèØÁâå" },
            { "line": "ÊàëÂè™ÊòØÂøò‰∫ÜÊàëÊòØË™∞ÁöÑ__", "answer": "ÂÖíÈÉé" },
            { "line": "‰Ω†ÂèàÈªûËµ∑‰∫Ü‰∏ã‰∏ÄÊîØÁöÑ__", "answer": "ÊÉÜÊÇµ" }
        ]
    },
    "È§òÁáºËêΩÂÖ•ËôõÁÑ°.mp3": {
        lyrics: [
            { "time": 11, "text": "ÁÅ´ÁÑ∞Ë∑≥ËëóÈùàÂãïÁöÑËàûËπà" },
            { "time": 16, "text": "ÁÅ∞ÁáºÈ£ÑËêΩÊúÄÂæå‰∏ÄÈÅ≠" },
            { "time": 20, "text": "ÁáíÂåñÁöÑÁ¥ôÈå¢ÈñãÂßãÈ£õÂêëÈõ≤ÈúÑ" },
            { "time": 25, "text": "Âú∞ÁçÑÁöÑÂ§ßÈñÄÂç≥Â∞á‰æÜÂà∞" },
            { "time": 30, "text": "Â∞±ÂÉèÈÇ£È¢®‰∏≠È£ÑÈõ∂ÁöÑËçâ" },
            { "time": 34, "text": "Ê≤íÊúâÊ†πÂü∫Âè™ËÉΩÈö®È¢®Ëµ∑" },
            { "time": 39, "text": "ËêΩÈ£ÑÊêñ‰Ω†ÁúãÈÇ£Â§©Á©∫‰∏≠ÁÄ∞Êº´ÁöÑÁÖô" },
            { "time": 44, "text": "ÈÇ£ÊòØ‰Ω†ÊàëÁîüÂëΩÊúÄÁµÇÁöÑÊ®£Ë≤å" },
            { "time": 58, "text": "ÁÅ´ÁÑ∞Ë∑≥ËëóÈùàÂãïÁöÑËàûËπà" },
            { "time": 102, "text": "ÁÅ∞ÁáºÈ£ÑËêΩÊúÄÂæå‰∏ÄÊó©" },
            { "time": 107, "text": "ÁáíÂåñÁöÑÁ¥ôÈå¢ÈñãÂßãÈ£õÂêëÈõ≤ÈúÑ" },
            { "time": 111, "text": "‰∏ÄÂàá‰ºº‰πéÂ∞±Ë¶ÅÁµêÊùü‰∫Ü" },
            { "time": 116, "text": "Â∞±ÂÉèÈÇ£È¢®‰∏≠È£ÑÈõ∂ÁöÑËçâ" },
            { "time": 121, "text": "Ê≤íÊúâÊ†πÂü∫Âè™ËÉΩÈö®È¢®Ëµ∑" },
            { "time": 126, "text": "Ëã•È£ÑÊêñ‰Ω†ÁúãÈÇ£Â§©Á©∫‰∏≠ÁÄ∞Êº´ÁöÑÁÖô" },
            { "time": 131, "text": "ÈÇ£ÊòØ‰Ω†ÊàëÁîüÂëΩÊúÄÁµÇÁöÑÊ®£Ë≤å" }
        ],
        quiz: [
            { "line": "ÁÅ´ÁÑ∞Ë∑≥ËëóÈùàÂãïÁöÑ__", "answer": "ËàûËπà" },
            { "line": "__È£ÑËêΩÊúÄÂæå‰∏ÄÈÅ≠", "answer": "ÁÅ∞Ááº" },
            { "line": "ÁáíÂåñÁöÑ__ÈñãÂßãÈ£õÂêëÈõ≤ÈúÑ", "answer": "Á¥ôÈå¢" },
            { "line": "Â∞±ÂÉèÈÇ£È¢®‰∏≠È£ÑÈõ∂ÁöÑ__", "answer": "Ëçâ" },
            { "line": "ÈÇ£ÊòØ‰Ω†ÊàëÁîüÂëΩÊúÄÁµÇÁöÑ__", "answer": "Ê®£Ë≤å" }
        ]
    },
    "ËÄÅÂ±ãÂõûÊÜ∂.mp3": {
        lyrics: [
            { "time": 16, "text": "ËÄÅÂ±ãÁöÑÊú®ÈñÄÂ∏∏Âπ¥ËôõÊé©" }, { "time": 22, "text": "ÈñÄÂ§ñÁ®ÆÁùÄ‰∏ÄÊ£µÊ°ÇËä±Ê®π" }, { "time": 28, "text": "ÁßãÊ∑±ÊôÇÁØÄ Ëä±Áì£Èõ∂Êï£‰∏ÄÂú∞" }, { "time": 35, "text": "ÊàëËàáÁà∫Áà∫Áî®Á´πÁÆïÊî∂ÈõÜ" }, { "time": 42, "text": "ÂõûÊÜ∂ÁöÑÁ¢éÁâá" }, { "time": 44, "text": "ÈÇ£ÊôÇÁöÑÂø´Ê®Ç" }, { "time": 46, "text": "ÊòØË¢´ÊçïÊçâÂæåÂèàÊîæÁîüÁöÑÂ∞èÈ≠ö" }, { "time": 55, "text": "ÊòØÊ°ÇËä±Á≥ïÂá∫ÈçãÊôÇÁöÑËí∏Ê±Ω" }, { "time": 62, "text": "ÊòØ‰∏Ä‰∏≤‰∏≤ÈäÄÈà¥Ëà¨ÁöÑËü≤È≥¥È≥•ÂõÄ" }, { "time": 69, "text": "ÁÑ∂ËÄåÂæå‰æÜ" }, { "time": 71, "text": "Èà¥ËÅ≤‰∏≠Êñ∑‰∫ÜÊàëÊâÄÈÇÇÈÄÖÁöÑËä±È≥•Ëü≤È≠ö" }, { "time": 79, "text": "Â∑≤ÊòØÊ¥ªÁîüÁîüÁöÑÊ®ôÊú¨" }
        ],
        quiz: [
            { "line": "ËÄÅÂ±ãÁöÑÊú®ÈñÄÂ∏∏Âπ¥__", "answer": "ËôõÊé©" }, { "line": "ÈñÄÂ§ñÁ®ÆÁùÄ‰∏ÄÊ£µ__Ê®π", "answer": "Ê°ÇËä±" }, { "line": "ÊàëËàáÁà∫Áà∫Áî®__Êî∂ÈõÜ", "answer": "Á´πÁÆï" }, { "line": "ÊòØ__Âá∫ÈçãÊôÇÁöÑËí∏Ê±Ω", "answer": "Ê°ÇËä±Á≥ï" }, { "line": "Â∑≤ÊòØÊ¥ªÁîüÁîüÁöÑ__", "answer": "Ê®ôÊú¨" }
        ]
    }
};


// --- CD Cover Images ---
const songCovers = {

    "ÁôΩÂΩ±.mp3": "https://i.ibb.co/0pYsv0m1/image.png",
   
    // ÁÇ∫ÂÖ∂‰ªñÊ≠åÊõ≤Ê∑ªÂä†Â∞ÅÈù¢ÔºåÊ†ºÂºèÁÇ∫ "Ê≠åÊõ≤Êñá‰ª∂Âêç.mp3": "ÂúñÁâáURL"
    // Â¶ÇÊûúÊ≤íÊúâÁâπÂÆöÂ∞ÅÈù¢ÔºåÂèØ‰ª•‰ΩøÁî®‰∏ÄÂÄãÈÄöÁî®ÁöÑÈªòË™çÂ∞ÅÈù¢
    "default": "https://i.ibb.co/G4Rmgzjt/image.png" // ÈªòË™çÂ∞ÅÈù¢
};



            // --- DOM Elements ---

            const mainGameContainer = document.getElementById('mainGameContainer');
            const tracksContainer = document.getElementById('tracksContainer');
            const scoreDisplay = document.getElementById('score');
            const startBtn = document.getElementById('startBtn');
            const musicSelect = document.getElementById('musicSelect');
            const progressBar = document.getElementById('progressBar');
            const gameOverModal = document.getElementById('gameOverModal');
            const finalScoreDisplay = document.getElementById('finalScore');
            const finalComboDisplay = document.getElementById('finalCombo');
            const restartBtn = document.getElementById('restartBtn');
            const settingsModal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settingsBtn');
            const closeSettings = document.getElementById('closeSettings');
    
            const volumeControlModal = document.getElementById('volumeControlModal');
            const sfxVolumeControl = document.getElementById('sfxVolumeControl');
            const touchKeys = document.querySelectorAll('.touch-key');
            const difficultySelect = document.getElementById('difficultySelect');
            const audio = new Audio();
            audio.volume = 1.0;
            // --- „ÄêÊñ∞Â¢û„ÄëÊéíË°åÊ¶úÁõ∏ÈóúÁöÑ DOM ÂÖÉÁ¥† ---
const leaderboardBtn = document.getElementById('leaderboardBtn');
const leaderboardModal = document.getElementById('leaderboardModal');
const closeLeaderboard = document.getElementById('closeLeaderboard');
const playerNameGroup = document.getElementById('playerNameGroup');
const playerNameInput = document.getElementById('playerNameInput');
const savePlayerNameBtn = document.getElementById('savePlayerNameBtn');
const leaderboardTitle = document.getElementById('leaderboardTitle');
const leaderboardList = document.getElementById('leaderboardList');
const leaderboardLoading = document.getElementById('leaderboardLoading');

            // New DOM Elements
            const personalHighScoreBtn = document.getElementById('personalHighScoreBtn');
            const personalHighScoreModal = document.getElementById('personalHighScoreModal');
            const closePersonalHighScore = document.getElementById('closePersonalHighScore');
            const personalHighScoreList = document.getElementById('personalHighScoreList');
            const musicPlayerBtn = document.getElementById('musicPlayerBtn');
            const musicPlayerModal = document.getElementById('musicPlayerModal');
            const closeMusicPlayer = document.getElementById('closeMusicPlayer');
            const nowPlaying = document.getElementById('nowPlaying');
            const lyricsContainer = document.getElementById('lyricsContainer');
            const prevBtn = document.getElementById('prevBtn');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const nextBtn = document.getElementById('nextBtn');
            const progressSlider = document.getElementById('progressSlider');
            const currentTimeDisplay = document.getElementById('currentTime');
            const durationDisplay = document.getElementById('duration');
            const volumeSliderPlayer = document.getElementById('volumeSliderPlayer');
            const playlist = document.getElementById('playlist');
            const unlockModal = document.getElementById('unlockModal');
            const closeUnlock = document.getElementById('closeUnlock');
            const unlockRequirement = document.getElementById('unlockRequirement');
             // ‚ñº‚ñº‚ñº Êñ∞Â¢ûÈÄöÁü•Ë¶ñÁ™óÁöÑ DOM ÂÖÉÁ¥† ‚ñº‚ñº‚ñº
            const notificationModal = document.getElementById('notificationModal');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            const closeNotification = document.getElementById('closeNotification');

            // ‚ñº‚ñº‚ñº Êñ∞Â¢ûÁöÑ DOM ÂÖÉÁ¥† ‚ñº‚ñº‚ñº
            const unlockProgressContainer = document.getElementById('unlockProgressContainer');
            const unlockProgressBar = document.getElementById('unlockProgressBar');
           // ‚ñº‚ñº‚ñº „Äê‰øÆË®Ç„ÄëÊîπÁÇ∫ÈÅ∏ÂèñÂÖ©ÂÄãÊñ∞ÁöÑÊ®ôË®òÁ∑öÂÖÉÁ¥† ‚ñº‚ñº‚ñº
            const songUnlockMarker = document.getElementById('songUnlockMarker');
            const difficultyUnlockMarker = document.getElementById('difficultyUnlockMarker');
            // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆË®ÇÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤


// ‚ñº‚ñº‚ñº „Äê‰øÆË®Ç„ÄëÊ∏¨È©óÁõ∏ÈóúÁöÑÁãÄÊÖãËÆäÊï∏ ‚ñº‚ñº‚ñº
let isQuizActive = false;
let quizQuestions = []; // Â∞áÂÑ≤Â≠òÁï∂ÂâçÊ∏¨È©óÁöÑÊâÄÊúâÈ°åÁõÆ
let currentQuizQuestion = null; // ÂÑ≤Â≠òÁï∂ÂâçÁöÑÂïèÈ°åÁâ©‰ª∂
let questionsAnsweredCorrectly = 0; // ËøΩËπ§Â∑≤Á≠îÂ∞çÁöÑÈ°åÊï∏
let totalQuestionsInQuiz = 0; // Ê∏¨È©óÈñãÂßãÊôÇÁöÑÁ∏ΩÈ°åÊï∏
let quizUnlockTarget = null; // Áî®ÊñºÂÑ≤Â≠òÊ∏¨È©óÊàêÂäüÂæåË¶ÅËß£ÈéñÁöÑÁõÆÊ®ô

// --- „ÄêÊñ∞Â¢û„ÄëÁç≤ÂèñÊ∏¨È©óË¶ñÁ™óÁöÑ DOM ÂÖÉÁ¥† ---
const lyricsQuizModal = document.getElementById('lyricsQuizModal');
const quizProgress = document.getElementById('quizProgress');
const quizQuestionText = document.getElementById('quizQuestionText');
const quizAnswerInput = document.getElementById('quizAnswerInput');
const quizSubmitBtn = document.getElementById('quizSubmitBtn');
const quizCloseBtn = document.getElementById('quizCloseBtn');
            
            // --- Game State Variables ---
            let gameActive = false;
let maxScoreForCurrentLevel = 0; // ‚ñº‚ñº‚ñº Êñ∞Â¢ûÁãÄÊÖãËÆäÊï∏
            let unlockThresholdPercentage = 0; // ‚ñº‚ñº‚ñº Êñ∞Â¢ûÁãÄÊÖãËÆäÊï∏
            let score = 0; // Á∏ΩÂàÜÔºåÂåÖÂê´ÈÄ£ÊìäÁçéÂãµ
let pureHitScore = 0; // Êñ∞Â¢ûÔºöÁ¥îÊìäÊâìÂàÜÊï∏ÔºåÁî®ÊñºËß£ÈéñË®àÁÆó
            let combo = 0;
            let notificationQueue = [];      // ÊàëÂÄëÁöÑÈÄöÁü•„ÄåÂæÖËæ¶Ê∏ÖÂñÆ„Äç
let isNotificationActive = false; // ‰∏ÄÂÄãÊóóÊ®ôÔºåÁî®‰æÜÂà§Êñ∑ÊòØÂê¶Â∑≤ÊúâÈÄöÁü•Ê≠£Âú®È°ØÁ§∫
            let maxCombo = 0;
            let notes = [];
            let noteSpeed = 3000;
            let animationFrame;
            let gameStartTime = 0;
            let currentSongDuration = 0;
            let noteQueue = [];
            let generateNotesTimer = null;
            let progressInterval = null;
            const musicSelectorDiv = document.querySelector('.music-selector');
            const progressContainerDiv = document.querySelector('.progress-container');
            const tracks = 4;
            const keys = ['A', 'S', 'D', 'F'];
            const keyCodes = [65, 83, 68, 70];
            const keyStates = { 65: false, 83: false, 68: false, 70: false };
            let trackCooldownUntil = new Array(tracks).fill(0);
            let sfxVolume = 0.5;
            // ‚ñº‚ñº‚ñº „ÄêÊñ∞Â¢û„ÄëÁ≤íÂ≠êÊ±†Áõ∏ÈóúËÆäÊï∏ ‚ñº‚ñº‚ñº
const PARTICLE_POOL_SIZE = 100; // Ê±†ÁöÑÂ§ßÂ∞èÔºåÂèØ‰ª•Ê†πÊìöÈúÄË¶ÅË™øÊï¥
let hitParticlePool = [];
let noteParticlePool = [];
let currentHitParticleIndex = 0;
let currentNoteParticleIndex = 0;
// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤

            // Music Player State
            let playerAudio = new Audio();
            playerAudio.volume = 1.0;
            let playerIsPlaying = false;
            let playlistItems = [];
            let currentPlaylistIndex = 0;
            let lyrics = [];
            let lyricsInterval = null;
            let isUpdatingSlider = false; // Flag to prevent slider update conflicts

            // --- Audio Context for SFX ---
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let isAudioContextStarted = false;
            function startAudioContext() {
                if (!isAudioContextStarted) {
                    audioContext.resume().then(() => {
                        isAudioContextStarted = true;
                        console.log("AudioContext started");
                    }).catch(e => console.error("Failed to start AudioContext:", e));
                }
            }
            document.body.addEventListener('click', startAudioContext, { once: true });
            document.body.addEventListener('touchstart', startAudioContext, { once: true });


// ‚ñº‚ñº‚ñº „ÄêÊñ∞Â¢û„ÄëË®≠ÂÆöÁ≤íÂ≠êÊ±†ÁöÑÂáΩÊï∏ ‚ñº‚ñº‚ñº
function setupParticlePools() {
    // Ê∏ÖÁ©∫‰∏¶ÈáçÂª∫ hitParticlePool
    hitParticlePool.forEach(p => p.remove());
    hitParticlePool = [];
    for (let i = 0; i < PARTICLE_POOL_SIZE; i++) {
        const particle = document.createElement('div');
        particle.className = 'hit-particle'; // È†êË®≠ class
        // ÂÖàÂ∞áÁ≤íÂ≠êÈôÑÂä†Âà∞‰∏ÄÂÄã‰∏çÊúÉÂΩ±Èüø‰ΩàÂ±ÄÁöÑÂú∞Êñπ
        tracksContainer.appendChild(particle);
        hitParticlePool.push(particle);
    }
    currentHitParticleIndex = 0;

    // Ê∏ÖÁ©∫‰∏¶ÈáçÂª∫ noteParticlePool
    noteParticlePool.forEach(p => p.remove());
    noteParticlePool = [];
    for (let i = 0; i < PARTICLE_POOL_SIZE; i++) {
        const particle = document.createElement('div');
        particle.className = 'note-particle'; // È†êË®≠ class
        tracksContainer.appendChild(particle);
        noteParticlePool.push(particle);
    }
    currentNoteParticleIndex = 0;
}
// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤

            
            function createSound(frequency, type = 'sine', duration = 0.1, baseVolume = 0.2) {
                return function() {
                    if (!isAudioContextStarted) return;
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.type = type;
                    oscillator.frequency.value = frequency;
                    gainNode.gain.value = baseVolume * sfxVolume;
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                };
            }
           const sounds = {
                perfect: createSound(523.25, 'sine', 0.15, 1.2), // ÂéüÁÇ∫ 0.7ÔºåÂº∑ÂäõÊîæÂ§ß
                great: createSound(392.00, 'sine', 0.15, 1.2),  // ÂéüÁÇ∫ 0.6ÔºåÂº∑ÂäõÊîæÂ§ß
                good: createSound(329.63, 'sine', 0.15, 1.2),   // ÂéüÁÇ∫ 0.5ÔºåÊîæÂ§ßËá≥Ê®ôÊ∫ñÈü≥Èáè
                miss: createSound(220.00, 'square', 0.2, 1.2),  // ÂéüÁÇ∫ 0.4ÔºåÈ°ØËëóÊîæÂ§ß
                combo: createSound(659.25, 'triangle', 0.1, 1.2) // ÂéüÁÇ∫ 0.5ÔºåÊîæÂ§ßËá≥Ê®ôÊ∫ñÈü≥Èáè
            };

            // --- Local Storage Management ---
           const STORAGE_KEY = 'musicGameSaveData';
const PLAYER_STORAGE_KEY = 'musicPlayerSettings';

let saveData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    unlockedSongs: ["ÁôΩÂΩ±.mp3"],
    unlockedDifficulties: {}, 
    personalHighScores: {} 
};

// Êñ∞Â¢ûÊí≠ÊîæÂô®Ë®≠ÂÆöÁöÑÂÑ≤Â≠òÁµêÊßã
let playerSettings = JSON.parse(localStorage.getItem(PLAYER_STORAGE_KEY)) || {
    currentSong: null,
    currentTime: 0,
    volume: 0.7,
    isPlaying: false,
    playlistStates: {}, // Ë®òÈåÑÊØèÈ¶ñÊ≠åÁöÑÂïüÁî®/ÂÅúÁî®ÁãÄÊÖã
    currentPlaylistIndex: 0
};

            // Initialize unlocked difficulties for existing unlocked songs
            saveData.unlockedSongs.forEach(song => {
                if (!saveData.unlockedDifficulties[song]) {
                    saveData.unlockedDifficulties[song] = { normal: true, hard: false, hell: false };
                }
            });

           function saveGame() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
}

// Êñ∞Â¢ûÊí≠ÊîæÂô®Ë®≠ÂÆö‰øùÂ≠òÂáΩÊï∏
function savePlayerSettings() {
    // Êõ¥Êñ∞Áï∂ÂâçÊí≠ÊîæÁãÄÊÖã
    if (playlistItems.length > 0 && currentPlaylistIndex >= 0) {
        playerSettings.currentSong = playlistItems[currentPlaylistIndex]?.url || null;
        playerSettings.currentTime = playerAudio.currentTime || 0;
        playerSettings.volume = playerAudio.volume || 0.7;
        playerSettings.isPlaying = playerIsPlaying;
        playerSettings.currentPlaylistIndex = currentPlaylistIndex;
    }
    
    // ‰øùÂ≠òÊí≠ÊîæÊ∏ÖÂñÆÁãÄÊÖã
    const playlistElements = document.querySelectorAll('.playlist-item');
    playerSettings.playlistStates = {};
    playlistElements.forEach((item, index) => {
        if (playlistItems[index]) {
            playerSettings.playlistStates[playlistItems[index].url] = {
                enabled: item.dataset.enabled === 'true',
                index: index
            };
        }
    });
    
    localStorage.setItem(PLAYER_STORAGE_KEY, JSON.stringify(playerSettings));
}

// ËºâÂÖ•Êí≠ÊîæÂô®Ë®≠ÂÆö
function loadPlayerSettings() {
    // ÊÅ¢Âæ©Èü≥ÈáèË®≠ÂÆö
    if (playerSettings.volume !== undefined) {
        playerAudio.volume = playerSettings.volume;
        volumeSliderPlayer.value = playerSettings.volume;
    }
}

            // --- Unlock System ---
            function isSongUnlocked(songUrl) {
                return saveData.unlockedSongs.includes(songUrl);
            }

            function isDifficultyUnlocked(songUrl, difficulty) {
                if (difficulty === 'easy' || difficulty === 'normal') return true; // Easy/Normal always unlocked for unlocked songs
                return saveData.unlockedDifficulties[songUrl] && saveData.unlockedDifficulties[songUrl][difficulty];
            }

         function unlockNextSong(songJustPlayed) {
                const allSongs = Array.from(musicSelect.options).map(opt => opt.value);
                const lastUnlockedSong = saveData.unlockedSongs[saveData.unlockedSongs.length - 1];

                if (songJustPlayed === lastUnlockedSong) {
                    const currentIndex = allSongs.indexOf(lastUnlockedSong);
                    if (currentIndex >= 0 && currentIndex < allSongs.length - 1) {
                        const nextSong = allSongs[currentIndex + 1];
                        if (!isSongUnlocked(nextSong)) {
                            saveData.unlockedSongs.push(nextSong);
                            saveData.unlockedDifficulties[nextSong] = { normal: true, hard: false, hell: false };
                            saveGame();
                            updateSongOptions();

                            const songDisplayName = Array.from(musicSelect.options).find(opt => opt.value === nextSong)?.textContent || nextSong;
                            showNotification('success', 'Êñ∞Ê≠åÊõ≤Â∑≤Ëß£ÈéñÔºÅ', `ÊÅ≠ÂñúÊÇ®ÔºÅÊ≠åÊõ≤ <strong>${songDisplayName}</strong> ÁèæÂú®ÂèØ‰ª•Âú®Êí≠ÊîæÊ∏ÖÂñÆ‰∏≠ÈÅ∏Êìá‰∫Ü„ÄÇ`);
                            
                            return true; // „ÄêÊñ∞Â¢û„ÄëÊàêÂäüËß£ÈéñÔºåÂõûÂÇ≥ true
                        }
                    }
                }
                return false; // „ÄêÊñ∞Â¢û„ÄëÊ≤íÊúâÁôºÁîüËß£ÈéñÔºåÂõûÂÇ≥ false
            }

           function unlockDifficulty(songUrl, difficulty) {
                if (!saveData.unlockedDifficulties[songUrl]) {
                    saveData.unlockedDifficulties[songUrl] = { normal: true, hard: false, hell: false };
                }
                if (!saveData.unlockedDifficulties[songUrl][difficulty]) {
                    saveData.unlockedDifficulties[songUrl][difficulty] = true;
                    saveGame();
                    updateSongOptions();
                    
                    const songTitle = Array.from(musicSelect.options).find(opt => opt.value === songUrl)?.textContent || songUrl;
                    const difficultyText = difficultySelect.querySelector(`option[value="${difficulty}"]`).textContent.replace(' (Êú™Ëß£Èéñ)', '');
                    showNotification('success', 'Êñ∞Èõ£Â∫¶Â∑≤Ëß£ÈéñÔºÅ', `<strong>${songTitle}</strong> ÁöÑ <strong>${difficultyText}</strong> Èõ£Â∫¶ÁèæÂ∑≤ÈñãÊîæÊåëÊà∞ÔºÅ`);

                    return true; // „ÄêÊñ∞Â¢û„ÄëÊàêÂäüËß£ÈéñÔºåÂõûÂÇ≥ true
                }
                return false; // „ÄêÊñ∞Â¢û„ÄëÊ≤íÊúâÁôºÁîüËß£ÈéñÔºåÂõûÂÇ≥ false
            }

          // ‰øÆË®ÇÂæåÁöÑ checkAndUnlockDifficulties ÂáΩÊï∏
// „Äê‰øÆÊ≠£ÂæåÁöÑÁâàÊú¨„ÄëË´ãÁî®ÈÄôÊÆµÁ®ãÂºèÁ¢ºÂÆåÊï¥ÊõøÊèõËàäÁöÑ checkAndUnlockDifficulties ÂáΩÊï∏

function checkAndUnlockDifficulties(songUrl, difficulty, pureHitScore) {
    // Ê™¢Êü•ÊòØÂê¶ÂèØ‰ª•Âæû "ÊôÆÈÄö" Ëß£Èéñ "Âõ∞Èõ£"
    if (difficulty === 'normal' && !isDifficultyUnlocked(songUrl, 'hard')) {
        // ‰ΩøÁî®ËàáÈÄ≤Â∫¶Ê¢ùÂÆåÂÖ®Áõ∏ÂêåÁöÑ„ÄÅÊ∫ñÁ¢∫ÁöÑÁêÜË´ñÊúÄÈ´òÂàÜ‰æÜË®àÁÆóÈñÄÊ™ª
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        
        // ‰ΩøÁî®ËàáÈÄ≤Â∫¶Ê¢ùÂÆåÂÖ®Áõ∏ÂêåÁöÑÁ¥îÁ≤πÊâìÊìäÂàÜÊï∏‰æÜÈÄ≤Ë°åÊØîËºÉ
        if (pureHitScore >= requiredScore) {
            unlockDifficulty(songUrl, 'hard');
        }
    }

    // Ê™¢Êü•ÊòØÂê¶ÂèØ‰ª•Âæû "Âõ∞Èõ£" Ëß£Èéñ "Âú∞ÁçÑ"
    if (difficulty === 'hard' && !isDifficultyUnlocked(songUrl, 'hell')) {
        // ÂêåÊ®£Ôºå‰ΩøÁî®Ê∫ñÁ¢∫ÁöÑÁêÜË´ñÊúÄÈ´òÂàÜ‰æÜË®àÁÆóÈñÄÊ™ª
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        
        // ÂêåÊ®£Ôºå‰ΩøÁî®Á¥îÁ≤πÊâìÊìäÂàÜÊï∏‰æÜÈÄ≤Ë°åÊØîËºÉ
        if (pureHitScore >= requiredScore) {
            unlockDifficulty(songUrl, 'hell');
        }
    }
}

            function showUnlockModal(message) {
                unlockRequirement.textContent = message;
                unlockModal.classList.add('active');
            }

            // --- UI Updates ---



function processNotificationQueue() {
    // Â¶ÇÊûúÁï∂ÂâçÂ∑≤ÊúâÈÄöÁü•Ê≠£Âú®È°ØÁ§∫ÔºåÊàñËÄÖÈöäÂàóÊòØÁ©∫ÁöÑÔºåÂ∞±Áõ¥Êé•ËøîÂõû
    if (isNotificationActive || notificationQueue.length === 0) {
        return;
    }

    // Ê®ôË®òÁÇ∫„ÄåÊ≠£Âú®È°ØÁ§∫ÈÄöÁü•„Äç
    isNotificationActive = true;

    // ÂæûÈöäÂàóÁöÑÈ†≠ÈÉ®ÂèñÂá∫Á¨¨‰∏ÄÂÄãÈÄöÁü•
    const notification = notificationQueue.shift();

    // --- ‰ª•‰∏ãÊòØÂéü showNotification ÂáΩÊï∏ÁöÑÊ†∏ÂøÉÈ°ØÁ§∫ÈÇèËºØ ---
    const content = notificationModal.querySelector('.notification-content');
    notificationTitle.textContent = notification.title;
    notificationMessage.innerHTML = notification.message;

    content.classList.remove('success', 'info');
    if (notification.type === 'success') {
        content.classList.add('success');
        notificationIcon.innerHTML = '&#127881;'; // üéâ
    } else {
        content.classList.add('info');
        notificationIcon.innerHTML = '&#128220;'; // üìå
    }
    
    notificationModal.classList.add('active');

    // Ë®≠ÂÆöË®àÊôÇÂô®ÔºåÂú®ÈÄöÁü•ÁµêÊùüÂæåËß∏Áôº‰∏ã‰∏ÄÂÄã
    notificationTimer = setTimeout(() => {
        notificationModal.classList.remove('active');
        isNotificationActive = false; // Ê®ôË®òÁÇ∫„ÄåÈÄöÁü•Â∑≤ÁµêÊùü„Äç
        processNotificationQueue();   // ÂÜçÊ¨°ÂëºÂè´Á∂ìÁêÜÔºåÊ™¢Êü•ÈöäÂàó‰∏≠ÊòØÂê¶ÈÇÑÊúâ‰∏ã‰∏ÄÂÄã
    }, notification.duration || 5000);
}
// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÂáΩÊï∏ÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤


            
// „Äê‰øÆÊîπÂæåÁöÑÁâàÊú¨„ÄëË´ãÁî®ÈÄôÊÆµÁ®ãÂºèÁ¢ºÂÆåÊï¥ÊõøÊèõËàäÁöÑ showNotification ÂáΩÊï∏

let notificationTimer = null;

function showNotification(type, title, message, duration = 5000) {
    // Ê≠•È©ü 1: Â∞áÈÄöÁü•‰ªªÂãôÊâìÂåÖÔºåÊ∑ªÂä†Âà∞ÈöäÂàóÁöÑÊú´Â∞æ
    notificationQueue.push({
        type: type,
        title: title,
        message: message,
        duration: duration
    });

    // Ê≠•È©ü 2: ÂëºÂè´ÊàëÂÄëÁöÑ„ÄåÁ∂ìÁêÜ„Äç‰æÜËôïÁêÜÈöäÂàó
    processNotificationQueue();
}

            // ÁÇ∫ÈÄöÁü•Ë¶ñÁ™óÁöÑÈóúÈñâÊåâÈàïÊ∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
           // „Äê‰øÆÊîπÂæåÁöÑÊ®£Â≠ê„Äë
closeNotification.addEventListener('click', () => {
    if (notificationTimer) {
        clearTimeout(notificationTimer); // Ê∏ÖÈô§Áï∂ÂâçÁöÑË®àÊôÇÂô®
    }
    notificationModal.classList.remove('active');
    isNotificationActive = false;      // Á´ãÂàªÊ®ôË®òÁÇ∫„ÄåÈÄöÁü•Â∑≤ÁµêÊùü„Äç
    processNotificationQueue();        // Á´ãÂàªÂëºÂè´Á∂ìÁêÜÔºåÈ°ØÁ§∫‰∏ã‰∏ÄÂÄãÈÄöÁü•
});


            
            function updateSongOptions() {
                const selectedSong = musicSelect.value;
                const selectedDifficulty = difficultySelect.value;

                Array.from(musicSelect.options).forEach(option => {
                    const songUrl = option.value;
                    if (isSongUnlocked(songUrl)) {
                        option.disabled = false;
                        option.text = option.text.replace(' (Êú™Ëß£Èéñ)', ''); // Remove unlock tag if present
                    } else {
                        option.disabled = true;
                        if (!option.text.includes('(Êú™Ëß£Èéñ)')) {
                            option.text += ' (Êú™Ëß£Èéñ)';
                        }
                    }
                });

                // Update difficulty options based on selected song
                updateDifficultyOptions(selectedSong);

                // Restore selection if it's still valid
                if (isSongUnlocked(selectedSong)) {
                    musicSelect.value = selectedSong;
                } else {
                    // Select the first unlocked song if current is locked
                    const firstUnlocked = saveData.unlockedSongs[0];
                    if (firstUnlocked) musicSelect.value = firstUnlocked;
                }
                if (!isDifficultyUnlocked(musicSelect.value, selectedDifficulty)) {
                    difficultySelect.value = 'normal'; // Default to normal if selected is locked
                }
            }

            function updateDifficultyOptions(songUrl) {
                const difficulties = ['easy', 'normal', 'hard', 'hell'];
                difficulties.forEach(diff => {
                    const option = difficultySelect.querySelector(`option[value="${diff}"]`);
                    if (isDifficultyUnlocked(songUrl, diff)) {
                        option.disabled = false;
                        option.text = option.text.replace(' (Êú™Ëß£Èéñ)', '');
                    } else {
                        option.disabled = true;
                        if (!option.text.includes('(Êú™Ëß£Èéñ)')) {
                            option.text += ' (Êú™Ëß£Èéñ)';
                        }
                    }
                });
            }

            function updatePersonalHighScore(songUrl, difficulty, newScore) {
                 if (!saveData.personalHighScores[songUrl]) {
                    saveData.personalHighScores[songUrl] = {};
                 }
                 const currentHigh = saveData.personalHighScores[songUrl][difficulty] || 0;
                 if (newScore > currentHigh) {
                    saveData.personalHighScores[songUrl][difficulty] = newScore;
                    saveGame();
                 }
            }

            function populatePersonalHighScoreList(songUrl) {
                personalHighScoreList.innerHTML = '';
                const difficulties = ['easy', 'normal', 'hard', 'hell'];
                difficulties.forEach(diff => {
                    const li = document.createElement('li');
                    li.className = 'personal-high-score-item';

                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'personal-high-score-label';
                    labelSpan.textContent = `${diff.toUpperCase()}:`;

                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'personal-high-score-value';
                    const score = saveData.personalHighScores[songUrl] ? saveData.personalHighScores[songUrl][diff] : 0;
                    valueSpan.textContent = score ? score.toLocaleString() : '0';

                    li.appendChild(labelSpan);
                    li.appendChild(valueSpan);
                    personalHighScoreList.appendChild(li);
                });
            }

            function initGame() {
    tracksContainer.innerHTML = '';
    for (let i = 0; i < tracks; i++) {
        const track = document.createElement('div');
        track.className = 'track';
        track.dataset.track = i;
        const hitLine = document.createElement('div');
        hitLine.className = 'hit-line';
        track.appendChild(hitLine);
        const keyHint = document.createElement('div');
        keyHint.className = 'key-hint';
        keyHint.textContent = keys[i];
        track.appendChild(keyHint);
        tracksContainer.appendChild(track);
    }
                  setupParticlePools();
    score = 0;
    combo = 0;
    maxCombo = 0;
    // Êñ∞Â¢ûÔºöÈáçË®≠ pureHitScore ‰ª•Á¢∫‰øùÊØèÊ¨°ÈÅäÊà≤ÈñãÂßãÊôÇÂæû0ÈñãÂßãÔºàÈÅøÂÖçÁ¥ØÁ©çBUGÔºâ
    pureHitScore = 0;
    notes = [];
    noteQueue = [];
    progressBar.style.width = '0%';
    updateUI();
    tracksContainer.className = 'tracks';
    const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    if (isMobile) {
        document.getElementById('touchControls').style.display = 'flex';
        document.querySelectorAll('.key-hint').forEach(hint => hint.style.display = 'none');
    }
}

            function updateUI() {
                scoreDisplay.textContent = score;
            }

           function updateProgress() {
    if (gameActive && currentSongDuration > 0) {
        const elapsed = (Date.now() - gameStartTime) / 1000;
        const progress = Math.min(100, (elapsed / currentSongDuration) * 100);
        progressBar.style.width = `${progress}%`;

        // Êñ∞Â¢ûÔºöÂëºÂè´ÈÅäÊà≤Ê≠åË©ûÊõ¥Êñ∞ÈÇèËºØ
        updateGameLyrics(elapsed);
    }
}

            // ==============================================================
// ====== „ÄêÊñ∞Â¢û„ÄëÊéíË°åÊ¶úÊ†∏ÂøÉÂäüËÉΩÂáΩÊï∏ ==========================
// ==============================================================

/**
 * Â∞áÊ≠åÊõ≤Êñá‰ª∂ÂêçËΩâÊèõÁÇ∫ÂèØÁî®Êñº Firebase key ÁöÑÂÆâÂÖ®Â≠ó‰∏≤
 * @param {string} filename - ‰æãÂ¶Ç "ÁôΩÂΩ±.mp3"
 * @returns {string} - ‰æãÂ¶Ç "ÁôΩÂΩ±_mp3"
 */
function sanitizeFirebaseKey(filename) {
    return filename.replace(/\./g, '_').replace(/[#$\[\]]/g, '');
}

/**
 * Ê™¢Êü•ÂêçÁ®±ÊòØÂê¶ÂåÖÂê´È´íË©±
 * @param {string} name - Ë¶ÅÊ™¢Êü•ÁöÑÂêçÁ®±
 * @returns {boolean} - Â¶ÇÊûúÂåÖÂê´È´íË©±ÂâáÂõûÂÇ≥ true
 */
function isProfane(name) {
    const lowerCaseName = name.toLowerCase();
    return profanityList.some(word => lowerCaseName.includes(word));
}

/**
 * ËôïÁêÜÁé©ÂÆ∂ÂêçÁ®±ÁöÑË®≠ÂÆöËàáÂÑ≤Â≠òÔºà‰øÆË®ÇÂæåÁâàÊú¨Ôºâ
 * - Â¢ûÂä† Firebase ÂÖ®ÂüüÂêçÁ®±ÂîØ‰∏ÄÊÄßÊ™¢Êü•
 */
async function handlePlayerName() {
    playerNameInput.value = playerName;
    if (!playerName) {
        showNotification('info', 'Ë®≠ÂÆöÂêçÁ®±', 'ÁÇ∫‰∫ÜÁôª‰∏äÊéíË°åÊ¶úÔºåË´ãÂÖàË®≠ÂÆö‰Ω†ÁöÑÂ∞àÂ±¨ÂêçÁ®±ÔºÅ');
    }

    savePlayerNameBtn.onclick = async () => {
        const newName = playerNameInput.value.trim();
        const oldName = playerName; // ‰øùÂ≠òÁõÆÂâçÁöÑÔºàËàäÔºâÂêçÁ®±

        // --- Âü∫Êú¨ÂÆ¢Êà∂Á´ØÈ©óË≠â ---
        if (newName.length === 0) {
            showNotification('info', 'ÂêçÁ®±ÁÑ°Êïà', 'ÂêçÁ®±‰∏çËÉΩÁÇ∫Á©∫ÔºÅ');
            return;
        }
        if (isProfane(newName)) {
            showNotification('info', 'ÂêçÁ®±‰∏çÈõÖ', 'Ë´ãÂãø‰ΩøÁî®‰∏çÈõÖË©ûÂΩô‰ΩúÁÇ∫ÂêçÁ®±„ÄÇ');
            return;
        }
        // Â¶ÇÊûúÂêçÁ®±Ê≤íÊúâÊîπËÆäÔºåÂâá‰∏çÈúÄË¶ÅÂü∑Ë°å‰ªª‰ΩïÊìç‰Ωú
        if (newName === oldName) {
            showNotification('info', 'ÊèêÁ§∫', 'ÂêçÁ®±Êú™ËÆäÊõ¥„ÄÇ');
            return;
        }

        // --- Firebase ÂÖ®ÂüüÂêçÁ®±ÂîØ‰∏ÄÊÄßÊ™¢Êü• ---

        // ÁÇ∫‰∫ÜËÆìÊ™¢Êü•‰∏çÂàÜÂ§ßÂ∞èÂØ´ (ÈÅøÂÖç Player Âíå player Ë¢´Ë¶ñÁÇ∫‰∏çÂêå)ÔºåÊàëÂÄëÁµ±‰∏ÄÁî®Â∞èÂØ´‰æÜÊ™¢Êü•ÂíåÂÑ≤Â≠ò
        const checkNameKey = newName.toLowerCase();
        const playerNamesRef = database.ref(`playerNames/${checkNameKey}`);
        
        savePlayerNameBtn.disabled = true; // Èò≤Ê≠¢ÈáçË§áÈªûÊìä
        savePlayerNameBtn.textContent = 'Ê™¢Êü•‰∏≠...';

        try {
            const snapshot = await playerNamesRef.once('value');

            if (snapshot.exists()) {
                // Â¶ÇÊûúË≥áÊñôÂ∫´‰∏≠Â≠òÂú®ÈÄôÂÄãÂêçÁ®±Ôºå‰ª£Ë°®Â∑≤Ë¢´‰ΩîÁî®
                showNotification('info', 'ÂêçÁ®±Â∑≤Ë¢´‰ΩøÁî®', `ÂêçÁ®±„Äå<strong>${newName}</strong>„ÄçÂ∑≤Ë¢´ÂÖ∂‰ªñÁé©ÂÆ∂Ë®ªÂÜäÔºåË´ãÊèõ‰∏ÄÂÄãÂêßÔºÅ`);
            } else {
                // --- ÂêçÁ®±ÂèØÁî®ÔºåÂü∑Ë°åÂÑ≤Â≠òÊìç‰Ωú ---

                // Âª∫Á´ã‰∏ÄÂÄãÁâ©‰ª∂‰æÜ‰∏ÄÊ¨°ÊÄßÊõ¥Êñ∞Â§öÂÄãË≥áÊñôË∑ØÂæë
                const updates = {};
                
                // 1. Âú® playerNames Ë®ªÂÜäÊñ∞ÂêçÁ®±
                updates[`/playerNames/${checkNameKey}`] = true;
                
                // 2. Â¶ÇÊûúÊòØ„ÄåÊõ¥Êîπ„ÄçÂêçÁ®±ÔºåÈúÄË¶ÅÂæû playerNames ‰∏≠Âà™Èô§ËàäÂêçÁ®±
                if (oldName) {
                    const oldNameKey = oldName.toLowerCase();
                    updates[`/playerNames/${oldNameKey}`] = null; // Âú® Firebase ‰∏≠ÔºåÂ∞áÂÄºË®≠ÁÇ∫ null Á≠âÊñºÂà™Èô§Ë©≤ÁØÄÈªû
                }

                // 3. Âü∑Ë°åÂéüÂ≠êÊÄßÊõ¥Êñ∞
                await database.ref().update(updates);

                // 4. Êõ¥Êñ∞Êú¨Âú∞ËÆäÊï∏Âíå Local Storage
                playerName = newName;
                localStorage.setItem('musicGamePlayerName', playerName);
                
                showNotification('success', 'ÂÑ≤Â≠òÊàêÂäü', `‰Ω†ÁöÑÊñ∞ÂêçÁ®±„Äå<strong>${playerName}</strong>„ÄçÂ∑≤ÊàêÂäüË®≠ÂÆöÔºÅ`);
            }
        } catch (error) {
            console.error("Ê™¢Êü•ÂêçÁ®±ÊôÇÁôºÁîüÈåØË™§:", error);
            showNotification('info', 'ÁôºÁîüÈåØË™§', 'Ëàá‰º∫ÊúçÂô®ÈÄ£Á∑öÊôÇÁôºÁîüÂïèÈ°åÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
        } finally {
            // ÁÑ°Ë´ñÊàêÂäüÊàñÂ§±ÊïóÔºåÈÉΩÊÅ¢Âæ©ÊåâÈàïÁöÑÁãÄÊÖã
            savePlayerNameBtn.disabled = false;
            savePlayerNameBtn.textContent = 'ÂÑ≤Â≠òÂêçÁ®±';
        }
    };

    // ÁßªÈô§ËàäÁöÑ EventListenerÔºåÈÅøÂÖçÈáçË§áÁ∂ÅÂÆö (Â¶ÇÊûú‰πãÂâçÊòØÁî® addEventListener ÁöÑË©±)
    // Áî±ÊñºÊàëÂÄëÊîπÁî® onclickÔºåÈÄôË°åÂèØ‰ª•ÁúÅÁï•Ôºå‰ΩÜ‰øùÁïôÊòØ‰∏ÄÁ®ÆÂ•ΩÁøíÊÖ£
    // savePlayerNameBtn.removeEventListener('click', ...);
}
/**
 * È°ØÁ§∫ÊåáÂÆöÊ≠åÊõ≤ËàáÈõ£Â∫¶ÁöÑÊéíË°åÊ¶ú
 * @param {string} songUrl - Ê≠åÊõ≤ÁöÑ URL
 * @param {string} difficulty - Èõ£Â∫¶
 */
function displayLeaderboard(songUrl, difficulty) {
    const songDisplayName = Array.from(musicSelect.options).find(opt => opt.value === songUrl)?.textContent || 'Êú™Áü•Ê≠åÊõ≤';
    const difficultyDisplayName = difficultySelect.querySelector(`option[value="${difficulty}"]`).textContent;
    
    leaderboardTitle.textContent = `${songDisplayName} - ${difficultyDisplayName}`;
    leaderboardList.innerHTML = '';
    leaderboardLoading.style.display = 'block';

    const songId = sanitizeFirebaseKey(songUrl);
    const leaderboardRef = database.ref(`leaderboards/${songId}/${difficulty}`);

    leaderboardRef.once('value', (snapshot) => {
        leaderboardLoading.style.display = 'none';
        const data = snapshot.val();

        if (data && data.length > 0) {
            data.forEach((entry, index) => {
                const li = document.createElement('li');
                li.className = 'leaderboard-item';
                li.innerHTML = `
                    <span class="leaderboard-rank">#${index + 1}</span>
                    <span class="leaderboard-name">${entry.name}</span>
                    <span class="leaderboard-score">${entry.score.toLocaleString()}</span>
                `;
                leaderboardList.appendChild(li);
            });
        } else {
            leaderboardList.innerHTML = '<li><p style="text-align: center; color: #aaa;">ÈÄôÂÄãÊéíË°åÊ¶úÈÇÑÊ≤íÊúâ‰∫∫ÊåëÊà∞ÈÅéÔºåÂø´‰æÜÊàêÁÇ∫Á¨¨‰∏ÄÂêçÔºÅ</p></li>';
        }
    });
}

/**
 * Êèê‰∫§ÂàÜÊï∏Âà∞ Firebase ÊéíË°åÊ¶úÔºà‰øÆË®ÇÂæåÁâàÊú¨Ôºâ
 * - ÊîØÊè¥Ââç‰∏âÂêç‰∏äÊ¶ú
 * - ÈòªÊ≠¢Âú®Âêå‰∏ÄÊ¶úÂñÆ‰∏ä‰ΩøÁî®ÈáçË§áÁöÑÁé©ÂÆ∂ÂêçÁ®±
 * @param {string} songUrl 
 * @param {string} difficulty 
 * @param {number} finalScore 
 */
async function submitScoreToLeaderboard(songUrl, difficulty, finalScore) {
    // Ê≠•È©ü 1: Á¢∫Ë™çÁé©ÂÆ∂Â∑≤Ë®≠ÂÆöÂêçÁ®±ÔºåÂê¶Ââá‰∏çÂü∑Ë°å‰ªª‰ΩïÊìç‰Ωú
    if (!playerName) {
        console.log("Áé©ÂÆ∂Êú™Ë®≠ÂÆöÂêçÁ®±Ôºå‰∏çÊèê‰∫§ÂàÜÊï∏Ëá≥ÊéíË°åÊ¶ú„ÄÇ");
        // ‰Ω†‰πüÂèØ‰ª•Âú®ÈÄôË£°Âä†‰∏ä‰∏ÄÂÄã showNotification() ‰æÜÊèêÈÜíÁé©ÂÆ∂ÂéªË®≠ÂÆöÂêçÁ®±
        return;
    }

    const songId = sanitizeFirebaseKey(songUrl);
    const leaderboardRef = database.ref(`leaderboards/${songId}/${difficulty}`);

    // Ê≠•È©ü 2: ‰ΩøÁî® Firebase ÁöÑ TransactionÔºà‰∫§ÊòìÔºâÂäüËÉΩ
    // ÈÄôÊòØ‰∏ÄÂÄãÂÆâÂÖ®ÁöÑÊìç‰ΩúÔºåËÉΩÈò≤Ê≠¢Â§ö‰ΩçÁé©ÂÆ∂ÂêåÊôÇÊèê‰∫§ÂàÜÊï∏ÊôÇÈÄ†ÊàêË≥áÊñôÈåØ‰∫Ç„ÄÇ
    // ÊàëÂÄëÂ∞á„ÄåËÆÄÂèñ„ÄÅ‰øÆÊîπ„ÄÅÂØ´Âõû„ÄçÈÄô‰∏âÂÄãÂãï‰ΩúÁ∂ÅÂú®‰∏ÄËµ∑ÔºåÁ¢∫‰øùÂÖ∂ÂéüÂ≠êÊÄß„ÄÇ
    try {
        const { committed, snapshot } = await leaderboardRef.transaction((currentData) => {
            // Â¶ÇÊûúË≥áÊñôÂ∫´‰∏≠ÈÇÑÊ≤íÊúâÈÄôÂÄãÊéíË°åÊ¶úÔºåÂ∞±ÂàùÂßãÂåñÁÇ∫‰∏ÄÂÄãÁ©∫Èô£Âàó
            if (currentData === null) {
                currentData = [];
            }

            // ==========================================================
            // ====== ÂÖ∂‰∫åÔºöÈÅøÂÖçÁé©ÂÆ∂Ë®≠ÂÆöÁõ∏ÂêåÁöÑÂêçÁ®± (Ê†∏ÂøÉÈÇèËºØ) ======
            // ==========================================================
            
            // Ê™¢Êü•ÈÄôÂÄãÂêçÂ≠óÊòØÂê¶Â∑≤Á∂ìË¢´Ê¶ú‰∏ä„ÄåÂÖ∂‰ªñ‰∫∫„Äç‰ΩøÁî®
            const isNameTakenByOther = currentData.some(entry => entry.name === playerName);

            // Â∞ãÊâæ„ÄåËá™Â∑±„ÄçÊòØÂê¶Â∑≤Á∂ìÂú®Ê¶ú‰∏ä
            let selfIndex = -1;
            for (let i = 0; i < currentData.length; i++) {
                if (currentData[i].name === playerName) {
                    selfIndex = i;
                    break;
                }
            }

            // „ÄêË¶èÂâá„ÄëÂ¶ÇÊûúÂêçÂ≠óË¢´‰ΩîÁî®ÔºåËÄå‰∏î‰ΩîÁî®ËÄÖ‰∏çÊòØËá™Â∑± -> Êèê‰∫§Â§±Êïó
            if (isNameTakenByOther && selfIndex === -1) {
                // ËøîÂõû undefined ÊúÉÂÆâÂÖ®Âú∞‰∏≠Ê≠¢ÈÄôÊ¨°ÁöÑ transactionÔºå‰∏çÊúÉÂØ´ÂÖ•‰ªª‰ΩïË≥áÊñô
                console.warn(`Êèê‰∫§Â§±ÊïóÔºöÂêçÁ®± "${playerName}" Â∑≤Ë¢´Ê≠§ÊéíË°åÊ¶ú‰∏äÁöÑÂÖ∂‰ªñÁé©ÂÆ∂‰ΩøÁî®„ÄÇ`);
                return; 
            }

            // ========================================================
            // ====== ÂÖ∂‰∏ÄÔºöÊéíË°åÊ¶úÊì¥ÂÖÖËá≥Ââç‰∏âÂêç (Ê†∏ÂøÉÈÇèËºØ) ======
            // ========================================================
            
            // ÊâæÂá∫Ê¶úÂñÆ‰∏äÁöÑÊúÄ‰ΩéÂàÜ (Â¶ÇÊûúÊ¶úÂñÆÊú™Êªø‰∏â‰∫∫ÔºåÂâáÊúÄ‰ΩéÂàÜÁÇ∫ 0)
            const lowestScoreOnBoard = currentData.length < 3 ? 0 : currentData[currentData.length - 1].score;

            if (selfIndex !== -1) {
                // --- ÊÉÖÊ≥Å A: ÊàëÂ∑≤Á∂ìÂú®Ê¶ú‰∏ä ---
                // Âè™ÊúâÂú®Êñ∞ÂàÜÊï∏Êõ¥È´òÊôÇÔºåÊâçÊõ¥Êñ∞ÊàëÁöÑÂàÜÊï∏
                if (finalScore > currentData[selfIndex].score) {
                    currentData[selfIndex].score = finalScore;
                } else {
                    // ÂàÜÊï∏Ê≤íÊúâÊõ¥È´òÔºå‰∏çÈúÄË¶ÅÊõ¥Êñ∞Ôºå‰∏≠Ê≠¢ transaction
                    return;
                }
            } else {
                // --- ÊÉÖÊ≥Å B: ÊàëÈÇÑÊ≤í‰∏äÊ¶ú ---
                // Â¶ÇÊûúÂàÜÊï∏‰∏çÂ§†È´ò (‰∏îÊ¶úÂñÆÂ∑≤Êªø 3 ‰∫∫)ÔºåÂ∞±ÁÑ°Ê≥ï‰∏äÊ¶ú
                if (finalScore <= lowestScoreOnBoard && currentData.length >= 3) {
                    return; // ‰∏≠Ê≠¢ transaction
                }
                // ÂàÜÊï∏Â§†È´òÔºåÂ∞áÊàëÁöÑÊñ∞Á¥ÄÈåÑÂä†ÂÖ•Èô£Âàó‰∏≠
                currentData.push({ name: playerName, score: finalScore });
            }

            // „ÄêÈóúÈçµÊ≠•È©ü„ÄëÂ∞çÊâÄÊúâÁ¥ÄÈåÑ‰æùÂàÜÊï∏Áî±È´òÂà∞‰ΩéÈáçÊñ∞ÊéíÂ∫è
            currentData.sort((a, b) => b.score - a.score);
            
            // „ÄêÈóúÈçµÊ≠•È©ü„ÄëÂè™‰øùÁïôÊéíÂ∫èÂæåÁöÑÂâç‰∏âÂêçÁ¥ÄÈåÑ
            const newData = currentData.slice(0, 3);
            
            // ËøîÂõûÊúÄÁµÇË¶ÅÂØ´ÂÖ•Ë≥áÊñôÂ∫´ÁöÑÊñ∞ÊéíË°åÊ¶úË≥áÊñô
            return newData;
        });

        // Ê≠•È©ü 3: Ê†πÊìö transaction ÁöÑÂü∑Ë°åÁµêÊûúÔºåÁµ¶‰∫àÁé©ÂÆ∂ÊòéÁ¢∫ÁöÑÂõûÈ•ã
        if (committed) {
            // Transaction ÊàêÂäüÊèê‰∫§Ôºå‰ª£Ë°®Ë≥áÊñôÂ∑≤Êõ¥Êñ∞
            const finalBoard = snapshot.val() || [];
            // ÂÜçÊ¨°Á¢∫Ë™çËá™Â∑±ÊòØÂê¶ÁúüÁöÑÂú®ÊúÄÁµÇÁöÑÊ¶úÂñÆ‰∏ä
            const onFinalBoard = finalBoard.some(entry => entry.name === playerName && entry.score === finalScore);
            
            if (onFinalBoard) {
                // Âè™ÊúâÊàêÂäü‰∏äÊ¶úÔºåÊâçÈ°ØÁ§∫ÊàêÂäüÈÄöÁü•
                const difficultyText = difficultySelect.querySelector(`option[value="${difficulty}"]`).textContent;
                showNotification('success', 'Áôª‰∏äÊéíË°åÊ¶úÔºÅ', `ÊÅ≠ÂñúÔºÅ‰Ω†Âú®„Äå<strong>${difficultyText}</strong>„ÄçÈõ£Â∫¶ÁöÑÂàÜÊï∏Â∑≤ÊàêÂäüÁôª‰∏äÊéíË°åÊ¶úÔºÅ`);
            } else {
                // ÈõñÁÑ∂Êèê‰∫§ÊàêÂäüÔºå‰ΩÜÂõ†ÁÇ∫ÂàÜÊï∏‰∏çÂ§†È´òËÄåË¢´Êì†Âá∫Ê¶úÂ§ñ
                showNotification('info', 'ÂÜçÊé•ÂÜçÂé≤', '‰Ω†ÁöÑÂàÜÊï∏Â∑≤ÊàêÂäüÊèê‰∫§Ôºå‰ΩÜÊú™ÈÅîÂà∞ÁõÆÂâçÊéíË°åÊ¶úÂâç‰∏âÂêçÁöÑÊ®ôÊ∫ñ„ÄÇ');
            }
        } else {
            // Transaction Ë¢´‰∏≠Ê≠¢ÔºåÈÄöÂ∏∏ÊòØÂõ†ÁÇ∫ÊàëÂÄëÂú®ÂâçÈù¢ÊâãÂãï‰∏≠Ê≠¢‰∫ÜÂÆÉÔºà‰æãÂ¶ÇÂêçÁ®±ÈáçË§áÔºâ
             showNotification('info', 'Êèê‰∫§Â§±Êïó', '‰Ω†ÁöÑÂêçÁ®±ÂèØËÉΩÂ∑≤Ë¢´Ê≠§ÊéíË°åÊ¶ú‰∏äÁöÑÂÖ∂‰ªñÁé©ÂÆ∂‰ΩøÁî®ÔºåË´ãÊõ¥ÊèõÂêçÁ®±ÂæåÂÜçË©¶‰∏ÄÊ¨°„ÄÇ');
        }

    } catch (error) {
        // Â¶ÇÊûúÁôºÁîüÁ∂≤Ë∑ØÈåØË™§Á≠âÂïèÈ°å
        console.error("Êèê‰∫§ÂàÜÊï∏ÊôÇÁôºÁîüÈåØË™§: ", error);
        showNotification('info', 'Êèê‰∫§ÈåØË™§', 'Ëàá‰º∫ÊúçÂô®ÈÄ£Á∑öÊôÇÁôºÁîüÂïèÈ°åÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
    }
}
// ==============================================================
// ====== „ÄêÊñ∞Â¢ûÂáΩÊï∏ÁµêÊùü„Äë ======================================
// ==============================================================

            // --- Game Logic ---
            function generateNote(noteData) {
    if (!gameActive) return;
    const trackIndex = noteData.track;
    const track = document.querySelector(`.track[data-track="${trackIndex}"]`);
    if (!track) return;
    const note = document.createElement('div');
    note.className = noteData.type === 'long' ? 'long-note' : 'note';
    note.dataset.track = trackIndex;
    note.style.animationDuration = `${noteSpeed}ms`;
    if (noteData.type === 'long') {
        const noteHeight = (noteData.duration / (noteSpeed / 1000)) * (tracksContainer.clientHeight + 50);
        note.style.height = `${Math.max(30, noteHeight)}px`;
    }
    track.appendChild(note);
    const noteObj = {
        element: note,
        track: trackIndex,
        type: noteData.type,
        duration: noteData.duration || 0,
        active: true,
        hitStarted: false,
        // ‚ñº‚ñº‚ñº „ÄêÂÑ™Âåñ„ÄëË®òÈåÑÈü≥Á¨¶Ë¢´ÂâµÈÄ†ÊôÇÁöÑÁ≤æÁ¢∫ÊôÇÈñìÊà≥ ‚ñº‚ñº‚ñº
        creationTime: Date.now(),
        // ‚ñ≤‚ñ≤‚ñ≤ ÂÑ™ÂåñÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤
    };
    notes.push(noteObj);
}

          // ‚ñº‚ñº‚ñº „Äê‰øÆË®ÇÂæå„Äë‰ΩøÁî®Áâ©‰ª∂Ê±†ÁöÑ createHitParticles ÂáΩÊï∏ ‚ñº‚ñº‚ñº
function createHitParticles(trackIndex, judgment) {
    const track = document.querySelector(`.track[data-track="${trackIndex}"]`);
    if (!track) return;

    const particleCount = (judgment === 'perfect') ? 15 : (judgment === 'great' ? 10 : 7); // Á®çÂæÆÊ∏õÂ∞ëÁ≤íÂ≠êÊï∏Èáè‰ª•ÊèêÂçáÊïàËÉΩ
    const maxOffset = (judgment === 'perfect') ? 100 : (judgment === 'great' ? 80 : 60);

    const colors = {
        perfect: '#ffcc00', great: '#00ccff', good: '#00ff99'
    };

    for (let i = 0; i < particleCount; i++) {
        // ÂæûÊ±†‰∏≠Áç≤Âèñ‰∏ÄÂÄãÁ≤íÂ≠ê
        currentHitParticleIndex = (currentHitParticleIndex + 1) % PARTICLE_POOL_SIZE;
        const particle = hitParticlePool[currentHitParticleIndex];

        // ÈáçË®≠Ê®£Âºè‰∏¶ÂïüÂãïÂãïÁï´
        particle.style.background = colors[judgment] || '#fff';
        const size = Math.floor(8 + Math.random() * 8);
        particle.style.setProperty('--size', `${size}px`);
        const x = (Math.random() - 0.5) * maxOffset * 2;
        const y = (Math.random() * -maxOffset) - 20;
        particle.style.setProperty('--x', `${x}px`);
        particle.style.setProperty('--y', `${y}px`);
        const rot = Math.random() * 360;
        const rotEnd = rot + (Math.random() * 720 - 360);
        particle.style.setProperty('--rot', `${rot}deg`);
        particle.style.setProperty('--rot-end', `${rotEnd}deg`);
        particle.style.left = `calc(${track.offsetLeft}px + 50% - ${size / 2}px)`;
        
        // ÁßªÈô§ËàäÁöÑÂãïÁï´È°ûÂà•ÔºåÂº∑Âà∂ÈáçÂïüÂãïÁï´
        particle.classList.remove('animate');
        void particle.offsetWidth; // Âº∑Âà∂ÁÄèË¶ΩÂô®ÈáçÁπ™
        particle.classList.add('animate');
        
        // ‰ΩøÁî® animationend ‰∫ã‰ª∂‰æÜÂõûÊî∂Á≤íÂ≠êÔºåÊØî setTimeout Êõ¥Á≤æÊ∫ñ
        particle.onanimationend = () => {
            particle.classList.remove('animate');
            particle.onanimationend = null; // Ê∏ÖÈô§‰∫ã‰ª∂Áõ£ËÅΩÂô®
        };
    }
}

// ‚ñº‚ñº‚ñº „Äê‰øÆË®ÇÂæå„Äë‰ΩøÁî®Áâ©‰ª∂Ê±†ÁöÑ explodeNote ÂáΩÊï∏ ‚ñº‚ñº‚ñº
function explodeNote(noteElement, judgment) {
    if (!noteElement) return;

    const rect = noteElement.getBoundingClientRect();
    const trackRect = tracksContainer.getBoundingClientRect();
    const particleCount = (judgment === 'perfect') ? 15 : (judgment === 'great' ? 10 : 7); // Ê∏õÂ∞ëÁ≤íÂ≠êÊï∏Èáè
    const maxOffset = 80;

    const colors = {
        perfect: '#ffcc00', great: '#00ccff', good: '#00ff99'
    };

    for (let i = 0; i < particleCount; i++) {
        // ÂæûÊ±†‰∏≠Áç≤Âèñ‰∏ÄÂÄãÁ≤íÂ≠ê
        currentNoteParticleIndex = (currentNoteParticleIndex + 1) % PARTICLE_POOL_SIZE;
        const particle = noteParticlePool[currentNoteParticleIndex];

        particle.style.background = colors[judgment] || '#fff';
        const size = Math.floor(4 + Math.random() * 9);
        particle.style.setProperty('--size', `${size}px`);
        const x = (Math.random() - 0.5) * maxOffset * 2;
        const y = (Math.random() - 0.5) * maxOffset * 2;
        particle.style.setProperty('--x', `${x}px`);
        particle.style.setProperty('--y', `${y}px`);
        const rot = Math.random() * 360;
        const rotEnd = rot + (Math.random() * 720 - 360);
        particle.style.setProperty('--rot', `${rot}deg`);
        particle.style.setProperty('--rot-end', `${rotEnd}deg`);
        particle.style.left = `${rect.left - trackRect.left + rect.width / 2 - size / 2}px`;
        particle.style.top = `${rect.top - trackRect.top + rect.height / 2 - size / 2}px`;

        particle.classList.remove('animate');
        void particle.offsetWidth;
        particle.classList.add('animate');

        particle.onanimationend = () => {
            particle.classList.remove('animate');
            particle.onanimationend = null;
        };
    }
}



            

     function judgeHit(trackIndex, type) {
                const track = document.querySelector(`.track[data-track="${trackIndex}"]`);
                if (sounds[type]) {
                    sounds[type]();
                }

                // ÂâµÂª∫‰∏¶È°ØÁ§∫Âà§ÂÆöÊñáÂ≠ó (Perfect, Great, etc.)
                const judgment = document.createElement('div');
                judgment.className = `judgment ${type}`;
                judgment.textContent = `${type.toUpperCase()}!`;
                if (track) {
                    track.appendChild(judgment);
                    judgment.style.left = '0';
                    judgment.style.width = '100%';
                    judgment.style.textAlign = 'center';
                }
                setTimeout(() => {
                    if (judgment && judgment.parentNode) {
                        judgment.remove();
                    }
                }, 1000);

                // ËôïÁêÜÈùû 'miss' ÁöÑÊàêÂäüÊâìÊìä
                if (type !== 'miss') {
                    // Ëß∏ÁôºÁ≤íÂ≠êÊïàÊûú
                    createHitParticles(trackIndex, type);

                    // Ëß∏ÁôºÊâìÊìäÁ∑öÁöÑËÑàË°ùÂãïÁï´
                    const hitLine = track.querySelector('.hit-line');
                    if (hitLine) {
                        hitLine.classList.remove('pulse-effect');
                        void hitLine.offsetWidth; // Âº∑Âà∂ÁÄèË¶ΩÂô®ÈáçÁπ™
                        hitLine.classList.add('pulse-effect');
                    }

                    // Ê†πÊìöÂà§ÂÆöÁ≠âÁ¥öËß∏Áôº‰∏çÂêåÁöÑËªåÈÅìÈñÉÂÖâÊïàÊûú
                    if (track) {
                        track.classList.remove('flash-perfect', 'flash-great', 'flash-good');
                        void track.offsetWidth;
                        if (type === 'perfect') {
                            track.classList.add('flash-perfect');
                        } else if (type === 'great') {
                            track.classList.add('flash-great');
                        } else if (type === 'good') {
                            track.classList.add('flash-good');
                        }
                    }

                    // Ëß∏ÁôºË£ùÁΩÆÈúáÂãïÂõûÈ•ã
                    if (navigator.vibrate) {
                        let vibrationPattern;
                        if (type === 'perfect') {
                            vibrationPattern = [55]; // Áü≠‰øÉÊúâÂäõÁöÑÈúáÂãï
                        } else if (type === 'great') {
                            vibrationPattern = [55]; // ‰∏≠Á≠âÈúáÂãï
                        } else if (type === 'good') {
                            vibrationPattern = [50]; // ËºïÂæÆÈúáÂãï
                        }
                        if (vibrationPattern) {
                            navigator.vibrate(vibrationPattern);
                        }
                    }

                   // „ÄêÈóúÈçµ‰øÆÂæ© 1„ÄëÂú®ÈÄôË£°Ê†πÊìöÂà§ÂÆöÈ°ûÂûãÔºåÂÆöÁæ© baseScore ÁöÑÂÄº
let baseScore = 0;
if (type === 'perfect') baseScore = 100;
else if (type === 'great') baseScore = 70;
else if (type === 'good') baseScore = 40;
                    
                    // „ÄêÈóúÈçµ‰øÆÂæ© 2„ÄëÂ∞á addScore ÁßªÂà∞ÈÄôË£°ÔºåÁ¢∫‰øùÁÑ°Ë´ñË£ùÁΩÆÊòØÂê¶ÊîØÊè¥ÈúáÂãïÔºåÈÉΩÊúÉË®àÂàÜ
                    addScore(baseScore);

                } else {
                    // ËôïÁêÜ 'miss' ÁöÑÊÉÖÊ≥Å
                    combo = 0;
                    const difficulty = getCurrentDifficulty();
                    trackCooldownUntil[trackIndex] = Date.now() + difficulty.cooldown;
                }

                updateUI();
            }

          function addScore(baseScore) {
                combo++;
                if (combo > maxCombo) maxCombo = combo;
                
                // Ê†∏ÂøÉ‰øÆË®ÇÔºöÂàÜÈñãË®àÁÆóÁ∏ΩÂàÜËàáÁî®ÊñºËß£ÈéñÁöÑÁ¥îÁ≤πÂàÜÊï∏
                pureHitScore += baseScore; // Á¥îÊìäÊâìÂàÜÊï∏ÔºåÁî®ÊñºËß£ÈéñÊ¢ù‰ª∂Âà§Êñ∑
                score += baseScore + Math.floor(baseScore * (Math.floor(combo / 10) * 0.1)); // ÂåÖÂê´ÈÄ£ÊìäÁçéÂãµÁöÑÁ∏ΩÂàÜÔºåÁî®ÊñºÈ°ØÁ§∫

                if (combo > 5) {
                    const comboEl = document.createElement('div');
                    comboEl.className = 'combo-display';
                    comboEl.textContent = `${combo} COMBO!`;
                    if (combo >= 1000) comboEl.classList.add('combo-rainbow');
                    else if (combo >= 500) comboEl.classList.add('combo-purple');
                    else if (combo >= 200) comboEl.classList.add('combo-pink');
                    else if (combo >= 100) comboEl.classList.add('combo-orange');
                    else if (combo >= 50) comboEl.classList.add('combo-blue');
                    else comboEl.classList.add('combo-base');
                    tracksContainer.appendChild(comboEl);
                    if (sounds.combo) sounds.combo();
                    setTimeout(() => comboEl.remove(), 500);
                }
                let trackComboClass = '';
                if (combo >= 1000) trackComboClass = 'combo-rainbow';
                else if (combo >= 500) trackComboClass = 'combo-purple';
                else if (combo >= 200) trackComboClass = 'combo-pink';
                else if (combo >= 100) trackComboClass = 'combo-orange';
                else if (combo >= 50) trackComboClass = 'combo-blue';
                tracksContainer.className = 'tracks';
                if (trackComboClass) tracksContainer.classList.add(trackComboClass);
                
                updateUnlockMeter(); // Âú®ÂàÜÊï∏Êõ¥Êñ∞ÂæåÔºåÂêåÊ≠•Êõ¥Êñ∞Ëß£ÈéñÈÄ≤Â∫¶Ê¢ù
            }

 // ‚ñº‚ñº‚ñº Êñ∞Â¢ûÁöÑÂáΩÊï∏ ‚ñº‚ñº‚ñº
           // ‚ñº‚ñº‚ñº ‰øÆÊ≠£ÂæåÁöÑÂáΩÊï∏ ‚ñº‚ñº‚ñº
function updateUnlockMeter() {
                if (maxScoreForCurrentLevel <= 0) return; // ÈÅøÂÖçÈô§‰ª•Èõ∂ÁöÑÈåØË™§
                
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÈÄ≤Â∫¶Ê¢ùÁöÑÁôæÂàÜÊØîÊáâÂü∫Êñº‰∏çÂê´ COMBO ÁöÑÁ¥îÁ≤πÂàÜÊï∏ÔºàpureHitScoreÔºâ‰æÜË®àÁÆó
                const currentPercent = Math.min(100, (pureHitScore / maxScoreForCurrentLevel) * 100);
                
                unlockProgressBar.style.width = `${currentPercent}%`;

                // Ê™¢Êü•ÊòØÂê¶Ë∂ÖÈÅé‰∫Ü‰ªª‰∏ÄÊ¢ùËß£ÈéñÁ∑öÔºåÂ¶ÇÊûúË∂ÖÈÅéÂâáÊ∑ªÂä†ÁôºÂÖâÊïàÊûú
                const hasReachedSongUnlock = currentPercent >= SONG_UNLOCK_PERCENTAGE * 100;
                const hasReachedDifficultyUnlock = currentPercent >= DIFFICULTY_UNLOCK_PERCENTAGE * 100;
                
                if (hasReachedSongUnlock || hasReachedDifficultyUnlock) {
                    unlockProgressBar.classList.add('glowing');
                } else {
                    unlockProgressBar.classList.remove('glowing');
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤

            async function getAudioDuration(src) {
                return new Promise((resolve) => {
                    const tempAudio = new Audio(src);
                    tempAudio.addEventListener('loadedmetadata', () => resolve(tempAudio.duration));
                    tempAudio.addEventListener('error', () => resolve(120));
                });
            }

            async function analyzeAudioForBeats(url) {
                try {
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    const channelData = audioBuffer.getChannelData(0);
                    const sampleRate = audioBuffer.sampleRate;
                    const beats = [];
                    const bufferSize = 1024;
                    const historySize = 43;
                    const C = 1.3;
                    const energyHistory = []; // <-- [‰øÆË®Ç] Êñ∞Â¢ûÈÄô‰∏ÄË°å


                    
                    const getEnergy = (buffer) => {
                        let sum = 0;
                        for (let i = 0; i < buffer.length; i++) {
                            sum += buffer[i] * buffer[i];
                        }
                        return Math.sqrt(sum / buffer.length);
                    };
                    for (let i = 0; i < channelData.length; i += bufferSize) {
                        const buffer = channelData.slice(i, i + bufferSize);
                        const currentEnergy = getEnergy(buffer);
                        let averageEnergy = energyHistory.length > 0 ?
                            energyHistory.reduce((a, b) => a + b, 0) / energyHistory.length : 0;
                        if (currentEnergy > averageEnergy * C) {
                            const beatTime = i / sampleRate;
                            if (beats.length === 0 || beatTime > beats[beats.length - 1] + 0.2) {
                                beats.push(beatTime);
                            }
                        }
                        energyHistory.push(currentEnergy);
                        if (energyHistory.length > historySize) {
                            energyHistory.shift();
                        }
                    }
                    console.log(`ÂÅµÊ∏¨Âà∞ ${beats.length} ÂÄãÁØÄÊãç„ÄÇ`);
                    return beats;
                } catch (error) {
                    console.error("Èü≥Ë®äÂàÜÊûêÂ§±ÊïóÔºàÂèØËÉΩÊòØ CORS Ë∑®ÂüüÂïèÈ°åÔºâ:", error);
                    return [];
                }
            }

            function getCurrentDifficulty() {
                return difficultySettings[difficultySelect.value] || difficultySettings.normal;
            }

          async function startGame() {
    const selectedSong = musicSelect.value;
    const selectedDifficulty = difficultySelect.value;

    if (!isSongUnlocked(selectedSong)) {
        showUnlockModal(`Âú®ÊôÆÈÄöÊ®°Âºè‰∏ãÈÅîÂà∞ ${SONG_UNLOCK_SCORE} ÂàÜ‰ª•Ëß£Èéñ‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤„ÄÇ`);
        return;
    }
    if (!isDifficultyUnlocked(selectedSong, selectedDifficulty)) {
        let reqScore = 0;
        let reqDiff = '';
        if (selectedDifficulty === 'hard') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_NORMAL_TO_HARD;
            reqDiff = 'ÊôÆÈÄö';
        } else if (selectedDifficulty === 'hell') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_HARD_TO_HELL;
            reqDiff = 'Âõ∞Èõ£';
        }
        showUnlockModal(`Âú® ${reqDiff} Ê®°Âºè‰∏ãÈÅîÂà∞ ${reqScore} ÂàÜ‰ª•Ëß£ÈéñÊ≠§Èõ£Â∫¶„ÄÇ`);
        return;
    }

    if (gameActive) return;
    gameActive = true;
    startBtn.disabled = true;
    musicSelect.disabled = true;
    difficultySelect.disabled = true;

    // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆË®Ç„ÄëÁÑ°Ê¢ù‰ª∂Ë®≠ÂÆöÂÖ©Ê¢ùÂêàÊ†ºÁ∑öÁöÑ‰ΩçÁΩÆ ‚ñº‚ñº‚ñº
    mainGameContainer.classList.add('game-running'); 
    
    // Ê†πÊìöÈ†êË®≠ÁöÑÁôæÂàÜÊØîÂ∏∏Êï∏ÔºåË®≠ÂÆöÂÖ©Ê¢ùÁ∑öÁöÑ left Â±¨ÊÄß
    songUnlockMarker.style.left = `${SONG_UNLOCK_PERCENTAGE * 100}%`;
    difficultyUnlockMarker.style.left = `${DIFFICULTY_UNLOCK_PERCENTAGE * 100}%`;
    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆË®ÇÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤
    
    // Êñ∞Â¢ûÔºöÂàùÂßãÂåñÈÄ≤Â∫¶Ê¢ùÈ´òÂ∫¶ÂíåÂØ¨Â∫¶ÔºåÁ¢∫‰øùÈ°ØÁ§∫Ê≠£Â∏∏Ôºà‰øÆÂæ©ÁÑ°Ê≥ïÈ°ØÁ§∫ÁöÑBUGÔºâ
    unlockProgressBar.style.height = '100%';
    unlockProgressBar.style.width = '0%';
    unlockProgressBar.classList.remove('glowing');

    startBtn.innerHTML = `<svg class="start-button-svg" viewBox="0 0 40 40" style="width:40px;height:40px;">
        <circle cx="20" cy="20" r="18" stroke="#ff8a00" stroke-width="3" fill="none" stroke-dasharray="89" stroke-dashoffset="20">
            <animateTransform attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="1s" repeatCount="indefinite" />
        </circle>
    </svg>`;
    
    const difficulty = getCurrentDifficulty();
    const beatTimestamps = await analyzeAudioForBeats(selectedSong);
    startBtn.innerHTML = originalStartButtonSVG;
 
    progressContainerDiv.style.display = 'block';
    trackCooldownUntil.fill(0); 
    audio.src = selectedSong;
    audio.volume = volumeControlModal.value;
    currentSongDuration = await getAudioDuration(selectedSong);
    noteSpeed = Math.floor(4000 / difficulty.speedMultiplier);
    // ‚ñº‚ñº‚ñº [‰øÆË®Ç] ÁîüÊàêÂü∫ÊñºÊ≠åÊõ≤ÂíåÈõ£Â∫¶ÁöÑÂõ∫ÂÆöÁ®ÆÂ≠ê ‚ñº‚ñº‚ñº
const songAndDifficultyString = selectedSong + selectedDifficulty;
let seed = 0;
for (let i = 0; i < songAndDifficultyString.length; i++) {
    const char = songAndDifficultyString.charCodeAt(i);
    seed = ((seed << 5) - seed) + char;
    seed |= 0; // Convert to 32bit integer
}
// Á¢∫‰øùÁ®ÆÂ≠êÁÇ∫Ê≠£Êï∏
seed = Math.abs(seed) || 1; // ÈÅøÂÖçÁ®ÆÂ≠êÁÇ∫ 0
console.log(`Generating notes for ${selectedSong} (${selectedDifficulty}) with seed: ${seed}`);
// ‚ñ≤‚ñ≤‚ñ≤ [‰øÆË®ÇÁµêÊùü] ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº [‰øÆË®Ç] ÂÇ≥ÂÖ•Á®ÆÂ≠ê ‚ñº‚ñº‚ñº
noteQueue = generateSongData(currentSongDuration, difficulty, beatTimestamps, seed, noteSpeed); // ÂÇ≥ÂÖ• noteSpeed
// ‚ñ≤‚ñ≤‚ñ≤ [‰øÆË®ÇÁµêÊùü] ‚ñ≤‚ñ≤‚ñ≤

    // ‚ñº‚ñº‚ñº „Äê‰øÆË®ÇÂæåÁöÑÊ†∏ÂøÉÈÇèËºØ„Äë ‚ñº‚ñº‚ñº
    // Âú®ÁîüÊàêÈü≥Á¨¶ÂæåÔºåÂãïÊÖãË®àÁÆó‰∏çÂê´ÈÄ£ÊìäÁçéÂãµÁöÑÁêÜË´ñÊúÄÈ´òÂàÜ
  const maxBaseScorePerNote = 100; // ‰øÆÊ≠£ÁÇ∫ "Perfect" ÁöÑÂØ¶ÈöõÂü∫Á§éÂàÜÊï∏ 55
maxScoreForCurrentLevel = noteQueue.length * maxBaseScorePerNote;

    // Â¶ÇÊûúË®àÁÆóÁµêÊûúÁÇ∫ 0 (‰æãÂ¶ÇÊ≠åÊõ≤Ê≤íÊúâÈü≥Á¨¶)ÔºåÂâáÊèê‰æõ‰∏ÄÂÄãÈ†êË®≠ÂÄº‰ª•ÈÅøÂÖçÈåØË™§
    if (maxScoreForCurrentLevel === 0) {
        maxScoreForCurrentLevel = 300000; // Ë®≠ÁΩÆ‰∏ÄÂÄãÂæåÂÇôÂÄº
    }
    // ‚ñ≤‚ñ≤‚ñ≤ „Äê‰øÆË®ÇÁµêÊùü„Äë ‚ñ≤‚ñ≤‚ñ≤

    await audio.play().catch(e => console.log("Èü≥Ë®äÊí≠ÊîæÂ§±Êïó:", e));
    gameStartTime = Date.now();
    generateNotesContinuously();
    gameLoop();
    progressInterval = setInterval(updateProgress, 100);
    setTimeout(() => { if (gameActive) endGame(); }, currentSongDuration * 1000 + 2000);

    // Êñ∞Â¢ûÔºöËºâÂÖ•‰∏¶ÂàùÂßãÂåñÈÅäÊà≤Ê≠åË©ûÈ°ØÁ§∫
    const lyricsLeft = document.querySelector('.lyrics-left');
    const lyricsRight = document.querySelector('.lyrics-right');
    if (lyricsLeft && lyricsRight) {
        lyricsLeft.classList.remove('hidden');
        lyricsRight.classList.remove('hidden');
    }
}


// Êñ∞Â¢ûËºîÂä©ÂáΩÊï∏ÔºöÂàÜÊûêÁØÄÊãçÈñìÈöîÔºå‰º∞ÁÆóÂü∫Êú¨ÊôÇÈñìÂñÆ‰ΩçÔºàÂ¶ÇÂçÅÂÖ≠ÂàÜÈü≥Á¨¶Èï∑Â∫¶Ôºâ
function analyzeBeatIntervals(beatTimestamps) {
    if (!beatTimestamps || beatTimestamps.length < 2) {
        console.warn("ÁØÄÊãçÊï∏Êìö‰∏çË∂≥ÔºåÁÑ°Ê≥ïÂàÜÊûê„ÄÇ");
        return { baseInterval: 0.5 }; // ËøîÂõû‰∏ÄÂÄãÈªòË™çÂÄº
    }

    const intervals = [];
    for (let i = 1; i < beatTimestamps.length; i++) {
        // Ë®àÁÆóÁõ∏ÈÑ∞ÁØÄÊãç‰πãÈñìÁöÑÊôÇÈñìÂ∑Æ
        const interval = beatTimestamps[i] - beatTimestamps[i - 1];
        // ÈÅéÊøæÊéâÈÅéÊñºÁü≠ÊàñÈÅéÊñºÈï∑ÁöÑÁï∞Â∏∏ÂÄºÔºàÂèØÈÅ∏ÔºåÊ†πÊìöÂØ¶ÈöõÊï∏ÊìöË™øÊï¥Ôºâ
        if (interval > 0.05 && interval < 5.0) {
             intervals.push(interval);
        }
    }

    if (intervals.length === 0) {
        console.warn("ÁÑ°ÊúâÊïàÁØÄÊãçÈñìÈöîÊï∏Êìö„ÄÇ");
        return { baseInterval: 0.5 };
    }

    // Á∞°ÂñÆÊñπÊ≥ïÔºöÂÅáË®≠ÊúÄÂ∞èÈñìÈöîÂ∞çÊáâÊñºÊúÄÁü≠ÁöÑÈü≥Á¨¶ÔºàÂ¶ÇÂçÅÂÖ≠ÂàÜÈü≥Á¨¶Ôºâ
    // Êõ¥Ë§áÈõúÁöÑÊñπÊ≥ïÂèØ‰ª•Áµ±Ë®àÈñìÈöîÁöÑÂàÜ‰ΩàÔºåÊâæÂá∫Âü∫È†ª
    const minInterval = Math.min(...intervals);
    // ÂõõÂàÜÈü≥Á¨¶ÈñìÈöîÈÄöÂ∏∏ÊòØÈÄôÂÄãÊúÄÂ∞èÈñìÈöîÁöÑÂÄçÊï∏ (e.g., 4ÂÄç)
    // ÊàëÂÄëÂèØ‰ª•‰º∞ÁÆó‰∏ÄÂÄãÂü∫Ê∫ñÈñìÈöîÔºåÈÄôË£°Á∞°ÂåñÁÇ∫Áõ¥Êé•‰ΩøÁî®ÊúÄÂ∞èÈñìÈöîÊàñÂÖ∂‰∏ÄÈÉ®ÂàÜ‰ΩúÁÇ∫ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶Èï∑Â∫¶
    // ÂÅáË®≠ÊúÄÂ∞èÈñìÈöîÊòØÂçÅÂÖ≠ÂàÜÈü≥Á¨¶ (1/16) ÁöÑÈï∑Â∫¶
    const baseInterval = minInterval; // ÈÄô‰ª£Ë°® 1/16 Èü≥Á¨¶ÁöÑÈï∑Â∫¶

    console.log(`ÂàÜÊûêÂæóÂá∫ÁöÑÂü∫Ê∫ñÈñìÈöî (‰º∞Ë®à1/16Èü≥Á¨¶Èï∑Â∫¶): ${baseInterval.toFixed(3)} Áßí`);
    return { baseInterval };
}


           // ‚ñº‚ñº‚ñº [Êñ∞Â¢û] PRNG ÂáΩÊï∏ (Á¢∫‰øùÈÄôÊÆµ‰ª£Á¢ºÂ≠òÂú®Êñº‰Ω†ÁöÑËÖ≥Êú¨‰∏≠) ‚ñº‚ñº‚ñº
// Mulberry32 PRNG - https://gist.github.com/tommyettinger/46a874533244883189143505d203312c
function mulberry32(a) {
    return function() {
        a |= 0; a = a + 0x6D2B79F5 | 0;
        var t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ [Êñ∞Â¢ûÁµêÊùü] ‚ñ≤‚ñ≤‚ñ≤


function generateSongData(duration, difficulty, beatTimestamps, seed = 12345, noteSpeed) {
    console.log(`Generating notes with seed: ${seed}`);
    const seededRandom = mulberry32(seed);
    const tracks = 4;

    // --- Á©∫ÈñìË°õÂÖµË®≠ÂÆö ---
    const totalFallDistance = tracksContainer.clientHeight + 50;
    const pixelsPerSecond = totalFallDistance / (noteSpeed / 1000);
    const SHORT_NOTE_SAFE_HEIGHT = 40 + 10; // „Äê‰øÆË®Ç„ÄëÁÇ∫Áü≠Èü≥Á¨¶Â¢ûÂä†È°çÂ§ñ 10px Á∑©Ë°ùÔºåÈò≤Ê≠¢Ë¶ñË¶∫ÈáçÁñä
    const MIN_LONG_NOTE_SAFE_HEIGHT = 50;
    const VISUAL_COMFORT_GAP = difficulty.visualGap || 50;
    
    const data = [];
    // Á©∫ÈñìË°õÂÖµÔºöËøΩËπ§ÊØèÂÄãËªåÈÅìÂú®Áâ©ÁêÜÂÉèÁ¥†‰∏äÁöÑÂèØÁî®‰ΩçÁΩÆ
    const trackFreeAtPixel = new Array(tracks).fill(0);
    
    // ÊôÇÈñìË°õÂÖµÔºöËøΩËπ§ÊØèÂÄãËªåÈÅìÂú®Èü≥Ê®ÇÊôÇÈñì‰∏äÁöÑÂèØÁî®ÊôÇÈñìÈªû
    const trackFreeAtTime = new Array(tracks).fill(0);

    const baseIntervalAnalysis = analyzeBeatIntervals(beatTimestamps);
    const baseInterval = baseIntervalAnalysis.baseInterval;

    const rhythmPatterns = [
        { name: "ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶", duration: baseInterval, weight: 0.70 },
        { name: "‰∏âÂçÅ‰∫åÂàÜÈü≥Á¨¶", duration: baseInterval / 2, weight: 0.30 }
    ];
    const noteGenerationTypes = [
        { type: 'short', weight: 0.75 },
        { type: 'long', weight: 0.25 }
    ];

    const totalRhythmWeight = rhythmPatterns.reduce((sum, p) => sum + p.weight, 0);
    const totalTypeWeight = noteGenerationTypes.reduce((sum, t) => sum + t.weight, 0);

    let currentTime = 1.0;

    while (currentTime < duration - (2.0 + (noteSpeed / 1000))) {
        let randomRhythm = seededRandom() * totalRhythmWeight;
        let selectedRhythm = rhythmPatterns[0];
        for (const pattern of rhythmPatterns) {
            randomRhythm -= pattern.weight;
            if (randomRhythm <= 0) {
                selectedRhythm = pattern;
                break;
            }
        }
        const stepDuration = selectedRhythm.duration;

        // „Äê‰øÆË®Ç„ÄëÂú®ÈÅäÊà≤ÈñãÂßãÂâç5ÁßíÔºåÈôç‰ΩéÂØÜÂ∫¶ 20% ‰ª•Ê∏õÂ∞ëÂØÜÈõÜÁîüÊàê
        let effectiveDensity = difficulty.noteDensity;
        if (currentTime < 5) {
            effectiveDensity *= 0.8; // Èôç‰Ωé 20%
        }

        if (seededRandom() < effectiveDensity) {
            const availableTracks = [];
            for (let i = 0; i < tracks; i++) {
                availableTracks.push(i);
            }

            if (availableTracks.length > 0) {
                const trackIndex = availableTracks[Math.floor(seededRandom() * availableTracks.length)];

                const newNoteStartPixel = currentTime * pixelsPerSecond;
                // „Äê‰øÆË®Ç„ÄëÂä†Âº∑Ê™¢Êü•ÔºöÂ¢ûÂä†ÊúÄÂ∞èÊôÇÈñìÈñìÈöô 0.1 Áßí
                if (currentTime >= trackFreeAtTime[trackIndex] + 0.1 && newNoteStartPixel >= trackFreeAtPixel[trackIndex]) {

                    // „Äê‰øÆË®Ç„ÄëÂú®ÈñãÂßãÂâç5ÁßíÔºåÈôç‰ΩéÈï∑Èü≥Á¨¶Ê©üÁéá 50%
                    let effectiveLongWeight = 0.25;
                    if (currentTime < 5) {
                        effectiveLongWeight *= 0.5;
                    }
                    let randomType = seededRandom() * (0.75 + effectiveLongWeight); // Ë™øÊï¥Á∏ΩÊ¨äÈáç
                    let selectedType = { type: 'short' };
                    if (randomType > 0.75) {
                        selectedType = { type: 'long' };
                    }

                    let finalNoteDuration = 0;
                    if (selectedType.type === 'long') {
                        const minMultiplier = difficulty.longNoteMinMultiplier || 2;
                        const maxMultiplier = difficulty.longNoteMaxMultiplier || 6;
                        const randomMultiplier = minMultiplier + seededRandom() * (maxMultiplier - minMultiplier);
                        finalNoteDuration = Math.min(baseInterval * randomMultiplier, 2.0);
                    }
                    
                    data.push({
                        time: currentTime,
                        track: trackIndex,
                        type: finalNoteDuration > 0 ? 'long' : 'short',
                        duration: finalNoteDuration
                    });

                    // --- Êõ¥Êñ∞ÂÖ©ÂÄãË°õÂÖµÁöÑÁãÄÊÖã ---
                    
                    // 1. Êõ¥Êñ∞Á©∫ÈñìË°õÂÖµ
                    let currentNoteSafeHeight = (finalNoteDuration > 0)
                        ? Math.max(MIN_LONG_NOTE_SAFE_HEIGHT, finalNoteDuration * pixelsPerSecond)
                        : SHORT_NOTE_SAFE_HEIGHT;
                    trackFreeAtPixel[trackIndex] = newNoteStartPixel + currentNoteSafeHeight + VISUAL_COMFORT_GAP;

                    // „Äê‰øÆË®Ç„ÄëÊõ¥Êñ∞ÊôÇÈñìË°õÂÖµÔºå‰∏¶ÁÇ∫Èï∑Èü≥Á¨¶ÂæåÊ∑ªÂä†È°çÂ§ñ 0.2 ÁßíÂÜ∑Âçª
                    if (finalNoteDuration > 0) {
                        trackFreeAtTime[trackIndex] = currentTime + finalNoteDuration + 0.2; // È°çÂ§ñÂÜ∑Âçª
                    } else {
                        trackFreeAtTime[trackIndex] = currentTime + stepDuration;
                    }
                }
            }
        }
        currentTime += stepDuration;
    }
    return data.sort((a, b) => a.time - b.time);
}

            function generateNotesContinuously() {
                if (!gameActive) return;
                const currentTime = (Date.now() - gameStartTime) / 1000;
                while (noteQueue.length > 0 && noteQueue[0].time < currentTime + (noteSpeed / 1000)) {
                    const noteData = noteQueue.shift();
                    if (trackCooldownUntil[noteData.track] > Date.now()) {
                        continue;
                    }
                    generateNote(noteData);
                }
                if (gameActive) {
                    generateNotesTimer = setTimeout(generateNotesContinuously, 50);
                }
            }


            // ‚ñº‚ñº‚ñº „ÄêÊñ∞Â¢û„ÄëÊâÄÊúâËàáÊ≠åË©ûÊ∏¨È©óÁõ∏ÈóúÁöÑÊñ∞ÂáΩÊï∏ ‚ñº‚ñº‚ñº

/**
 * Ê†πÊìöÊ≠åÊõ≤ URL ÁîüÊàêÂ°´ÂÖÖÈ°å
 * @param {string} songUrl - Ê≠åÊõ≤ÁöÑÊ™îÊ°àÂêçÁ®±
 * @returns {Array} - ‰∏ÄÂÄãÂåÖÂê´ÂïèÈ°åÁâ©‰ª∂ÁöÑÈô£Âàó
 */
function generateQuizQuestions(songUrl) {
    const songLyricsForQuiz = songLyrics[songUrl];
    if (!songLyricsForQuiz || songLyricsForQuiz.length === 0) {
        return []; // Â¶ÇÊûúÈÄôÈ¶ñÊ≠åÊ≤íÊúâÊ≠åË©ûÔºåËøîÂõûÁ©∫Èô£Âàó
    }

    const generatedQuestions = [];
    const usedLines = new Set(); // Á¢∫‰øù‰∏çÊúÉÈáçË§á‰ΩøÁî®Âêå‰∏ÄÂè•Ê≠åË©û

    // ÂòóË©¶ÂæûÊ≠åË©û‰∏≠ÁîüÊàêÊúÄÂ§ö 10 ÂÄãÁç®ÁâπÁöÑÂïèÈ°å
    while (generatedQuestions.length < 10 && usedLines.size < songLyricsForQuiz.length) {
        let randomIndex;
        do {
            randomIndex = Math.floor(Math.random() * songLyricsForQuiz.length);
        } while (usedLines.has(randomIndex));
        
        const line = songLyricsForQuiz[randomIndex].text;
        usedLines.add(randomIndex);

        // ‰ΩøÁî®Ê≠£ÂâáË°®ÈÅîÂºèÊâæÂá∫Ê≠åË©û‰∏≠ 2 Âà∞ 4 ÂÄãÂ≠óÁöÑ‰∏≠ÊñáË©ûË™û‰ΩúÁÇ∫Á≠îÊ°àÈÅ∏È†Ö
        const words = line.match(/[\u4e00-\u9fa5]{2,4}/g) || [];

        if (words.length > 0) {
            // ÂæûÊâæÂà∞ÁöÑË©ûË™û‰∏≠Èö®Ê©üÈÅ∏‰∏ÄÂÄã‰ΩúÁÇ∫Á≠îÊ°à
            const answer = words[Math.floor(Math.random() * words.length)];
            const questionText = line.replace(answer, '____');
            
            // Á¢∫‰øùÂïèÈ°åÂ∑≤ÊàêÂäüÁîüÊàêÔºàÊõøÊèõÂâçÂæåÊñáÊú¨‰∏çÂêåÔºâ
            if (questionText !== line) {
                 generatedQuestions.push({
                    question: questionText,
                    answer: answer
                });
            }
        }
    }
    
    // Â¶ÇÊûúÁÑ°Ê≥ïÁîüÊàê‰ªª‰ΩïÂïèÈ°åÔºà‰æãÂ¶ÇÊ≠åË©ûÂ§™Áü≠ÔºâÔºåÂâáÂâµÂª∫‰∏ÄÂÄãÂÇôÁî®ÂïèÈ°å
    if (generatedQuestions.length === 0 && songLyricsForQuiz.length > 0) {
         const fallbackLine = songLyricsForQuiz[0].text;
         if (fallbackLine.length > 2) {
             const answer = fallbackLine.substring(0, 2);
             const question = '____' + fallbackLine.substring(2);
             generatedQuestions.push({ question, answer });
         }
    }
    
    return generatedQuestions;
}

/**
 * ËºîÂä©ÂáΩÊï∏ÔºöFisher-Yates Ê¥óÁâåÊºîÁÆóÊ≥ïÔºåÁî®ÊñºÊâì‰∫ÇÈ°åÂ∫´È†ÜÂ∫è
 * @param {Array} array - Ë¶ÅÊâì‰∫ÇÁöÑÈô£Âàó
 * @returns {Array} - Êâì‰∫ÇÂæåÁöÑÈô£Âàó
 */
function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

/**
 * ÈñãÂßãÊ≠åË©ûÂ°´ÂÖÖÊ∏¨È©ó
 * @param {string} unlockType - Ëß£ÈéñÈ°ûÂûã ('song' Êàñ 'difficulty')
 * @param {any} unlockValue - Ë¶ÅËß£ÈéñÁöÑÁõÆÊ®ôÂÄº
 * @param {string} songUrlForQuiz - Áî®ÊñºÁîüÊàêÊ∏¨È©óÈ°åÁõÆÁöÑÊ≠åÊõ≤ URL
 */
function startLyricsQuiz(unlockType, unlockValue, songUrlForQuiz) {
    // Âæû songData ‰∏≠Áç≤ÂèñÈ†êË®≠ÁöÑÈ°åÁõÆ
    const predefinedQuestions = songData[songUrlForQuiz]?.quiz || [];

    if (predefinedQuestions.length === 0) {
        console.warn(`Ê≠åÊõ≤ ${songUrlForQuiz} Ê≤íÊúâÈ†êË®≠È°åÁõÆÔºåËá™ÂãïÊéà‰∫àËß£Èéñ„ÄÇ`);
        showNotification('info', 'Ëá™ÂãïËß£Èéñ', 'Áî±ÊñºÊ≠§Ê≠åÊõ≤ÁÑ°Ê≠åË©ûÂèØ‰æõÊ∏¨È©óÔºåÂ∑≤ÁÇ∫ÊÇ®Áõ¥Êé•Ëß£ÈéñÊñ∞ÂÖßÂÆπÔºÅ');
        if (unlockType === 'song') {
            unlockNextSong(unlockValue);
        } else if (unlockType === 'difficulty') {
            unlockDifficulty(unlockValue.song, unlockValue.difficulty);
        }
        return;
    }
    
    isQuizActive = true;
    quizUnlockTarget = { type: unlockType, value: unlockValue };
    questionsAnsweredCorrectly = 0;
    
    // Ë§áË£Ω‰∏¶Êâì‰∫ÇÈ°åÂ∫´ÔºåÈÅøÂÖçÂΩ±ÈüøÂéüÂßãË≥áÊñô
    quizQuestions = shuffleArray([...predefinedQuestions]); 
    totalQuestionsInQuiz = quizQuestions.length;
    
    lyricsQuizModal.classList.add('active');
    displayNextQuizQuestion();
}
/**
 * È°ØÁ§∫‰∏ã‰∏ÄÂÄãÊ∏¨È©óÂïèÈ°å
 */
function displayNextQuizQuestion() {
    // Â¶ÇÊûúÈ°åÂ∫´Â∑≤Á©∫Ôºå‰ª£Ë°®ÂÖ®ÈÉ®Á≠îÂ∞ç
    if (quizQuestions.length === 0) {
        endQuiz(true); 
        return;
    }
    
    // ÂæûÈ°åÂ∫´‰∏≠ÂèñÂá∫‰∏ã‰∏ÄÈ°å
    currentQuizQuestion = quizQuestions.pop();

    // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆË®Ç„ÄëÂ∞áÂ∫ïÁ∑öÊõøÊèõÁÇ∫Â∏∂Êúâ class ÁöÑ span ÂÖÉÁ¥† ‚ñº‚ñº‚ñº
    const questionLine = currentQuizQuestion.line.replace(/__/g, '<span class="quiz-blank"></span>');
    quizQuestionText.innerHTML = questionLine;
    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆË®ÇÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤

    quizProgress.textContent = `ÈÄ≤Â∫¶: ${questionsAnsweredCorrectly} / ${totalQuestionsInQuiz}`;
    quizAnswerInput.value = '';
    quizAnswerInput.classList.remove('correct', 'incorrect');
    quizAnswerInput.disabled = false;
    quizSubmitBtn.disabled = false;
    quizAnswerInput.focus();
}
/**
 * Ê™¢Êü•Áé©ÂÆ∂Êèê‰∫§ÁöÑÁ≠îÊ°à
 */
function checkQuizAnswer() {
    if (!isQuizActive || !currentQuizQuestion) return;

    const userAnswer = quizAnswerInput.value.trim();
    const correctAnswer = currentQuizQuestion.answer;

    quizAnswerInput.disabled = true;
    quizSubmitBtn.disabled = true;

    if (userAnswer === correctAnswer) {
        questionsAnsweredCorrectly++;
        quizAnswerInput.classList.add('correct');
        quizProgress.textContent = `ÈÄ≤Â∫¶: ${questionsAnsweredCorrectly} / ${totalQuestionsInQuiz}`;
        
        // Á≠îÂ∞çÂæåÔºåÂª∂ÈÅ≤‰∏ÄÂ∞èÊÆµÊôÇÈñìÂÜçÈÄ≤ÂÖ•‰∏ã‰∏ÄÈ°å
        setTimeout(displayNextQuizQuestion, 800);
    } else {
        // „ÄêÊ†∏ÂøÉË¶èÂâá„ÄëÁ≠îÈåØÔºåÁ´ãÂç≥ÁµêÊùüÊ∏¨È©ó‰∏¶Âà§ÂÆöÂ§±Êïó
        quizAnswerInput.classList.add('incorrect');
        setTimeout(() => endQuiz(false), 1200); 
    }
}


/**
 * ÁµêÊùüÊ∏¨È©óÔºå‰∏¶Ê†πÊìöÁµêÊûúÂü∑Ë°åÊúÄÁµÇÊìç‰Ωú
 * @param {boolean} success - Ê∏¨È©óÊòØÂê¶ÊàêÂäü
 */
function endQuiz(success) {
    if (!isQuizActive) return; // Èò≤Ê≠¢ÈáçË§áÂü∑Ë°å

    isQuizActive = false;
    lyricsQuizModal.classList.remove('active');

    if (success) {
        // Â¶ÇÊûúÊàêÂäüÔºåÂâáÂü∑Ë°åÁúüÊ≠£ÁöÑËß£ÈéñÊìç‰Ωú
        const { type, value } = quizUnlockTarget;
        if (type === 'song') {
            unlockNextSong(value); 
        } else if (type === 'difficulty') {
            unlockDifficulty(value.song, value.difficulty);
        }
    } else {
        // Â¶ÇÊûúÂ§±ÊïóÊàñ‰∏≠ÈÄîÈóúÈñâÔºåÈ°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ
        showNotification('info', 'Ëß£ÈéñÂ§±Êïó', 'Ê≠åË©ûÊ∏¨È©óÊú™ÈÄöÈÅéÔºå‰∏ãÊ¨°Ë´ãÂÜçÊé•ÂÜçÂé≤ÔºÅ');
    }

    // ÈáçÁΩÆÊ∏¨È©óÁãÄÊÖã‰ª•ÂÇô‰∏ãÊ¨°‰ΩøÁî®
    quizQuestions = [];
    currentQuizQuestion = null;
    questionsAnsweredCorrectly = 0;
    totalQuestionsInQuiz = 0;
    quizUnlockTarget = null;
}

/**
 * Ê™¢Êü•Ëß£ÈéñÊ¢ù‰ª∂‰∏¶Ëß∏ÁôºÊ∏¨È©óÊàñÈ°ØÁ§∫ÊèêÁ§∫ (Ê†∏ÂøÉÈÇèËºØÂáΩÊï∏)
 * @param {string} songUrl - Áï∂ÂâçÊ≠åÊõ≤ URL
 * @param {string} difficulty - Áï∂ÂâçÈõ£Â∫¶
 * @param {number} pureHitScore - Á¥îÁ≤πÁöÑÊìäÊâìÂàÜÊï∏ (‰∏çÂê´ Combo Âä†Êàê)
 */
function checkAndShowQuizOrInfo(songUrl, difficulty, pureHitScore) {
    // ‚ñº‚ñº‚ñº „Äê‰øÆË®ÇËôï„ÄëÊ™¢Êü• songData ‰∏≠ÊòØÂê¶Êúâ quiz Â±¨ÊÄß ‚ñº‚ñº‚ñº
    const hasQuiz = songData[songUrl]?.quiz && songData[songUrl].quiz.length > 0;
    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆË®ÇÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤
    let potentialUnlock = null;

    // Ê™¢Êü•1: ÊòØÂê¶ÊªøË∂≥Ëß£Èéñ„ÄêÊñ∞Ê≠åÊõ≤„ÄëÁöÑÊ¢ù‰ª∂ (ÂÉÖÂú®ÊôÆÈÄöÈõ£Â∫¶‰∏ã)
    if (difficulty === 'normal') {
        const allSongs = Array.from(musicSelect.options).map(opt => opt.value);
        const lastUnlockedSong = saveData.unlockedSongs[saveData.unlockedSongs.length - 1];
        
        // ÂøÖÈ†àÁé©ÁöÑÊòØÁï∂ÂâçÂ∑≤Ëß£ÈéñÁöÑÊúÄÂæå‰∏ÄÈ¶ñÊ≠å
        if (songUrl === lastUnlockedSong) {
            const currentIndex = allSongs.indexOf(lastUnlockedSong);
            if (currentIndex >= 0 && currentIndex < allSongs.length - 1) {
                const nextSong = allSongs[currentIndex + 1];
                if (!isSongUnlocked(nextSong)) {
                    const requiredScore = maxScoreForCurrentLevel * SONG_UNLOCK_PERCENTAGE;
                    if (pureHitScore >= requiredScore) {
                        potentialUnlock = { type: 'song', value: songUrl, songForQuiz: songUrl };
                    } else {
                        const remainingScore = Math.ceil(requiredScore - pureHitScore);
                        showNotification('info', 'ÁõÆÊ®ôÂ∑Æ‰∏ÄÈªûÔºÅ', `ÊÇ®Âú®„ÄåÊôÆÈÄö„ÄçÈõ£Â∫¶‰∏ãÈÇÑÂ∑Æ <strong>${remainingScore.toLocaleString()}</strong> ÂàÜÂ∞±ËÉΩÊåëÊà∞Ëß£Èéñ‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤‰∫Ü„ÄÇÂÜçÂä†ÊääÂãÅÔºÅ`, 6000);
                    }
                }
            }
        }
    }

    // Â¶ÇÊûúÂ∑≤ÊªøË∂≥Ëß£ÈéñÊ≠åÊõ≤Ê¢ù‰ª∂ÔºåÂâáÂÑ™ÂÖàËôïÁêÜÔºå‰∏¶ÁµÇÊ≠¢ÂæåÁ∫åÊ™¢Êü•
    if (potentialUnlock) {
        if (hasQuiz) {
            startLyricsQuiz(potentialUnlock.type, potentialUnlock.value, potentialUnlock.songForQuiz);
        } else {
            console.warn(`Ê≠åÊõ≤ ${potentialUnlock.songForQuiz} ÁÑ°Ê≥ïËß∏ÁôºÊ∏¨È©óÔºåÂõ†ÁÇ∫Ê≤íÊúâÈ†êË®≠È°åÁõÆ„ÄÇÂ∞áÁõ¥Êé•Ëß£Èéñ„ÄÇ`);
            unlockNextSong(potentialUnlock.value);
        }
        return; 
    }

    // Ê™¢Êü•2: ÊòØÂê¶ÊªøË∂≥Ëß£Èéñ„ÄêÂõ∞Èõ£„ÄëÈõ£Â∫¶ÁöÑÊ¢ù‰ª∂ (ÂæûÊôÆÈÄöÈõ£Â∫¶ÊåëÊà∞)
    if (difficulty === 'normal' && !isDifficultyUnlocked(songUrl, 'hard')) {
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        if (pureHitScore >= requiredScore) {
            potentialUnlock = { type: 'difficulty', value: { song: songUrl, difficulty: 'hard' }, songForQuiz: songUrl };
        }
    }

    // Ê™¢Êü•3: ÊòØÂê¶ÊªøË∂≥Ëß£Èéñ„ÄêÂú∞ÁçÑ„ÄëÈõ£Â∫¶ÁöÑÊ¢ù‰ª∂ (ÂæûÂõ∞Èõ£Èõ£Â∫¶ÊåëÊà∞)
    if (difficulty === 'hard' && !isDifficultyUnlocked(songUrl, 'hell')) {
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        if (pureHitScore >= requiredScore) {
            potentialUnlock = { type: 'difficulty', value: { song: songUrl, difficulty: 'hell' }, songForQuiz: songUrl };
        }
    }
    
    // Â¶ÇÊûúÊªøË∂≥Ëß£ÈéñÈõ£Â∫¶ÁöÑÊ¢ù‰ª∂ÔºåËß∏ÁôºÁõ∏ÊáâÊìç‰Ωú
    if (potentialUnlock) {
         if (hasQuiz) {
            startLyricsQuiz(potentialUnlock.type, potentialUnlock.value, potentialUnlock.songForQuiz);
         } else {
            console.warn(`Ê≠åÊõ≤ ${potentialUnlock.songForQuiz} ÁÑ°Ê≥ïËß∏ÁôºÊ∏¨È©óÔºåÂõ†ÁÇ∫Ê≤íÊúâÈ†êË®≠È°åÁõÆ„ÄÇÂ∞áÁõ¥Êé•Ëß£Èéñ„ÄÇ`);
            unlockDifficulty(potentialUnlock.value.song, potentialUnlock.value.difficulty);
         }
    }
}


            



function updateGameLyrics(currentTime) {
    const selectedSong = musicSelect.value;
    
    // ‚ñº‚ñº‚ñº „Äê‰øÆË®ÇËôï„ÄëÂæû songData Áç≤ÂèñÊ≠åË©û ‚ñº‚ñº‚ñº
    const lyrics = songData[selectedSong]?.lyrics || [];
    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆË®ÇÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤
    
    if (lyrics.length === 0) return; // ÁÑ°Ê≠åË©ûÔºåÁõ¥Êé•ËøîÂõû

    let currentIndex = -1;
    for (let i = 0; i < lyrics.length; i++) {
        if (lyrics[i].time <= currentTime) {
            currentIndex = i;
        } else {
            break;
        }
    }

    const lyricsBackground = document.getElementById('lyricsBackground');
    if (lyricsBackground) {
        lyricsBackground.innerHTML = ''; // Ê∏ÖÁ©∫ËàäÂÖßÂÆπ
        const currentLyric = (currentIndex >= 0 && lyrics[currentIndex]) ? lyrics[currentIndex].text : '';
        if (currentLyric) {
            // ÂãïÊÖãË®àÁÆóÈúÄË¶ÅÁöÑ span Êï∏ÈáèÔºå‰ª•Â°´ÊªøÊï¥ÂÄãÁï´Èù¢
            const fontSize = parseFloat(getComputedStyle(lyricsBackground).fontSize); // Áç≤ÂèñÁï∂Ââç font-size (ÂñÆ‰Ωç px)
            const approxCharWidth = fontSize * 0.6; // ‰º∞Ë®àÊØèÂÄãÂ≠óÂÖÉÁöÑÂØ¨Â∫¶ÔºàÁ¥Ñ 0.6 * font-sizeÔºâ
            const lineHeight = fontSize * 1.2; // ‰º∞Ë®àË°åÈ´òÔºàÂü∫Êñº line-height: 1.2Ôºâ
            
            const lyricWidth = currentLyric.length * approxCharWidth; // ‰º∞Ë®àÂñÆÂÄã span ÁöÑÂØ¨Â∫¶
            const spanWidth = Math.max(lyricWidth, window.innerWidth * 0.1); // ÊúÄÂ∞è 10% ÂØ¨ÔºåÈò≤Ê≠¢Â§™Á™Ñ
            const spanHeight = lineHeight; // ÂñÆÂÄã span ÁöÑÈ´òÂ∫¶
            
            const horizontalCount = Math.ceil(window.innerWidth / spanWidth); // Ê∞¥Âπ≥ËÉΩÊîæÂ§öÂ∞ëÂÄã
            const verticalCount = Math.ceil(window.innerHeight / spanHeight); // ÂûÇÁõ¥ËÉΩÊîæÂ§öÂ∞ëÂÄã
            
            const densityFactor = 1.2; // Áï•Â§ö 20% ‰ª•Á¢∫‰øùÂÆåÂÖ®Ë¶ÜËìãÔºàÂèØË™øÊï¥ 1.0-1.5Ôºâ
            const totalSpans = Math.ceil(horizontalCount * verticalCount * densityFactor); // Á∏ΩÊï∏
            
            for (let i = 0; i < totalSpans; i++) {
                const span = document.createElement('span');
                span.textContent = currentLyric;
                lyricsBackground.appendChild(span);
            }
        }
    }
}

// ‰øÆË®ÇÔºöstartGameÔºàÈ°ØÁ§∫Êñ∞ËÉåÊôØÂÆπÂô®Ôºâ
async function startGame() {
    const selectedSong = musicSelect.value;
    const selectedDifficulty = difficultySelect.value;

    if (!isSongUnlocked(selectedSong)) {
        showUnlockModal(`Âú®ÊôÆÈÄöÊ®°Âºè‰∏ãÈÅîÂà∞ ${SONG_UNLOCK_SCORE} ÂàÜ‰ª•Ëß£Èéñ‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤„ÄÇ`);
        return;
    }
    if (!isDifficultyUnlocked(selectedSong, selectedDifficulty)) {
        let reqScore = 0;
        let reqDiff = '';
        if (selectedDifficulty === 'hard') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_NORMAL_TO_HARD;
            reqDiff = 'ÊôÆÈÄö';
        } else if (selectedDifficulty === 'hell') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_HARD_TO_HELL;
            reqDiff = 'Âõ∞Èõ£';
        }
        showUnlockModal(`Âú® ${reqDiff} Ê®°Âºè‰∏ãÈÅîÂà∞ ${reqScore} ÂàÜ‰ª•Ëß£ÈéñÊ≠§Èõ£Â∫¶„ÄÇ`);
        return;
    }

    if (gameActive) return;
    gameActive = true;
    startBtn.disabled = true;
    musicSelect.disabled = true;
    difficultySelect.disabled = true;

    // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆË®Ç„ÄëÁÑ°Ê¢ù‰ª∂Ë®≠ÂÆöÂÖ©Ê¢ùÂêàÊ†ºÁ∑öÁöÑ‰ΩçÁΩÆ ‚ñº‚ñº‚ñº
    mainGameContainer.classList.add('game-running'); 
    // ÂàùÂßãÂåñÈÄ≤Â∫¶Ê¢ùÈ´òÂ∫¶ÂíåÂØ¨Â∫¶ÔºåÁ¢∫‰øùÈ°ØÁ§∫Ê≠£Â∏∏
unlockProgressBar.style.height = '100%';
unlockProgressBar.style.width = '0%';
unlockProgressBar.classList.remove('glowing');
    
    // Ê†πÊìöÈ†êË®≠ÁöÑÁôæÂàÜÊØîÂ∏∏Êï∏ÔºåË®≠ÂÆöÂÖ©Ê¢ùÁ∑öÁöÑ left Â±¨ÊÄß
    songUnlockMarker.style.left = `${SONG_UNLOCK_PERCENTAGE * 100}%`;
    difficultyUnlockMarker.style.left = `${DIFFICULTY_UNLOCK_PERCENTAGE * 100}%`;
    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆË®ÇÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤
    
    startBtn.innerHTML = `<svg class="start-button-svg" viewBox="0 0 40 40" style="width:40px;height:40px;">
        <circle cx="20" cy="20" r="18" stroke="#ff8a00" stroke-width="3" fill="none" stroke-dasharray="89" stroke-dashoffset="20">
            <animateTransform attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="1s" repeatCount="indefinite" />
        </circle>
    </svg>`;
    
    const difficulty = getCurrentDifficulty();
    const beatTimestamps = await analyzeAudioForBeats(selectedSong);
    startBtn.innerHTML = originalStartButtonSVG;
 
    progressContainerDiv.style.display = 'block';
    trackCooldownUntil.fill(0); 
    audio.src = selectedSong;
    audio.volume = volumeControlModal.value;
    currentSongDuration = await getAudioDuration(selectedSong);
    noteSpeed = Math.floor(4000 / difficulty.speedMultiplier);
    // ‚ñº‚ñº‚ñº [‰øÆË®Ç] ÁîüÊàêÂü∫ÊñºÊ≠åÊõ≤ÂíåÈõ£Â∫¶ÁöÑÂõ∫ÂÆöÁ®ÆÂ≠ê ‚ñº‚ñº‚ñº
const songAndDifficultyString = selectedSong + selectedDifficulty;
let seed = 0;
for (let i = 0; i < songAndDifficultyString.length; i++) {
    const char = songAndDifficultyString.charCodeAt(i);
    seed = ((seed << 5) - seed) + char;
    seed |= 0; // Convert to 32bit integer
}
// Á¢∫‰øùÁ®ÆÂ≠êÁÇ∫Ê≠£Êï∏
seed = Math.abs(seed) || 1; // ÈÅøÂÖçÁ®ÆÂ≠êÁÇ∫ 0
console.log(`Generating notes for ${selectedSong} (${selectedDifficulty}) with seed: ${seed}`);
// ‚ñ≤‚ñ≤‚ñ≤ [‰øÆË®ÇÁµêÊùü] ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº [‰øÆË®Ç] ÂÇ≥ÂÖ•Á®ÆÂ≠ê ‚ñº‚ñº‚ñº
noteQueue = generateSongData(currentSongDuration, difficulty, beatTimestamps, seed, noteSpeed); // ÂÇ≥ÂÖ• noteSpeed
// ‚ñ≤‚ñ≤‚ñ≤ [‰øÆË®ÇÁµêÊùü] ‚ñ≤‚ñ≤‚ñ≤

    // ‚ñº‚ñº‚ñº „Äê‰øÆË®ÇÂæåÁöÑÊ†∏ÂøÉÈÇèËºØ„Äë ‚ñº‚ñº‚ñº
    // Âú®ÁîüÊàêÈü≥Á¨¶ÂæåÔºåÂãïÊÖãË®àÁÆó‰∏çÂê´ÈÄ£ÊìäÁçéÂãµÁöÑÁêÜË´ñÊúÄÈ´òÂàÜ
    const maxBaseScorePerNote = 100; // "Perfect" ÁöÑÂü∫Á§éÂàÜÊï∏ÊòØ 100
    maxScoreForCurrentLevel = noteQueue.length * maxBaseScorePerNote;

    // Â¶ÇÊûúË®àÁÆóÁµêÊûúÁÇ∫ 0 (‰æãÂ¶ÇÊ≠åÊõ≤Ê≤íÊúâÈü≥Á¨¶)ÔºåÂâáÊèê‰æõ‰∏ÄÂÄãÈ†êË®≠ÂÄº‰ª•ÈÅøÂÖçÈåØË™§
    if (maxScoreForCurrentLevel === 0) {
        maxScoreForCurrentLevel = 300000; // Ë®≠ÁΩÆ‰∏ÄÂÄãÂæåÂÇôÂÄº
    }
    // ‚ñ≤‚ñ≤‚ñ≤ „Äê‰øÆË®ÇÁµêÊùü„Äë ‚ñ≤‚ñ≤‚ñ≤

    await audio.play().catch(e => console.log("Èü≥Ë®äÊí≠ÊîæÂ§±Êïó:", e));
    gameStartTime = Date.now();
    generateNotesContinuously();
    gameLoop();
    progressInterval = setInterval(updateProgress, 100);
    setTimeout(() => { if (gameActive) endGame(); }, currentSongDuration * 1000 + 2000);

    // Êñ∞Â¢ûÔºöÈ°ØÁ§∫ËÉåÊôØÊ≠åË©ûÂÆπÂô®
    const lyricsBackground = document.getElementById('lyricsBackground');
    if (lyricsBackground) {
        lyricsBackground.style.display = 'grid';
    }
}

function endGame() {
    if (!gameActive) return; // Èò≤Ê≠¢ÈáçË§áËß∏Áôº

    gameActive = false;
    audio.pause();
    audio.currentTime = 0;
    clearTimeout(generateNotesTimer);
    clearInterval(progressInterval);
    cancelAnimationFrame(animationFrame);
    startBtn.disabled = false;
    musicSelect.disabled = false;
    difficultySelect.disabled = false;

    // Èö±ËóèÈÅäÊà≤‰∏≠ÁöÑ UI ÂÖÉÁ¥†
    mainGameContainer.classList.remove('game-running'); 
    unlockProgressBar.style.width = '0%';
    unlockProgressBar.classList.remove('glowing');
    progressBar.style.width = '0%';
    notes.forEach(note => note.element.remove());
    notes = [];

    const lyricsBackground = document.getElementById('lyricsBackground');
    if (lyricsBackground) {
        lyricsBackground.style.display = 'none';
        lyricsBackground.innerHTML = '';
    }

    // --- ÈÅäÊà≤ÂæåÁµêÁÆó ---
    const selectedSong = musicSelect.value;
    const selectedDifficulty = difficultySelect.value;
    updatePersonalHighScore(selectedSong, selectedDifficulty, score);

    // „ÄêÊ†∏ÂøÉ‰øÆË®Ç„Äë
    // Â∞áÊâÄÊúâËß£ÈéñÂà§Êñ∑Áµ±‰∏Ä‰∫§Áµ¶ checkAndShowQuizOrInfo ÂáΩÊï∏„ÄÇ
    checkAndShowQuizOrInfo(selectedSong, selectedDifficulty, pureHitScore);
    
    // ====== „ÄêÊñ∞Â¢û„ÄëÊèê‰∫§ÂàÜÊï∏Âà∞ÂÖ®ÁêÉÊéíË°åÊ¶ú ======
    submitScoreToLeaderboard(selectedSong, selectedDifficulty, score);
    // ==========================================

    // È°ØÁ§∫ÈÅäÊà≤ÁµêÊùüÁï´Èù¢
    showGameOver();
}

            function showGameOver() {
                finalScoreDisplay.textContent = score.toLocaleString();
                finalComboDisplay.textContent = maxCombo;
                gameOverModal.classList.add('active');
            }

            function restartGame() {
                gameOverModal.classList.remove('active');
                initGame();
            }

          function gameLoop() {
    if (!gameActive) return;

    // --- Ê†∏ÂøÉÂÑ™ÂåñÔºöÂú®Ëø¥ÂúàÂ§ñÂø´Âèñ‰∏çÊúÉËÆäÂãïÁöÑÊï∏ÂÄº ---
    // Áç≤ÂèñËªåÈÅìÁ∏ΩÈ´òÂ∫¶ÔºåÈü≥Á¨¶ÈúÄË¶ÅÁßªÂãïÁöÑÁ∏ΩË∑ùÈõ¢
    const fallDistance = tracksContainer.clientHeight; 
    // Ë®àÁÆóÂà§ÂÆöÁ∑öÁöÑ Y Â∫ßÊ®ô (Áõ∏Â∞çÊñºËªåÈÅìÈ†ÇÈÉ®)
    const hitLineY = fallDistance - 100; 
    // Ë®àÁÆóÈü≥Á¨¶ÊØèÊØ´ÁßíÁßªÂãïÁöÑÂÉèÁ¥†Ë∑ùÈõ¢
    const pixelsPerMillisecond = fallDistance / noteSpeed;

    const now = Date.now();

    for (let i = notes.length - 1; i >= 0; i--) {
        const note = notes[i];
        if (!note.active) continue;

        // --- Ê†∏ÂøÉÂÑ™ÂåñÔºöÁî®Êï∏Â≠∏ÂÖ¨Âºè„ÄåË®àÁÆó„ÄçÈü≥Á¨¶ÁöÑÁï∂Ââç‰ΩçÁΩÆ ---
        const timeElapsed = now - note.creationTime;
        // Èü≥Á¨¶È†ÇÈÉ®ÁöÑ Y Â∫ßÊ®ô = Â∑≤ÈÅéÊôÇÈñì * ÊØèÊØ´ÁßíÁßªÂãïË∑ùÈõ¢ - Èü≥Á¨¶Ëá™Ë∫´È´òÂ∫¶(ÂãïÁï´ÊòØÂæû-50pxÈñãÂßãÁöÑ)
        const noteTopY = (timeElapsed * pixelsPerMillisecond) - 50;

        // --- ‰ΩøÁî®Ë®àÁÆóÂá∫ÁöÑ‰ΩçÁΩÆ‰æÜÈÄ≤Ë°åÂà§Êñ∑ ---
        // Â¶ÇÊûúÈü≥Á¨¶È†ÇÈÉ®Â∑≤Á∂ìË∂ÖÈÅé‰∫ÜÂà§ÂÆöÁ∑öÂä†‰∏ÄÂÄãÁ∑©Ë°ùÂçÄ (20px)
        if (noteTopY > hitLineY + 20) {
            const isTrackInvincible = notes.some(n =>
                n.track === note.track &&
                n.type === 'long' &&
                n.hitStarted
            );

            if (!isTrackInvincible) {
                judgeHit(note.track, 'miss');
            }
            
            note.active = false;
            note.element.remove(); // ÈÄôË£°ÁöÑ remove ÊòØÂøÖË¶ÅÁöÑÔºåÂõ†ÁÇ∫ miss ‰∫Ü
            notes.splice(i, 1);
        }
    }

    animationFrame = requestAnimationFrame(gameLoop);
}

         function handleKeyDown(e) {
                if (!gameActive) return;
                const keyCode = e.keyCode;
                if (keyStates[keyCode]) return;
                keyStates[keyCode] = true;
                const trackIndex = keyCodes.indexOf(keyCode);
                if (trackIndex !== -1) {
                    const trackEl = document.querySelector(`.track[data-track="${trackIndex}"]`);
                    if (trackEl) {
                        trackEl.classList.remove('hit-effect');
                        void trackEl.offsetWidth;
                        trackEl.classList.add('hit-effect');
                    }
                    const trackRect = tracksContainer.getBoundingClientRect();
                    const hitLineY = trackRect.top + trackRect.height - 100;
                    let hitNote = null;
                    let minDistance = Infinity;
                    let hitIndex = -1;
                    notes.forEach((note, index) => {
                        if (note.track === trackIndex && note.active && !note.hitStarted) {
                            const rect = note.element.getBoundingClientRect();
                            const distance = Math.abs(rect.bottom - hitLineY);
                            if (distance < minDistance) {
                                minDistance = distance;
                                hitNote = note;
                                hitIndex = index;
                            }
                        }
                    });
                   if (hitNote && minDistance < 50) {
    let judgment;
    if (minDistance < 15) judgment = 'perfect';
    else if (minDistance < 30) judgment = 'great';
    else judgment = 'good';
    if (hitNote.type === 'long') {
        hitNote.hitStarted = true;
        hitNote.element.classList.add('held');
        judgeHit(trackIndex, judgment);
        explodeNote(hitNote.element, judgment); // Êñ∞Â¢ûÔºöÈï∑Èü≥Á¨¶Êåâ‰∏ãÊôÇÂàÜËß£Á≤íÂ≠ê
    } else {
        hitNote.active = false;
        explodeNote(hitNote.element, judgment); // Êñ∞Â¢ûÔºöÁü≠Èü≥Á¨¶Êìä‰∏≠ÊôÇÂàÜËß£Á≤íÂ≠ê
        hitNote.element.remove();
        notes.splice(hitIndex, 1);
        judgeHit(trackIndex, judgment);
    }
} else {
                        // Â¶ÇÊûúÊåâ‰∏ãÊôÇÔºåÊ≤íÊúâ‰ªª‰ΩïÈü≥Á¨¶Âú®ÂèØÊìä‰∏≠ÁØÑÂúçÂÖßÔºåÂâáÂà§ÂÆöÁÇ∫ MISS
                        judgeHit(trackIndex, 'miss');

                        // ‚ñº‚ñº‚ñº ‰øÆË®ÇÁöÑÈóúÈçµ‰πãËôï ‚ñº‚ñº‚ñº
                        // ‰∏¶‰∏îÔºåÂ¶ÇÊûúËªåÈÅì‰∏äÁ¢∫ÂØ¶Êúâ‰∏ÄÂÄãÊúÄËøëÁöÑÈü≥Á¨¶ÔºàÂè™ÊòØÂ§™ÈÅ†‰∫ÜÔºâÔºå
                        // ÂâáÂ∞áË©≤Èü≥Á¨¶ÁßªÈô§Ôºå‰ª•Êá≤ÁΩ∞ÊèêÊó©ÊåâÈçµÁöÑË°åÁÇ∫„ÄÇ
                        if (hitNote) {
                            hitNote.active = false;
                            hitNote.element.remove();
                            notes.splice(hitIndex, 1);
                        }
                        // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆË®ÇÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤
                    }
                }
            }

         function handleKeyUp(e) {
    if (!gameActive) return;
    const keyCode = e.keyCode;
    keyStates[keyCode] = false;
    const trackIndex = keyCodes.indexOf(keyCode);
    if (trackIndex !== -1) {
        const heldNoteIndex = notes.findIndex(note =>
            note.track === trackIndex && note.type === 'long' && note.hitStarted
        );
        if (heldNoteIndex !== -1) {
            const note = notes[heldNoteIndex];
            const trackRect = tracksContainer.getBoundingClientRect();
            const hitLineY = trackRect.top + trackRect.height - 100;
            const rect = note.element.getBoundingClientRect();
            const noteTailY = rect.top;
            const distance = Math.abs(noteTailY - hitLineY);
            let type = 'miss';  // È†êË®≠ÁÇ∫ MISS
if (distance < 50) {
    if (distance < 15) type = 'perfect';
    else if (distance < 30) type = 'great';
    else type = 'good';
}

// ‰øÆË®ÇÔºöÁÑ°Ë´ñ MISS ÊàñÈùû MISSÔºåÈÉΩÂëºÂè´ judgeHitÔºåËÆìÂÆÉËôïÁêÜÊâÄÊúâÊïàÊûúÔºàÂåÖÊã¨Á≤íÂ≠ê/ÈúáÂãïÔºâ
judgeHit(trackIndex, type);
if (type !== 'miss') {
    explodeNote(note.element, type); // Êñ∞Â¢ûÔºöÈï∑Èü≥Á¨¶ÈáãÊîæÊàêÂäüÊôÇÂàÜËß£Á≤íÂ≠ê
}

note.active = false;
note.element.remove();
notes.splice(heldNoteIndex, 1);
        }
    }
}
            function onTouchStart(e) {
                e.preventDefault();
                const keyElement = e.target.closest('.touch-key');
                if (keyElement) {
                    keyElement.classList.add('pressed');
                    handleKeyDown({ keyCode: parseInt(keyElement.dataset.key) });
                }
            }

            function onTouchEnd(e) {
                e.preventDefault();
                const changedTouches = e.changedTouches || [e];
                for (const touch of changedTouches) {
                    const originalKeyElement = e.target.closest('.touch-key');
                    if (originalKeyElement) {
                        originalKeyElement.classList.remove('pressed');
                        handleKeyUp({ keyCode: parseInt(originalKeyElement.dataset.key) });
                    }
                }
            }


// Â∞ãÊâæ‰∏ã‰∏ÄÈ¶ñÂïüÁî®ÁöÑÊ≠åÊõ≤
function findNextEnabledSong(currentIndex) {
    for (let i = currentIndex + 1; i < playlistItems.length; i++) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // Ê≤íÊúâÊâæÂà∞‰∏ã‰∏ÄÈ¶ñÂïüÁî®ÁöÑÊ≠åÊõ≤
}

// Â∞ãÊâæ‰∏ä‰∏ÄÈ¶ñÂïüÁî®ÁöÑÊ≠åÊõ≤
function findPrevEnabledSong(currentIndex) {
    for (let i = currentIndex - 1; i >= 0; i--) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // Ê≤íÊúâÊâæÂà∞‰∏ä‰∏ÄÈ¶ñÂïüÁî®ÁöÑÊ≠åÊõ≤
}


            // --- Music Player Logic ---
            function initMusicPlayer() {
                // Filter playlist items to only include unlocked songs
                const unlockedSongsSet = new Set(saveData.unlockedSongs);
                playlistItems = Array.from(musicSelect.options)
                    .filter(opt => unlockedSongsSet.has(opt.value)) // Only unlocked songs
                    .map((opt, index) => ({
                        url: opt.value,
                        title: opt.textContent.replace(' (Êú™Ëß£Èéñ)', ''),
                        index: index
                    }));

                playlist.innerHTML = '';
playlistItems.forEach(item => {
    const li = document.createElement('li');
    li.className = 'playlist-item';
    li.textContent = item.title;
    li.dataset.index = item.index;
    
    // ÂæûÂÑ≤Â≠òÁöÑË®≠ÂÆö‰∏≠ÊÅ¢Âæ©Ê≠åÊõ≤ÁãÄÊÖã
    const savedState = playerSettings.playlistStates[item.url];
    const isEnabled = savedState ? savedState.enabled : true;
    li.dataset.enabled = isEnabled ? 'true' : 'false';
    
    if (!isEnabled) {
        li.classList.add('disabled');
    }
    
    let clickCount = 0;
    let clickTimer = null;
    
    li.addEventListener('click', () => {
        clickCount++;
        
        if (clickTimer) {
            clearTimeout(clickTimer);
        }
        
       clickTimer = setTimeout(() => {
    if (clickCount === 1) {
        // ÂñÆÊìäÔºöÊí≠ÊîæË©≤Ê≠åÊõ≤ÊàñÂïüÁî®Ë©≤Ê≠åÊõ≤
        li.dataset.enabled = 'true';
        li.classList.remove('disabled');
        playSong(item.index);
        savePlayerSettings(); // ‰øùÂ≠òË®≠ÂÆö
    } else if (clickCount === 2) {
        // ÈõôÊìäÔºöÂÅúÁî®Ë©≤Ê≠åÊõ≤Ôºå‰∏çÊí≠Êîæ
        li.dataset.enabled = 'false';
        li.classList.add('disabled');
        savePlayerSettings(); // ‰øùÂ≠òË®≠ÂÆö
                
                // Â¶ÇÊûúÁï∂ÂâçÊ≠£Âú®Êí≠ÊîæÈÄôÈ¶ñÊ≠åÔºåÂâáÊö´ÂÅú‰∏¶Â∞ãÊâæ‰∏ã‰∏ÄÈ¶ñÂïüÁî®ÁöÑÊ≠åÊõ≤
                if (currentPlaylistIndex === item.index && playerIsPlaying) {
                    const nextIndex = findNextEnabledSong(currentPlaylistIndex);
                    if (nextIndex !== -1) {
                        playSong(nextIndex);
                    } else {
                        playerAudio.pause();
                    }
                }
            }
            clickCount = 0;
        }, 300); // 300ÊØ´ÁßíÂÖßÁöÑÈªûÊìäË¶ñÁÇ∫ÈõôÊìä
    });
    
    playlist.appendChild(li);
});

                playerAudio.addEventListener('loadedmetadata', () => {
                    durationDisplay.textContent = formatTime(playerAudio.duration);
                    progressSlider.max = playerAudio.duration;
                });

               playerAudio.addEventListener('timeupdate', () => {
    if (!isUpdatingSlider) {
        currentTimeDisplay.textContent = formatTime(playerAudio.currentTime);
        progressSlider.value = playerAudio.currentTime;
        updateLyrics(playerAudio.currentTime);
        
        // ÊØè5ÁßíËá™Âãï‰øùÂ≠òÊí≠ÊîæÈÄ≤Â∫¶
        if (Math.floor(playerAudio.currentTime) % 5 === 0) {
            savePlayerSettings();
        }
    }
});

playerAudio.addEventListener('play', () => {
    playerIsPlaying = true;
    playPauseBtn.textContent = '\u275A\u275A';
    updatePlayerUI();
    savePlayerSettings(); // ‰øùÂ≠òÊí≠ÊîæÁãÄÊÖã
});

playerAudio.addEventListener('pause', () => {
    playerIsPlaying = false;
    playPauseBtn.textContent = '\u25B6';
    updatePlayerUI();
    savePlayerSettings(); // ‰øùÂ≠òÊö´ÂÅúÁãÄÊÖã
});
               playerAudio.addEventListener('ended', () => {
    playerIsPlaying = false;
    playPauseBtn.textContent = '\u25B6'; // Play icon
ocument.getElementById('cdCoverImage').classList.remove('playing'); // Êñ∞Â¢ûÔºöÂÅúÊ≠¢ÊóãËΩâ
    
    // Â∞ãÊâæ‰∏ã‰∏ÄÈ¶ñÂïüÁî®ÁöÑÊ≠åÊõ≤
    const nextIndex = findNextEnabledSong(currentPlaylistIndex);
    if (nextIndex !== -1) {
        playSong(nextIndex);
    }
    updatePlayerUI();
});

                playerAudio.addEventListener('play', () => {
                    playerIsPlaying = true;
                    playPauseBtn.textContent = '\u275A\u275A'; // Pause icon
                    updatePlayerUI();
                });

                playerAudio.addEventListener('pause', () => {
                    playerIsPlaying = false;
                    playPauseBtn.textContent = '\u25B6'; // Play icon
                    updatePlayerUI();
// Êñ∞Â¢ûÔºöÂÅúÊ≠¢ CD ÊóãËΩâ
    document.getElementById('cdCoverImage').classList.remove('playing');
                });
            }

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }

           function playSong(index) {
    if (index < 0 || index >= playlistItems.length) return;
    
    // Ê™¢Êü•Ê≠åÊõ≤ÊòØÂê¶Ë¢´ÂÅúÁî®
    const playlistItem = playlist.children[index];
    if (playlistItem && playlistItem.dataset.enabled === 'false') {
        console.log('Ê≠åÊõ≤Â∑≤Ë¢´ÂÅúÁî®ÔºåË∑≥ÈÅéÊí≠Êîæ');
        return;
    }
    
    // Check if the song is unlocked before playing
    const songToPlay = playlistItems[index];
    if (!isSongUnlocked(songToPlay.url)) {
        console.warn(`ÂòóË©¶Êí≠ÊîæÊú™Ëß£ÈéñÁöÑÊ≠åÊõ≤: ${songToPlay.title}`);
        return; // Do not play if not unlocked
    }

    currentPlaylistIndex = index;
    const song = playlistItems[index];
    playerAudio.src = song.url;
    playerAudio.volume = volumeSliderPlayer.value;
    nowPlaying.textContent = `Ê≠£Âú®Êí≠Êîæ: ${song.title}`;
    updateCdCover(song.url); // Êõ¥Êñ∞ CD Â∞ÅÈù¢
    
    // ‚ñº‚ñº‚ñº „Äê‰øÆË®ÇËôï„ÄëÂæû songData Áç≤ÂèñÊ≠åË©û ‚ñº‚ñº‚ñº
    lyrics = songData[song.url]?.lyrics || [];
    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆË®ÇÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤

    updateLyricsContainer();
    updatePlayerUI();
    document.getElementById('cdCoverImage').classList.add('playing'); // ÈñãÂßãÊóãËΩâ
    playerAudio.play().catch(e => console.error("Êí≠ÊîæÂô®Êí≠ÊîæÂ§±Êïó:", e));
    savePlayerSettings(); // ‰øùÂ≠òÁï∂ÂâçÊí≠ÊîæÁãÄÊÖã
}

// Âú®ÁèæÊúâÂáΩÊï∏‰πãÂâçÊñ∞Â¢ûÈÄôÂÖ©ÂÄãËºîÂä©ÂáΩÊï∏
function findNextEnabledSong(currentIndex) {
    for (let i = currentIndex + 1; i < playlistItems.length; i++) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // Ê≤íÊúâÊâæÂà∞‰∏ã‰∏ÄÈ¶ñÂïüÁî®ÁöÑÊ≠åÊõ≤
}

function findPrevEnabledSong(currentIndex) {
    for (let i = currentIndex - 1; i >= 0; i--) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // Ê≤íÊúâÊâæÂà∞‰∏ä‰∏ÄÈ¶ñÂïüÁî®ÁöÑÊ≠åÊõ≤
}

            function updateLyricsContainer() {
                lyricsContainer.innerHTML = '';
                if (lyrics.length === 0) {
                    lyricsContainer.innerHTML = '<div class="no-lyrics">ÁÑ°Ê≠åË©û</div>';
                    return;
                }
                lyrics.forEach((line, i) => {
                    const p = document.createElement('p');
                    p.className = 'lyric-line';
                    p.textContent = line.text;
                    p.dataset.time = line.time;
                    lyricsContainer.appendChild(p);
                });
            }

            function updateLyrics(currentTime) {
                if (lyrics.length === 0) return;
                let activeIndex = -1;
                for (let i = 0; i < lyrics.length; i++) {
                    if (lyrics[i].time <= currentTime) {
                        activeIndex = i;
                    } else {
                        break;
                    }
                }
                document.querySelectorAll('.lyric-line').forEach((line, i) => {
                    line.classList.toggle('active', i === activeIndex);
                    if (i === activeIndex) {
                        line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }



// Êõ¥Êñ∞ CD Â∞ÅÈù¢ÁöÑÂáΩÊï∏
function updateCdCover(songUrl) {
    const coverImage = document.getElementById('cdCoverImage');
    // Ê†πÊìöÊ≠åÊõ≤ URL Áç≤ÂèñÂ∞çÊáâÁöÑÂ∞ÅÈù¢ÔºåÂ¶ÇÊûúÊ≤íÊúâÂâá‰ΩøÁî®ÈªòË™çÂ∞ÅÈù¢
    const coverUrl = songCovers[songUrl] || songCovers["default"];
    coverImage.src = coverUrl;
    // ÂèØÈÅ∏ÔºöÊ∑ªÂä†Âä†ËºâÈåØË™§ÁöÑÂõûÈÄÄ
    coverImage.onerror = function() {
        this.src = songCovers["default"];
    };
}



            function updatePlayerUI() {
    document.querySelectorAll('.playlist-item').forEach((item, i) => {
        item.classList.toggle('active', i === currentPlaylistIndex);
    });
    
    // Ê™¢Êü•ÊòØÂê¶Êúâ‰∏ä‰∏ÄÈ¶ñ/‰∏ã‰∏ÄÈ¶ñÂïüÁî®ÁöÑÊ≠åÊõ≤‰æÜÊ±∫ÂÆöÊåâÈàïÁãÄÊÖã
    const hasPrev = findPrevEnabledSong(currentPlaylistIndex) !== -1;
    const hasNext = findNextEnabledSong(currentPlaylistIndex) !== -1;
    
    prevBtn.disabled = !hasPrev;
    nextBtn.disabled = !hasNext;
}

            // --- Event Listeners ---
            touchKeys.forEach(key => {
                key.addEventListener('touchstart', onTouchStart, { passive: false });
                key.addEventListener('touchend', onTouchEnd, { passive: false });
                key.addEventListener('touchcancel', onTouchEnd, { passive: false });
            });

            settingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
            closeSettings.addEventListener('click', () => settingsModal.classList.remove('active'));
            window.addEventListener('click', (e) => {
                if (e.target === settingsModal) settingsModal.classList.remove('active');
                if (e.target === personalHighScoreModal) personalHighScoreModal.classList.remove('active');
                if (e.target === unlockModal) unlockModal.classList.remove('active');
            });

         // „Äê‰øÆË®Ç„ÄëÁÇ∫Èü≥Ê®ÇÈü≥ÈáèÊªëÊ°øÊ∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÔºå‰∏¶Âç≥ÊôÇÊõ¥Êñ∞CSSËÆäÊï∏
            volumeControlModal.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                audio.volume = isNaN(value) ? 1.0 : value; // Â∞áÂæåÂÇôÂÄºÂæû 0.7 ÊîπÁÇ∫ 1.0
                // Êõ¥Êñ∞CSSËÆäÊï∏‰æÜÊéßÂà∂ËÉåÊôØÂ°´ÂÖÖ
                const percent = value * 100;
                e.target.style.background = `linear-gradient(to right, #3b82f6 ${percent}%, #4a5568 ${percent}%)`;
            });

            // „Äê‰øÆË®Ç„ÄëÁÇ∫Èü≥ÊïàÈü≥ÈáèÊªëÊ°øÊ∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÔºå‰∏¶Âç≥ÊôÇÊõ¥Êñ∞CSSËÆäÊï∏
            sfxVolumeControl.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                sfxVolume = isNaN(value) ? 0.5 : value;
                // Êõ¥Êñ∞CSSËÆäÊï∏‰æÜÊéßÂà∂ËÉåÊôØÂ°´ÂÖÖ
                const percent = value * 100;
                e.target.style.background = `linear-gradient(to right, #3b82f6 ${percent}%, #4a5568 ${percent}%)`;
            });
            
            startBtn.addEventListener('click', startGame);
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            restartBtn.addEventListener('click', restartGame);
            // --- Handle Page Visibility to Prevent Ghost Notes ---
            document.addEventListener('visibilitychange', () => {
                // ÊàëÂÄëÂè™ÈóúÂøÉÈ†ÅÈù¢Âæû„ÄåÈö±Ëóè„ÄçËÆäÁÇ∫„ÄåÂèØË¶ã„ÄçÁöÑÈÇ£ÂÄãÁû¨Èñì
                // ‰∏¶‰∏îÂè™ÊúâÂú®ÈÅäÊà≤Ê≠£Âú®ÈÄ≤Ë°å‰∏≠ÊâçÈúÄË¶ÅËôïÁêÜ
                if (!document.hidden && gameActive) {
                    const now = Date.now();
                    
                    // ÈÅçÊ≠∑ÊâÄÊúâÁï∂ÂâçÂú®Áï´Èù¢‰∏äÁöÑÈü≥Á¨¶
                    // ÊàëÂÄëÂæûÂæåÂæÄÂâçÈÅçÊ≠∑ÔºåÈÄôÊ®£Âú®Âà™Èô§Èô£ÂàóÂÖÉÁ¥†ÊôÇÊâç‰∏çÊúÉÂá∫ÈåØ
                    for (let i = notes.length - 1; i >= 0; i--) {
                        const note = notes[i];
                        const timeAlive = now - note.creationTime;

                        // „ÄêÊ†∏ÂøÉÊ∏ÖÁêÜÈÇèËºØ„Äë
                        // Â¶ÇÊûú‰∏ÄÂÄãÈü≥Á¨¶ÁöÑÂ≠òÊ¥ªÊôÇÈñìÔºåÂ∑≤Á∂ìË∂ÖÈÅé‰∫ÜÂÆÉË∑ëÂÆåÊï¥ÂÄãËªåÈÅìÊâÄÈúÄÁöÑÊôÇÈñì (noteSpeed)
                        // ÂÜçÂä†‰∏ä‰∏ÄÂÄãÂ∞èÁöÑÁ∑©Ë°ùÊôÇÈñìÔºà‰æãÂ¶Ç 500 ÊØ´ÁßíÔºâÔºå
                        // ÊàëÂÄëÂ∞±Ë™çÂÆöÂÆÉÊòØ‰∏ÄÂÄãÂú®È†ÅÈù¢Èö±ËóèÊúüÈñìÂ∞±ÊáâË©≤Ê∂àÂ§±ÁöÑ„ÄåÂπΩÈùàÈü≥Á¨¶„Äç„ÄÇ
                        if (timeAlive > noteSpeed + 500) {
                            note.active = false;      // Ê®ôË®òÁÇ∫Èùû‰ΩúÁî®‰∏≠
                            note.element.remove();    // ÂæûÁï´Èù¢‰∏≠ÁßªÈô§ DOM ÂÖÉÁ¥†
                            notes.splice(i, 1);       // ÂæûÊàëÂÄëÁöÑÈÅäÊà≤ÈÇèËºØÈô£Âàó‰∏≠ÁßªÈô§
                        }
                    }
                }
            });

            // New Event Listeners
            personalHighScoreBtn.addEventListener('click', () => {
                const selectedSong = musicSelect.value;
                populatePersonalHighScoreList(selectedSong);
                personalHighScoreModal.classList.add('active');
            });
            closePersonalHighScore.addEventListener('click', () => personalHighScoreModal.classList.remove('active'));

           musicPlayerBtn.addEventListener('click', () => {
    musicPlayerModal.classList.add('active');
    initMusicPlayer(); // Re-initialize playlist on open to reflect unlocks
    loadPlayerSettings(); // ËºâÂÖ•ÂÑ≤Â≠òÁöÑË®≠ÂÆö
    
    // ÊÅ¢Âæ©‰∏äÊ¨°ÁöÑÊí≠ÊîæÁãÄÊÖã
    if (playerSettings.currentSong && playlistItems.length > 0) {
        const songIndex = playlistItems.findIndex(item => item.url === playerSettings.currentSong);
        if (songIndex !== -1) {
            currentPlaylistIndex = songIndex;
            playerAudio.src = playerSettings.currentSong;
            playerAudio.currentTime = playerSettings.currentTime || 0;
            nowPlaying.textContent = `Ê≠£Âú®Êí≠Êîæ: ${playlistItems[songIndex].title}`;
            
            // ÊÅ¢Âæ©Ê≠åË©ûÂíåUI
            const song = playlistItems[songIndex];
            lyrics = songLyrics[song.url] || [];
            updateLyricsContainer();
            updatePlayerUI();
            
            // Â¶ÇÊûú‰πãÂâçÊòØÊí≠ÊîæÁãÄÊÖãÔºåÂâáËá™ÂãïÁπºÁ∫åÊí≠Êîæ
            if (playerSettings.isPlaying) {
                playerAudio.play().catch(e => console.error("Ëá™ÂãïÊí≠ÊîæÂ§±Êïó:", e));
            }
        }
    }
});
           closeMusicPlayer.addEventListener('click', () => {
    savePlayerSettings(); // ‰øùÂ≠òÁï∂ÂâçÁãÄÊÖãÂÜçÈóúÈñâ
    musicPlayerModal.classList.remove('active');
    playerAudio.pause();
});
            playPauseBtn.addEventListener('click', () => {
    if (playerAudio.src) {
        if (playerIsPlaying) {
            playerAudio.pause();
        } else {
            playerAudio.play();
        }
    } else {
        // Â¶ÇÊûúÊ≤íÊúâÈü≥Ê∫êÔºåÊí≠ÊîæÁ¨¨‰∏ÄÈ¶ñÂïüÁî®ÁöÑÊ≠åÊõ≤
        const firstEnabledIndex = findNextEnabledSong(-1);
        if (firstEnabledIndex !== -1) {
            playSong(firstEnabledIndex);
        }
    }
});
          prevBtn.addEventListener('click', () => {
    const prevIndex = findPrevEnabledSong(currentPlaylistIndex);
    if (prevIndex !== -1) {
        playSong(prevIndex);
    }
});

nextBtn.addEventListener('click', () => {
    const nextIndex = findNextEnabledSong(currentPlaylistIndex);
    if (nextIndex !== -1) {
        playSong(nextIndex);
    }
});

            progressSlider.addEventListener('input', () => {
                isUpdatingSlider = true;
                playerAudio.currentTime = progressSlider.value;
                currentTimeDisplay.textContent = formatTime(progressSlider.value);
            });
            progressSlider.addEventListener('change', () => {
                 isUpdatingSlider = false;
            });

            // Fixed volume slider input listeners for player to use 'change' event for full range
            volumeSliderPlayer.addEventListener('change', () => {
    const value = parseFloat(volumeSliderPlayer.value);
    playerAudio.volume = isNaN(value) ? 0.7 : value;
    savePlayerSettings(); // ‰øùÂ≠òÈü≥ÈáèË®≠ÂÆö
});

            musicSelect.addEventListener('change', () => {
                const selectedSong = musicSelect.value;
                updateDifficultyOptions(selectedSong);
                populatePersonalHighScoreList(selectedSong); // Update personal score list on song change
            });

            difficultySelect.addEventListener('change', () => {
                // Optional: Add logic if difficulty change needs immediate UI update
            });

            closeUnlock.addEventListener('click', () => unlockModal.classList.remove('active'));

             // --- „ÄêÊñ∞Â¢û„ÄëÊéíË°åÊ¶ú Modal ÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô® ---
            leaderboardBtn.addEventListener('click', () => {
                leaderboardModal.classList.add('active');
                handlePlayerName(); // ËôïÁêÜÁé©ÂÆ∂ÂêçÁ®±
                // È†êË®≠È°ØÁ§∫Áï∂Ââç‰∏ª‰ªãÈù¢ÈÅ∏ÊìáÁöÑÊ≠åÊõ≤ÂíåÈõ£Â∫¶
                displayLeaderboard(musicSelect.value, difficultySelect.value);
            });

            closeLeaderboard.addEventListener('click', () => {
                leaderboardModal.classList.remove('active');
            });

            // Áï∂‰∏ª‰ªãÈù¢ÁöÑÊ≠åÊõ≤ÊàñÈõ£Â∫¶ÊîπËÆäÊôÇÔºåÂ¶ÇÊûúÊéíË°åÊ¶úÊòØÈñãÂïüÁöÑÔºåÂ∞±ÂêåÊ≠•Êõ¥Êñ∞
            musicSelect.addEventListener('change', () => {
                if (leaderboardModal.classList.contains('active')) {
                    displayLeaderboard(musicSelect.value, difficultySelect.value);
                }
                // ÈÄô‰∏ÄÊÆµÊúÉËàá‰∏äÈù¢ÁöÑ musicSelect.addEventListener ÈáçË§áÔºå‰ΩÜÂΩ±Èüø‰∏çÂ§ßÔºåÂõ†ÁÇ∫ÂÆÉÂÄëÁöÑÂäüËÉΩ‰∏çË°ùÁ™Å
                // ÁÇ∫‰∫ÜÁ®ãÂºèÁ¢ºÁ∞°ÊΩîÔºå‰Ω†ÂèØ‰ª•ËÄÉÊÖÆÂ∞áÂÖ©ÂÄã change ‰∫ã‰ª∂ÁöÑÈÇèËºØÂêà‰ΩµÔºå‰ΩÜÂàÜÈñãÂØ´‰πüÂÆåÂÖ®ÂèØ‰ª•ÈÅã‰Ωú
            });

            difficultySelect.addEventListener('change', () => {
                if (leaderboardModal.classList.contains('active')) {
                    displayLeaderboard(musicSelect.value, difficultySelect.value);
                }
            });

            // --- Initialization ---
            const originalStartButtonSVG = startBtn.innerHTML;
            updateSongOptions(); // Apply unlock status on load
            populatePersonalHighScoreList(musicSelect.value); // Show scores for initially selected song
            initGame();

            // „ÄêÊñ∞Â¢û„ÄëÁ∂ÅÂÆöÊ∏¨È©óË¶ñÁ™óÁöÑÊåâÈàï‰∫ã‰ª∂
quizSubmitBtn.addEventListener('click', checkQuizAnswer);
quizAnswerInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault(); // Èò≤Ê≠¢Ë°®ÂñÆÊèê‰∫§ÁöÑÈ†êË®≠Ë°åÁÇ∫
        checkQuizAnswer();
    }
});
quizCloseBtn.addEventListener('click', () => {
    if (isQuizActive) {
        endQuiz(false); // Áé©ÂÆ∂ÊâãÂãïÈóúÈñâË¶ñÁ™óÔºåË¶ñÁÇ∫Ê∏¨È©óÂ§±Êïó
    }
});


// ÁÇ∫ÁâàÊ¨äËÅ≤ÊòéÊåâÈàïÊ∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
const showDisclaimerBtn = document.getElementById('showDisclaimerBtn');
const disclaimerModal = document.getElementById('disclaimerModal');
const closeDisclaimer = document.getElementById('closeDisclaimer');

showDisclaimerBtn.addEventListener('click', () => {
    disclaimerModal.classList.add('active');
});

closeDisclaimer.addEventListener('click', () => {
    disclaimerModal.classList.remove('active');
});

// ÈªûÊìäÊ®°ÊÖãÊ°ÜÂ§ñÈÉ®ÈóúÈñâ
disclaimerModal.addEventListener('click', (e) => {
    if (e.target === disclaimerModal) {
        disclaimerModal.classList.remove('active');
    }
});
});
    </script>


<!-- Copyright Disclaimer Modal -->
<div class="copyright-disclaimer-modal" id="disclaimerModal">
    <div class="disclaimer-content">
        <button class="close-disclaimer" id="closeDisclaimer">&times;</button>
        <h2 class="disclaimer-title">Èü≥Ê®ÇÁâàÊ¨äËÅ≤Êòé</h2>
        <div class="disclaimer-section">
            <h3>Èü≥Ê®Ç‰æÜÊ∫ê</h3>
            <p>Êú¨Â∞àÊ°à‰∏≠‰ΩøÁî®ÁöÑÈü≥Ê®ÇÁî± AI Â∑•ÂÖ∑ÔºàË±ÜÂåÖÔºâÁîüÊàê„ÄÇ</p>
        </div>
        <div class="disclaimer-section">
            <h3>‰ΩøÁî®ÈôêÂà∂</h3>
            <p>Êú¨Èü≥Ê®ÇÂÉÖÁî®ÊñºË™ûÊñáÊïôËÇ≤Áî®ÈÄîÔºåÁ¶ÅÊ≠¢‰ªª‰ΩïÁî®Êà∂‰∏ãËºâÂæåÁî®ÊñºÂïÜÊ•≠Á≠âÂÖ∂‰ªñÂ†¥ÊôØ„ÄÇ</p>
        </div>
        <div class="disclaimer-section">
            <h3>ÂÖçË≤¨ËÅ≤Êòé</h3>
            <p>Ëã•Èü≥Ê®ÇÈÅïÂèç‰ªª‰ΩïÁâàÊ¨äÔºåÊú¨‰∫∫Â∞áÁ´ãÂç≥Âà™Èô§ÊúâÈóú‰ΩúÂìÅ„ÄÇ</p>
        </div>
    </div>
</div>

<!-- ‚ñº‚ñº‚ñº „ÄêÊñ∞Â¢û„ÄëÊ≠åË©ûÂ°´ÂÖÖÊ∏¨È©óË¶ñÁ™ó ‚ñº‚ñº‚ñº -->
<div class="lyrics-quiz-modal" id="lyricsQuizModal">
    <div class="quiz-content">
        <h2 class="quiz-title">Ê≠åË©ûÂ°´ÂÖÖÊ∏¨È©ó</h2>
        <p class="quiz-instructions">ÈÄ£Á∫åÁ≠îÂ∞ç‰∏âÈ°åÂç≥ÂèØËß£ÈéñÊñ∞ÂÖßÂÆπÔºÅ</p>
        <div class="quiz-progress" id="quizProgress">ÈÄ£Á∫åÁ≠îÂ∞ç: 0 / 3</div>
        <div class="quiz-question-container">
            <p id="quizQuestionText"></p>
        </div>
        <input type="text" id="quizAnswerInput" class="quiz-answer-input" placeholder="Ë´ãÂú®Ê≠§Ëº∏ÂÖ•Á≠îÊ°à..." autocomplete="off">
        <button id="quizSubmitBtn" class="quiz-submit-btn">Êèê‰∫§Á≠îÊ°à</button>
        <button id="quizCloseBtn" class="quiz-close-btn">&times;</button>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁµêÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ====== „ÄêÊñ∞Â¢û„ÄëÊéíË°åÊ¶ú Modal ====== -->
<div class="settings-modal" id="leaderboardModal">
    <div class="settings-content">
        <button class="close-settings" id="closeLeaderboard">&times;</button>
        <h2 class="settings-title">Ê≠åÊõ≤ÊéíË°åÊ¶ú</h2>
        
        <!-- Áé©ÂÆ∂ÂêçÁ®±Ë®≠ÂÆö -->
        <div class="setting-group" id="playerNameGroup">
            <label class="setting-label" for="playerNameInput">‰Ω†ÁöÑÈ°ØÁ§∫ÂêçÁ®±:</label>
            <input type="text" id="playerNameInput" class="setting-control" placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑÂêçÁ®±" maxlength="20">
            <button id="savePlayerNameBtn" class="restart-btn"></button>
        </div>

        <!-- ÊéíË°åÊ¶úÈ°ØÁ§∫ÂçÄÂüü -->
        <div class="leaderboard-display">
            <h3 id="leaderboardTitle" class="personal-high-score-title" style="margin-top: 20px;">Ë´ãÈÅ∏ÊìáÊ≠åÊõ≤ËàáÈõ£Â∫¶</h3>
            <ol class="personal-high-score-list" id="leaderboardList">
                <!-- ÊéíË°åÊ¶úË≥áÊñôÊúÉÁî± JS ÂãïÊÖãÂ°´ÂÖ• -->
            </ol>
            <p id="leaderboardLoading" style="display: none;">ËÆÄÂèñ‰∏≠...</p>
        </div>
    </div>
</div>

</body>
</html>
