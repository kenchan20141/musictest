

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å¤±è½ä¹‹æ„Ÿæ€§</title>

  <!-- â–¼â–¼â–¼ æ­¥é©Ÿ 1ï¼šè²¼ä¸Šæˆ–æ›¿æ›ç‚ºé€™æ®µæ–°çš„ CSP è¦å‰‡ â–¼â–¼â–¼ -->
   <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://www.gstatic.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' https: data:;
    media-src 'self';
    connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com;
    object-src 'none';
    base-uri 'self';
    form-action 'none';
">


    
      <!-- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘è«‹å°‡é€™ä¸‰è¡Œ Google Fonts é€£çµåŠ åœ¨é€™è£¡ â–¼â–¼â–¼ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
/* =================================================================== */
/* ====== 1. å…¨åŸŸæ¨£å¼ & å­—é«”è¨­å®š (Global Styles & Typography) ====== */
/* =================================================================== */

/* --- ä¸»é¡Œé¡è‰²è®Šæ•¸ --- */
:root {
    /* "æ˜Ÿå…‰æ®¿å ‚" ä¸»é¡Œé¡è‰² */
    --starlight-bg: linear-gradient(145deg, #fdfbfb 0%, #ebedee 100%);
    --starlight-accent: #b48f5a;
    --starlight-accent-glow: rgba(180, 143, 90, 0.35);
    --starlight-text-primary: #3a332a;
    --starlight-text-secondary: #8c7d6b;
    --starlight-border: rgba(180, 143, 90, 0.4);
    --starlight-item-bg: rgba(255, 255, 255, 0.6);
    --starlight-item-hover-bg: #ffffff;
    /* "æ˜Ÿå¡µæ¦®è€€" æ’è¡Œæ¦œä¸»é¡Œé¡è‰² */
    --rank-gold: #D4AF37;
    --rank-silver: #C0C0C0;
    --rank-bronze: #CD7F32;
    --rank-item-bg: rgba(235, 237, 238, 0.5);
    --rank-item-hover-bg: rgba(255, 255, 255, 0.9);
    --rank-icon-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}

/* --- å…¨åŸŸé‡è¨­èˆ‡åŸºç¤è¨­å®š --- */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    /* é˜²æ­¢è§¸æ§é è¨­è¡Œç‚ºï¼Œå¦‚é›™æ“Šç¸®æ”¾ */
    touch-action: manipulation; 
}

body {
    /* ã€æ ¸å¿ƒã€‘ç¢ºä¿ Noto Serif TC å­—é«”æˆåŠŸå¥—ç”¨ */
    font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
    background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
    /* ç¦ç”¨æ–‡å­—é¸å–èˆ‡é›™æ“Šç¸®æ”¾ */
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

/* --- é é¢èƒŒæ™¯æ•ˆæœ --- */
body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 10% 20%, rgba(255, 200, 124, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(108, 99, 255, 0.1) 0%, transparent 20%);
    z-index: -1;
}

.background-image {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('https://i.ibb.co/W4yhM5v0/image.png');
    background-size: cover;
    background-position: center;
    opacity: 0.6;
    z-index: -2;
}

/* éŠæˆ²ä¸­æµ®å‹•æ­Œè©èƒŒæ™¯ */
.lyrics-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    display: none; /* é è¨­éš±è— */
    flex-wrap: wrap;
    align-content: flex-start;
    justify-content: space-around;
    gap: 2px;
    opacity: 0.25;
    color: #fff;
    font-size: 5rem;
    pointer-events: none;
    text-align: center;
    overflow: hidden;
}

.lyrics-background span {
    line-height: 1.1;
    white-space: nowrap;
    flex: 0 0 auto;
    min-width: 10%;
    min-height: 10vh;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    word-break: break-word;
    overflow: hidden;
}


/* =================================================================== */
/* ====== 2. ä¸»è¦ä½ˆå±€ & å®¹å™¨ (Layout & Containers) ============== */
/* =================================================================== */

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px;
    position: relative;
    z-index: 1;
}

.main-game-container {
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.15);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    margin-bottom: 20px;
}

.game-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* =================================================================== */
/* ====== 3. é ‚éƒ¨æ¨™é¡Œ & éŠæˆ²æ§åˆ¶ä»‹é¢ (Header & Game UI) ======== */
/* =================================================================== */

header {
    text-align: center;
    padding: 10px 0;
    margin-bottom: 10px;
}

h1 {
    font-size: 2.5rem;
    margin-bottom: 5px;
    background: linear-gradient(45deg, #ff8a00, #e52e71);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.subtitle {
    font-size: 1rem;
    opacity: 0.8;
    margin-bottom: 10px;
}

.game-ui {
    position: relative;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 10px;
    padding-bottom: 60px; /* ç‚ºé€²åº¦æ¢å’Œæ­Œè©é ç•™ç©ºé–“ */
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

/* éŠæˆ²ä¸­éš±è—é¸æ“‡å™¨ */
.game-running .music-selector,
.game-running .difficulty-selector {
    display: none;
}

/* --- çµ±è¨ˆæ•¸æ“š (åˆ†æ•¸ç­‰) --- */
.stats {
    display: flex;
    gap: 10px;
}

.stat-box {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 8px 12px;
    min-width: 90px;
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #ffcc00;
}

.stat-label {
    font-size: 1rem;
    color: #fff;
    opacity: 1;
}

/* --- æ§åˆ¶æŒ‰éˆ• (é–‹å§‹ã€è¨­å®šç­‰) --- */
.controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

.svg-button {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    width: 80px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
}
.svg-button:hover {
    transform: translateY(-2px);
}
.svg-button:active {
    transform: translateY(1px);
}
.svg-button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
    transform: none;
}
.start-button-svg {
    width: 100%;
    height: 100%;
}

.settings-btn,
.music-player-btn {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.settings-icon,
.music-player-icon {
    width: 100%;
    height: 100%;
    fill: white;
}
.music-player-btn {
    margin-left: 10px;
}

/* --- æ­Œæ›²/é›£åº¦é¸æ“‡å™¨ --- */
.music-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}

.music-select-wrapper {
    position: relative;
    display: inline-block;
}

.music-select-wrapper select {
    background: rgba(0, 0, 0, 0.3);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 8px 35px 8px 12px;
    border-radius: 50px;
    font-size: 0.9rem;
    min-width: 0;
    flex: 1;
    appearance: none;
    cursor: pointer;
}
.music-select-wrapper select:disabled {
    color: #888;
    cursor: not-allowed;
}

.music-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    fill: white;
    width: 16px;
    height: 16px;
}

.difficulty-selector {
    display: flex;
    gap: 5px;
    align-items: center;
    font-size: 0.9rem;
}

.difficulty-selector select {
    background: rgba(0, 0, 0, 0.3);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.9rem;
}
.difficulty-selector select:disabled {
    color: #888;
    cursor: not-allowed;
}

/* --- å€‹äºº/æ­Œæ›²æ’è¡Œæ¦œæŒ‰éˆ• --- */
.personal-high-score-btn {
    background: none;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: background 0.3s ease, border-color 0.3s ease;
}
.personal-high-score-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.5);
}
.personal-high-score-icon {
    width: 18px;
    height: 18px;
    fill: white;
}

/* --- é€²åº¦æ¢ (æ­Œæ›² & è§£é–) --- */
.progress-container {
    position: absolute;
    bottom: 5px;
    left: 10px;
    right: 10px;
    width: auto;
    height: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    overflow: hidden;
    z-index: 10;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ff8a00, #e52e71);
    width: 0%;
    transition: width 0.1s linear;
}

.unlock-progress-container {
    position: absolute;
    bottom: 22px; /* ä½æ–¼æ­Œæ›²é€²åº¦æ¢ä¸Šæ–¹ */
    left: 10px;
    right: 10px;
    width: auto;
    height: 12px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
    z-index: 10;
    opacity: 0;
    transform: translateY(100%);
    transition: opacity 0.5s ease, transform 0.5s ease;
    display: flex;
    align-items: center;
}

/* éŠæˆ²é€²è¡Œä¸­ï¼Œé¡¯ç¤ºè§£é–é€²åº¦æ¢ */
.game-running .unlock-progress-container {
    opacity: 1;
    transform: translateY(0);
}

.unlock-progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #1D976C, #93F9B9);
    transition: width 0.2s ease-out, box-shadow 0.3s ease;
    box-shadow: 0 0 10px rgba(147, 249, 185, 0);
}
.unlock-progress-bar.glowing {
    box-shadow: 0 0 15px 5px rgba(147, 249, 185, 0.8);
}

.unlock-progress-marker {
    position: absolute;
    top: -5px;
    bottom: -5px;
    width: 2px;
    height: auto;
    z-index: 2;
}
.unlock-progress-marker.song-marker {
    background: #FFD700; /* é‡‘é»ƒè‰² */
    box-shadow: 0 0 8px #FFD700;
}
.unlock-progress-marker.difficulty-marker {
    background: #F96666; /* äº®ç´…è‰² */
    box-shadow: 0 0 8px #F96666;
}

/* =================================================================== */
/* ====== 4. æ ¸å¿ƒéŠæˆ²å€åŸŸ (Game Area) ============================ */
/* =================================================================== */

.game-area {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.tracks {
    display: flex;
    justify-content: center;
    gap: 8px;
    position: relative;
    height: 600px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    overflow: hidden;
    padding: 15px 0;
    transition: box-shadow 0.3s ease;
}

.track {
    width: 80px;
    height: 100%;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    position: relative;
}
.track::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, transparent 0%, rgba(255, 255, 255, 0.2) 100%);
    pointer-events: none;
}

/* --- Combo å…‰æšˆæ•ˆæœ --- */
.tracks.combo-blue { box-shadow: 0 0 20px 5px rgba(30, 144, 255, 0.7); }
.tracks.combo-orange { box-shadow: 0 0 25px 8px rgba(255, 165, 0, 0.7); }
.tracks.combo-pink { box-shadow: 0 0 30px 10px rgba(255, 105, 180, 0.7); }
.tracks.combo-purple { box-shadow: 0 0 35px 12px rgba(147, 112, 219, 0.7); }
.tracks.combo-rainbow {
    box-shadow: 0 0 40px 15px;
    animation: rainbowGlow 1.5s infinite;
}

/* --- éŸ³ç¬¦ & åˆ¤å®šç·š --- */
.hit-line {
    position: absolute;
    bottom: 100px;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #ff8a00, #e52e71);
    border-radius: 2px;
    box-shadow: 0 0 10px rgba(229, 46, 113, 0.7);
    z-index: 10;
}

.note {
    position: absolute;
    width: 70px;
    height: 25px;
    background: linear-gradient(45deg, #00c9ff, #92fe9d);
    border-radius: 12px;
    top: -50px;
    left: 5px;
    box-shadow: 0 0 10px rgba(0, 201, 255, 0.7);
    animation: fall linear;
    z-index: 5;
}

.long-note {
    position: absolute;
    width: 70px;
    background: linear-gradient(45deg, #ff416c, #ff4b2b);
    border-radius: 12px;
    top: -50px;
    left: 5px;
    box-shadow: 0 0 10px rgba(255, 65, 108, 0.7);
    animation: fall linear;
    z-index: 5;
    transition: background 0.1s ease, box-shadow 0.1s ease;
}
.long-note.held {
    background: linear-gradient(45deg, #ffdd4b, #ff8c4b);
    box-shadow: 0 0 15px rgba(255, 221, 75, 0.9);
}

.key-hint {
    position: absolute;
    bottom: 50px;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 1.3rem;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.7);
}

/* --- éŠæˆ²å…§æ•ˆæœ (åˆ¤å®šã€Comboã€ç²’å­) --- */
.judgment {
    position: absolute;
    bottom: 150px;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
    opacity: 0;
    z-index: 20;
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
    animation: judgmentFade 1s ease-out;
}
.perfect { color: #ffcc00; }
.great { color: #00ccff; }
.good { color: #00ff99; }
.miss { color: #ff3366; }

.combo-display {
    position: absolute;
    top: 20%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    font-weight: bold;
    opacity: 0;
    z-index: 15;
    animation: comboFlash 0.5s ease-out;
    pointer-events: none;
}
.combo-display.combo-base { color: #e0e0e0; text-shadow: 0 0 10px rgba(224, 224, 224, 0.7); }
.combo-display.combo-blue { color: #1e90ff; text-shadow: 0 0 15px rgba(30, 144, 255, 0.8); }
.combo-display.combo-orange { color: #ffa500; text-shadow: 0 0 15px rgba(255, 165, 0, 0.8); }
.combo-display.combo-pink { color: #ff69b4; text-shadow: 0 0 15px rgba(255, 105, 180, 0.8); }
.combo-display.combo-purple { color: #9370db; text-shadow: 0 0 15px rgba(147, 112, 219, 0.8); }
.combo-display.combo-rainbow {
    background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
    background-size: 400% 400%;
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    animation: comboFlashRainbow 0.5s ease-out, rainbowText 2s linear infinite;
}

/* è»Œé“æ‰“æ“Šèˆ‡åˆ¤å®šç·šè„ˆè¡æ•ˆæœ */
.track.hit-effect, .track.flash-effect { animation: trackFlash 0.2s ease-out; }
.track.flash-perfect { animation: trackFlashPerfect 0.3s ease-out; }
.track.flash-great { animation: trackFlashGreat 0.3s ease-out; }
.track.flash-good { animation: trackFlashGood 0.3s ease-out; }

.hit-line.pulse-effect {
    animation: hitLinePulse 0.2s ease-out;
}

/* ç²’å­æ•ˆæœ */
.hit-particle, .note-particle {
    position: absolute;
    width: var(--size, 10px);
    height: var(--size, 10px);
    pointer-events: none;
    z-index: 30;
    opacity: 0;
    will-change: transform, opacity;
}
.hit-particle {
    bottom: 100px;
    border-radius: 50%;
}
.note-particle {
    border-radius: 30%;
}

.hit-particle.animate {
    animation: particleBurst 0.6s ease-out forwards;
}
.note-particle.animate {
    animation: noteDecompose 0.5s ease-out forwards;
}

/* --- éŠæˆ²ä¸­æ­Œè©é¡¯ç¤º --- */
.game-lyrics-container {
    position: absolute;
    top: 10%;
    left: 0;
    right: 0;
    text-align: center;
    z-index: 15;
    opacity: 0.8;
    transition: opacity 0.5s ease;
    display: none; /* é è¨­éš±è— */
}

.game-lyric-line {
    font-size: 1.2rem;
    color: #fff;
    margin: 5px 0;
    text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    transition: transform 0.3s ease, color 0.3s ease;
}
.game-lyric-line.active {
    font-size: 1.5rem;
    color: #ffcc00;
    transform: scale(1.1);
}

.lyrics-side {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 150px;
    opacity: 0.5;
    background: transparent;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 10px;
    overflow-y: auto;
    color: #fff;
    font-size: clamp(1rem, 10vw, 1.5rem);
    text-align: center;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    line-height: 1.2;
    z-index: 10;
    transition: opacity 0.3s ease;
}
.lyrics-left {
    left: calc(50% - 200px - 150px);
    text-align: right;
    padding-right: 20px;
}
.lyrics-right {
    right: calc(50% - 200px - 150px);
    text-align: left;
    padding-left: 20px;
}
.lyrics-side.hidden {
    display: none;
}


/* =================================================================== */
/* ====== 5. è§¸æ§æŒ‰éµ (Touch Controls) =========================== */
/* =================================================================== */

.touch-controls {
    display: none; /* é è¨­éš±è—ï¼Œç”± JS åµæ¸¬è§¸æ§è£ç½®å¾Œé¡¯ç¤º */
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
    padding: 10px 0;
    width: 100%;
    z-index: 100;
}

/* --- è§¸æ§æŒ‰éµåŸºç¤æ¨£å¼ --- */
.touch-key {
    width: 70px;
    height: 70px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.95);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    cursor: pointer;
    user-select: none;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    border: 2px solid;
    transition: box-shadow 0.15s ease, transform 0.1s ease, filter 0.1s ease, background 0.15s ease;
}

/* --- å„æŒ‰éµé¡è‰²é…ç½® --- */
.touch-key[data-key="65"] {
    background: linear-gradient(135deg, rgba(0, 220, 220, 0.7), rgba(0, 100, 120, 0.8));
    border-color: rgba(80, 230, 230, 0.8);
    box-shadow: 0 0 15px rgba(0, 220, 220, 0.6);
}
.touch-key[data-key="83"] {
    background: linear-gradient(135deg, rgba(0, 201, 255, 0.7), rgba(0, 123, 255, 0.75));
    border-color: rgba(100, 220, 255, 0.8);
    box-shadow: 0 0 15px rgba(0, 201, 255, 0.6);
}
.touch-key[data-key="68"] {
    background: linear-gradient(135deg, rgba(210, 240, 255, 0.7), rgba(150, 210, 255, 0.8));
    border-color: rgba(220, 245, 255, 0.85);
    box-shadow: 0 0 18px rgba(180, 225, 255, 0.7);
}
.touch-key[data-key="70"] {
    background: linear-gradient(135deg, rgba(225, 230, 235, 0.7), rgba(170, 180, 190, 0.8));
    border-color: rgba(230, 235, 240, 0.8);
    box-shadow: 0 0 15px rgba(210, 215, 220, 0.7);
}

/* --- æŒ‰ä¸‹æ™‚çš„æ¿€æ´»æ•ˆæœ --- */
.touch-key:active, .touch-key.pressed {
    filter: brightness(1.3) saturate(1.2);
    box-shadow: 0 0 28px 5px;
}
.touch-key[data-key="65"]:active, .touch-key[data-key="65"].pressed { box-shadow: 0 0 28px 5px rgba(0, 220, 220, 0.8); }
.touch-key[data-key="83"]:active, .touch-key[data-key="83"].pressed { box-shadow: 0 0 28px 5px rgba(0, 201, 255, 0.8); }
.touch-key[data-key="68"]:active, .touch-key[data-key="68"].pressed { box-shadow: 0 0 28px 5px rgba(180, 225, 255, 0.85); }
.touch-key[data-key="70"]:active, .touch-key[data-key="70"].pressed { box-shadow: 0 0 28px 5px rgba(225, 230, 235, 0.9); }


/* =================================================================== */
/* ====== 6. å½ˆå‡ºè¦–çª— (Modals) =================================== */
/* =================================================================== */

/* --- å½ˆå‡ºè¦–çª—åŸºç¤æ¨£å¼ --- */
.game-over-modal,
.settings-modal,
.copyright-disclaimer-modal,
.personal-high-score-modal,
.music-player-modal,
.unlock-modal,
.notification-modal,
.lyrics-quiz-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
}
.game-over-modal.active,
.settings-modal.active,
.copyright-disclaimer-modal.active,
.personal-high-score-modal.active,
.music-player-modal.active,
.unlock-modal.active,
.notification-modal.active,
.lyrics-quiz-modal.active {
    opacity: 1;
    pointer-events: all;
}

/* --- å½ˆå‡ºè¦–çª—å…§å®¹çš„åŸºç¤å‹•ç•« --- */
.game-over-modal .game-over-content,
.settings-modal .settings-content,
.personal-high-score-modal .personal-high-score-content,
.unlock-modal .unlock-content,
.notification-modal .notification-content,
.lyrics-quiz-modal .quiz-content {
    transform: scale(0.8) translateY(20px);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
    box-sizing: border-box;
}
.game-over-modal.active .game-over-content,
.settings-modal.active .settings-content,
.personal-high-score-modal.active .personal-high-score-content,
.unlock-modal.active .unlock-content,
.notification-modal.active .notification-content,
.lyrics-quiz-modal.active .quiz-content {
    transform: scale(1) translateY(0);
    opacity: 1;
}

/* --- çµ±ä¸€çš„é—œé–‰æŒ‰éˆ•æ¨£å¼ --- */
.close-settings,
.close-personal-high-score,
.close-disclaimer,
.close-notification,
.quiz-close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    background: transparent;
    border: none;
    font-size: 2.2rem;
    font-weight: 400;
    line-height: 1;
    color: var(--starlight-text-secondary, #8c7d6b);
    cursor: pointer;
    transition: color 0.3s ease, transform 0.3s ease;
}
.close-settings:hover,
.close-personal-high-score:hover,
.close-disclaimer:hover,
.close-notification:hover,
.quiz-close-btn:hover {
    color: var(--starlight-text-primary, #3a332a);
    transform: rotate(90deg);
}


/* --- 6.1 é€šçŸ¥è¦–çª— (Notification Modal) --- */
.notification-modal {
    background: rgba(25, 40, 60, 0.7);
    backdrop-filter: blur(5px);
    z-index: 2000;
}
.notification-content {
    width: 90%;
    max-width: 400px;
    background: #f0f4f8;
    color: #334155;
    padding: 25px 30px;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    position: relative;
    border-left: 5px solid #64748b;
}
.notification-icon {
    font-size: 3.5rem;
    margin-bottom: 15px;
    animation: icon-pop 0.5s ease-out 0.3s backwards;
}
.notification-title {
    font-size: 1.6rem;
    margin-bottom: 8px;
    font-weight: 700;
}
.notification-message {
    font-size: 1rem;
    color: #64748b;
    line-height: 1.6;
}
.notification-message strong {
    font-weight: 700;
    color: #334155;
}
/* æˆåŠŸæ¨£å¼ */
.notification-content.success { border-left-color: #10b981; }
.notification-content.success .notification-icon { color: #10b981; }
.notification-content.success .notification-title { color: #059669; }
/* è³‡è¨Š/å¤±æ•—æ¨£å¼ */
.notification-content.info { border-left-color: #3b82f6; }
.notification-content.info .notification-icon { color: #3b82f6; }
.notification-content.info .notification-title { color: #2563eb; }


/* --- 6.2 éŠæˆ²çµæŸè¦–çª— (Game Over Modal) --- */
.game-over-modal {
    background: rgba(10, 20, 40, 0.7);
    backdrop-filter: blur(5px);
    z-index: 1000;
}
.game-over-content {
    background: linear-gradient(160deg, #1d2b4a, #11182c);
    width: 90%;
    max-width: 450px;
    padding: 30px 40px;
    border-radius: 20px;
    text-align: center;
    border: 1px solid rgba(255, 204, 0, 0.3);
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5), 0 0 25px rgba(255, 204, 0, 0.2) inset;
}
.game-over-title {
    font-size: 2.8rem;
    margin-bottom: 20px;
    color: #ffcc00;
    font-weight: 700;
    text-shadow: 0 0 15px rgba(255, 204, 0, 0.6);
}
.game-over-stats {
    display: flex;
    justify-content: space-around;
    margin: 25px 0;
    gap: 15px;
}
.game-over-stat {
    background: rgba(255, 255, 255, 0.05);
    padding: 15px;
    border-radius: 12px;
    flex: 1;
    min-width: 100px;
}
.stat-number {
    font-size: 2.2rem;
    font-weight: bold;
    color: #ff8a00;
}
.restart-btn {
    background: linear-gradient(45deg, #00c9ff, #92fe9d);
    color: #fff;
    border: none;
    padding: 14px 35px;
    border-radius: 50px;
    font-size: 1.2rem;
    font-weight: bold;
    cursor: pointer;
    margin-top: 20px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    text-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.restart-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 201, 255, 0.3);
}


/* --- 6.3 æ­Œè©å¡«å……æ¸¬é©—è¦–çª— (Lyrics Quiz Modal) --- */
.lyrics-quiz-modal {
    background: rgba(25, 40, 60, 0.85);
    backdrop-filter: blur(8px);
    z-index: 2500;
}
.quiz-content {
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    color: #343a40;
    padding: 30px 40px;
    border-radius: 20px;
    text-align: center;
    max-width: 500px;
    width: 90%;
    position: relative;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}
.quiz-title {
    font-size: 2.2rem;
    color: #17a2b8;
    margin-bottom: 10px;
    font-weight: 700;
}
.quiz-instructions {
    font-size: 1rem;
    color: #6c757d;
    margin-bottom: 20px;
}
.quiz-progress {
    background: #17a2b820;
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 25px;
    font-size: 1.1rem;
    font-weight: bold;
    color: #17a2b8;
    transition: all 0.3s ease;
    border: 1px solid #17a2b880;
}
.quiz-question-container {
    margin: 25px 0;
    padding: 25px;
    background: #ffffff;
    border-radius: 15px;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #dee2e6;
}
#quizQuestionText {
    font-size: 1.6rem;
    color: #212529;
    line-height: 1.6;
    letter-spacing: 1px;
    font-weight: 500;
}
.quiz-blank {
    display: inline-block;
    width: 100px;
    border-bottom: 2px solid #6c757d;
    margin: 0 4px;
    vertical-align: baseline; /* ç¢ºä¿åº•ç·šèˆ‡æ–‡å­—åŸºç·šå°é½Š */
}
.quiz-answer-input {
    width: 100%;
    padding: 15px;
    font-size: 1.2rem;
    border-radius: 12px;
    border: 2px solid #ced4da;
    background: #f8f9fa;
    color: #495057;
    text-align: center;
    transition: all 0.3s ease;
    box-sizing: border-box;
}
.quiz-answer-input:focus {
    outline: none;
    border-color: #17a2b8;
    box-shadow: 0 0 0 4px rgba(23, 162, 184, 0.25);
}
.quiz-answer-input.correct {
    border-color: #28a745;
    background-color: #e9f7ec;
}
.quiz-answer-input.incorrect {
    border-color: #dc3545;
    background-color: #fbebed;
    animation: shake 0.5s ease-in-out;
}
.quiz-submit-btn {
    width: 100%;
    padding: 15px 20px;
    font-size: 1.2rem;
    font-weight: bold;
    color: #fff;
    background: linear-gradient(45deg, #17a2b8, #138496);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.2s ease;
}
.quiz-submit-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
}
.quiz-submit-btn:disabled {
    background: #adb5bd;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}


/* --- 6.4 è¨­å®šã€æ’è¡Œæ¦œã€åˆ†æ•¸ã€è§£é–è¦–çª— ("æ˜Ÿå…‰æ®¿å ‚" ä¸»é¡Œ) --- */
.settings-modal,
.personal-high-score-modal,
.unlock-modal {
    background: rgba(0, 0, 0, 0.8);
    z-index: 1001;
}
.settings-content,
.personal-high-score-content,
.unlock-content {
    width: 90%;
    max-width: 500px;
    background: var(--starlight-bg);
    color: var(--starlight-text-primary);
    border-radius: 16px;
    border: 1px solid var(--starlight-border);
    box-shadow: 0 10px 35px rgba(0, 0, 0, 0.08), 0 0 20px var(--starlight-accent-glow) inset;
    padding: 30px;
    position: relative;
    text-align: center;
}

/* æ¨™é¡Œ */
.settings-title,
.personal-high-score-title,
.unlock-message {
    font-size: 2rem;
    color: var(--starlight-accent);
    font-weight: 700;
    text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
    margin-bottom: 25px;
}
#leaderboardTitle {
    color: #6a8eae; /* æ’è¡Œæ¦œæ¨™é¡Œç‰¹æ®Šé¡è‰² */
}
.unlock-icon {
    font-size: 4rem;
    color: var(--starlight-accent);
    margin-bottom: 20px;
}
.unlock-requirement {
    font-size: 1rem;
    color: var(--starlight-accent);
    margin-bottom: 30px;
}

/* è¡¨å–®èˆ‡æ§åˆ¶é … */
.setting-group {
    margin-bottom: 20px;
    text-align: left;
}
.setting-label {
    display: block;
    margin-bottom: 8px;
    font-size: 1.1rem;
    color: var(--starlight-text-secondary);
    font-weight: bold;
}
.setting-control {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    background: #f0f2f5;
    color: var(--starlight-text-primary);
    border: 1px solid #dde0e4;
    font-size: 1rem;
}
.setting-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    background: #4a5568;
    border-radius: 5px;
    outline: none;
    transition: opacity .2s;
    cursor: pointer;
}
.setting-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #e2e8f0;
    border-radius: 50%;
    border: 2px solid #718096;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}
.setting-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #e2e8f0;
    border-radius: 50%;
    border: 2px solid #718096;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}
.setting-group button.setting-control {
    text-align: center;
    cursor: pointer;
}

/* å„²å­˜æŒ‰éˆ• & é—œé–‰æŒ‰éˆ• */
.setting-group .restart-btn,
.close-unlock {
    background: var(--starlight-accent);
    color: white;
    border-radius: 50px;
    border: none;
    text-shadow: none;
    box-shadow: 0 4px 15px var(--starlight-accent-glow);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    padding: 10px 20px;
    font-size: 1rem;
    cursor: pointer;
    display: inline-block;
}
.setting-group .restart-btn:hover,
.close-unlock:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px var(--starlight-accent-glow);
}

/* --- 6.5 æ’è¡Œæ¦œåˆ—è¡¨ ("æ˜Ÿå¡µæ¦®è€€" ä¸»é¡Œ) --- */
#playerNameGroup {
    display: flex;
    align-items: center;
    gap: 12px;
    border: 1px solid var(--starlight-border);
    padding: 10px;
    border-radius: 50px;
    background: rgba(255, 255, 255, 0.5);
    margin-bottom: 25px;
}
#playerNameGroup .setting-label {
    display: none;
}
#playerNameGroup .setting-control {
    flex-grow: 1;
    border: none;
    background: transparent;
    padding: 8px 15px;
    font-size: 1.1rem;
}
#playerNameGroup .setting-control:focus {
    outline: none;
}
#savePlayerNameBtn {
    width: 48px;
    height: 48px;
    padding: 0;
    flex-shrink: 0;
    border-radius: 50%;
    background: #8db592; /* é¼ å°¾è‰ç¶  */
    color: white;
    font-size: 1.5rem;
    border: none;
    box-shadow: 0 4px 12px rgba(141, 181, 146, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}
#savePlayerNameBtn::before {
    content: 'âœ”';
    font-weight: bold;
}
#savePlayerNameBtn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 18px rgba(106, 142, 174, 0.4);
}
#savePlayerNameBtn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}
#savePlayerNameBtn.loading::before {
    content: '';
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.leaderboard-display {
    margin-top: 20px;
}
.personal-high-score-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.personal-high-score-item, .leaderboard-item {
    background: var(--starlight-item-bg);
    border-left: 4px solid var(--starlight-accent);
    margin-bottom: 10px;
    border-radius: 8px;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    gap: 15px;
}
.personal-high-score-item:hover, .leaderboard-item:hover {
    background: var(--starlight-item-hover-bg);
    transform: scale(1.03) translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
}
.personal-high-score-label {
    font-weight: 500;
    color: var(--starlight-text-primary);
}
.personal-high-score-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--starlight-accent);
}

.leaderboard-rank {
    flex-basis: 50px;
    flex-shrink: 0;
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    color: var(--starlight-text-secondary);
}
.leaderboard-name {
    flex-grow: 1;
    font-size: 1.1rem;
    font-weight: 500;
    color: var(--starlight-text-primary);
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.leaderboard-score {
    flex-basis: 100px;
    flex-shrink: 0;
    font-size: 1.4rem;
    font-weight: bold;
    color: var(--starlight-accent);
    text-align: right;
}

/* å‰ä¸‰åç‰¹æ®Šæ¨£å¼ */
.leaderboard-item:nth-child(1) { background: linear-gradient(100deg, rgba(212, 175, 55, 0.15), transparent 70%); border-color: var(--rank-gold); box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2); }
.leaderboard-item:nth-child(1) .leaderboard-rank { color: var(--rank-gold); text-shadow: 0 0 8px rgba(212, 175, 55, 0.7); font-size: 0; }
.leaderboard-item:nth-child(1) .leaderboard-rank::before { content: 'ğŸ‘‘'; position: absolute; font-size: 1.8rem; opacity: 0.9; filter: drop-shadow(var(--rank-icon-shadow)); }
.leaderboard-item:nth-child(2) { background: linear-gradient(100deg, rgba(192, 192, 192, 0.15), transparent 70%); border-color: var(--rank-silver); }
.leaderboard-item:nth-child(2) .leaderboard-rank { color: var(--rank-silver); text-shadow: 0 0 6px rgba(192, 192, 192, 0.7); font-size: 0; }
.leaderboard-item:nth-child(2) .leaderboard-rank::before { content: 'ğŸ¥ˆ'; position: absolute; font-size: 1.6rem; filter: drop-shadow(var(--rank-icon-shadow)); }
.leaderboard-item:nth-child(3) { background: linear-gradient(100deg, rgba(205, 127, 50, 0.15), transparent 70%); border-color: var(--rank-bronze); }
.leaderboard-item:nth-child(3) .leaderboard-rank { color: var(--rank-bronze); text-shadow: 0 0 5px rgba(205, 127, 50, 0.7); font-size: 0; }
.leaderboard-item:nth-child(3) .leaderboard-rank::before { content: 'ğŸ¥‰'; position: absolute; font-size: 1.6rem; filter: drop-shadow(var(--rank-icon-shadow)); }


/* --- 6.6 ç‰ˆæ¬Šè²æ˜è¦–çª— (Copyright Modal) --- */
.copyright-disclaimer-modal {
    background: rgba(0, 0, 0, 0.85);
    z-index: 1005;
}
.disclaimer-content {
    background: linear-gradient(135deg, #2c1810, #1a1a2e);
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
    max-width: 500px;
    width: 90%;
    position: relative;
    text-align: left;
    border: 1px solid rgba(255, 215, 0, 0.2);
    animation: modalPop 0.5s ease-out;
}
.disclaimer-title {
    font-size: 2rem;
    margin-bottom: 30px;
    text-align: center;
    color: #FFD700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}
.disclaimer-section {
    margin-bottom: 25px;
    padding: 20px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 15px;
    border-left: 4px solid #FFD700;
}
.disclaimer-section h3 {
    color: #FFD700;
    margin-bottom: 10px;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}
.disclaimer-section p {
    color: #e0e0e0;
    line-height: 1.6;
    font-size: 1.1rem;
}


/* --- 6.7 éŸ³æ¨‚æ’­æ”¾å™¨ (Music Player Modal) --- */
.music-player-modal {
    background-color: #0b192f;
    background-image: 
        radial-gradient(at 20% 80%, hsla(190, 80%, 50%, 0.3), transparent 50%),
        radial-gradient(at 80% 10%, hsla(170, 70%, 60%, 0.25), transparent 50%),
        radial-gradient(at 90% 20%, hsla(40, 90%, 70%, 0.35), transparent 60%),
        radial-gradient(at 10% 40%, hsla(45, 80%, 75%, 0.25), transparent 70%);
    flex-direction: column;
    z-index: 1003;
}
.music-player-content {
    width: 90%;
    max-width: 800px;
    text-align: center;
    padding: 30px;
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border-radius: 20px;
    border: 1px solid rgba(230, 180, 80, 0.5);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2), 0 0 20px rgba(230, 180, 80, 0.2);
    max-height: 90vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}
.music-player-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}
.close-music-player {
    background: none;
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 5px;
    transition: background 0.3s ease;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.close-music-player:hover { background: rgba(255, 255, 255, 0.1); }
.close-music-player-icon { width: 100%; height: 100%; fill: white; }

.cd-cover-container {
    width: 100%;
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    padding: 0 10px;
}
.cd-cover-wrapper {
    position: relative;
    width: 100%;
    max-width: 300px;
    aspect-ratio: 1 / 1;
    border-radius: 50%;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
}
.cd-cover-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
    border-radius: 50%;
    transform-origin: center;
}
.cd-cover-img.playing { animation: cdSpin 15s linear infinite; }
.cd-cover-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0) 100%);
    pointer-events: none;
}

.now-playing {
    font-size: 1.5rem;
    margin-bottom: 20px;
    color: #2c3e50;
    font-weight: 600;
}
.lyrics-container {
    height: 250px;
    overflow-y: auto;
    margin-bottom: 20px;
    font-size: 1.1rem;
}
.lyric-line {
    margin: 10px 0;
    color: #a3a3a3;
    opacity: 0.7;
    transition: all 0.3s ease;
}
.lyric-line.active {
    opacity: 1;
    font-weight: bold;
    color: #17a2b8;
    transform: scale(1.05);
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
}
.no-lyrics { color: #aaa; font-style: italic; }

.player-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}
.player-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #2c3e50;
    font-size: 2rem;
    cursor: pointer;
    width: 55px;
    height: 55px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    border-radius: 50%;
    transition: background 0.3s ease, transform 0.2s ease;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.player-btn:hover { background: rgba(255, 255, 255, 0.4); }

.progress-slider {
    width: 100%;
    height: 8px;
    -webkit-appearance: none;
    background: rgba(140, 115, 70, 0.3);
    border-radius: 4px;
    outline: none;
}
.progress-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #17a2b8;
    border: 1px solid rgba(0,0,0,0.1);
    cursor: pointer;
}
.time-display {
    display: flex;
    justify-content: space-between;
    width: 100%;
    margin-bottom: 20px;
    font-size: 0.9rem;
    color: #ccc;
}
.volume-control-player {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    justify-content: center;
}
.volume-control-player input[type="range"] {
    width: 150px;
}
.playlist {
    list-style: none;
    padding: 10px;
    margin-top: 30px;
    max-height: 200px;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
}
.playlist-item {
    padding: 12px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
    text-align: left;
    color: #e1d4dd;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}
.playlist-item:last-child { border-bottom: none; }
.playlist-item:hover { background: rgba(255, 255, 255, 0.1); }
.playlist-item.active { background: rgba(23, 162, 184, 0.2); color: #2c3e50; font-weight: bold; }
.playlist-item.locked { color: #888; cursor: not-allowed; opacity: 0.7; }
.playlist-item.disabled { opacity: 0.5; color: #888; text-decoration: line-through; }


/* =================================================================== */
/* ====== 7. å‹•ç•«æ•ˆæœ (Animations) =============================== */
/* =================================================================== */

@keyframes fall {
    from { transform: translateY(-50px); }
    to { transform: translateY(650px); }
}
@keyframes judgmentFade {
    0% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-40px); }
}
@keyframes comboFlash {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
}
@keyframes comboFlashRainbow {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(1.5); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
}
@keyframes rainbowText {
    0% { background-position: 0% 50%; }
    100% { background-position: 100% 50%; }
}
@keyframes rainbowGlow {
    0% { box-shadow-color: rgba(255, 0, 0, 0.7); }
    16.66% { box-shadow-color: rgba(255, 255, 0, 0.7); }
    33.33% { box-shadow-color: rgba(0, 255, 0, 0.7); }
    50% { box-shadow-color: rgba(0, 255, 255, 0.7); }
    66.66% { box-shadow-color: rgba(0, 0, 255, 0.7); }
    83.33% { box-shadow-color: rgba(255, 0, 255, 0.7); }
    100% { box-shadow-color: rgba(255, 0, 0, 0.7); }
}
@keyframes trackFlash {
    0% { background-color: rgba(255, 255, 255, 0.35); }
    100% { background-color: rgba(255, 255, 255, 0.15); }
}
@keyframes hitLinePulse {
    0% { transform: scaleX(1); box-shadow: 0 0 10px rgba(229, 46, 113, 0.7); }
    50% { transform: scaleX(1.1); box-shadow: 0 0 30px 8px rgba(255, 204, 0, 1); }
    100% { transform: scaleX(1); box-shadow: 0 0 10px rgba(229, 46, 113, 0.7); }
}
@keyframes particleBurst {
    0% { transform: translateY(0) scale(1) rotate(var(--rot, 0deg)); opacity: 1; }
    100% { transform: translateY(var(--y)) translateX(var(--x)) scale(0) rotate(var(--rot-end, 360deg)); opacity: 0; }
}
@keyframes noteDecompose {
    0% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; }
    100% { transform: translate(var(--x), var(--y)) scale(0.2) rotate(var(--rot-end, 360deg)); opacity: 0; }
}
@keyframes modalPop {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
@keyframes icon-pop {
    0% { transform: scale(0); }
    80% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
    20%, 40%, 60%, 80% { transform: translateX(8px); }
}
@keyframes cdSpin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
@keyframes trackFlashPerfect {
    0% { background-color: rgba(255, 204, 0, 0.5); }
    100% { background-color: rgba(255, 255, 255, 0.15); }
}
@keyframes trackFlashGreat {
    0% { background-color: rgba(0, 204, 255, 0.5); }
    100% { background-color: rgba(255, 255, 255, 0.15); }
}
@keyframes trackFlashGood {
    0% { background-color: rgba(0, 255, 153, 0.5); }
    100% { background-color: rgba(255, 255, 255, 0.15); }
}


/* =================================================================== */
/* ====== 8. éŸ¿æ‡‰å¼è¨­è¨ˆ (Responsive Design) ===================== */
/* =================================================================== */

/* --- å¹³æ¿ & æ›´å°è¢å¹• (æœ€å¤§ 1024px) --- */
@media (max-width: 1024px) {
    h1 { font-size: 2.2rem; }
    .subtitle { font-size: 1.1rem; }
    .tracks { height: 550px; }
    .track { width: 70px; }
    .note, .long-note { width: 60px; height: 30px; }
    .hit-line { bottom: 100px; }
    .judgment { font-size: 2.2rem; bottom: 170px; }
    .combo-display { font-size: 3.2rem; top: 25%; }
    .music-select-wrapper select,
    .difficulty-selector select { font-size: 1rem; }
    
    .lyrics-side { width: 120px; font-size: clamp(0.9rem, 8vw, 1.2rem); }
    .lyrics-left { left: calc(50% - 172px - 120px); }
    .lyrics-right { right: calc(50% - 172px - 120px); }
    
    .lyrics-background { font-size: 4rem; }
    .lyrics-background span { min-width: 12.5%; min-height: 12vh; }
    
    .music-player-content { max-width: 700px; padding: 25px 30px; }
    .lyrics-container { font-size: 1.4rem; min-height: 150px; }
    .playlist { flex: 0 1 auto; max-height: 300px; min-height: 150px; }
    
    .cd-cover-wrapper { max-width: 230px; }
}

/* --- æ‰‹æ©Ÿ (æœ€å¤§ 768px) --- */
@media (max-width: 768px) {
    h1 { font-size: 2rem; }
    .tracks { height: 500px; }
    .track { width: 60px; }
    .note, .long-note { width: 50px; height: 25px; }
    .hit-line { bottom: 90px; }
    .music-select-wrapper select { max-width: 150px; }
    .difficulty-selector select { max-width: 100px; }
    .game-ui { padding-bottom: 50px; }
    .game-lyrics-container { top: 5%; font-size: 1rem; }

    .lyrics-side { width: 80px; font-size: clamp(0.7rem, 6vw, 1rem); opacity: 0.3; }
    .lyrics-left { left: calc(50% - 172px - 80px); }
    .lyrics-right { right: calc(50% - 172px - 80px); }

    .lyrics-background { font-size: 3.5rem; }
    .lyrics-background span { min-width: 16.66%; min-height: 15vh; }
    
    .music-player-content { padding: 15px; }
    .lyrics-container { height: auto; font-size: 1.2rem; flex: 1; min-height: 120px; }
    .playlist { max-height: 150px; flex-shrink: 0; }
    .player-btn { font-size: 1.5rem; }
    .play-pause-btn { font-size: 2rem; }
    .cd-cover-wrapper { max-width: 220px; }
}

/* --- å°å‹æ‰‹æ©Ÿ (æœ€å¤§ 480px) --- */
@media (max-width: 480px) {
    h1 { font-size: 1.7rem; }
    .game-ui {
        justify-content: space-around;
        gap: 5px;
        flex-wrap: wrap;
    }
    .stats, .controls {
        flex-shrink: 1;
        flex-wrap: wrap;
        justify-content: center;
    }
    .music-select-wrapper select { padding: 6px 30px 6px 10px; font-size: 0.8rem; max-width: 120px; }
    .stat-box { padding: 6px 10px; min-width: 80px; }
    .stat-value { font-size: 1.3rem; }
    .tracks { height: 400px; }
    .track { width: 50px; }
    .note, .long-note { width: 40px; }
    .hit-line { bottom: 80px; }
    .difficulty-selector select { max-width: 80px; font-size: 0.8rem; padding: 4px 6px; }

    .lyrics-side { width: 60px; font-size: clamp(0.6rem, 5vw, 0.8rem); }
    .lyrics-left { left: calc(50% - 172px - 60px); }
    .lyrics-right { right: calc(50% - 172px - 60px); }

    .lyrics-background { font-size: 3rem; }
    .lyrics-background span { min-width: 25%; min-height: 20vh; }

    .music-player-content { padding: 10px 15px; max-height: 90vh; }
    .music-player-header { flex-direction: column; gap: 10px; }
    .now-playing { font-size: 1.1rem; }
    .cd-cover-wrapper { max-width: 180px; margin-bottom: 15px; }
    .player-controls { gap: 15px; }
    .player-btn { width: 45px; height: 45px; font-size: 1.2rem; padding: 0; }
    .play-pause-btn { width: 60px; height: 60px; font-size: 1.8rem; }
    .volume-control-player { flex-direction: column; gap: 5px; }
    .volume-control-player input[type="range"] { width: 100%; }
    .time-display { font-size: 0.8rem; }

    /* å½ˆå‡ºè¦–çª—çµ±ä¸€èª¿æ•´ */
    .notification-content,
    .game-over-content,
    .quiz-content,
    .settings-content,
    .personal-high-score-content,
    .unlock-content {
        padding: 20px 15px;
    }
    .notification-title, .quiz-title, .settings-title, .personal-high-score-title, .unlock-message {
        font-size: 1.8rem;
    }
    .game-over-title { font-size: 2.2rem; }
    .game-over-stats { flex-direction: column; gap: 10px; }
    .stat-number { font-size: 2rem; }
    .restart-btn { padding: 12px 30px; font-size: 1.1rem; }
    #quizQuestionText { font-size: 1.3rem; }
    .quiz-blank { width: 70px; }
    .quiz-answer-input, .quiz-submit-btn { font-size: 1.1rem; padding: 12px; }

    #playerNameGroup { flex-direction: column; border-radius: 20px; padding: 15px; }
    #playerNameInput { width: 100%; text-align: center; }
    #savePlayerNameBtn { width: 100%; border-radius: 25px; }
    #savePlayerNameBtn::before { content: 'å„²å­˜'; }
    .leaderboard-name { font-size: 1rem; }
    .leaderboard-score { font-size: 1.1rem; }
}

/* --- è¶…å¤§è¢å¹• (æœ€å° 1025px) --- */
@media (min-width: 1025px) {
    .lyrics-background { font-size: 4.5rem; }
    .lyrics-background span { min-width: 8.33%; min-height: 8vh; }
    .playlist { max-height: 400px; }
}
</style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
</head>
<body>
    <div class="lyrics-background" id="lyricsBackground"></div>  <!-- ç§»åˆ°é€™è£¡ -->
    <!-- Background Image -->
    <div class="background-image"></div>
    <div class="container">
        <div class="main-game-container" id="mainGameContainer">
            <div class="game-container">
                <div class="game-ui">
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value" id="score">0</div>
                            <div class="stat-label">åˆ†æ•¸</div>
                        </div>


<!-- â–¼â–¼â–¼ ã€ä¿®è¨‚ã€‘å°‡åŸæœ‰çš„å–®ä¸€æ¨™è¨˜ç·šæ”¹ç‚ºå…©å€‹ç¨ç«‹çš„æ¨™è¨˜ç·š â–¼â–¼â–¼ -->
<div id="unlockProgressContainer" class="unlock-progress-container">
    <!-- æ­Œæ›²è§£é–ç·š (é»ƒè‰²) -->
    <div id="songUnlockMarker" class="unlock-progress-marker song-marker"></div>
    <!-- é›£åº¦è§£é–ç·š (ç´…è‰²) -->
    <div id="difficultyUnlockMarker" class="unlock-progress-marker difficulty-marker"></div>
    
    <div id="unlockProgressBar" class="unlock-progress-bar"></div>

</div>
<!-- â–²â–²â–² ä¿®è¨‚çµæŸ â–²â–²â–² -->


                    </div>




                    <div class="controls">
                        <button class="svg-button" id="startBtn" title="é–‹å§‹éŠæˆ²">
                            <svg class="start-button-svg" viewBox="0 0 80 40">
                                <defs>
                                    <linearGradient id="startButtonGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#ff8a00;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#e52e71;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect x="0" y="0" width="80" height="40" rx="20" ry="20" fill="url(#startButtonGradient)" />
                                <path d="M30 12 L30 28 L50 20 Z" fill="white"/>
                            </svg>
                        </button>
                        <button class="settings-btn" id="settingsBtn" title="è¨­å®š">
                            <svg class="settings-icon" viewBox="0 0 24 24">
                                <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                            </svg>
                        </button>


                        
                        <button class="music-player-btn" id="musicPlayerBtn" title="éŸ³æ¨‚æ’­æ”¾å™¨">
                             <svg class="music-player-icon" viewBox="0 0 24 24">
                                <path d="M12,3V13.55C11.41,13.21 10.73,13 10,13C7.79,13 6,14.79 6,17C6,19.21 7.79,21 10,21C12.21,21 14,19.21 14,17V7H18V3H12Z" />
                            </svg>
                        </button>
                    </div>
                    <div class="music-selector">
                        <div class="music-select-wrapper">
                            <select id="musicSelect">
                                <option value="ç™½å½±.mp3">ç™½å½±</option>
                                <option value="ç­‰å¾….mp3">ç­‰å¾…</option>
                                <option value="ä¸‹ä¸€æçš„æƒ†æ‚µ.mp3">ä¸‹ä¸€æçš„æƒ†æ‚µ</option>
                                <option value="é¤˜ç‡¼è½å…¥è™›ç„¡.mp3">é¤˜ç‡¼è½å…¥è™›ç„¡</option>
                                <option value="è€å±‹å›æ†¶.mp3">è€å±‹å›æ†¶</option>
                                <option value="battle-abysswalker.mp3">The Abysswalker</option>
                                <option value="Battle-Rosemoon.mp3">éƒ½æˆ°ä¹™å¥³</option>
                                <option value="Battle-deadly.mp3">äº”å¤§ç½ª</option>
                                <option value="Battle-rapier.mp3">ç¹¼æ‰¿åŠçš„å°‘å¥³</option>
                                <option value="Ariadne-Battle.mp3">ä¸å±ˆæ„å¿—ä¹‹åˆƒ</option>
                                <option value="battle-arms.mp3">è¥¿éƒ¨æˆ°é¬¥</option>
                                <option value="Battle.mp3">Battle Theme</option>
                                <option value="Wanderers-City.mp3">æµæµªåŸé®</option>
                                <option value="Remotest-Liblary.mp3">æ²‰ç¡çš„è¨˜æ†¶</option>
                                <option value="Nostalgia.mp3">éº¥ç”°æ‡·èˆŠ</option>
                                <option value="sunbeams.mp3">æ”¾å­¸å¾Œ</option>
                                <option value="village.mp3">é„‰æ‘ç”Ÿæ´»</option>
                                <option value="Take-a-Rest.mp3">ä¼‘æ¯ä¸€ä¸‹</option>
                                <option value="winter-snow.mp3">é›ªé„‰</option>
                                <option value="Forgotten-Place.mp3">è¢«éºå¿˜çš„åœ°æ–¹</option>
                                <option value="Rest-in-Peace.mp3">å®‰æ¯</option>
                                <option value="Farewell.mp3">å‘Šåˆ¥</option>
                                <option value="reminiscence.mp3">å›æ†¶</option>
                                <option value="starry-night.mp3">æ˜Ÿå¤œ</option>
                                <option value="last-wish.mp3">ç•¶æ€å¿µå‚³åˆ°æŸäººè€³ç•”</option>
                                <option value="sorrow.mp3">è¶…è¶Šæ‚²å‚·</option>
                                <option value="hotarumichi.mp3">è¢ç«èŸ²ä¹‹è·¯</option>
                                <option value="Sky-Airship.mp3">é£›è‰‡</option>
                                <option value="Voyage_SE.mp3">è·¨è¶Šç¥ç§˜ä¹‹æµ·</option>
                                <option value="main-theme01.mp3">ç›¼æœ›</option>
                                <option value="saikai637.mp3">ç´„å®šä¹‹åœ°</option>
                            </select>
                            <svg class="music-icon" viewBox="0 0 24 24">
                                <path d="M12,3V13.55C11.41,13.21 10.73,13 10,13C7.79,13 6,14.79 6,17C6,19.21 7.79,21 10,21C12.21,21 14,19.21 14,17V7H18V3H12Z" />
                            </svg>
                        </div>
                        <button class="personal-high-score-btn" id="personalHighScoreBtn" title="æŸ¥çœ‹å€‹äººæœ€é«˜åˆ†æ•¸">
                            <svg class="personal-high-score-icon" viewBox="0 0 24 24">
                                <path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" />
                            </svg>
                        </button>

<!-- åœ¨ id="settingsBtn" çš„æŒ‰éˆ•å¾Œé¢åŠ å…¥é€™æ®µ -->
<button class="personal-high-score-btn" id="leaderboardBtn" title="æ­Œæ›²æ’è¡Œæ¦œ">
    <svg class="personal-high-score-icon" viewBox="0 0 24 24">
        <path d="M16 11V3H8V11H2V21H22V11H16M14 5H10V9H14V5M20 13H18V15H20V13M20 17H18V19H20V17M12 13H4V19H12V13Z" />
    </svg>
</button>



                        
                    </div>
                    <div class="difficulty-selector">
                        
                        <select id="difficultySelect">
                            <option value="easy">ç°¡å–®</option>
                            <option value="normal" selected>æ™®é€š</option>
                            <option value="hard">å›°é›£</option>
                            <option value="hell">åœ°ç„</option>
                        </select>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
               <div class="game-area">
    <div class="tracks" id="tracksContainer"></div>
   
    
    <!-- è§¸æ§æŒ‰éµ (åƒ…åœ¨è§¸æ§è£ç½®ä¸Šé¡¯ç¤º) -->
    <div class="touch-controls" id="touchControls">
        <div class="touch-key" data-key="65">A</div>
        <div class="touch-key" data-key="83">S</div>
        <div class="touch-key" data-key="68">D</div>
        <div class="touch-key" data-key="70">F</div>
    </div>
</div>
            </div>
        </div>
    </div>

<!-- Notification Modal -->
    <div class="notification-modal" id="notificationModal">
        <div class="notification-content">
            <button class="close-notification" id="closeNotification">&times;</button>
            <div class="notification-icon" id="notificationIcon"></div>
            <h2 class="notification-title" id="notificationTitle"></h2>
            <p class="notification-message" id="notificationMessage"></p>
        </div>
    </div>


    
    <div class="game-over-modal" id="gameOverModal">
        <div class="game-over-content">
            <h2 class="game-over-title">éŠæˆ²çµæŸ</h2>
            <div class="game-over-stats">
                <div class="game-over-stat">
                    <div class="stat-label">æœ€çµ‚åˆ†æ•¸</div>
                    <div class="stat-number" id="finalScore">0</div>
                </div>
                <div class="game-over-stat">
                    <div class="stat-label">æœ€é«˜é€£æ“Š</div>
                    <div class="stat-number" id="finalCombo">0</div>
                </div>
            </div>
            <button class="restart-btn" id="restartBtn">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <button class="close-settings" id="closeSettings">&times;</button>
            <h2 class="settings-title">éŠæˆ²è¨­å®š</h2>
           
            <div class="setting-group">
                <label class="setting-label" for="volumeControlModal">éŸ³æ¨‚éŸ³é‡:</label>
                <input type="range" class="setting-control setting-slider" id="volumeControlModal" min="0" max="1" step="0.01" value="0.7">
            </div>
            <div class="setting-group">
                <label class="setting-label" for="sfxVolumeControl">éŸ³æ•ˆéŸ³é‡:</label>
                <input type="range" class="setting-control setting-slider" id="sfxVolumeControl" min="0" max="1" step="0.01" value="0.5">
            </div>

<div class="setting-group">
    <button class="setting-control" id="showDisclaimerBtn">æŸ¥çœ‹éŸ³æ¨‚ç‰ˆæ¬Šè²æ˜</button>
</div>




        </div>
    </div>

    <!-- Personal High Score Modal -->
    <div class="personal-high-score-modal" id="personalHighScoreModal">
        <div class="personal-high-score-content">
            <button class="close-personal-high-score" id="closePersonalHighScore">&times;</button>
            <h2 class="personal-high-score-title">å€‹äººæœ€é«˜åˆ†æ•¸</h2>
            <ul class="personal-high-score-list" id="personalHighScoreList">
                <!-- Scores will be populated here -->
            </ul>
        </div>
    </div>

    <!-- Music Player Modal -->
    <div class="music-player-modal" id="musicPlayerModal">
        <div class="music-player-content">
            <div class="music-player-header">
                <!-- Removed <h1 class="music-player-title">éŸ³æ¨‚æ’­æ”¾å™¨</h1> -->
                <button class="close-music-player" id="closeMusicPlayer" title="è¿”å›">
                    <svg class="close-music-player-icon" viewBox="0 0 24 24">
                        <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
                    </svg>
                </button>
            </div>


<!-- CD Cover Container -->
<div class="cd-cover-container">
    <div class="cd-cover-wrapper">
        <img id="cdCoverImage" src="https://i.ibb.co/G4Rmgzjt/image.png" alt="CD Cover" class="cd-cover-img">
        <div class="cd-cover-overlay"></div>
    </div>
</div>


            <div class="now-playing" id="nowPlaying">æ­£åœ¨æ’­æ”¾: ç„¡</div>
            <div class="lyrics-container" id="lyricsContainer">
                <div class="no-lyrics">ç„¡æ­Œè©</div>
            </div>
            <div class="player-controls">
                <button class="player-btn" id="prevBtn" title="ä¸Šä¸€é¦–" disabled>&#9664;&#9664;</button>
                <button class="player-btn play-pause-btn" id="playPauseBtn" title="æ’­æ”¾/æš«åœ">&#9658;</button>
                <button class="player-btn" id="nextBtn" title="ä¸‹ä¸€é¦–" disabled>&#9654;&#9654;</button>
            </div>
            <div class="progress-slider-container">
                <input type="range" class="progress-slider" id="progressSlider" min="0" max="100" value="0">
            </div>
            <div class="time-display">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
            </div>
            <div class="volume-control-player">
                <label for="volumeSliderPlayer">éŸ³é‡:</label>
                <input type="range" class="setting-slider" id="volumeSliderPlayer" min="0" max="1" step="0.01" value="0.7">
            </div>
            <ul class="playlist" id="playlist">
                <!-- Playlist items will be populated here -->
            </ul>
        </div>
    </div>

    <!-- Unlock Modal -->
    <div class="unlock-modal" id="unlockModal">
        <div class="unlock-content">
            <div class="unlock-icon">&#128274;</div> <!-- Lock Emoji -->
            <h2 class="unlock-message">æ­¤é …ç›®å°šæœªè§£é–</h2>
            <p class="unlock-requirement" id="unlockRequirement">åœ¨æ™®é€šæ¨¡å¼ä¸‹é”åˆ° 40000 åˆ†ä»¥è§£é–ã€‚</p>
            <button class="close-unlock" id="closeUnlock">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

// ==========================================================
// ====== ã€æ–°å¢ã€‘Firebase åˆå§‹åŒ–èˆ‡æ’è¡Œæ¦œç›¸é—œè¨­å®š ======
// ==========================================================

// ä½ çš„ Firebase è¨­å®šç‰©ä»¶
const firebaseConfig = {
  apiKey: "AIzaSyD0J56yq_QjjzAZuhAEqE3SVU0GePS2l-0",
  authDomain: "musicgame-7dad1.firebaseapp.com",
  projectId: "musicgame-7dad1",
  storageBucket: "musicgame-7dad1.firebasestorage.app",
  messagingSenderId: "720961310659",
  appId: "1:720961310659:web:4959c7269b0adbed5ab776"
};

// åˆå§‹åŒ– Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// é«’è©±éæ¿¾åˆ—è¡¨ (å¯æŒçºŒæ“´å……)
const profanityList = [
    // ç²µèª
    "å±Œ", "å±Œä½ ", "ä»†è¡—", "å†šå®¶å‰·", "on9", "æ’š", "é³©", "æŸ’", "onL9",
    // æ™®é€šè©±
    "æ“", "è‰æ³¥é©¬", "å‚»é€¼", "è‚", "åª½çš„", "ä»–åª½çš„", "æˆ‘é ", "å°¼ç›"
];

// ç©å®¶ç‹€æ…‹è®Šæ•¸
let playerName = localStorage.getItem('musicGamePlayerName') || '';

// ==========================================================
// ====== ã€æ–°å¢çµæŸã€‘ ========================================
// ==========================================================

            
           // --- Constants and Configuration ---
// [ä¿®è¨‚] æ­Œæ›²è§£é–æ¢ä»¶ï¼šéœ€è¦é”åˆ°æ™®é€šé›£åº¦æœ€é«˜åˆ†çš„ 80%
const SONG_UNLOCK_PERCENTAGE = 0.75; 
// [ä¿®è¨‚] é›£åº¦è§£é–æ¢ä»¶ï¼šéœ€è¦é”åˆ°ç•¶å‰é›£åº¦æœ€é«˜åˆ†çš„ 100%
const DIFFICULTY_UNLOCK_PERCENTAGE = 0.85;

const difficultySettings = {
    // Easy é›£åº¦ï¼šé•·éŸ³ç¬¦è¼ƒé•·ï¼ŒéŸ³ç¬¦é–“è·å¤§ï¼ŒéŠç©é«”é©—è¼•é¬†
    easy: { 
        speedMultiplier: 0.9, longNoteChance: 0.2, noteDensity: 2.0, maxSimultaneous: 3, cooldown: 400,
        longNoteMinMultiplier: 2.5, // é•·éŸ³ç¬¦æœ€çŸ­æ˜¯ 2.5 å€åŸºç¤é–“éš”
        longNoteMaxMultiplier: 8,   // é•·éŸ³ç¬¦æœ€é•·æ˜¯ 8 å€åŸºç¤é–“éš”
        visualGap: 70               // ç‰©ç†é–“éš™ 70 åƒç´ 
    },
    // Normal é›£åº¦ï¼šæ¨™æº–è¨­å®š
    normal: { 
        speedMultiplier: 1.1, longNoteChance: 0.25, noteDensity: 3.5, maxSimultaneous: 8, cooldown: 150,
        longNoteMinMultiplier: 2,
        longNoteMaxMultiplier: 6,
        visualGap: 50
    },
    // ã€ä¿®è¨‚ã€‘Hard é›£åº¦ï¼šé€²ä¸€æ­¥ç¸®çŸ­é•·éŸ³ç¬¦æœ€å¤§é•·åº¦
    hard: { 
        speedMultiplier: 1.6, longNoteChance: 0.30, noteDensity: 4.5, maxSimultaneous: 4, cooldown: 100,
        longNoteMinMultiplier: 2,
        longNoteMaxMultiplier: 3.5,   // å¾ 4 ç¸®çŸ­è‡³ 3.5
        visualGap: 25               
    },
    // ã€ä¿®è¨‚ã€‘Hell é›£åº¦ï¼šå¤§å¹…ç¸®çŸ­é•·éŸ³ç¬¦æœ€å¤§é•·åº¦ï¼Œä½¿å…¶æ›´åƒä¸€å€‹ã€Œç¨é•·çš„çŸ­éŸ³ç¬¦ã€
    hell: { 
        speedMultiplier: 2.2, longNoteChance: 0.35, noteDensity: 5.0, maxSimultaneous: 4, cooldown: 50,
        longNoteMinMultiplier: 1.5, 
        longNoteMaxMultiplier: 2.5,   // å¾ 3 å¤§å¹…ç¸®çŸ­è‡³ 2.5ï¼Œæ¥è¿‘æ‚¨æåˆ°çš„ baseInterval * 2
        visualGap: 10               
    }
};
            // Max possible scores for each song and difficulty (for display purposes)
            const maxPossibleScores = {
                "Battle-Abysswalker.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle-Rosemoon.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle-deadly.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle-rapier.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Ariadne-Battle.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "battle-arms.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Wanderers-City.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Remotest-Liblary.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Nostalgia.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "sunbeams.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "village.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Take-a-Rest.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "winter-snow.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Forgotten-Place.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Rest-in-Peace.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Farewell.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "reminiscence.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "starry-night.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "last-wish.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "sorrow.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "hotarumichi.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Sky-Airship.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Voyage_SE.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "main-theme01.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "saikai637.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                }
            };

           // è«‹ç”¨é€™æ®µç¨‹å¼ç¢¼å®Œæ•´æ›¿æ›èˆŠçš„ songLyrics ç‰©ä»¶
const songData = {
    "ç­‰å¾….mp3": {
        lyrics: [
            { "time": 9, "text": "æœˆäº®é«˜æ›åœ¨å¤œç©ºä¹‹ä¸Š" },
            { "time": 13, "text": "å®›å¦‚ä¸çœ çš„çœ¼ç›ä¸€æ¨£" },
            { "time": 17, "text": "éœéœæ³¨è¦–è‘—å–§å›‚çš„äººé–“" },
            { "time": 21, "text": "æœ‰å¤šå°‘æ‚²æ­¡é›¢åˆåœ¨ä¸Šæ¼”" },
            { "time": 27, "text": "å®ƒå®ˆæœ›è‘—å¤œçš„è’¼èŒ«" },
            { "time": 29, "text": "ä¹Ÿå®ˆæœ›è‘—é»æ˜çš„æ›™å…‰" },
            { "time": 33, "text": "åœ¨æ¼«é•·æ­²æœˆè£¡ç­‰å¾…è‘—" },
            { "time": 36, "text": "ç­‰å¾…è‘—æŸå€‹äººçš„å‡ºç¾" },
            { "time": 49, "text": "å¥¹å·²ç¶“è¨˜ä¸æ¸…ä½ çš„æ¨¡æ¨£" },
            { "time": 54, "text": "å»ä¾ç„¶åœ¨åŸåœ°é»˜é»˜å®ˆæœ›" },
            { "time": 58, "text": "é‚£æ˜¯ä¸€ç¨®æ€æ¨£çš„æ·±æƒ…" },
            { "time": 61, "text": "æ‰èƒ½å¦‚æ­¤åŸ·è‘—åˆæ¼«é•·" },
            { "time": 67, "text": "ä¹Ÿè¨±ä½ æ—©å·²æŠŠå®ƒéºå¿˜" },
            { "time": 72, "text": "è€Œå¥¹å»é‚„åœ¨ç‚ºä½ ç…§äº®" },
            { "time": 76, "text": "åœ¨é€™åŸå¸‚çš„å–§å›‚ä¹‹ä¸­" },
            { "time": 80, "text": "é‚„æœ‰å¤šå°‘äººåœ¨ç­‰å¾…è‘—" }
        ],
        quiz: [
            { "line": "æœˆäº®é«˜æ›åœ¨__ä¹‹ä¸Š", "answer": "å¤œç©º" },
            { "line": "éœéœæ³¨è¦–è‘—å–§å›‚çš„__", "answer": "äººé–“" },
            { "line": "ä¹Ÿå®ˆæœ›è‘—é»æ˜çš„__", "answer": "æ›™å…‰" },
            { "line": "å¥¹å·²ç¶“è¨˜ä¸æ¸…ä½ çš„__", "answer": "æ¨¡æ¨£" },
            { "line": "æ‰èƒ½å¦‚æ­¤åŸ·è‘—åˆ__", "answer": "æ¼«é•·" }
        ]
    },
    "ç™½å½±.mp3": {
        lyrics: [
            { "time": 12, "text": "ä»–èµ°é€²äº†ä¸€å€‹è’èª•çš„å¤¢å¢ƒ" },
            { "time": 18, "text": "å¤¢è£¡æœ‰å€‹é‡è¤‡å‡ºç¾çš„ç™½å½±" },
            { "time": 24, "text": "ç™½å½±å¾®ç¬‘è‘—æº–å‚™ç™»ä¸Š" },
            { "time": 30, "text": "æœ‰ç ç‰™çš„ç«è»Šå»‚é ‚" },
            { "time": 35, "text": "é»ƒæ˜ä¸€æ¬¡æ¬¡çš„æŠŠç™½å½±æ“„èµ°" },
            { "time": 41, "text": "ä»–ä¸€æ¬¡æ¬¡çš„ç«™åœ¨åŸåœ°ç›®é€" },
            { "time": 47, "text": "ä»–æ²’æœ‰è¾¦æ³•æŒ½ç•™" },
            { "time": 51, "text": "ä»–æ²’æœ‰è¾¦æ³•ä¼¸å‡ºæ‰‹" },
            { "time": 71, "text": "å¤šå¹´å¾Œä»–é‚„æ˜¯æœƒå¸¸å¸¸é©šé†’" },
            { "time": 77, "text": "æ•é‚Šç¸½æ˜¯æ¿•æ½¤çš„ä¸€ç‰‡ç‹¼è—‰" },
            { "time": 83, "text": "ç™½å½±åƒé¤ƒå­çš®ä¸€æ¨£åŒ…è£¹è‘—ä»–" },
            { "time": 90, "text": "è¶Šæ™æ‰è¶Šé™·é€²å»" },
            { "time": 95, "text": "é»ƒæ˜ä¸€æ¬¡æ¬¡çš„æŠŠç™½å½±æ“„èµ°" },
            { "time": 101, "text": "ä»–ä¸€æ¬¡æ¬¡çš„ç«™åœ¨åŸåœ°ç›®é€" },
            { "time": 107, "text": "ä»–åªèƒ½é»˜é»˜åœ°çœ‹" },
            { "time": 112, "text": "ä»–åªèƒ½é»˜é»˜åœ°å" }
        ],
        quiz: [
            { "line": "ä»–èµ°é€²äº†ä¸€å€‹è’èª•çš„__", "answer": "å¤¢å¢ƒ" },
            { "line": "å¤¢è£¡æœ‰å€‹é‡è¤‡å‡ºç¾çš„__", "answer": "ç™½å½±" },
            { "line": "__ä¸€æ¬¡æ¬¡çš„æŠŠç™½å½±æ“„èµ°", "answer": "é»ƒæ˜" },
            { "line": "æ•é‚Šç¸½æ˜¯æ¿•æ½¤çš„ä¸€ç‰‡__", "answer": "ç‹¼è—‰" },
            { "line": "ä»–æ²’æœ‰è¾¦æ³•ä¼¸å‡º__", "answer": "æ‰‹" }
        ]
    },
    "ä¸‹ä¸€æçš„æƒ†æ‚µ.mp3": {
        lyrics: [
            { "time": 16, "text": "åŒ—äº¬çš„é›¨æ˜¯" },
            { "time": 18, "text": "å››æœˆæœªåœæ­‡çš„å‚¾è¨´" },
            { "time": 23, "text": "èƒ¡åŒçš„è·¯æ˜¯æˆ‘" },
            { "time": 26, "text": "ç„¡æ³•å¿˜å»çš„å­¤ç¨" },
            { "time": 31, "text": "æ‹†é·çš„é€šçŸ¥" },
            { "time": 34, "text": "æ˜¯æˆ‘é‚„æœªæ”¶æ‹¾çš„åŒ…è¢±" },
            { "time": 39, "text": "é¨è¡Œçš„å¤–è³£" },
            { "time": 42, "text": "æ˜¯æˆ‘å”¯ä¸€èƒ½åšçš„æ•‘è´–" },
            { "time": 46, "text": "æœ‰é‚£éº¼ä¸€åˆ»æˆ‘ä»¥ç‚ºæˆ‘" },
            { "time": 50, "text": "å¿˜è¨˜äº†å“­" },
            { "time": 53, "text": "ç›´åˆ°åˆèåˆ°ä¸­è¯ç‰Œé¦™è¸çš„æº«åº¦" },
            { "time": 59, "text": "æœ‰é‚£éº¼ä¸€åˆ»æˆ‘ä»¥ç‚ºæˆ‘" },
            { "time": 62, "text": "ç¿’æ…£äº†å“­" },
            { "time": 65, "text": "ç›´åˆ°åˆçœ‹åˆ°ä¸­è¯ç‰Œé¦™è¸çš„é–ƒçˆ" },
            { "time": 82, "text": "ä½ èªªæ­²æœˆæ¼«é•·" },
            { "time": 86, "text": "å…«å¹´é¢¨å¡µåƒ•åƒ•å»ä¹Ÿè½‰çœ¼ä¸€æ™ƒ" },
            { "time": 89, "text": "æˆ‘èªªå…‰é™°åŒ†å¿™" },
            { "time": 91, "text": "æˆ‘åªæ˜¯å¿˜äº†æˆ‘æ˜¯èª°çš„å…’éƒ" },
            { "time": 97, "text": "ä½ èªªæœªä¾†é•·æ²³" },
            { "time": 101, "text": "ä½ åˆé»èµ·äº†ä¸‹ä¸€æ”¯çš„æƒ†æ‚µ" },
            { "time": 104, "text": "æˆ‘èªªäººç”ŸåŒ†å¿™" },
            { "time": 106, "text": "å¯æˆ‘åˆèº²ä¸é" },
            { "time": 108, "text": "æ­²æœˆçš„è’¼èŒ«" }
        ],
        quiz: [
            { "line": "__çš„è·¯æ˜¯æˆ‘", "answer": "èƒ¡åŒ" },
            { "line": "é¨è¡Œçš„__æ˜¯æˆ‘å”¯ä¸€èƒ½åšçš„æ•‘è´–", "answer": "å¤–è³£" },
            { "line": "ç›´åˆ°åˆèåˆ°__é¦™è¸çš„æº«åº¦", "answer": "ä¸­è¯ç‰Œ" },
            { "line": "æˆ‘åªæ˜¯å¿˜äº†æˆ‘æ˜¯èª°çš„__", "answer": "å…’éƒ" },
            { "line": "ä½ åˆé»èµ·äº†ä¸‹ä¸€æ”¯çš„__", "answer": "æƒ†æ‚µ" }
        ]
    },
    "é¤˜ç‡¼è½å…¥è™›ç„¡.mp3": {
        lyrics: [
            { "time": 11, "text": "ç«ç„°è·³è‘—éˆå‹•çš„èˆè¹ˆ" },
            { "time": 16, "text": "ç°ç‡¼é£„è½æœ€å¾Œä¸€é­" },
            { "time": 20, "text": "ç‡’åŒ–çš„ç´™éŒ¢é–‹å§‹é£›å‘é›²éœ„" },
            { "time": 25, "text": "åœ°ç„çš„å¤§é–€å³å°‡ä¾†åˆ°" },
            { "time": 30, "text": "å°±åƒé‚£é¢¨ä¸­é£„é›¶çš„è‰" },
            { "time": 34, "text": "æ²’æœ‰æ ¹åŸºåªèƒ½éš¨é¢¨èµ·" },
            { "time": 39, "text": "è½é£„æ–ä½ çœ‹é‚£å¤©ç©ºä¸­ç€°æ¼«çš„ç…™" },
            { "time": 44, "text": "é‚£æ˜¯ä½ æˆ‘ç”Ÿå‘½æœ€çµ‚çš„æ¨£è²Œ" },
            { "time": 58, "text": "ç«ç„°è·³è‘—éˆå‹•çš„èˆè¹ˆ" },
            { "time": 102, "text": "ç°ç‡¼é£„è½æœ€å¾Œä¸€æ—©" },
            { "time": 107, "text": "ç‡’åŒ–çš„ç´™éŒ¢é–‹å§‹é£›å‘é›²éœ„" },
            { "time": 111, "text": "ä¸€åˆ‡ä¼¼ä¹å°±è¦çµæŸäº†" },
            { "time": 116, "text": "å°±åƒé‚£é¢¨ä¸­é£„é›¶çš„è‰" },
            { "time": 121, "text": "æ²’æœ‰æ ¹åŸºåªèƒ½éš¨é¢¨èµ·" },
            { "time": 126, "text": "è‹¥é£„æ–ä½ çœ‹é‚£å¤©ç©ºä¸­ç€°æ¼«çš„ç…™" },
            { "time": 131, "text": "é‚£æ˜¯ä½ æˆ‘ç”Ÿå‘½æœ€çµ‚çš„æ¨£è²Œ" }
        ],
        quiz: [
            { "line": "ç«ç„°è·³è‘—éˆå‹•çš„__", "answer": "èˆè¹ˆ" },
            { "line": "__é£„è½æœ€å¾Œä¸€é­", "answer": "ç°ç‡¼" },
            { "line": "ç‡’åŒ–çš„__é–‹å§‹é£›å‘é›²éœ„", "answer": "ç´™éŒ¢" },
            { "line": "å°±åƒé‚£é¢¨ä¸­é£„é›¶çš„__", "answer": "è‰" },
            { "line": "é‚£æ˜¯ä½ æˆ‘ç”Ÿå‘½æœ€çµ‚çš„__", "answer": "æ¨£è²Œ" }
        ]
    },
    "è€å±‹å›æ†¶.mp3": {
        lyrics: [
            { "time": 16, "text": "è€å±‹çš„æœ¨é–€å¸¸å¹´è™›æ©" }, { "time": 22, "text": "é–€å¤–ç¨®ç€ä¸€æ£µæ¡‚èŠ±æ¨¹" }, { "time": 28, "text": "ç§‹æ·±æ™‚ç¯€ èŠ±ç“£é›¶æ•£ä¸€åœ°" }, { "time": 35, "text": "æˆ‘èˆ‡çˆºçˆºç”¨ç«¹ç®•æ”¶é›†" }, { "time": 42, "text": "å›æ†¶çš„ç¢ç‰‡" }, { "time": 44, "text": "é‚£æ™‚çš„å¿«æ¨‚" }, { "time": 46, "text": "æ˜¯è¢«æ•æ‰å¾Œåˆæ”¾ç”Ÿçš„å°é­š" }, { "time": 55, "text": "æ˜¯æ¡‚èŠ±ç³•å‡ºé‹æ™‚çš„è’¸æ±½" }, { "time": 62, "text": "æ˜¯ä¸€ä¸²ä¸²éŠ€éˆ´èˆ¬çš„èŸ²é³´é³¥å›€" }, { "time": 69, "text": "ç„¶è€Œå¾Œä¾†" }, { "time": 71, "text": "éˆ´è²ä¸­æ–·äº†æˆ‘æ‰€é‚‚é€…çš„èŠ±é³¥èŸ²é­š" }, { "time": 79, "text": "å·²æ˜¯æ´»ç”Ÿç”Ÿçš„æ¨™æœ¬" }
        ],
        quiz: [
            { "line": "è€å±‹çš„æœ¨é–€å¸¸å¹´__", "answer": "è™›æ©" }, { "line": "é–€å¤–ç¨®ç€ä¸€æ£µ__æ¨¹", "answer": "æ¡‚èŠ±" }, { "line": "æˆ‘èˆ‡çˆºçˆºç”¨__æ”¶é›†", "answer": "ç«¹ç®•" }, { "line": "æ˜¯__å‡ºé‹æ™‚çš„è’¸æ±½", "answer": "æ¡‚èŠ±ç³•" }, { "line": "å·²æ˜¯æ´»ç”Ÿç”Ÿçš„__", "answer": "æ¨™æœ¬" }
        ]
    }
};


// --- CD Cover Images ---
const songCovers = {

    "ç™½å½±.mp3": "https://i.ibb.co/0pYsv0m1/image.png",
   
    // ç‚ºå…¶ä»–æ­Œæ›²æ·»åŠ å°é¢ï¼Œæ ¼å¼ç‚º "æ­Œæ›²æ–‡ä»¶å.mp3": "åœ–ç‰‡URL"
    // å¦‚æœæ²’æœ‰ç‰¹å®šå°é¢ï¼Œå¯ä»¥ä½¿ç”¨ä¸€å€‹é€šç”¨çš„é»˜èªå°é¢
    "default": "https://i.ibb.co/G4Rmgzjt/image.png" // é»˜èªå°é¢
};



            // --- DOM Elements ---

            const mainGameContainer = document.getElementById('mainGameContainer');
            const tracksContainer = document.getElementById('tracksContainer');
            const scoreDisplay = document.getElementById('score');
            const startBtn = document.getElementById('startBtn');
            const musicSelect = document.getElementById('musicSelect');
            const progressBar = document.getElementById('progressBar');
            const gameOverModal = document.getElementById('gameOverModal');
            const finalScoreDisplay = document.getElementById('finalScore');
            const finalComboDisplay = document.getElementById('finalCombo');
            const restartBtn = document.getElementById('restartBtn');
            const settingsModal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settingsBtn');
            const closeSettings = document.getElementById('closeSettings');
    
            const volumeControlModal = document.getElementById('volumeControlModal');
            const sfxVolumeControl = document.getElementById('sfxVolumeControl');
            const touchKeys = document.querySelectorAll('.touch-key');
            const difficultySelect = document.getElementById('difficultySelect');
            const audio = new Audio();
            audio.volume = 1.0;
            // --- ã€æ–°å¢ã€‘æ’è¡Œæ¦œç›¸é—œçš„ DOM å…ƒç´  ---
const leaderboardBtn = document.getElementById('leaderboardBtn');
const leaderboardModal = document.getElementById('leaderboardModal');
const closeLeaderboard = document.getElementById('closeLeaderboard');
const playerNameGroup = document.getElementById('playerNameGroup');
const playerNameInput = document.getElementById('playerNameInput');
const savePlayerNameBtn = document.getElementById('savePlayerNameBtn');
const leaderboardTitle = document.getElementById('leaderboardTitle');
const leaderboardList = document.getElementById('leaderboardList');
const leaderboardLoading = document.getElementById('leaderboardLoading');

            // New DOM Elements
            const personalHighScoreBtn = document.getElementById('personalHighScoreBtn');
            const personalHighScoreModal = document.getElementById('personalHighScoreModal');
            const closePersonalHighScore = document.getElementById('closePersonalHighScore');
            const personalHighScoreList = document.getElementById('personalHighScoreList');
            const musicPlayerBtn = document.getElementById('musicPlayerBtn');
            const musicPlayerModal = document.getElementById('musicPlayerModal');
            const closeMusicPlayer = document.getElementById('closeMusicPlayer');
            const nowPlaying = document.getElementById('nowPlaying');
            const lyricsContainer = document.getElementById('lyricsContainer');
            const prevBtn = document.getElementById('prevBtn');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const nextBtn = document.getElementById('nextBtn');
            const progressSlider = document.getElementById('progressSlider');
            const currentTimeDisplay = document.getElementById('currentTime');
            const durationDisplay = document.getElementById('duration');
            const volumeSliderPlayer = document.getElementById('volumeSliderPlayer');
            const playlist = document.getElementById('playlist');
            const unlockModal = document.getElementById('unlockModal');
            const closeUnlock = document.getElementById('closeUnlock');
            const unlockRequirement = document.getElementById('unlockRequirement');
             // â–¼â–¼â–¼ æ–°å¢é€šçŸ¥è¦–çª—çš„ DOM å…ƒç´  â–¼â–¼â–¼
            const notificationModal = document.getElementById('notificationModal');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            const closeNotification = document.getElementById('closeNotification');

            // â–¼â–¼â–¼ æ–°å¢çš„ DOM å…ƒç´  â–¼â–¼â–¼
            const unlockProgressContainer = document.getElementById('unlockProgressContainer');
            const unlockProgressBar = document.getElementById('unlockProgressBar');
           // â–¼â–¼â–¼ ã€ä¿®è¨‚ã€‘æ”¹ç‚ºé¸å–å…©å€‹æ–°çš„æ¨™è¨˜ç·šå…ƒç´  â–¼â–¼â–¼
            const songUnlockMarker = document.getElementById('songUnlockMarker');
            const difficultyUnlockMarker = document.getElementById('difficultyUnlockMarker');
            // â–²â–²â–² ä¿®è¨‚çµæŸ â–²â–²â–²
            // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€ä¿®è¨‚ã€‘æ¸¬é©—ç›¸é—œçš„ç‹€æ…‹è®Šæ•¸ â–¼â–¼â–¼
let isQuizActive = false;
let quizQuestions = []; // å°‡å„²å­˜ç•¶å‰æ¸¬é©—çš„æ‰€æœ‰é¡Œç›®
let currentQuizQuestion = null; // å„²å­˜ç•¶å‰çš„å•é¡Œç‰©ä»¶
let questionsAnsweredCorrectly = 0; // è¿½è¹¤å·²ç­”å°çš„é¡Œæ•¸
let totalQuestionsInQuiz = 0; // æ¸¬é©—é–‹å§‹æ™‚çš„ç¸½é¡Œæ•¸
let quizUnlockTarget = null; // ç”¨æ–¼å„²å­˜æ¸¬é©—æˆåŠŸå¾Œè¦è§£é–çš„ç›®æ¨™

// --- ã€æ–°å¢ã€‘ç²å–æ¸¬é©—è¦–çª—çš„ DOM å…ƒç´  ---
const lyricsQuizModal = document.getElementById('lyricsQuizModal');
const quizProgress = document.getElementById('quizProgress');
const quizQuestionText = document.getElementById('quizQuestionText');
const quizAnswerInput = document.getElementById('quizAnswerInput');
const quizSubmitBtn = document.getElementById('quizSubmitBtn');
const quizCloseBtn = document.getElementById('quizCloseBtn');
            
            // --- Game State Variables ---
            let gameActive = false;
let maxScoreForCurrentLevel = 0; // â–¼â–¼â–¼ æ–°å¢ç‹€æ…‹è®Šæ•¸
            let unlockThresholdPercentage = 0; // â–¼â–¼â–¼ æ–°å¢ç‹€æ…‹è®Šæ•¸
            let score = 0; // ç¸½åˆ†ï¼ŒåŒ…å«é€£æ“Šçå‹µ
let pureHitScore = 0; // æ–°å¢ï¼šç´”æ“Šæ‰“åˆ†æ•¸ï¼Œç”¨æ–¼è§£é–è¨ˆç®—
            let combo = 0;
            let notificationQueue = [];      // æˆ‘å€‘çš„é€šçŸ¥ã€Œå¾…è¾¦æ¸…å–®ã€
let isNotificationActive = false; // ä¸€å€‹æ——æ¨™ï¼Œç”¨ä¾†åˆ¤æ–·æ˜¯å¦å·²æœ‰é€šçŸ¥æ­£åœ¨é¡¯ç¤º
            let maxCombo = 0;
            let notes = [];
            let noteSpeed = 3000;
            let animationFrame;
            let gameStartTime = 0;
            let currentSongDuration = 0;
            let noteQueue = [];
            let generateNotesTimer = null;
            let progressInterval = null;
            const musicSelectorDiv = document.querySelector('.music-selector');
            const progressContainerDiv = document.querySelector('.progress-container');
            const tracks = 4;
            const keys = ['A', 'S', 'D', 'F'];
            const keyCodes = [65, 83, 68, 70];
            const keyStates = { 65: false, 83: false, 68: false, 70: false };
            let trackCooldownUntil = new Array(tracks).fill(0);
            let sfxVolume = 0.5;
            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘ç²’å­æ± ç›¸é—œè®Šæ•¸ â–¼â–¼â–¼
const PARTICLE_POOL_SIZE = 100; // æ± çš„å¤§å°ï¼Œå¯ä»¥æ ¹æ“šéœ€è¦èª¿æ•´
let hitParticlePool = [];
let noteParticlePool = [];
let currentHitParticleIndex = 0;
let currentNoteParticleIndex = 0;
// â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

            // Music Player State
            let playerAudio = new Audio();
            playerAudio.volume = 1.0;
            let playerIsPlaying = false;
            let playlistItems = [];
            let currentPlaylistIndex = 0;
            let lyrics = [];
            let lyricsInterval = null;
            let isUpdatingSlider = false; // Flag to prevent slider update conflicts

            // --- Audio Context for SFX ---
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let isAudioContextStarted = false;
            function startAudioContext() {
                if (!isAudioContextStarted) {
                    audioContext.resume().then(() => {
                        isAudioContextStarted = true;
                        console.log("AudioContext started");
                    }).catch(e => console.error("Failed to start AudioContext:", e));
                }
            }
            document.body.addEventListener('click', startAudioContext, { once: true });
            document.body.addEventListener('touchstart', startAudioContext, { once: true });


// â–¼â–¼â–¼ ã€æ–°å¢ã€‘è¨­å®šç²’å­æ± çš„å‡½æ•¸ â–¼â–¼â–¼
function setupParticlePools() {
    // æ¸…ç©ºä¸¦é‡å»º hitParticlePool
    hitParticlePool.forEach(p => p.remove());
    hitParticlePool = [];
    for (let i = 0; i < PARTICLE_POOL_SIZE; i++) {
        const particle = document.createElement('div');
        particle.className = 'hit-particle'; // é è¨­ class
        // å…ˆå°‡ç²’å­é™„åŠ åˆ°ä¸€å€‹ä¸æœƒå½±éŸ¿ä½ˆå±€çš„åœ°æ–¹
        tracksContainer.appendChild(particle);
        hitParticlePool.push(particle);
    }
    currentHitParticleIndex = 0;

    // æ¸…ç©ºä¸¦é‡å»º noteParticlePool
    noteParticlePool.forEach(p => p.remove());
    noteParticlePool = [];
    for (let i = 0; i < PARTICLE_POOL_SIZE; i++) {
        const particle = document.createElement('div');
        particle.className = 'note-particle'; // é è¨­ class
        tracksContainer.appendChild(particle);
        noteParticlePool.push(particle);
    }
    currentNoteParticleIndex = 0;
}
// â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

            
            function createSound(frequency, type = 'sine', duration = 0.1, baseVolume = 0.2) {
                return function() {
                    if (!isAudioContextStarted) return;
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.type = type;
                    oscillator.frequency.value = frequency;
                    gainNode.gain.value = baseVolume * sfxVolume;
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                };
            }
           const sounds = {
                perfect: createSound(523.25, 'sine', 0.15, 1.2), // åŸç‚º 0.7ï¼Œå¼·åŠ›æ”¾å¤§
                great: createSound(392.00, 'sine', 0.15, 1.2),  // åŸç‚º 0.6ï¼Œå¼·åŠ›æ”¾å¤§
                good: createSound(329.63, 'sine', 0.15, 1.2),   // åŸç‚º 0.5ï¼Œæ”¾å¤§è‡³æ¨™æº–éŸ³é‡
                miss: createSound(220.00, 'square', 0.2, 1.2),  // åŸç‚º 0.4ï¼Œé¡¯è‘—æ”¾å¤§
                combo: createSound(659.25, 'triangle', 0.1, 1.2) // åŸç‚º 0.5ï¼Œæ”¾å¤§è‡³æ¨™æº–éŸ³é‡
            };

            // --- Local Storage Management ---
           const STORAGE_KEY = 'musicGameSaveData';
const PLAYER_STORAGE_KEY = 'musicPlayerSettings';

let saveData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    unlockedSongs: ["ç™½å½±.mp3"],
    unlockedDifficulties: {}, 
    personalHighScores: {} 
};

// æ–°å¢æ’­æ”¾å™¨è¨­å®šçš„å„²å­˜çµæ§‹
let playerSettings = JSON.parse(localStorage.getItem(PLAYER_STORAGE_KEY)) || {
    currentSong: null,
    currentTime: 0,
    volume: 0.7,
    isPlaying: false,
    playlistStates: {}, // è¨˜éŒ„æ¯é¦–æ­Œçš„å•Ÿç”¨/åœç”¨ç‹€æ…‹
    currentPlaylistIndex: 0
};

            // Initialize unlocked difficulties for existing unlocked songs
            saveData.unlockedSongs.forEach(song => {
                if (!saveData.unlockedDifficulties[song]) {
                    saveData.unlockedDifficulties[song] = { normal: true, hard: false, hell: false };
                }
            });

           function saveGame() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
}

// æ–°å¢æ’­æ”¾å™¨è¨­å®šä¿å­˜å‡½æ•¸
function savePlayerSettings() {
    // æ›´æ–°ç•¶å‰æ’­æ”¾ç‹€æ…‹
    if (playlistItems.length > 0 && currentPlaylistIndex >= 0) {
        playerSettings.currentSong = playlistItems[currentPlaylistIndex]?.url || null;
        playerSettings.currentTime = playerAudio.currentTime || 0;
        playerSettings.volume = playerAudio.volume || 0.7;
        playerSettings.isPlaying = playerIsPlaying;
        playerSettings.currentPlaylistIndex = currentPlaylistIndex;
    }
    
    // ä¿å­˜æ’­æ”¾æ¸…å–®ç‹€æ…‹
    const playlistElements = document.querySelectorAll('.playlist-item');
    playerSettings.playlistStates = {};
    playlistElements.forEach((item, index) => {
        if (playlistItems[index]) {
            playerSettings.playlistStates[playlistItems[index].url] = {
                enabled: item.dataset.enabled === 'true',
                index: index
            };
        }
    });
    
    localStorage.setItem(PLAYER_STORAGE_KEY, JSON.stringify(playerSettings));
}

// è¼‰å…¥æ’­æ”¾å™¨è¨­å®š
function loadPlayerSettings() {
    // æ¢å¾©éŸ³é‡è¨­å®š
    if (playerSettings.volume !== undefined) {
        playerAudio.volume = playerSettings.volume;
        volumeSliderPlayer.value = playerSettings.volume;
    }
}

            // --- Unlock System ---
            function isSongUnlocked(songUrl) {
                return saveData.unlockedSongs.includes(songUrl);
            }

            function isDifficultyUnlocked(songUrl, difficulty) {
                if (difficulty === 'easy' || difficulty === 'normal') return true; // Easy/Normal always unlocked for unlocked songs
                return saveData.unlockedDifficulties[songUrl] && saveData.unlockedDifficulties[songUrl][difficulty];
            }

         function unlockNextSong(songJustPlayed) {
                const allSongs = Array.from(musicSelect.options).map(opt => opt.value);
                const lastUnlockedSong = saveData.unlockedSongs[saveData.unlockedSongs.length - 1];

                if (songJustPlayed === lastUnlockedSong) {
                    const currentIndex = allSongs.indexOf(lastUnlockedSong);
                    if (currentIndex >= 0 && currentIndex < allSongs.length - 1) {
                        const nextSong = allSongs[currentIndex + 1];
                        if (!isSongUnlocked(nextSong)) {
                            saveData.unlockedSongs.push(nextSong);
                            saveData.unlockedDifficulties[nextSong] = { normal: true, hard: false, hell: false };
                            saveGame();
                            updateSongOptions();

                            const songDisplayName = Array.from(musicSelect.options).find(opt => opt.value === nextSong)?.textContent || nextSong;
                            showNotification('success', 'æ–°æ­Œæ›²å·²è§£é–ï¼', `æ­å–œæ‚¨ï¼æ­Œæ›² <strong>${songDisplayName}</strong> ç¾åœ¨å¯ä»¥åœ¨æ’­æ”¾æ¸…å–®ä¸­é¸æ“‡äº†ã€‚`);
                            
                            return true; // ã€æ–°å¢ã€‘æˆåŠŸè§£é–ï¼Œå›å‚³ true
                        }
                    }
                }
                return false; // ã€æ–°å¢ã€‘æ²’æœ‰ç™¼ç”Ÿè§£é–ï¼Œå›å‚³ false
            }

           function unlockDifficulty(songUrl, difficulty) {
                if (!saveData.unlockedDifficulties[songUrl]) {
                    saveData.unlockedDifficulties[songUrl] = { normal: true, hard: false, hell: false };
                }
                if (!saveData.unlockedDifficulties[songUrl][difficulty]) {
                    saveData.unlockedDifficulties[songUrl][difficulty] = true;
                    saveGame();
                    updateSongOptions();
                    
                    const songTitle = Array.from(musicSelect.options).find(opt => opt.value === songUrl)?.textContent || songUrl;
                    const difficultyText = difficultySelect.querySelector(`option[value="${difficulty}"]`).textContent.replace(' (æœªè§£é–)', '');
                    showNotification('success', 'æ–°é›£åº¦å·²è§£é–ï¼', `<strong>${songTitle}</strong> çš„ <strong>${difficultyText}</strong> é›£åº¦ç¾å·²é–‹æ”¾æŒ‘æˆ°ï¼`);

                    return true; // ã€æ–°å¢ã€‘æˆåŠŸè§£é–ï¼Œå›å‚³ true
                }
                return false; // ã€æ–°å¢ã€‘æ²’æœ‰ç™¼ç”Ÿè§£é–ï¼Œå›å‚³ false
            }

          // ä¿®è¨‚å¾Œçš„ checkAndUnlockDifficulties å‡½æ•¸
// ã€ä¿®æ­£å¾Œçš„ç‰ˆæœ¬ã€‘è«‹ç”¨é€™æ®µç¨‹å¼ç¢¼å®Œæ•´æ›¿æ›èˆŠçš„ checkAndUnlockDifficulties å‡½æ•¸

function checkAndUnlockDifficulties(songUrl, difficulty, pureHitScore) {
    // æª¢æŸ¥æ˜¯å¦å¯ä»¥å¾ "æ™®é€š" è§£é– "å›°é›£"
    if (difficulty === 'normal' && !isDifficultyUnlocked(songUrl, 'hard')) {
        // ä½¿ç”¨èˆ‡é€²åº¦æ¢å®Œå…¨ç›¸åŒçš„ã€æº–ç¢ºçš„ç†è«–æœ€é«˜åˆ†ä¾†è¨ˆç®—é–€æª»
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        
        // ä½¿ç”¨èˆ‡é€²åº¦æ¢å®Œå…¨ç›¸åŒçš„ç´”ç²¹æ‰“æ“Šåˆ†æ•¸ä¾†é€²è¡Œæ¯”è¼ƒ
        if (pureHitScore >= requiredScore) {
            unlockDifficulty(songUrl, 'hard');
        }
    }

    // æª¢æŸ¥æ˜¯å¦å¯ä»¥å¾ "å›°é›£" è§£é– "åœ°ç„"
    if (difficulty === 'hard' && !isDifficultyUnlocked(songUrl, 'hell')) {
        // åŒæ¨£ï¼Œä½¿ç”¨æº–ç¢ºçš„ç†è«–æœ€é«˜åˆ†ä¾†è¨ˆç®—é–€æª»
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        
        // åŒæ¨£ï¼Œä½¿ç”¨ç´”ç²¹æ‰“æ“Šåˆ†æ•¸ä¾†é€²è¡Œæ¯”è¼ƒ
        if (pureHitScore >= requiredScore) {
            unlockDifficulty(songUrl, 'hell');
        }
    }
}

            function showUnlockModal(message) {
                unlockRequirement.textContent = message;
                unlockModal.classList.add('active');
            }

            // --- UI Updates ---



function processNotificationQueue() {
    // å¦‚æœç•¶å‰å·²æœ‰é€šçŸ¥æ­£åœ¨é¡¯ç¤ºï¼Œæˆ–è€…éšŠåˆ—æ˜¯ç©ºçš„ï¼Œå°±ç›´æ¥è¿”å›
    if (isNotificationActive || notificationQueue.length === 0) {
        return;
    }

    // æ¨™è¨˜ç‚ºã€Œæ­£åœ¨é¡¯ç¤ºé€šçŸ¥ã€
    isNotificationActive = true;

    // å¾éšŠåˆ—çš„é ­éƒ¨å–å‡ºç¬¬ä¸€å€‹é€šçŸ¥
    const notification = notificationQueue.shift();

    // --- ä»¥ä¸‹æ˜¯åŸ showNotification å‡½æ•¸çš„æ ¸å¿ƒé¡¯ç¤ºé‚è¼¯ ---
    const content = notificationModal.querySelector('.notification-content');
    notificationTitle.textContent = notification.title;
    notificationMessage.innerHTML = notification.message;

    content.classList.remove('success', 'info');
    if (notification.type === 'success') {
        content.classList.add('success');
        notificationIcon.innerHTML = '&#127881;'; // ğŸ‰
    } else {
        content.classList.add('info');
        notificationIcon.innerHTML = '&#128220;'; // ğŸ“Œ
    }
    
    notificationModal.classList.add('active');

    // è¨­å®šè¨ˆæ™‚å™¨ï¼Œåœ¨é€šçŸ¥çµæŸå¾Œè§¸ç™¼ä¸‹ä¸€å€‹
    notificationTimer = setTimeout(() => {
        notificationModal.classList.remove('active');
        isNotificationActive = false; // æ¨™è¨˜ç‚ºã€Œé€šçŸ¥å·²çµæŸã€
        processNotificationQueue();   // å†æ¬¡å‘¼å«ç¶“ç†ï¼Œæª¢æŸ¥éšŠåˆ—ä¸­æ˜¯å¦é‚„æœ‰ä¸‹ä¸€å€‹
    }, notification.duration || 5000);
}
// â–²â–²â–² æ–°å¢å‡½æ•¸çµæŸ â–²â–²â–²


            
// ã€ä¿®æ”¹å¾Œçš„ç‰ˆæœ¬ã€‘è«‹ç”¨é€™æ®µç¨‹å¼ç¢¼å®Œæ•´æ›¿æ›èˆŠçš„ showNotification å‡½æ•¸

let notificationTimer = null;

function showNotification(type, title, message, duration = 5000) {
    // æ­¥é©Ÿ 1: å°‡é€šçŸ¥ä»»å‹™æ‰“åŒ…ï¼Œæ·»åŠ åˆ°éšŠåˆ—çš„æœ«å°¾
    notificationQueue.push({
        type: type,
        title: title,
        message: message,
        duration: duration
    });

    // æ­¥é©Ÿ 2: å‘¼å«æˆ‘å€‘çš„ã€Œç¶“ç†ã€ä¾†è™•ç†éšŠåˆ—
    processNotificationQueue();
}

            // ç‚ºé€šçŸ¥è¦–çª—çš„é—œé–‰æŒ‰éˆ•æ·»åŠ é»æ“Šäº‹ä»¶
           // ã€ä¿®æ”¹å¾Œçš„æ¨£å­ã€‘
closeNotification.addEventListener('click', () => {
    if (notificationTimer) {
        clearTimeout(notificationTimer); // æ¸…é™¤ç•¶å‰çš„è¨ˆæ™‚å™¨
    }
    notificationModal.classList.remove('active');
    isNotificationActive = false;      // ç«‹åˆ»æ¨™è¨˜ç‚ºã€Œé€šçŸ¥å·²çµæŸã€
    processNotificationQueue();        // ç«‹åˆ»å‘¼å«ç¶“ç†ï¼Œé¡¯ç¤ºä¸‹ä¸€å€‹é€šçŸ¥
});


            
            function updateSongOptions() {
                const selectedSong = musicSelect.value;
                const selectedDifficulty = difficultySelect.value;

                Array.from(musicSelect.options).forEach(option => {
                    const songUrl = option.value;
                    if (isSongUnlocked(songUrl)) {
                        option.disabled = false;
                        option.text = option.text.replace(' (æœªè§£é–)', ''); // Remove unlock tag if present
                    } else {
                        option.disabled = true;
                        if (!option.text.includes('(æœªè§£é–)')) {
                            option.text += ' (æœªè§£é–)';
                        }
                    }
                });

                // Update difficulty options based on selected song
                updateDifficultyOptions(selectedSong);

                // Restore selection if it's still valid
                if (isSongUnlocked(selectedSong)) {
                    musicSelect.value = selectedSong;
                } else {
                    // Select the first unlocked song if current is locked
                    const firstUnlocked = saveData.unlockedSongs[0];
                    if (firstUnlocked) musicSelect.value = firstUnlocked;
                }
                if (!isDifficultyUnlocked(musicSelect.value, selectedDifficulty)) {
                    difficultySelect.value = 'normal'; // Default to normal if selected is locked
                }
            }

            function updateDifficultyOptions(songUrl) {
                const difficulties = ['easy', 'normal', 'hard', 'hell'];
                difficulties.forEach(diff => {
                    const option = difficultySelect.querySelector(`option[value="${diff}"]`);
                    if (isDifficultyUnlocked(songUrl, diff)) {
                        option.disabled = false;
                        option.text = option.text.replace(' (æœªè§£é–)', '');
                    } else {
                        option.disabled = true;
                        if (!option.text.includes('(æœªè§£é–)')) {
                            option.text += ' (æœªè§£é–)';
                        }
                    }
                });
            }

            function updatePersonalHighScore(songUrl, difficulty, newScore) {
                 if (!saveData.personalHighScores[songUrl]) {
                    saveData.personalHighScores[songUrl] = {};
                 }
                 const currentHigh = saveData.personalHighScores[songUrl][difficulty] || 0;
                 if (newScore > currentHigh) {
                    saveData.personalHighScores[songUrl][difficulty] = newScore;
                    saveGame();
                 }
            }

            function populatePersonalHighScoreList(songUrl) {
                personalHighScoreList.innerHTML = '';
                const difficulties = ['easy', 'normal', 'hard', 'hell'];
                difficulties.forEach(diff => {
                    const li = document.createElement('li');
                    li.className = 'personal-high-score-item';

                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'personal-high-score-label';
                    labelSpan.textContent = `${diff.toUpperCase()}:`;

                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'personal-high-score-value';
                    const score = saveData.personalHighScores[songUrl] ? saveData.personalHighScores[songUrl][diff] : 0;
                    valueSpan.textContent = score ? score.toLocaleString() : '0';

                    li.appendChild(labelSpan);
                    li.appendChild(valueSpan);
                    personalHighScoreList.appendChild(li);
                });
            }

            function initGame() {
    tracksContainer.innerHTML = '';
    for (let i = 0; i < tracks; i++) {
        const track = document.createElement('div');
        track.className = 'track';
        track.dataset.track = i;
        const hitLine = document.createElement('div');
        hitLine.className = 'hit-line';
        track.appendChild(hitLine);
        const keyHint = document.createElement('div');
        keyHint.className = 'key-hint';
        keyHint.textContent = keys[i];
        track.appendChild(keyHint);
        tracksContainer.appendChild(track);
    }
                  setupParticlePools();
    score = 0;
    combo = 0;
    maxCombo = 0;
    // æ–°å¢ï¼šé‡è¨­ pureHitScore ä»¥ç¢ºä¿æ¯æ¬¡éŠæˆ²é–‹å§‹æ™‚å¾0é–‹å§‹ï¼ˆé¿å…ç´¯ç©BUGï¼‰
    pureHitScore = 0;
    notes = [];
    noteQueue = [];
    progressBar.style.width = '0%';
    updateUI();
    tracksContainer.className = 'tracks';
    const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    if (isMobile) {
        document.getElementById('touchControls').style.display = 'flex';
        document.querySelectorAll('.key-hint').forEach(hint => hint.style.display = 'none');
    }
}

            function updateUI() {
                scoreDisplay.textContent = score;
            }

           function updateProgress() {
    if (gameActive && currentSongDuration > 0) {
        const elapsed = (Date.now() - gameStartTime) / 1000;
        const progress = Math.min(100, (elapsed / currentSongDuration) * 100);
        progressBar.style.width = `${progress}%`;

        // æ–°å¢ï¼šå‘¼å«éŠæˆ²æ­Œè©æ›´æ–°é‚è¼¯
        updateGameLyrics(elapsed);
    }
}

            // ==============================================================
// ====== ã€æ–°å¢ã€‘æ’è¡Œæ¦œæ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ ==========================
// ==============================================================

/**
 * å°‡æ­Œæ›²æ–‡ä»¶åè½‰æ›ç‚ºå¯ç”¨æ–¼ Firebase key çš„å®‰å…¨å­—ä¸²
 * @param {string} filename - ä¾‹å¦‚ "ç™½å½±.mp3"
 * @returns {string} - ä¾‹å¦‚ "ç™½å½±_mp3"
 */
function sanitizeFirebaseKey(filename) {
    return filename.replace(/\./g, '_').replace(/[#$\[\]]/g, '');
}

/**
 * æª¢æŸ¥åç¨±æ˜¯å¦åŒ…å«é«’è©±
 * @param {string} name - è¦æª¢æŸ¥çš„åç¨±
 * @returns {boolean} - å¦‚æœåŒ…å«é«’è©±å‰‡å›å‚³ true
 */
function isProfane(name) {
    const lowerCaseName = name.toLowerCase();
    return profanityList.some(word => lowerCaseName.includes(word));
}

/**
 * è™•ç†ç©å®¶åç¨±çš„è¨­å®šèˆ‡å„²å­˜ï¼ˆä¿®è¨‚å¾Œç‰ˆæœ¬ï¼‰
 * - å¢åŠ  Firebase å…¨åŸŸåç¨±å”¯ä¸€æ€§æª¢æŸ¥
 */
async function handlePlayerName() {
    playerNameInput.value = playerName;
    if (!playerName) {
        showNotification('info', 'è¨­å®šåç¨±', 'ç‚ºäº†ç™»ä¸Šæ’è¡Œæ¦œï¼Œè«‹å…ˆè¨­å®šä½ çš„å°ˆå±¬åç¨±ï¼');
    }

    savePlayerNameBtn.onclick = async () => {
        const newName = playerNameInput.value.trim();
        const oldName = playerName; // ä¿å­˜ç›®å‰çš„ï¼ˆèˆŠï¼‰åç¨±

        // --- åŸºæœ¬å®¢æˆ¶ç«¯é©—è­‰ ---
        if (newName.length === 0) {
            showNotification('info', 'åç¨±ç„¡æ•ˆ', 'åç¨±ä¸èƒ½ç‚ºç©ºï¼');
            return;
        }
        if (isProfane(newName)) {
            showNotification('info', 'åç¨±ä¸é›…', 'è«‹å‹¿ä½¿ç”¨ä¸é›…è©å½™ä½œç‚ºåç¨±ã€‚');
            return;
        }
        // å¦‚æœåç¨±æ²’æœ‰æ”¹è®Šï¼Œå‰‡ä¸éœ€è¦åŸ·è¡Œä»»ä½•æ“ä½œ
        if (newName === oldName) {
            showNotification('info', 'æç¤º', 'åç¨±æœªè®Šæ›´ã€‚');
            return;
        }

        // --- Firebase å…¨åŸŸåç¨±å”¯ä¸€æ€§æª¢æŸ¥ ---

        // ç‚ºäº†è®“æª¢æŸ¥ä¸åˆ†å¤§å°å¯« (é¿å… Player å’Œ player è¢«è¦–ç‚ºä¸åŒ)ï¼Œæˆ‘å€‘çµ±ä¸€ç”¨å°å¯«ä¾†æª¢æŸ¥å’Œå„²å­˜
        const checkNameKey = newName.toLowerCase();
        const playerNamesRef = database.ref(`playerNames/${checkNameKey}`);
        
        savePlayerNameBtn.disabled = true; // é˜²æ­¢é‡è¤‡é»æ“Š
        savePlayerNameBtn.textContent = 'æª¢æŸ¥ä¸­...';

        try {
            const snapshot = await playerNamesRef.once('value');

            if (snapshot.exists()) {
                // å¦‚æœè³‡æ–™åº«ä¸­å­˜åœ¨é€™å€‹åç¨±ï¼Œä»£è¡¨å·²è¢«ä½”ç”¨
                showNotification('info', 'åç¨±å·²è¢«ä½¿ç”¨', `åç¨±ã€Œ<strong>${newName}</strong>ã€å·²è¢«å…¶ä»–ç©å®¶è¨»å†Šï¼Œè«‹æ›ä¸€å€‹å§ï¼`);
            } else {
                // --- åç¨±å¯ç”¨ï¼ŒåŸ·è¡Œå„²å­˜æ“ä½œ ---

                // å»ºç«‹ä¸€å€‹ç‰©ä»¶ä¾†ä¸€æ¬¡æ€§æ›´æ–°å¤šå€‹è³‡æ–™è·¯å¾‘
                const updates = {};
                
                // 1. åœ¨ playerNames è¨»å†Šæ–°åç¨±
                updates[`/playerNames/${checkNameKey}`] = true;
                
                // 2. å¦‚æœæ˜¯ã€Œæ›´æ”¹ã€åç¨±ï¼Œéœ€è¦å¾ playerNames ä¸­åˆªé™¤èˆŠåç¨±
                if (oldName) {
                    const oldNameKey = oldName.toLowerCase();
                    updates[`/playerNames/${oldNameKey}`] = null; // åœ¨ Firebase ä¸­ï¼Œå°‡å€¼è¨­ç‚º null ç­‰æ–¼åˆªé™¤è©²ç¯€é»
                }

                // 3. åŸ·è¡ŒåŸå­æ€§æ›´æ–°
                await database.ref().update(updates);

                // 4. æ›´æ–°æœ¬åœ°è®Šæ•¸å’Œ Local Storage
                playerName = newName;
                localStorage.setItem('musicGamePlayerName', playerName);
                
                showNotification('success', 'å„²å­˜æˆåŠŸ', `ä½ çš„æ–°åç¨±ã€Œ<strong>${playerName}</strong>ã€å·²æˆåŠŸè¨­å®šï¼`);
            }
        } catch (error) {
            console.error("æª¢æŸ¥åç¨±æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            showNotification('info', 'ç™¼ç”ŸéŒ¯èª¤', 'èˆ‡ä¼ºæœå™¨é€£ç·šæ™‚ç™¼ç”Ÿå•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        } finally {
            // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½æ¢å¾©æŒ‰éˆ•çš„ç‹€æ…‹
            savePlayerNameBtn.disabled = false;
            savePlayerNameBtn.textContent = 'å„²å­˜åç¨±';
        }
    };

    // ç§»é™¤èˆŠçš„ EventListenerï¼Œé¿å…é‡è¤‡ç¶å®š (å¦‚æœä¹‹å‰æ˜¯ç”¨ addEventListener çš„è©±)
    // ç”±æ–¼æˆ‘å€‘æ”¹ç”¨ onclickï¼Œé€™è¡Œå¯ä»¥çœç•¥ï¼Œä½†ä¿ç•™æ˜¯ä¸€ç¨®å¥½ç¿’æ…£
    // savePlayerNameBtn.removeEventListener('click', ...);
}
/**
 * é¡¯ç¤ºæŒ‡å®šæ­Œæ›²èˆ‡é›£åº¦çš„æ’è¡Œæ¦œ
 * @param {string} songUrl - æ­Œæ›²çš„ URL
 * @param {string} difficulty - é›£åº¦
 */
function displayLeaderboard(songUrl, difficulty) {
    const songDisplayName = Array.from(musicSelect.options).find(opt => opt.value === songUrl)?.textContent || 'æœªçŸ¥æ­Œæ›²';
    const difficultyDisplayName = difficultySelect.querySelector(`option[value="${difficulty}"]`).textContent;
    
    leaderboardTitle.textContent = `${songDisplayName} - ${difficultyDisplayName}`;
    leaderboardList.innerHTML = '';
    leaderboardLoading.style.display = 'block';

    const songId = sanitizeFirebaseKey(songUrl);
    const leaderboardRef = database.ref(`leaderboards/${songId}/${difficulty}`);

    leaderboardRef.once('value', (snapshot) => {
        leaderboardLoading.style.display = 'none';
        const data = snapshot.val();

        if (data && data.length > 0) {
            data.forEach((entry, index) => {
                const li = document.createElement('li');
                li.className = 'leaderboard-item';
                li.innerHTML = `
                    <span class="leaderboard-rank">#${index + 1}</span>
                    <span class="leaderboard-name">${entry.name}</span>
                    <span class="leaderboard-score">${entry.score.toLocaleString()}</span>
                `;
                leaderboardList.appendChild(li);
            });
        } else {
            leaderboardList.innerHTML = '<li><p style="text-align: center; color: #aaa;">é€™å€‹æ’è¡Œæ¦œé‚„æ²’æœ‰äººæŒ‘æˆ°éï¼Œå¿«ä¾†æˆç‚ºç¬¬ä¸€åï¼</p></li>';
        }
    });
}

/**
 * æäº¤åˆ†æ•¸åˆ° Firebase æ’è¡Œæ¦œï¼ˆä¿®è¨‚å¾Œç‰ˆæœ¬ï¼‰
 * - æ”¯æ´å‰ä¸‰åä¸Šæ¦œ
 * - é˜»æ­¢åœ¨åŒä¸€æ¦œå–®ä¸Šä½¿ç”¨é‡è¤‡çš„ç©å®¶åç¨±
 * @param {string} songUrl 
 * @param {string} difficulty 
 * @param {number} finalScore 
 */
async function submitScoreToLeaderboard(songUrl, difficulty, finalScore) {
    // æ­¥é©Ÿ 1: ç¢ºèªç©å®¶å·²è¨­å®šåç¨±ï¼Œå¦å‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ
    if (!playerName) {
        console.log("ç©å®¶æœªè¨­å®šåç¨±ï¼Œä¸æäº¤åˆ†æ•¸è‡³æ’è¡Œæ¦œã€‚");
        // ä½ ä¹Ÿå¯ä»¥åœ¨é€™è£¡åŠ ä¸Šä¸€å€‹ showNotification() ä¾†æé†’ç©å®¶å»è¨­å®šåç¨±
        return;
    }

    const songId = sanitizeFirebaseKey(songUrl);
    const leaderboardRef = database.ref(`leaderboards/${songId}/${difficulty}`);

    // æ­¥é©Ÿ 2: ä½¿ç”¨ Firebase çš„ Transactionï¼ˆäº¤æ˜“ï¼‰åŠŸèƒ½
    // é€™æ˜¯ä¸€å€‹å®‰å…¨çš„æ“ä½œï¼Œèƒ½é˜²æ­¢å¤šä½ç©å®¶åŒæ™‚æäº¤åˆ†æ•¸æ™‚é€ æˆè³‡æ–™éŒ¯äº‚ã€‚
    // æˆ‘å€‘å°‡ã€Œè®€å–ã€ä¿®æ”¹ã€å¯«å›ã€é€™ä¸‰å€‹å‹•ä½œç¶åœ¨ä¸€èµ·ï¼Œç¢ºä¿å…¶åŸå­æ€§ã€‚
    try {
        const { committed, snapshot } = await leaderboardRef.transaction((currentData) => {
            // å¦‚æœè³‡æ–™åº«ä¸­é‚„æ²’æœ‰é€™å€‹æ’è¡Œæ¦œï¼Œå°±åˆå§‹åŒ–ç‚ºä¸€å€‹ç©ºé™£åˆ—
            if (currentData === null) {
                currentData = [];
            }

            // ==========================================================
            // ====== å…¶äºŒï¼šé¿å…ç©å®¶è¨­å®šç›¸åŒçš„åç¨± (æ ¸å¿ƒé‚è¼¯) ======
            // ==========================================================
            
            // æª¢æŸ¥é€™å€‹åå­—æ˜¯å¦å·²ç¶“è¢«æ¦œä¸Šã€Œå…¶ä»–äººã€ä½¿ç”¨
            const isNameTakenByOther = currentData.some(entry => entry.name === playerName);

            // å°‹æ‰¾ã€Œè‡ªå·±ã€æ˜¯å¦å·²ç¶“åœ¨æ¦œä¸Š
            let selfIndex = -1;
            for (let i = 0; i < currentData.length; i++) {
                if (currentData[i].name === playerName) {
                    selfIndex = i;
                    break;
                }
            }

            // ã€è¦å‰‡ã€‘å¦‚æœåå­—è¢«ä½”ç”¨ï¼Œè€Œä¸”ä½”ç”¨è€…ä¸æ˜¯è‡ªå·± -> æäº¤å¤±æ•—
            if (isNameTakenByOther && selfIndex === -1) {
                // è¿”å› undefined æœƒå®‰å…¨åœ°ä¸­æ­¢é€™æ¬¡çš„ transactionï¼Œä¸æœƒå¯«å…¥ä»»ä½•è³‡æ–™
                console.warn(`æäº¤å¤±æ•—ï¼šåç¨± "${playerName}" å·²è¢«æ­¤æ’è¡Œæ¦œä¸Šçš„å…¶ä»–ç©å®¶ä½¿ç”¨ã€‚`);
                return; 
            }

            // ========================================================
            // ====== å…¶ä¸€ï¼šæ’è¡Œæ¦œæ“´å……è‡³å‰ä¸‰å (æ ¸å¿ƒé‚è¼¯) ======
            // ========================================================
            
            // æ‰¾å‡ºæ¦œå–®ä¸Šçš„æœ€ä½åˆ† (å¦‚æœæ¦œå–®æœªæ»¿ä¸‰äººï¼Œå‰‡æœ€ä½åˆ†ç‚º 0)
            const lowestScoreOnBoard = currentData.length < 3 ? 0 : currentData[currentData.length - 1].score;

            if (selfIndex !== -1) {
                // --- æƒ…æ³ A: æˆ‘å·²ç¶“åœ¨æ¦œä¸Š ---
                // åªæœ‰åœ¨æ–°åˆ†æ•¸æ›´é«˜æ™‚ï¼Œæ‰æ›´æ–°æˆ‘çš„åˆ†æ•¸
                if (finalScore > currentData[selfIndex].score) {
                    currentData[selfIndex].score = finalScore;
                } else {
                    // åˆ†æ•¸æ²’æœ‰æ›´é«˜ï¼Œä¸éœ€è¦æ›´æ–°ï¼Œä¸­æ­¢ transaction
                    return;
                }
            } else {
                // --- æƒ…æ³ B: æˆ‘é‚„æ²’ä¸Šæ¦œ ---
                // å¦‚æœåˆ†æ•¸ä¸å¤ é«˜ (ä¸”æ¦œå–®å·²æ»¿ 3 äºº)ï¼Œå°±ç„¡æ³•ä¸Šæ¦œ
                if (finalScore <= lowestScoreOnBoard && currentData.length >= 3) {
                    return; // ä¸­æ­¢ transaction
                }
                // åˆ†æ•¸å¤ é«˜ï¼Œå°‡æˆ‘çš„æ–°ç´€éŒ„åŠ å…¥é™£åˆ—ä¸­
                currentData.push({ name: playerName, score: finalScore });
            }

            // ã€é—œéµæ­¥é©Ÿã€‘å°æ‰€æœ‰ç´€éŒ„ä¾åˆ†æ•¸ç”±é«˜åˆ°ä½é‡æ–°æ’åº
            currentData.sort((a, b) => b.score - a.score);
            
            // ã€é—œéµæ­¥é©Ÿã€‘åªä¿ç•™æ’åºå¾Œçš„å‰ä¸‰åç´€éŒ„
            const newData = currentData.slice(0, 3);
            
            // è¿”å›æœ€çµ‚è¦å¯«å…¥è³‡æ–™åº«çš„æ–°æ’è¡Œæ¦œè³‡æ–™
            return newData;
        });

        // æ­¥é©Ÿ 3: æ ¹æ“š transaction çš„åŸ·è¡Œçµæœï¼Œçµ¦äºˆç©å®¶æ˜ç¢ºçš„å›é¥‹
        if (committed) {
            // Transaction æˆåŠŸæäº¤ï¼Œä»£è¡¨è³‡æ–™å·²æ›´æ–°
            const finalBoard = snapshot.val() || [];
            // å†æ¬¡ç¢ºèªè‡ªå·±æ˜¯å¦çœŸçš„åœ¨æœ€çµ‚çš„æ¦œå–®ä¸Š
            const onFinalBoard = finalBoard.some(entry => entry.name === playerName && entry.score === finalScore);
            
            if (onFinalBoard) {
                // åªæœ‰æˆåŠŸä¸Šæ¦œï¼Œæ‰é¡¯ç¤ºæˆåŠŸé€šçŸ¥
                const difficultyText = difficultySelect.querySelector(`option[value="${difficulty}"]`).textContent;
                showNotification('success', 'ç™»ä¸Šæ’è¡Œæ¦œï¼', `æ­å–œï¼ä½ åœ¨ã€Œ<strong>${difficultyText}</strong>ã€é›£åº¦çš„åˆ†æ•¸å·²æˆåŠŸç™»ä¸Šæ’è¡Œæ¦œï¼`);
            } else {
                // é›–ç„¶æäº¤æˆåŠŸï¼Œä½†å› ç‚ºåˆ†æ•¸ä¸å¤ é«˜è€Œè¢«æ“ å‡ºæ¦œå¤–
                showNotification('info', 'å†æ¥å†å²', 'ä½ çš„åˆ†æ•¸å·²æˆåŠŸæäº¤ï¼Œä½†æœªé”åˆ°ç›®å‰æ’è¡Œæ¦œå‰ä¸‰åçš„æ¨™æº–ã€‚');
            }
        } else {
            // Transaction è¢«ä¸­æ­¢ï¼Œé€šå¸¸æ˜¯å› ç‚ºæˆ‘å€‘åœ¨å‰é¢æ‰‹å‹•ä¸­æ­¢äº†å®ƒï¼ˆä¾‹å¦‚åç¨±é‡è¤‡ï¼‰
             showNotification('info', 'æäº¤å¤±æ•—', 'ä½ çš„åç¨±å¯èƒ½å·²è¢«æ­¤æ’è¡Œæ¦œä¸Šçš„å…¶ä»–ç©å®¶ä½¿ç”¨ï¼Œè«‹æ›´æ›åç¨±å¾Œå†è©¦ä¸€æ¬¡ã€‚');
        }

    } catch (error) {
        // å¦‚æœç™¼ç”Ÿç¶²è·¯éŒ¯èª¤ç­‰å•é¡Œ
        console.error("æäº¤åˆ†æ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
        showNotification('info', 'æäº¤éŒ¯èª¤', 'èˆ‡ä¼ºæœå™¨é€£ç·šæ™‚ç™¼ç”Ÿå•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
    }
}
// ==============================================================
// ====== ã€æ–°å¢å‡½æ•¸çµæŸã€‘ ======================================
// ==============================================================

            // --- Game Logic ---
            function generateNote(noteData) {
    if (!gameActive) return;
    const trackIndex = noteData.track;
    const track = document.querySelector(`.track[data-track="${trackIndex}"]`);
    if (!track) return;
    const note = document.createElement('div');
    note.className = noteData.type === 'long' ? 'long-note' : 'note';
    note.dataset.track = trackIndex;
    note.style.animationDuration = `${noteSpeed}ms`;
    if (noteData.type === 'long') {
        const noteHeight = (noteData.duration / (noteSpeed / 1000)) * (tracksContainer.clientHeight + 50);
        note.style.height = `${Math.max(30, noteHeight)}px`;
    }
    track.appendChild(note);
    const noteObj = {
        element: note,
        track: trackIndex,
        type: noteData.type,
        duration: noteData.duration || 0,
        active: true,
        hitStarted: false,
        // â–¼â–¼â–¼ ã€å„ªåŒ–ã€‘è¨˜éŒ„éŸ³ç¬¦è¢«å‰µé€ æ™‚çš„ç²¾ç¢ºæ™‚é–“æˆ³ â–¼â–¼â–¼
        creationTime: Date.now(),
        // â–²â–²â–² å„ªåŒ–çµæŸ â–²â–²â–²
    };
    notes.push(noteObj);
}

          // â–¼â–¼â–¼ ã€ä¿®è¨‚å¾Œã€‘ä½¿ç”¨ç‰©ä»¶æ± çš„ createHitParticles å‡½æ•¸ â–¼â–¼â–¼
function createHitParticles(trackIndex, judgment) {
    const track = document.querySelector(`.track[data-track="${trackIndex}"]`);
    if (!track) return;

    const particleCount = (judgment === 'perfect') ? 15 : (judgment === 'great' ? 10 : 7); // ç¨å¾®æ¸›å°‘ç²’å­æ•¸é‡ä»¥æå‡æ•ˆèƒ½
    const maxOffset = (judgment === 'perfect') ? 100 : (judgment === 'great' ? 80 : 60);

    const colors = {
        perfect: '#ffcc00', great: '#00ccff', good: '#00ff99'
    };

    for (let i = 0; i < particleCount; i++) {
        // å¾æ± ä¸­ç²å–ä¸€å€‹ç²’å­
        currentHitParticleIndex = (currentHitParticleIndex + 1) % PARTICLE_POOL_SIZE;
        const particle = hitParticlePool[currentHitParticleIndex];

        // é‡è¨­æ¨£å¼ä¸¦å•Ÿå‹•å‹•ç•«
        particle.style.background = colors[judgment] || '#fff';
        const size = Math.floor(8 + Math.random() * 8);
        particle.style.setProperty('--size', `${size}px`);
        const x = (Math.random() - 0.5) * maxOffset * 2;
        const y = (Math.random() * -maxOffset) - 20;
        particle.style.setProperty('--x', `${x}px`);
        particle.style.setProperty('--y', `${y}px`);
        const rot = Math.random() * 360;
        const rotEnd = rot + (Math.random() * 720 - 360);
        particle.style.setProperty('--rot', `${rot}deg`);
        particle.style.setProperty('--rot-end', `${rotEnd}deg`);
        particle.style.left = `calc(${track.offsetLeft}px + 50% - ${size / 2}px)`;
        
        // ç§»é™¤èˆŠçš„å‹•ç•«é¡åˆ¥ï¼Œå¼·åˆ¶é‡å•Ÿå‹•ç•«
        particle.classList.remove('animate');
        void particle.offsetWidth; // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª
        particle.classList.add('animate');
        
        // ä½¿ç”¨ animationend äº‹ä»¶ä¾†å›æ”¶ç²’å­ï¼Œæ¯” setTimeout æ›´ç²¾æº–
        particle.onanimationend = () => {
            particle.classList.remove('animate');
            particle.onanimationend = null; // æ¸…é™¤äº‹ä»¶ç›£è½å™¨
        };
    }
}

// â–¼â–¼â–¼ ã€ä¿®è¨‚å¾Œã€‘ä½¿ç”¨ç‰©ä»¶æ± çš„ explodeNote å‡½æ•¸ â–¼â–¼â–¼
function explodeNote(noteElement, judgment) {
    if (!noteElement) return;

    const rect = noteElement.getBoundingClientRect();
    const trackRect = tracksContainer.getBoundingClientRect();
    const particleCount = (judgment === 'perfect') ? 15 : (judgment === 'great' ? 10 : 7); // æ¸›å°‘ç²’å­æ•¸é‡
    const maxOffset = 80;

    const colors = {
        perfect: '#ffcc00', great: '#00ccff', good: '#00ff99'
    };

    for (let i = 0; i < particleCount; i++) {
        // å¾æ± ä¸­ç²å–ä¸€å€‹ç²’å­
        currentNoteParticleIndex = (currentNoteParticleIndex + 1) % PARTICLE_POOL_SIZE;
        const particle = noteParticlePool[currentNoteParticleIndex];

        particle.style.background = colors[judgment] || '#fff';
        const size = Math.floor(4 + Math.random() * 9);
        particle.style.setProperty('--size', `${size}px`);
        const x = (Math.random() - 0.5) * maxOffset * 2;
        const y = (Math.random() - 0.5) * maxOffset * 2;
        particle.style.setProperty('--x', `${x}px`);
        particle.style.setProperty('--y', `${y}px`);
        const rot = Math.random() * 360;
        const rotEnd = rot + (Math.random() * 720 - 360);
        particle.style.setProperty('--rot', `${rot}deg`);
        particle.style.setProperty('--rot-end', `${rotEnd}deg`);
        particle.style.left = `${rect.left - trackRect.left + rect.width / 2 - size / 2}px`;
        particle.style.top = `${rect.top - trackRect.top + rect.height / 2 - size / 2}px`;

        particle.classList.remove('animate');
        void particle.offsetWidth;
        particle.classList.add('animate');

        particle.onanimationend = () => {
            particle.classList.remove('animate');
            particle.onanimationend = null;
        };
    }
}



            

     function judgeHit(trackIndex, type) {
                const track = document.querySelector(`.track[data-track="${trackIndex}"]`);
                if (sounds[type]) {
                    sounds[type]();
                }

                // å‰µå»ºä¸¦é¡¯ç¤ºåˆ¤å®šæ–‡å­— (Perfect, Great, etc.)
                const judgment = document.createElement('div');
                judgment.className = `judgment ${type}`;
                judgment.textContent = `${type.toUpperCase()}!`;
                if (track) {
                    track.appendChild(judgment);
                    judgment.style.left = '0';
                    judgment.style.width = '100%';
                    judgment.style.textAlign = 'center';
                }
                setTimeout(() => {
                    if (judgment && judgment.parentNode) {
                        judgment.remove();
                    }
                }, 1000);

                // è™•ç†é 'miss' çš„æˆåŠŸæ‰“æ“Š
                if (type !== 'miss') {
                    // è§¸ç™¼ç²’å­æ•ˆæœ
                    createHitParticles(trackIndex, type);

                    // è§¸ç™¼æ‰“æ“Šç·šçš„è„ˆè¡å‹•ç•«
                    const hitLine = track.querySelector('.hit-line');
                    if (hitLine) {
                        hitLine.classList.remove('pulse-effect');
                        void hitLine.offsetWidth; // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª
                        hitLine.classList.add('pulse-effect');
                    }

                    // æ ¹æ“šåˆ¤å®šç­‰ç´šè§¸ç™¼ä¸åŒçš„è»Œé“é–ƒå…‰æ•ˆæœ
                    if (track) {
                        track.classList.remove('flash-perfect', 'flash-great', 'flash-good');
                        void track.offsetWidth;
                        if (type === 'perfect') {
                            track.classList.add('flash-perfect');
                        } else if (type === 'great') {
                            track.classList.add('flash-great');
                        } else if (type === 'good') {
                            track.classList.add('flash-good');
                        }
                    }

                    // è§¸ç™¼è£ç½®éœ‡å‹•å›é¥‹
                    if (navigator.vibrate) {
                        let vibrationPattern;
                        if (type === 'perfect') {
                            vibrationPattern = [55]; // çŸ­ä¿ƒæœ‰åŠ›çš„éœ‡å‹•
                        } else if (type === 'great') {
                            vibrationPattern = [55]; // ä¸­ç­‰éœ‡å‹•
                        } else if (type === 'good') {
                            vibrationPattern = [50]; // è¼•å¾®éœ‡å‹•
                        }
                        if (vibrationPattern) {
                            navigator.vibrate(vibrationPattern);
                        }
                    }

                   // ã€é—œéµä¿®å¾© 1ã€‘åœ¨é€™è£¡æ ¹æ“šåˆ¤å®šé¡å‹ï¼Œå®šç¾© baseScore çš„å€¼
let baseScore = 0;
if (type === 'perfect') baseScore = 100;
else if (type === 'great') baseScore = 70;
else if (type === 'good') baseScore = 40;
                    
                    // ã€é—œéµä¿®å¾© 2ã€‘å°‡ addScore ç§»åˆ°é€™è£¡ï¼Œç¢ºä¿ç„¡è«–è£ç½®æ˜¯å¦æ”¯æ´éœ‡å‹•ï¼Œéƒ½æœƒè¨ˆåˆ†
                    addScore(baseScore);

                } else {
                    // è™•ç† 'miss' çš„æƒ…æ³
                    combo = 0;
                    const difficulty = getCurrentDifficulty();
                    trackCooldownUntil[trackIndex] = Date.now() + difficulty.cooldown;
                }

                updateUI();
            }

          function addScore(baseScore) {
                combo++;
                if (combo > maxCombo) maxCombo = combo;
                
                // æ ¸å¿ƒä¿®è¨‚ï¼šåˆ†é–‹è¨ˆç®—ç¸½åˆ†èˆ‡ç”¨æ–¼è§£é–çš„ç´”ç²¹åˆ†æ•¸
                pureHitScore += baseScore; // ç´”æ“Šæ‰“åˆ†æ•¸ï¼Œç”¨æ–¼è§£é–æ¢ä»¶åˆ¤æ–·
                score += baseScore + Math.floor(baseScore * (Math.floor(combo / 10) * 0.1)); // åŒ…å«é€£æ“Šçå‹µçš„ç¸½åˆ†ï¼Œç”¨æ–¼é¡¯ç¤º

                if (combo > 5) {
                    const comboEl = document.createElement('div');
                    comboEl.className = 'combo-display';
                    comboEl.textContent = `${combo} COMBO!`;
                    if (combo >= 1000) comboEl.classList.add('combo-rainbow');
                    else if (combo >= 500) comboEl.classList.add('combo-purple');
                    else if (combo >= 200) comboEl.classList.add('combo-pink');
                    else if (combo >= 100) comboEl.classList.add('combo-orange');
                    else if (combo >= 50) comboEl.classList.add('combo-blue');
                    else comboEl.classList.add('combo-base');
                    tracksContainer.appendChild(comboEl);
                    if (sounds.combo) sounds.combo();
                    setTimeout(() => comboEl.remove(), 500);
                }
                let trackComboClass = '';
                if (combo >= 1000) trackComboClass = 'combo-rainbow';
                else if (combo >= 500) trackComboClass = 'combo-purple';
                else if (combo >= 200) trackComboClass = 'combo-pink';
                else if (combo >= 100) trackComboClass = 'combo-orange';
                else if (combo >= 50) trackComboClass = 'combo-blue';
                tracksContainer.className = 'tracks';
                if (trackComboClass) tracksContainer.classList.add(trackComboClass);
                
                updateUnlockMeter(); // åœ¨åˆ†æ•¸æ›´æ–°å¾Œï¼ŒåŒæ­¥æ›´æ–°è§£é–é€²åº¦æ¢
            }

 // â–¼â–¼â–¼ æ–°å¢çš„å‡½æ•¸ â–¼â–¼â–¼
           // â–¼â–¼â–¼ ä¿®æ­£å¾Œçš„å‡½æ•¸ â–¼â–¼â–¼
function updateUnlockMeter() {
                if (maxScoreForCurrentLevel <= 0) return; // é¿å…é™¤ä»¥é›¶çš„éŒ¯èª¤
                
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘é€²åº¦æ¢çš„ç™¾åˆ†æ¯”æ‡‰åŸºæ–¼ä¸å« COMBO çš„ç´”ç²¹åˆ†æ•¸ï¼ˆpureHitScoreï¼‰ä¾†è¨ˆç®—
                const currentPercent = Math.min(100, (pureHitScore / maxScoreForCurrentLevel) * 100);
                
                unlockProgressBar.style.width = `${currentPercent}%`;

                // æª¢æŸ¥æ˜¯å¦è¶…éäº†ä»»ä¸€æ¢è§£é–ç·šï¼Œå¦‚æœè¶…éå‰‡æ·»åŠ ç™¼å…‰æ•ˆæœ
                const hasReachedSongUnlock = currentPercent >= SONG_UNLOCK_PERCENTAGE * 100;
                const hasReachedDifficultyUnlock = currentPercent >= DIFFICULTY_UNLOCK_PERCENTAGE * 100;
                
                if (hasReachedSongUnlock || hasReachedDifficultyUnlock) {
                    unlockProgressBar.classList.add('glowing');
                } else {
                    unlockProgressBar.classList.remove('glowing');
                }
            }
            // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²

            async function getAudioDuration(src) {
                return new Promise((resolve) => {
                    const tempAudio = new Audio(src);
                    tempAudio.addEventListener('loadedmetadata', () => resolve(tempAudio.duration));
                    tempAudio.addEventListener('error', () => resolve(120));
                });
            }

            async function analyzeAudioForBeats(url) {
                try {
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    const channelData = audioBuffer.getChannelData(0);
                    const sampleRate = audioBuffer.sampleRate;
                    const beats = [];
                    const bufferSize = 1024;
                    const historySize = 43;
                    const C = 1.3;
                    const energyHistory = []; // <-- [ä¿®è¨‚] æ–°å¢é€™ä¸€è¡Œ


                    
                    const getEnergy = (buffer) => {
                        let sum = 0;
                        for (let i = 0; i < buffer.length; i++) {
                            sum += buffer[i] * buffer[i];
                        }
                        return Math.sqrt(sum / buffer.length);
                    };
                    for (let i = 0; i < channelData.length; i += bufferSize) {
                        const buffer = channelData.slice(i, i + bufferSize);
                        const currentEnergy = getEnergy(buffer);
                        let averageEnergy = energyHistory.length > 0 ?
                            energyHistory.reduce((a, b) => a + b, 0) / energyHistory.length : 0;
                        if (currentEnergy > averageEnergy * C) {
                            const beatTime = i / sampleRate;
                            if (beats.length === 0 || beatTime > beats[beats.length - 1] + 0.2) {
                                beats.push(beatTime);
                            }
                        }
                        energyHistory.push(currentEnergy);
                        if (energyHistory.length > historySize) {
                            energyHistory.shift();
                        }
                    }
                    console.log(`åµæ¸¬åˆ° ${beats.length} å€‹ç¯€æ‹ã€‚`);
                    return beats;
                } catch (error) {
                    console.error("éŸ³è¨Šåˆ†æå¤±æ•—ï¼ˆå¯èƒ½æ˜¯ CORS è·¨åŸŸå•é¡Œï¼‰:", error);
                    return [];
                }
            }

            function getCurrentDifficulty() {
                return difficultySettings[difficultySelect.value] || difficultySettings.normal;
            }

          async function startGame() {
    const selectedSong = musicSelect.value;
    const selectedDifficulty = difficultySelect.value;

    if (!isSongUnlocked(selectedSong)) {
        showUnlockModal(`åœ¨æ™®é€šæ¨¡å¼ä¸‹é”åˆ° ${SONG_UNLOCK_SCORE} åˆ†ä»¥è§£é–ä¸‹ä¸€é¦–æ­Œæ›²ã€‚`);
        return;
    }
    if (!isDifficultyUnlocked(selectedSong, selectedDifficulty)) {
        let reqScore = 0;
        let reqDiff = '';
        if (selectedDifficulty === 'hard') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_NORMAL_TO_HARD;
            reqDiff = 'æ™®é€š';
        } else if (selectedDifficulty === 'hell') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_HARD_TO_HELL;
            reqDiff = 'å›°é›£';
        }
        showUnlockModal(`åœ¨ ${reqDiff} æ¨¡å¼ä¸‹é”åˆ° ${reqScore} åˆ†ä»¥è§£é–æ­¤é›£åº¦ã€‚`);
        return;
    }

    if (gameActive) return;
    gameActive = true;
    startBtn.disabled = true;
    musicSelect.disabled = true;
    difficultySelect.disabled = true;

    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®è¨‚ã€‘ç„¡æ¢ä»¶è¨­å®šå…©æ¢åˆæ ¼ç·šçš„ä½ç½® â–¼â–¼â–¼
    mainGameContainer.classList.add('game-running'); 
    
    // æ ¹æ“šé è¨­çš„ç™¾åˆ†æ¯”å¸¸æ•¸ï¼Œè¨­å®šå…©æ¢ç·šçš„ left å±¬æ€§
    songUnlockMarker.style.left = `${SONG_UNLOCK_PERCENTAGE * 100}%`;
    difficultyUnlockMarker.style.left = `${DIFFICULTY_UNLOCK_PERCENTAGE * 100}%`;
    // â–²â–²â–² ä¿®è¨‚çµæŸ â–²â–²â–²
    
    // æ–°å¢ï¼šåˆå§‹åŒ–é€²åº¦æ¢é«˜åº¦å’Œå¯¬åº¦ï¼Œç¢ºä¿é¡¯ç¤ºæ­£å¸¸ï¼ˆä¿®å¾©ç„¡æ³•é¡¯ç¤ºçš„BUGï¼‰
    unlockProgressBar.style.height = '100%';
    unlockProgressBar.style.width = '0%';
    unlockProgressBar.classList.remove('glowing');

    startBtn.innerHTML = `<svg class="start-button-svg" viewBox="0 0 40 40" style="width:40px;height:40px;">
        <circle cx="20" cy="20" r="18" stroke="#ff8a00" stroke-width="3" fill="none" stroke-dasharray="89" stroke-dashoffset="20">
            <animateTransform attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="1s" repeatCount="indefinite" />
        </circle>
    </svg>`;
    
    const difficulty = getCurrentDifficulty();
    const beatTimestamps = await analyzeAudioForBeats(selectedSong);
    startBtn.innerHTML = originalStartButtonSVG;
 
    progressContainerDiv.style.display = 'block';
    trackCooldownUntil.fill(0); 
    audio.src = selectedSong;
    audio.volume = volumeControlModal.value;
    currentSongDuration = await getAudioDuration(selectedSong);
    noteSpeed = Math.floor(4000 / difficulty.speedMultiplier);
    // â–¼â–¼â–¼ [ä¿®è¨‚] ç”ŸæˆåŸºæ–¼æ­Œæ›²å’Œé›£åº¦çš„å›ºå®šç¨®å­ â–¼â–¼â–¼
const songAndDifficultyString = selectedSong + selectedDifficulty;
let seed = 0;
for (let i = 0; i < songAndDifficultyString.length; i++) {
    const char = songAndDifficultyString.charCodeAt(i);
    seed = ((seed << 5) - seed) + char;
    seed |= 0; // Convert to 32bit integer
}
// ç¢ºä¿ç¨®å­ç‚ºæ­£æ•¸
seed = Math.abs(seed) || 1; // é¿å…ç¨®å­ç‚º 0
console.log(`Generating notes for ${selectedSong} (${selectedDifficulty}) with seed: ${seed}`);
// â–²â–²â–² [ä¿®è¨‚çµæŸ] â–²â–²â–²

// â–¼â–¼â–¼ [ä¿®è¨‚] å‚³å…¥ç¨®å­ â–¼â–¼â–¼
noteQueue = generateSongData(currentSongDuration, difficulty, beatTimestamps, seed, noteSpeed); // å‚³å…¥ noteSpeed
// â–²â–²â–² [ä¿®è¨‚çµæŸ] â–²â–²â–²

    // â–¼â–¼â–¼ ã€ä¿®è¨‚å¾Œçš„æ ¸å¿ƒé‚è¼¯ã€‘ â–¼â–¼â–¼
    // åœ¨ç”ŸæˆéŸ³ç¬¦å¾Œï¼Œå‹•æ…‹è¨ˆç®—ä¸å«é€£æ“Šçå‹µçš„ç†è«–æœ€é«˜åˆ†
  const maxBaseScorePerNote = 100; // ä¿®æ­£ç‚º "Perfect" çš„å¯¦éš›åŸºç¤åˆ†æ•¸ 55
maxScoreForCurrentLevel = noteQueue.length * maxBaseScorePerNote;

    // å¦‚æœè¨ˆç®—çµæœç‚º 0 (ä¾‹å¦‚æ­Œæ›²æ²’æœ‰éŸ³ç¬¦)ï¼Œå‰‡æä¾›ä¸€å€‹é è¨­å€¼ä»¥é¿å…éŒ¯èª¤
    if (maxScoreForCurrentLevel === 0) {
        maxScoreForCurrentLevel = 300000; // è¨­ç½®ä¸€å€‹å¾Œå‚™å€¼
    }
    // â–²â–²â–² ã€ä¿®è¨‚çµæŸã€‘ â–²â–²â–²

    await audio.play().catch(e => console.log("éŸ³è¨Šæ’­æ”¾å¤±æ•—:", e));
    gameStartTime = Date.now();
    generateNotesContinuously();
    gameLoop();
    progressInterval = setInterval(updateProgress, 100);
    setTimeout(() => { if (gameActive) endGame(); }, currentSongDuration * 1000 + 2000);

    // æ–°å¢ï¼šè¼‰å…¥ä¸¦åˆå§‹åŒ–éŠæˆ²æ­Œè©é¡¯ç¤º
    const lyricsLeft = document.querySelector('.lyrics-left');
    const lyricsRight = document.querySelector('.lyrics-right');
    if (lyricsLeft && lyricsRight) {
        lyricsLeft.classList.remove('hidden');
        lyricsRight.classList.remove('hidden');
    }
}


// æ–°å¢è¼”åŠ©å‡½æ•¸ï¼šåˆ†æç¯€æ‹é–“éš”ï¼Œä¼°ç®—åŸºæœ¬æ™‚é–“å–®ä½ï¼ˆå¦‚åå…­åˆ†éŸ³ç¬¦é•·åº¦ï¼‰
function analyzeBeatIntervals(beatTimestamps) {
    if (!beatTimestamps || beatTimestamps.length < 2) {
        console.warn("ç¯€æ‹æ•¸æ“šä¸è¶³ï¼Œç„¡æ³•åˆ†æã€‚");
        return { baseInterval: 0.5 }; // è¿”å›ä¸€å€‹é»˜èªå€¼
    }

    const intervals = [];
    for (let i = 1; i < beatTimestamps.length; i++) {
        // è¨ˆç®—ç›¸é„°ç¯€æ‹ä¹‹é–“çš„æ™‚é–“å·®
        const interval = beatTimestamps[i] - beatTimestamps[i - 1];
        // éæ¿¾æ‰éæ–¼çŸ­æˆ–éæ–¼é•·çš„ç•°å¸¸å€¼ï¼ˆå¯é¸ï¼Œæ ¹æ“šå¯¦éš›æ•¸æ“šèª¿æ•´ï¼‰
        if (interval > 0.05 && interval < 5.0) {
             intervals.push(interval);
        }
    }

    if (intervals.length === 0) {
        console.warn("ç„¡æœ‰æ•ˆç¯€æ‹é–“éš”æ•¸æ“šã€‚");
        return { baseInterval: 0.5 };
    }

    // ç°¡å–®æ–¹æ³•ï¼šå‡è¨­æœ€å°é–“éš”å°æ‡‰æ–¼æœ€çŸ­çš„éŸ³ç¬¦ï¼ˆå¦‚åå…­åˆ†éŸ³ç¬¦ï¼‰
    // æ›´è¤‡é›œçš„æ–¹æ³•å¯ä»¥çµ±è¨ˆé–“éš”çš„åˆ†ä½ˆï¼Œæ‰¾å‡ºåŸºé »
    const minInterval = Math.min(...intervals);
    // å››åˆ†éŸ³ç¬¦é–“éš”é€šå¸¸æ˜¯é€™å€‹æœ€å°é–“éš”çš„å€æ•¸ (e.g., 4å€)
    // æˆ‘å€‘å¯ä»¥ä¼°ç®—ä¸€å€‹åŸºæº–é–“éš”ï¼Œé€™è£¡ç°¡åŒ–ç‚ºç›´æ¥ä½¿ç”¨æœ€å°é–“éš”æˆ–å…¶ä¸€éƒ¨åˆ†ä½œç‚ºåå…­åˆ†éŸ³ç¬¦é•·åº¦
    // å‡è¨­æœ€å°é–“éš”æ˜¯åå…­åˆ†éŸ³ç¬¦ (1/16) çš„é•·åº¦
    const baseInterval = minInterval; // é€™ä»£è¡¨ 1/16 éŸ³ç¬¦çš„é•·åº¦

    console.log(`åˆ†æå¾—å‡ºçš„åŸºæº–é–“éš” (ä¼°è¨ˆ1/16éŸ³ç¬¦é•·åº¦): ${baseInterval.toFixed(3)} ç§’`);
    return { baseInterval };
}


           // â–¼â–¼â–¼ [æ–°å¢] PRNG å‡½æ•¸ (ç¢ºä¿é€™æ®µä»£ç¢¼å­˜åœ¨æ–¼ä½ çš„è…³æœ¬ä¸­) â–¼â–¼â–¼
// Mulberry32 PRNG - https://gist.github.com/tommyettinger/46a874533244883189143505d203312c
function mulberry32(a) {
    return function() {
        a |= 0; a = a + 0x6D2B79F5 | 0;
        var t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
}
// â–²â–²â–² [æ–°å¢çµæŸ] â–²â–²â–²


function generateSongData(duration, difficulty, beatTimestamps, seed = 12345, noteSpeed) {
    console.log(`Generating notes with seed: ${seed}`);
    const seededRandom = mulberry32(seed);
    const tracks = 4;

    // --- ç©ºé–“è¡›å…µè¨­å®š ---
    const totalFallDistance = tracksContainer.clientHeight + 50;
    const pixelsPerSecond = totalFallDistance / (noteSpeed / 1000);
    const SHORT_NOTE_SAFE_HEIGHT = 40 + 10; // ã€ä¿®è¨‚ã€‘ç‚ºçŸ­éŸ³ç¬¦å¢åŠ é¡å¤– 10px ç·©è¡ï¼Œé˜²æ­¢è¦–è¦ºé‡ç–Š
    const MIN_LONG_NOTE_SAFE_HEIGHT = 50;
    const VISUAL_COMFORT_GAP = difficulty.visualGap || 50;
    
    const data = [];
    // ç©ºé–“è¡›å…µï¼šè¿½è¹¤æ¯å€‹è»Œé“åœ¨ç‰©ç†åƒç´ ä¸Šçš„å¯ç”¨ä½ç½®
    const trackFreeAtPixel = new Array(tracks).fill(0);
    
    // æ™‚é–“è¡›å…µï¼šè¿½è¹¤æ¯å€‹è»Œé“åœ¨éŸ³æ¨‚æ™‚é–“ä¸Šçš„å¯ç”¨æ™‚é–“é»
    const trackFreeAtTime = new Array(tracks).fill(0);

    const baseIntervalAnalysis = analyzeBeatIntervals(beatTimestamps);
    const baseInterval = baseIntervalAnalysis.baseInterval;

    const rhythmPatterns = [
        { name: "åå…­åˆ†éŸ³ç¬¦", duration: baseInterval, weight: 0.70 },
        { name: "ä¸‰åäºŒåˆ†éŸ³ç¬¦", duration: baseInterval / 2, weight: 0.30 }
    ];
    const noteGenerationTypes = [
        { type: 'short', weight: 0.75 },
        { type: 'long', weight: 0.25 }
    ];

    const totalRhythmWeight = rhythmPatterns.reduce((sum, p) => sum + p.weight, 0);
    const totalTypeWeight = noteGenerationTypes.reduce((sum, t) => sum + t.weight, 0);

    let currentTime = 1.0;

    while (currentTime < duration - (2.0 + (noteSpeed / 1000))) {
        let randomRhythm = seededRandom() * totalRhythmWeight;
        let selectedRhythm = rhythmPatterns[0];
        for (const pattern of rhythmPatterns) {
            randomRhythm -= pattern.weight;
            if (randomRhythm <= 0) {
                selectedRhythm = pattern;
                break;
            }
        }
        const stepDuration = selectedRhythm.duration;

        // ã€ä¿®è¨‚ã€‘åœ¨éŠæˆ²é–‹å§‹å‰5ç§’ï¼Œé™ä½å¯†åº¦ 20% ä»¥æ¸›å°‘å¯†é›†ç”Ÿæˆ
        let effectiveDensity = difficulty.noteDensity;
        if (currentTime < 5) {
            effectiveDensity *= 0.8; // é™ä½ 20%
        }

        if (seededRandom() < effectiveDensity) {
            const availableTracks = [];
            for (let i = 0; i < tracks; i++) {
                availableTracks.push(i);
            }

            if (availableTracks.length > 0) {
                const trackIndex = availableTracks[Math.floor(seededRandom() * availableTracks.length)];

                const newNoteStartPixel = currentTime * pixelsPerSecond;
                // ã€ä¿®è¨‚ã€‘åŠ å¼·æª¢æŸ¥ï¼šå¢åŠ æœ€å°æ™‚é–“é–“éš™ 0.1 ç§’
                if (currentTime >= trackFreeAtTime[trackIndex] + 0.1 && newNoteStartPixel >= trackFreeAtPixel[trackIndex]) {

                    // ã€ä¿®è¨‚ã€‘åœ¨é–‹å§‹å‰5ç§’ï¼Œé™ä½é•·éŸ³ç¬¦æ©Ÿç‡ 50%
                    let effectiveLongWeight = 0.25;
                    if (currentTime < 5) {
                        effectiveLongWeight *= 0.5;
                    }
                    let randomType = seededRandom() * (0.75 + effectiveLongWeight); // èª¿æ•´ç¸½æ¬Šé‡
                    let selectedType = { type: 'short' };
                    if (randomType > 0.75) {
                        selectedType = { type: 'long' };
                    }

                    let finalNoteDuration = 0;
                    if (selectedType.type === 'long') {
                        const minMultiplier = difficulty.longNoteMinMultiplier || 2;
                        const maxMultiplier = difficulty.longNoteMaxMultiplier || 6;
                        const randomMultiplier = minMultiplier + seededRandom() * (maxMultiplier - minMultiplier);
                        finalNoteDuration = Math.min(baseInterval * randomMultiplier, 2.0);
                    }
                    
                    data.push({
                        time: currentTime,
                        track: trackIndex,
                        type: finalNoteDuration > 0 ? 'long' : 'short',
                        duration: finalNoteDuration
                    });

                    // --- æ›´æ–°å…©å€‹è¡›å…µçš„ç‹€æ…‹ ---
                    
                    // 1. æ›´æ–°ç©ºé–“è¡›å…µ
                    let currentNoteSafeHeight = (finalNoteDuration > 0)
                        ? Math.max(MIN_LONG_NOTE_SAFE_HEIGHT, finalNoteDuration * pixelsPerSecond)
                        : SHORT_NOTE_SAFE_HEIGHT;
                    trackFreeAtPixel[trackIndex] = newNoteStartPixel + currentNoteSafeHeight + VISUAL_COMFORT_GAP;

                    // ã€ä¿®è¨‚ã€‘æ›´æ–°æ™‚é–“è¡›å…µï¼Œä¸¦ç‚ºé•·éŸ³ç¬¦å¾Œæ·»åŠ é¡å¤– 0.2 ç§’å†·å»
                    if (finalNoteDuration > 0) {
                        trackFreeAtTime[trackIndex] = currentTime + finalNoteDuration + 0.2; // é¡å¤–å†·å»
                    } else {
                        trackFreeAtTime[trackIndex] = currentTime + stepDuration;
                    }
                }
            }
        }
        currentTime += stepDuration;
    }
    return data.sort((a, b) => a.time - b.time);
}

            function generateNotesContinuously() {
                if (!gameActive) return;
                const currentTime = (Date.now() - gameStartTime) / 1000;
                while (noteQueue.length > 0 && noteQueue[0].time < currentTime + (noteSpeed / 1000)) {
                    const noteData = noteQueue.shift();
                    if (trackCooldownUntil[noteData.track] > Date.now()) {
                        continue;
                    }
                    generateNote(noteData);
                }
                if (gameActive) {
                    generateNotesTimer = setTimeout(generateNotesContinuously, 50);
                }
            }


            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘æ‰€æœ‰èˆ‡æ­Œè©æ¸¬é©—ç›¸é—œçš„æ–°å‡½æ•¸ â–¼â–¼â–¼

/**
 * æ ¹æ“šæ­Œæ›² URL ç”Ÿæˆå¡«å……é¡Œ
 * @param {string} songUrl - æ­Œæ›²çš„æª”æ¡ˆåç¨±
 * @returns {Array} - ä¸€å€‹åŒ…å«å•é¡Œç‰©ä»¶çš„é™£åˆ—
 */
function generateQuizQuestions(songUrl) {
    const songLyricsForQuiz = songLyrics[songUrl];
    if (!songLyricsForQuiz || songLyricsForQuiz.length === 0) {
        return []; // å¦‚æœé€™é¦–æ­Œæ²’æœ‰æ­Œè©ï¼Œè¿”å›ç©ºé™£åˆ—
    }

    const generatedQuestions = [];
    const usedLines = new Set(); // ç¢ºä¿ä¸æœƒé‡è¤‡ä½¿ç”¨åŒä¸€å¥æ­Œè©

    // å˜—è©¦å¾æ­Œè©ä¸­ç”Ÿæˆæœ€å¤š 10 å€‹ç¨ç‰¹çš„å•é¡Œ
    while (generatedQuestions.length < 10 && usedLines.size < songLyricsForQuiz.length) {
        let randomIndex;
        do {
            randomIndex = Math.floor(Math.random() * songLyricsForQuiz.length);
        } while (usedLines.has(randomIndex));
        
        const line = songLyricsForQuiz[randomIndex].text;
        usedLines.add(randomIndex);

        // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æ‰¾å‡ºæ­Œè©ä¸­ 2 åˆ° 4 å€‹å­—çš„ä¸­æ–‡è©èªä½œç‚ºç­”æ¡ˆé¸é …
        const words = line.match(/[\u4e00-\u9fa5]{2,4}/g) || [];

        if (words.length > 0) {
            // å¾æ‰¾åˆ°çš„è©èªä¸­éš¨æ©Ÿé¸ä¸€å€‹ä½œç‚ºç­”æ¡ˆ
            const answer = words[Math.floor(Math.random() * words.length)];
            const questionText = line.replace(answer, '____');
            
            // ç¢ºä¿å•é¡Œå·²æˆåŠŸç”Ÿæˆï¼ˆæ›¿æ›å‰å¾Œæ–‡æœ¬ä¸åŒï¼‰
            if (questionText !== line) {
                 generatedQuestions.push({
                    question: questionText,
                    answer: answer
                });
            }
        }
    }
    
    // å¦‚æœç„¡æ³•ç”Ÿæˆä»»ä½•å•é¡Œï¼ˆä¾‹å¦‚æ­Œè©å¤ªçŸ­ï¼‰ï¼Œå‰‡å‰µå»ºä¸€å€‹å‚™ç”¨å•é¡Œ
    if (generatedQuestions.length === 0 && songLyricsForQuiz.length > 0) {
         const fallbackLine = songLyricsForQuiz[0].text;
         if (fallbackLine.length > 2) {
             const answer = fallbackLine.substring(0, 2);
             const question = '____' + fallbackLine.substring(2);
             generatedQuestions.push({ question, answer });
         }
    }
    
    return generatedQuestions;
}

/**
 * è¼”åŠ©å‡½æ•¸ï¼šFisher-Yates æ´—ç‰Œæ¼”ç®—æ³•ï¼Œç”¨æ–¼æ‰“äº‚é¡Œåº«é †åº
 * @param {Array} array - è¦æ‰“äº‚çš„é™£åˆ—
 * @returns {Array} - æ‰“äº‚å¾Œçš„é™£åˆ—
 */
function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

/**
 * é–‹å§‹æ­Œè©å¡«å……æ¸¬é©—
 * @param {string} unlockType - è§£é–é¡å‹ ('song' æˆ– 'difficulty')
 * @param {any} unlockValue - è¦è§£é–çš„ç›®æ¨™å€¼
 * @param {string} songUrlForQuiz - ç”¨æ–¼ç”Ÿæˆæ¸¬é©—é¡Œç›®çš„æ­Œæ›² URL
 */
function startLyricsQuiz(unlockType, unlockValue, songUrlForQuiz) {
    // å¾ songData ä¸­ç²å–é è¨­çš„é¡Œç›®
    const predefinedQuestions = songData[songUrlForQuiz]?.quiz || [];

    if (predefinedQuestions.length === 0) {
        console.warn(`æ­Œæ›² ${songUrlForQuiz} æ²’æœ‰é è¨­é¡Œç›®ï¼Œè‡ªå‹•æˆäºˆè§£é–ã€‚`);
        showNotification('info', 'è‡ªå‹•è§£é–', 'ç”±æ–¼æ­¤æ­Œæ›²ç„¡æ­Œè©å¯ä¾›æ¸¬é©—ï¼Œå·²ç‚ºæ‚¨ç›´æ¥è§£é–æ–°å…§å®¹ï¼');
        if (unlockType === 'song') {
            unlockNextSong(unlockValue);
        } else if (unlockType === 'difficulty') {
            unlockDifficulty(unlockValue.song, unlockValue.difficulty);
        }
        return;
    }
    
    isQuizActive = true;
    quizUnlockTarget = { type: unlockType, value: unlockValue };
    questionsAnsweredCorrectly = 0;
    
    // è¤‡è£½ä¸¦æ‰“äº‚é¡Œåº«ï¼Œé¿å…å½±éŸ¿åŸå§‹è³‡æ–™
    quizQuestions = shuffleArray([...predefinedQuestions]); 
    totalQuestionsInQuiz = quizQuestions.length;
    
    lyricsQuizModal.classList.add('active');
    displayNextQuizQuestion();
}
/**
 * é¡¯ç¤ºä¸‹ä¸€å€‹æ¸¬é©—å•é¡Œ
 */
function displayNextQuizQuestion() {
    // å¦‚æœé¡Œåº«å·²ç©ºï¼Œä»£è¡¨å…¨éƒ¨ç­”å°
    if (quizQuestions.length === 0) {
        endQuiz(true); 
        return;
    }
    
    // å¾é¡Œåº«ä¸­å–å‡ºä¸‹ä¸€é¡Œ
    currentQuizQuestion = quizQuestions.pop();

    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®è¨‚ã€‘å°‡åº•ç·šæ›¿æ›ç‚ºå¸¶æœ‰ class çš„ span å…ƒç´  â–¼â–¼â–¼
    const questionLine = currentQuizQuestion.line.replace(/__/g, '<span class="quiz-blank"></span>');
    quizQuestionText.innerHTML = questionLine;
    // â–²â–²â–² ä¿®è¨‚çµæŸ â–²â–²â–²

    quizProgress.textContent = `é€²åº¦: ${questionsAnsweredCorrectly} / ${totalQuestionsInQuiz}`;
    quizAnswerInput.value = '';
    quizAnswerInput.classList.remove('correct', 'incorrect');
    quizAnswerInput.disabled = false;
    quizSubmitBtn.disabled = false;
    quizAnswerInput.focus();
}
/**
 * æª¢æŸ¥ç©å®¶æäº¤çš„ç­”æ¡ˆ
 */
function checkQuizAnswer() {
    if (!isQuizActive || !currentQuizQuestion) return;

    const userAnswer = quizAnswerInput.value.trim();
    const correctAnswer = currentQuizQuestion.answer;

    quizAnswerInput.disabled = true;
    quizSubmitBtn.disabled = true;

    if (userAnswer === correctAnswer) {
        questionsAnsweredCorrectly++;
        quizAnswerInput.classList.add('correct');
        quizProgress.textContent = `é€²åº¦: ${questionsAnsweredCorrectly} / ${totalQuestionsInQuiz}`;
        
        // ç­”å°å¾Œï¼Œå»¶é²ä¸€å°æ®µæ™‚é–“å†é€²å…¥ä¸‹ä¸€é¡Œ
        setTimeout(displayNextQuizQuestion, 800);
    } else {
        // ã€æ ¸å¿ƒè¦å‰‡ã€‘ç­”éŒ¯ï¼Œç«‹å³çµæŸæ¸¬é©—ä¸¦åˆ¤å®šå¤±æ•—
        quizAnswerInput.classList.add('incorrect');
        setTimeout(() => endQuiz(false), 1200); 
    }
}


/**
 * çµæŸæ¸¬é©—ï¼Œä¸¦æ ¹æ“šçµæœåŸ·è¡Œæœ€çµ‚æ“ä½œ
 * @param {boolean} success - æ¸¬é©—æ˜¯å¦æˆåŠŸ
 */
function endQuiz(success) {
    if (!isQuizActive) return; // é˜²æ­¢é‡è¤‡åŸ·è¡Œ

    isQuizActive = false;
    lyricsQuizModal.classList.remove('active');

    if (success) {
        // å¦‚æœæˆåŠŸï¼Œå‰‡åŸ·è¡ŒçœŸæ­£çš„è§£é–æ“ä½œ
        const { type, value } = quizUnlockTarget;
        if (type === 'song') {
            unlockNextSong(value); 
        } else if (type === 'difficulty') {
            unlockDifficulty(value.song, value.difficulty);
        }
    } else {
        // å¦‚æœå¤±æ•—æˆ–ä¸­é€”é—œé–‰ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
        showNotification('info', 'è§£é–å¤±æ•—', 'æ­Œè©æ¸¬é©—æœªé€šéï¼Œä¸‹æ¬¡è«‹å†æ¥å†å²ï¼');
    }

    // é‡ç½®æ¸¬é©—ç‹€æ…‹ä»¥å‚™ä¸‹æ¬¡ä½¿ç”¨
    quizQuestions = [];
    currentQuizQuestion = null;
    questionsAnsweredCorrectly = 0;
    totalQuestionsInQuiz = 0;
    quizUnlockTarget = null;
}

/**
 * æª¢æŸ¥è§£é–æ¢ä»¶ä¸¦è§¸ç™¼æ¸¬é©—æˆ–é¡¯ç¤ºæç¤º (æ ¸å¿ƒé‚è¼¯å‡½æ•¸)
 * @param {string} songUrl - ç•¶å‰æ­Œæ›² URL
 * @param {string} difficulty - ç•¶å‰é›£åº¦
 * @param {number} pureHitScore - ç´”ç²¹çš„æ“Šæ‰“åˆ†æ•¸ (ä¸å« Combo åŠ æˆ)
 */
function checkAndShowQuizOrInfo(songUrl, difficulty, pureHitScore) {
    // â–¼â–¼â–¼ ã€ä¿®è¨‚è™•ã€‘æª¢æŸ¥ songData ä¸­æ˜¯å¦æœ‰ quiz å±¬æ€§ â–¼â–¼â–¼
    const hasQuiz = songData[songUrl]?.quiz && songData[songUrl].quiz.length > 0;
    // â–²â–²â–² ä¿®è¨‚çµæŸ â–²â–²â–²
    let potentialUnlock = null;

    // æª¢æŸ¥1: æ˜¯å¦æ»¿è¶³è§£é–ã€æ–°æ­Œæ›²ã€‘çš„æ¢ä»¶ (åƒ…åœ¨æ™®é€šé›£åº¦ä¸‹)
    if (difficulty === 'normal') {
        const allSongs = Array.from(musicSelect.options).map(opt => opt.value);
        const lastUnlockedSong = saveData.unlockedSongs[saveData.unlockedSongs.length - 1];
        
        // å¿…é ˆç©çš„æ˜¯ç•¶å‰å·²è§£é–çš„æœ€å¾Œä¸€é¦–æ­Œ
        if (songUrl === lastUnlockedSong) {
            const currentIndex = allSongs.indexOf(lastUnlockedSong);
            if (currentIndex >= 0 && currentIndex < allSongs.length - 1) {
                const nextSong = allSongs[currentIndex + 1];
                if (!isSongUnlocked(nextSong)) {
                    const requiredScore = maxScoreForCurrentLevel * SONG_UNLOCK_PERCENTAGE;
                    if (pureHitScore >= requiredScore) {
                        potentialUnlock = { type: 'song', value: songUrl, songForQuiz: songUrl };
                    } else {
                        const remainingScore = Math.ceil(requiredScore - pureHitScore);
                        showNotification('info', 'ç›®æ¨™å·®ä¸€é»ï¼', `æ‚¨åœ¨ã€Œæ™®é€šã€é›£åº¦ä¸‹é‚„å·® <strong>${remainingScore.toLocaleString()}</strong> åˆ†å°±èƒ½æŒ‘æˆ°è§£é–ä¸‹ä¸€é¦–æ­Œæ›²äº†ã€‚å†åŠ æŠŠå‹ï¼`, 6000);
                    }
                }
            }
        }
    }

    // å¦‚æœå·²æ»¿è¶³è§£é–æ­Œæ›²æ¢ä»¶ï¼Œå‰‡å„ªå…ˆè™•ç†ï¼Œä¸¦çµ‚æ­¢å¾ŒçºŒæª¢æŸ¥
    if (potentialUnlock) {
        if (hasQuiz) {
            startLyricsQuiz(potentialUnlock.type, potentialUnlock.value, potentialUnlock.songForQuiz);
        } else {
            console.warn(`æ­Œæ›² ${potentialUnlock.songForQuiz} ç„¡æ³•è§¸ç™¼æ¸¬é©—ï¼Œå› ç‚ºæ²’æœ‰é è¨­é¡Œç›®ã€‚å°‡ç›´æ¥è§£é–ã€‚`);
            unlockNextSong(potentialUnlock.value);
        }
        return; 
    }

    // æª¢æŸ¥2: æ˜¯å¦æ»¿è¶³è§£é–ã€å›°é›£ã€‘é›£åº¦çš„æ¢ä»¶ (å¾æ™®é€šé›£åº¦æŒ‘æˆ°)
    if (difficulty === 'normal' && !isDifficultyUnlocked(songUrl, 'hard')) {
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        if (pureHitScore >= requiredScore) {
            potentialUnlock = { type: 'difficulty', value: { song: songUrl, difficulty: 'hard' }, songForQuiz: songUrl };
        }
    }

    // æª¢æŸ¥3: æ˜¯å¦æ»¿è¶³è§£é–ã€åœ°ç„ã€‘é›£åº¦çš„æ¢ä»¶ (å¾å›°é›£é›£åº¦æŒ‘æˆ°)
    if (difficulty === 'hard' && !isDifficultyUnlocked(songUrl, 'hell')) {
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        if (pureHitScore >= requiredScore) {
            potentialUnlock = { type: 'difficulty', value: { song: songUrl, difficulty: 'hell' }, songForQuiz: songUrl };
        }
    }
    
    // å¦‚æœæ»¿è¶³è§£é–é›£åº¦çš„æ¢ä»¶ï¼Œè§¸ç™¼ç›¸æ‡‰æ“ä½œ
    if (potentialUnlock) {
         if (hasQuiz) {
            startLyricsQuiz(potentialUnlock.type, potentialUnlock.value, potentialUnlock.songForQuiz);
         } else {
            console.warn(`æ­Œæ›² ${potentialUnlock.songForQuiz} ç„¡æ³•è§¸ç™¼æ¸¬é©—ï¼Œå› ç‚ºæ²’æœ‰é è¨­é¡Œç›®ã€‚å°‡ç›´æ¥è§£é–ã€‚`);
            unlockDifficulty(potentialUnlock.value.song, potentialUnlock.value.difficulty);
         }
    }
}


            



function updateGameLyrics(currentTime) {
    const selectedSong = musicSelect.value;
    
    // â–¼â–¼â–¼ ã€ä¿®è¨‚è™•ã€‘å¾ songData ç²å–æ­Œè© â–¼â–¼â–¼
    const lyrics = songData[selectedSong]?.lyrics || [];
    // â–²â–²â–² ä¿®è¨‚çµæŸ â–²â–²â–²
    
    if (lyrics.length === 0) return; // ç„¡æ­Œè©ï¼Œç›´æ¥è¿”å›

    let currentIndex = -1;
    for (let i = 0; i < lyrics.length; i++) {
        if (lyrics[i].time <= currentTime) {
            currentIndex = i;
        } else {
            break;
        }
    }

    const lyricsBackground = document.getElementById('lyricsBackground');
    if (lyricsBackground) {
        lyricsBackground.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
        const currentLyric = (currentIndex >= 0 && lyrics[currentIndex]) ? lyrics[currentIndex].text : '';
        if (currentLyric) {
            // å‹•æ…‹è¨ˆç®—éœ€è¦çš„ span æ•¸é‡ï¼Œä»¥å¡«æ»¿æ•´å€‹ç•«é¢
            const fontSize = parseFloat(getComputedStyle(lyricsBackground).fontSize); // ç²å–ç•¶å‰ font-size (å–®ä½ px)
            const approxCharWidth = fontSize * 0.6; // ä¼°è¨ˆæ¯å€‹å­—å…ƒçš„å¯¬åº¦ï¼ˆç´„ 0.6 * font-sizeï¼‰
            const lineHeight = fontSize * 1.2; // ä¼°è¨ˆè¡Œé«˜ï¼ˆåŸºæ–¼ line-height: 1.2ï¼‰
            
            const lyricWidth = currentLyric.length * approxCharWidth; // ä¼°è¨ˆå–®å€‹ span çš„å¯¬åº¦
            const spanWidth = Math.max(lyricWidth, window.innerWidth * 0.1); // æœ€å° 10% å¯¬ï¼Œé˜²æ­¢å¤ªçª„
            const spanHeight = lineHeight; // å–®å€‹ span çš„é«˜åº¦
            
            const horizontalCount = Math.ceil(window.innerWidth / spanWidth); // æ°´å¹³èƒ½æ”¾å¤šå°‘å€‹
            const verticalCount = Math.ceil(window.innerHeight / spanHeight); // å‚ç›´èƒ½æ”¾å¤šå°‘å€‹
            
            const densityFactor = 1.2; // ç•¥å¤š 20% ä»¥ç¢ºä¿å®Œå…¨è¦†è“‹ï¼ˆå¯èª¿æ•´ 1.0-1.5ï¼‰
            const totalSpans = Math.ceil(horizontalCount * verticalCount * densityFactor); // ç¸½æ•¸
            
            for (let i = 0; i < totalSpans; i++) {
                const span = document.createElement('span');
                span.textContent = currentLyric;
                lyricsBackground.appendChild(span);
            }
        }
    }
}

// ä¿®è¨‚ï¼šstartGameï¼ˆé¡¯ç¤ºæ–°èƒŒæ™¯å®¹å™¨ï¼‰
async function startGame() {
    const selectedSong = musicSelect.value;
    const selectedDifficulty = difficultySelect.value;

    if (!isSongUnlocked(selectedSong)) {
        showUnlockModal(`åœ¨æ™®é€šæ¨¡å¼ä¸‹é”åˆ° ${SONG_UNLOCK_SCORE} åˆ†ä»¥è§£é–ä¸‹ä¸€é¦–æ­Œæ›²ã€‚`);
        return;
    }
    if (!isDifficultyUnlocked(selectedSong, selectedDifficulty)) {
        let reqScore = 0;
        let reqDiff = '';
        if (selectedDifficulty === 'hard') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_NORMAL_TO_HARD;
            reqDiff = 'æ™®é€š';
        } else if (selectedDifficulty === 'hell') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_HARD_TO_HELL;
            reqDiff = 'å›°é›£';
        }
        showUnlockModal(`åœ¨ ${reqDiff} æ¨¡å¼ä¸‹é”åˆ° ${reqScore} åˆ†ä»¥è§£é–æ­¤é›£åº¦ã€‚`);
        return;
    }

    if (gameActive) return;
    gameActive = true;
    startBtn.disabled = true;
    musicSelect.disabled = true;
    difficultySelect.disabled = true;

    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®è¨‚ã€‘ç„¡æ¢ä»¶è¨­å®šå…©æ¢åˆæ ¼ç·šçš„ä½ç½® â–¼â–¼â–¼
    mainGameContainer.classList.add('game-running'); 
    // åˆå§‹åŒ–é€²åº¦æ¢é«˜åº¦å’Œå¯¬åº¦ï¼Œç¢ºä¿é¡¯ç¤ºæ­£å¸¸
unlockProgressBar.style.height = '100%';
unlockProgressBar.style.width = '0%';
unlockProgressBar.classList.remove('glowing');
    
    // æ ¹æ“šé è¨­çš„ç™¾åˆ†æ¯”å¸¸æ•¸ï¼Œè¨­å®šå…©æ¢ç·šçš„ left å±¬æ€§
    songUnlockMarker.style.left = `${SONG_UNLOCK_PERCENTAGE * 100}%`;
    difficultyUnlockMarker.style.left = `${DIFFICULTY_UNLOCK_PERCENTAGE * 100}%`;
    // â–²â–²â–² ä¿®è¨‚çµæŸ â–²â–²â–²
    
    startBtn.innerHTML = `<svg class="start-button-svg" viewBox="0 0 40 40" style="width:40px;height:40px;">
        <circle cx="20" cy="20" r="18" stroke="#ff8a00" stroke-width="3" fill="none" stroke-dasharray="89" stroke-dashoffset="20">
            <animateTransform attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="1s" repeatCount="indefinite" />
        </circle>
    </svg>`;
    
    const difficulty = getCurrentDifficulty();
    const beatTimestamps = await analyzeAudioForBeats(selectedSong);
    startBtn.innerHTML = originalStartButtonSVG;
 
    progressContainerDiv.style.display = 'block';
    trackCooldownUntil.fill(0); 
    audio.src = selectedSong;
    audio.volume = volumeControlModal.value;
    currentSongDuration = await getAudioDuration(selectedSong);
    noteSpeed = Math.floor(4000 / difficulty.speedMultiplier);
    // â–¼â–¼â–¼ [ä¿®è¨‚] ç”ŸæˆåŸºæ–¼æ­Œæ›²å’Œé›£åº¦çš„å›ºå®šç¨®å­ â–¼â–¼â–¼
const songAndDifficultyString = selectedSong + selectedDifficulty;
let seed = 0;
for (let i = 0; i < songAndDifficultyString.length; i++) {
    const char = songAndDifficultyString.charCodeAt(i);
    seed = ((seed << 5) - seed) + char;
    seed |= 0; // Convert to 32bit integer
}
// ç¢ºä¿ç¨®å­ç‚ºæ­£æ•¸
seed = Math.abs(seed) || 1; // é¿å…ç¨®å­ç‚º 0
console.log(`Generating notes for ${selectedSong} (${selectedDifficulty}) with seed: ${seed}`);
// â–²â–²â–² [ä¿®è¨‚çµæŸ] â–²â–²â–²

// â–¼â–¼â–¼ [ä¿®è¨‚] å‚³å…¥ç¨®å­ â–¼â–¼â–¼
noteQueue = generateSongData(currentSongDuration, difficulty, beatTimestamps, seed, noteSpeed); // å‚³å…¥ noteSpeed
// â–²â–²â–² [ä¿®è¨‚çµæŸ] â–²â–²â–²

    // â–¼â–¼â–¼ ã€ä¿®è¨‚å¾Œçš„æ ¸å¿ƒé‚è¼¯ã€‘ â–¼â–¼â–¼
    // åœ¨ç”ŸæˆéŸ³ç¬¦å¾Œï¼Œå‹•æ…‹è¨ˆç®—ä¸å«é€£æ“Šçå‹µçš„ç†è«–æœ€é«˜åˆ†
    const maxBaseScorePerNote = 100; // "Perfect" çš„åŸºç¤åˆ†æ•¸æ˜¯ 100
    maxScoreForCurrentLevel = noteQueue.length * maxBaseScorePerNote;

    // å¦‚æœè¨ˆç®—çµæœç‚º 0 (ä¾‹å¦‚æ­Œæ›²æ²’æœ‰éŸ³ç¬¦)ï¼Œå‰‡æä¾›ä¸€å€‹é è¨­å€¼ä»¥é¿å…éŒ¯èª¤
    if (maxScoreForCurrentLevel === 0) {
        maxScoreForCurrentLevel = 300000; // è¨­ç½®ä¸€å€‹å¾Œå‚™å€¼
    }
    // â–²â–²â–² ã€ä¿®è¨‚çµæŸã€‘ â–²â–²â–²

    await audio.play().catch(e => console.log("éŸ³è¨Šæ’­æ”¾å¤±æ•—:", e));
    gameStartTime = Date.now();
    generateNotesContinuously();
    gameLoop();
    progressInterval = setInterval(updateProgress, 100);
    setTimeout(() => { if (gameActive) endGame(); }, currentSongDuration * 1000 + 2000);

    // æ–°å¢ï¼šé¡¯ç¤ºèƒŒæ™¯æ­Œè©å®¹å™¨
    const lyricsBackground = document.getElementById('lyricsBackground');
    if (lyricsBackground) {
        lyricsBackground.style.display = 'grid';
    }
}

function endGame() {
    if (!gameActive) return; // é˜²æ­¢é‡è¤‡è§¸ç™¼

    gameActive = false;
    audio.pause();
    audio.currentTime = 0;
    clearTimeout(generateNotesTimer);
    clearInterval(progressInterval);
    cancelAnimationFrame(animationFrame);
    startBtn.disabled = false;
    musicSelect.disabled = false;
    difficultySelect.disabled = false;

    // éš±è—éŠæˆ²ä¸­çš„ UI å…ƒç´ 
    mainGameContainer.classList.remove('game-running'); 
    unlockProgressBar.style.width = '0%';
    unlockProgressBar.classList.remove('glowing');
    progressBar.style.width = '0%';
    notes.forEach(note => note.element.remove());
    notes = [];

    const lyricsBackground = document.getElementById('lyricsBackground');
    if (lyricsBackground) {
        lyricsBackground.style.display = 'none';
        lyricsBackground.innerHTML = '';
    }

    // --- éŠæˆ²å¾Œçµç®— ---
    const selectedSong = musicSelect.value;
    const selectedDifficulty = difficultySelect.value;
    updatePersonalHighScore(selectedSong, selectedDifficulty, score);

    // ã€æ ¸å¿ƒä¿®è¨‚ã€‘
    // å°‡æ‰€æœ‰è§£é–åˆ¤æ–·çµ±ä¸€äº¤çµ¦ checkAndShowQuizOrInfo å‡½æ•¸ã€‚
    checkAndShowQuizOrInfo(selectedSong, selectedDifficulty, pureHitScore);
    
    // ====== ã€æ–°å¢ã€‘æäº¤åˆ†æ•¸åˆ°å…¨çƒæ’è¡Œæ¦œ ======
    submitScoreToLeaderboard(selectedSong, selectedDifficulty, score);
    // ==========================================

    // é¡¯ç¤ºéŠæˆ²çµæŸç•«é¢
    showGameOver();
}

            function showGameOver() {
                finalScoreDisplay.textContent = score.toLocaleString();
                finalComboDisplay.textContent = maxCombo;
                gameOverModal.classList.add('active');
            }

            function restartGame() {
                gameOverModal.classList.remove('active');
                initGame();
            }

          function gameLoop() {
    if (!gameActive) return;

    // --- æ ¸å¿ƒå„ªåŒ–ï¼šåœ¨è¿´åœˆå¤–å¿«å–ä¸æœƒè®Šå‹•çš„æ•¸å€¼ ---
    // ç²å–è»Œé“ç¸½é«˜åº¦ï¼ŒéŸ³ç¬¦éœ€è¦ç§»å‹•çš„ç¸½è·é›¢
    const fallDistance = tracksContainer.clientHeight; 
    // è¨ˆç®—åˆ¤å®šç·šçš„ Y åº§æ¨™ (ç›¸å°æ–¼è»Œé“é ‚éƒ¨)
    const hitLineY = fallDistance - 100; 
    // è¨ˆç®—éŸ³ç¬¦æ¯æ¯«ç§’ç§»å‹•çš„åƒç´ è·é›¢
    const pixelsPerMillisecond = fallDistance / noteSpeed;

    const now = Date.now();

    for (let i = notes.length - 1; i >= 0; i--) {
        const note = notes[i];
        if (!note.active) continue;

        // --- æ ¸å¿ƒå„ªåŒ–ï¼šç”¨æ•¸å­¸å…¬å¼ã€Œè¨ˆç®—ã€éŸ³ç¬¦çš„ç•¶å‰ä½ç½® ---
        const timeElapsed = now - note.creationTime;
        // éŸ³ç¬¦é ‚éƒ¨çš„ Y åº§æ¨™ = å·²éæ™‚é–“ * æ¯æ¯«ç§’ç§»å‹•è·é›¢ - éŸ³ç¬¦è‡ªèº«é«˜åº¦(å‹•ç•«æ˜¯å¾-50pxé–‹å§‹çš„)
        const noteTopY = (timeElapsed * pixelsPerMillisecond) - 50;

        // --- ä½¿ç”¨è¨ˆç®—å‡ºçš„ä½ç½®ä¾†é€²è¡Œåˆ¤æ–· ---
        // å¦‚æœéŸ³ç¬¦é ‚éƒ¨å·²ç¶“è¶…éäº†åˆ¤å®šç·šåŠ ä¸€å€‹ç·©è¡å€ (20px)
        if (noteTopY > hitLineY + 20) {
            const isTrackInvincible = notes.some(n =>
                n.track === note.track &&
                n.type === 'long' &&
                n.hitStarted
            );

            if (!isTrackInvincible) {
                judgeHit(note.track, 'miss');
            }
            
            note.active = false;
            note.element.remove(); // é€™è£¡çš„ remove æ˜¯å¿…è¦çš„ï¼Œå› ç‚º miss äº†
            notes.splice(i, 1);
        }
    }

    animationFrame = requestAnimationFrame(gameLoop);
}

         function handleKeyDown(e) {
                if (!gameActive) return;
                const keyCode = e.keyCode;
                if (keyStates[keyCode]) return;
                keyStates[keyCode] = true;
                const trackIndex = keyCodes.indexOf(keyCode);
                if (trackIndex !== -1) {
                    const trackEl = document.querySelector(`.track[data-track="${trackIndex}"]`);
                    if (trackEl) {
                        trackEl.classList.remove('hit-effect');
                        void trackEl.offsetWidth;
                        trackEl.classList.add('hit-effect');
                    }
                    const trackRect = tracksContainer.getBoundingClientRect();
                    const hitLineY = trackRect.top + trackRect.height - 100;
                    let hitNote = null;
                    let minDistance = Infinity;
                    let hitIndex = -1;
                    notes.forEach((note, index) => {
                        if (note.track === trackIndex && note.active && !note.hitStarted) {
                            const rect = note.element.getBoundingClientRect();
                            const distance = Math.abs(rect.bottom - hitLineY);
                            if (distance < minDistance) {
                                minDistance = distance;
                                hitNote = note;
                                hitIndex = index;
                            }
                        }
                    });
                   if (hitNote && minDistance < 50) {
    let judgment;
    if (minDistance < 15) judgment = 'perfect';
    else if (minDistance < 30) judgment = 'great';
    else judgment = 'good';
    if (hitNote.type === 'long') {
        hitNote.hitStarted = true;
        hitNote.element.classList.add('held');
        judgeHit(trackIndex, judgment);
        explodeNote(hitNote.element, judgment); // æ–°å¢ï¼šé•·éŸ³ç¬¦æŒ‰ä¸‹æ™‚åˆ†è§£ç²’å­
    } else {
        hitNote.active = false;
        explodeNote(hitNote.element, judgment); // æ–°å¢ï¼šçŸ­éŸ³ç¬¦æ“Šä¸­æ™‚åˆ†è§£ç²’å­
        hitNote.element.remove();
        notes.splice(hitIndex, 1);
        judgeHit(trackIndex, judgment);
    }
} else {
                        // å¦‚æœæŒ‰ä¸‹æ™‚ï¼Œæ²’æœ‰ä»»ä½•éŸ³ç¬¦åœ¨å¯æ“Šä¸­ç¯„åœå…§ï¼Œå‰‡åˆ¤å®šç‚º MISS
                        judgeHit(trackIndex, 'miss');

                        // â–¼â–¼â–¼ ä¿®è¨‚çš„é—œéµä¹‹è™• â–¼â–¼â–¼
                        // ä¸¦ä¸”ï¼Œå¦‚æœè»Œé“ä¸Šç¢ºå¯¦æœ‰ä¸€å€‹æœ€è¿‘çš„éŸ³ç¬¦ï¼ˆåªæ˜¯å¤ªé äº†ï¼‰ï¼Œ
                        // å‰‡å°‡è©²éŸ³ç¬¦ç§»é™¤ï¼Œä»¥æ‡²ç½°ææ—©æŒ‰éµçš„è¡Œç‚ºã€‚
                        if (hitNote) {
                            hitNote.active = false;
                            hitNote.element.remove();
                            notes.splice(hitIndex, 1);
                        }
                        // â–²â–²â–² ä¿®è¨‚çµæŸ â–²â–²â–²
                    }
                }
            }

         function handleKeyUp(e) {
    if (!gameActive) return;
    const keyCode = e.keyCode;
    keyStates[keyCode] = false;
    const trackIndex = keyCodes.indexOf(keyCode);
    if (trackIndex !== -1) {
        const heldNoteIndex = notes.findIndex(note =>
            note.track === trackIndex && note.type === 'long' && note.hitStarted
        );
        if (heldNoteIndex !== -1) {
            const note = notes[heldNoteIndex];
            const trackRect = tracksContainer.getBoundingClientRect();
            const hitLineY = trackRect.top + trackRect.height - 100;
            const rect = note.element.getBoundingClientRect();
            const noteTailY = rect.top;
            const distance = Math.abs(noteTailY - hitLineY);
            let type = 'miss';  // é è¨­ç‚º MISS
if (distance < 50) {
    if (distance < 15) type = 'perfect';
    else if (distance < 30) type = 'great';
    else type = 'good';
}

// ä¿®è¨‚ï¼šç„¡è«– MISS æˆ–é MISSï¼Œéƒ½å‘¼å« judgeHitï¼Œè®“å®ƒè™•ç†æ‰€æœ‰æ•ˆæœï¼ˆåŒ…æ‹¬ç²’å­/éœ‡å‹•ï¼‰
judgeHit(trackIndex, type);
if (type !== 'miss') {
    explodeNote(note.element, type); // æ–°å¢ï¼šé•·éŸ³ç¬¦é‡‹æ”¾æˆåŠŸæ™‚åˆ†è§£ç²’å­
}

note.active = false;
note.element.remove();
notes.splice(heldNoteIndex, 1);
        }
    }
}
            function onTouchStart(e) {
                e.preventDefault();
                const keyElement = e.target.closest('.touch-key');
                if (keyElement) {
                    keyElement.classList.add('pressed');
                    handleKeyDown({ keyCode: parseInt(keyElement.dataset.key) });
                }
            }

            function onTouchEnd(e) {
                e.preventDefault();
                const changedTouches = e.changedTouches || [e];
                for (const touch of changedTouches) {
                    const originalKeyElement = e.target.closest('.touch-key');
                    if (originalKeyElement) {
                        originalKeyElement.classList.remove('pressed');
                        handleKeyUp({ keyCode: parseInt(originalKeyElement.dataset.key) });
                    }
                }
            }


// å°‹æ‰¾ä¸‹ä¸€é¦–å•Ÿç”¨çš„æ­Œæ›²
function findNextEnabledSong(currentIndex) {
    for (let i = currentIndex + 1; i < playlistItems.length; i++) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // æ²’æœ‰æ‰¾åˆ°ä¸‹ä¸€é¦–å•Ÿç”¨çš„æ­Œæ›²
}

// å°‹æ‰¾ä¸Šä¸€é¦–å•Ÿç”¨çš„æ­Œæ›²
function findPrevEnabledSong(currentIndex) {
    for (let i = currentIndex - 1; i >= 0; i--) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // æ²’æœ‰æ‰¾åˆ°ä¸Šä¸€é¦–å•Ÿç”¨çš„æ­Œæ›²
}


            // --- Music Player Logic ---
            function initMusicPlayer() {
                // Filter playlist items to only include unlocked songs
                const unlockedSongsSet = new Set(saveData.unlockedSongs);
                playlistItems = Array.from(musicSelect.options)
                    .filter(opt => unlockedSongsSet.has(opt.value)) // Only unlocked songs
                    .map((opt, index) => ({
                        url: opt.value,
                        title: opt.textContent.replace(' (æœªè§£é–)', ''),
                        index: index
                    }));

                playlist.innerHTML = '';
playlistItems.forEach(item => {
    const li = document.createElement('li');
    li.className = 'playlist-item';
    li.textContent = item.title;
    li.dataset.index = item.index;
    
    // å¾å„²å­˜çš„è¨­å®šä¸­æ¢å¾©æ­Œæ›²ç‹€æ…‹
    const savedState = playerSettings.playlistStates[item.url];
    const isEnabled = savedState ? savedState.enabled : true;
    li.dataset.enabled = isEnabled ? 'true' : 'false';
    
    if (!isEnabled) {
        li.classList.add('disabled');
    }
    
    let clickCount = 0;
    let clickTimer = null;
    
    li.addEventListener('click', () => {
        clickCount++;
        
        if (clickTimer) {
            clearTimeout(clickTimer);
        }
        
       clickTimer = setTimeout(() => {
    if (clickCount === 1) {
        // å–®æ“Šï¼šæ’­æ”¾è©²æ­Œæ›²æˆ–å•Ÿç”¨è©²æ­Œæ›²
        li.dataset.enabled = 'true';
        li.classList.remove('disabled');
        playSong(item.index);
        savePlayerSettings(); // ä¿å­˜è¨­å®š
    } else if (clickCount === 2) {
        // é›™æ“Šï¼šåœç”¨è©²æ­Œæ›²ï¼Œä¸æ’­æ”¾
        li.dataset.enabled = 'false';
        li.classList.add('disabled');
        savePlayerSettings(); // ä¿å­˜è¨­å®š
                
                // å¦‚æœç•¶å‰æ­£åœ¨æ’­æ”¾é€™é¦–æ­Œï¼Œå‰‡æš«åœä¸¦å°‹æ‰¾ä¸‹ä¸€é¦–å•Ÿç”¨çš„æ­Œæ›²
                if (currentPlaylistIndex === item.index && playerIsPlaying) {
                    const nextIndex = findNextEnabledSong(currentPlaylistIndex);
                    if (nextIndex !== -1) {
                        playSong(nextIndex);
                    } else {
                        playerAudio.pause();
                    }
                }
            }
            clickCount = 0;
        }, 300); // 300æ¯«ç§’å…§çš„é»æ“Šè¦–ç‚ºé›™æ“Š
    });
    
    playlist.appendChild(li);
});

                playerAudio.addEventListener('loadedmetadata', () => {
                    durationDisplay.textContent = formatTime(playerAudio.duration);
                    progressSlider.max = playerAudio.duration;
                });

               playerAudio.addEventListener('timeupdate', () => {
    if (!isUpdatingSlider) {
        currentTimeDisplay.textContent = formatTime(playerAudio.currentTime);
        progressSlider.value = playerAudio.currentTime;
        updateLyrics(playerAudio.currentTime);
        
        // æ¯5ç§’è‡ªå‹•ä¿å­˜æ’­æ”¾é€²åº¦
        if (Math.floor(playerAudio.currentTime) % 5 === 0) {
            savePlayerSettings();
        }
    }
});

playerAudio.addEventListener('play', () => {
    playerIsPlaying = true;
    playPauseBtn.textContent = '\u275A\u275A';
    updatePlayerUI();
    savePlayerSettings(); // ä¿å­˜æ’­æ”¾ç‹€æ…‹
});

playerAudio.addEventListener('pause', () => {
    playerIsPlaying = false;
    playPauseBtn.textContent = '\u25B6';
    updatePlayerUI();
    savePlayerSettings(); // ä¿å­˜æš«åœç‹€æ…‹
});
               playerAudio.addEventListener('ended', () => {
    playerIsPlaying = false;
    playPauseBtn.textContent = '\u25B6'; // Play icon
ocument.getElementById('cdCoverImage').classList.remove('playing'); // æ–°å¢ï¼šåœæ­¢æ—‹è½‰
    
    // å°‹æ‰¾ä¸‹ä¸€é¦–å•Ÿç”¨çš„æ­Œæ›²
    const nextIndex = findNextEnabledSong(currentPlaylistIndex);
    if (nextIndex !== -1) {
        playSong(nextIndex);
    }
    updatePlayerUI();
});

                playerAudio.addEventListener('play', () => {
                    playerIsPlaying = true;
                    playPauseBtn.textContent = '\u275A\u275A'; // Pause icon
                    updatePlayerUI();
                });

                playerAudio.addEventListener('pause', () => {
                    playerIsPlaying = false;
                    playPauseBtn.textContent = '\u25B6'; // Play icon
                    updatePlayerUI();
// æ–°å¢ï¼šåœæ­¢ CD æ—‹è½‰
    document.getElementById('cdCoverImage').classList.remove('playing');
                });
            }

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }

           function playSong(index) {
    if (index < 0 || index >= playlistItems.length) return;
    
    // æª¢æŸ¥æ­Œæ›²æ˜¯å¦è¢«åœç”¨
    const playlistItem = playlist.children[index];
    if (playlistItem && playlistItem.dataset.enabled === 'false') {
        console.log('æ­Œæ›²å·²è¢«åœç”¨ï¼Œè·³éæ’­æ”¾');
        return;
    }
    
    // Check if the song is unlocked before playing
    const songToPlay = playlistItems[index];
    if (!isSongUnlocked(songToPlay.url)) {
        console.warn(`å˜—è©¦æ’­æ”¾æœªè§£é–çš„æ­Œæ›²: ${songToPlay.title}`);
        return; // Do not play if not unlocked
    }

    currentPlaylistIndex = index;
    const song = playlistItems[index];
    playerAudio.src = song.url;
    playerAudio.volume = volumeSliderPlayer.value;
    nowPlaying.textContent = `æ­£åœ¨æ’­æ”¾: ${song.title}`;
    updateCdCover(song.url); // æ›´æ–° CD å°é¢
    
    // â–¼â–¼â–¼ ã€ä¿®è¨‚è™•ã€‘å¾ songData ç²å–æ­Œè© â–¼â–¼â–¼
    lyrics = songData[song.url]?.lyrics || [];
    // â–²â–²â–² ä¿®è¨‚çµæŸ â–²â–²â–²

    updateLyricsContainer();
    updatePlayerUI();
    document.getElementById('cdCoverImage').classList.add('playing'); // é–‹å§‹æ—‹è½‰
    playerAudio.play().catch(e => console.error("æ’­æ”¾å™¨æ’­æ”¾å¤±æ•—:", e));
    savePlayerSettings(); // ä¿å­˜ç•¶å‰æ’­æ”¾ç‹€æ…‹
}

// åœ¨ç¾æœ‰å‡½æ•¸ä¹‹å‰æ–°å¢é€™å…©å€‹è¼”åŠ©å‡½æ•¸
function findNextEnabledSong(currentIndex) {
    for (let i = currentIndex + 1; i < playlistItems.length; i++) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // æ²’æœ‰æ‰¾åˆ°ä¸‹ä¸€é¦–å•Ÿç”¨çš„æ­Œæ›²
}

function findPrevEnabledSong(currentIndex) {
    for (let i = currentIndex - 1; i >= 0; i--) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // æ²’æœ‰æ‰¾åˆ°ä¸Šä¸€é¦–å•Ÿç”¨çš„æ­Œæ›²
}

            function updateLyricsContainer() {
                lyricsContainer.innerHTML = '';
                if (lyrics.length === 0) {
                    lyricsContainer.innerHTML = '<div class="no-lyrics">ç„¡æ­Œè©</div>';
                    return;
                }
                lyrics.forEach((line, i) => {
                    const p = document.createElement('p');
                    p.className = 'lyric-line';
                    p.textContent = line.text;
                    p.dataset.time = line.time;
                    lyricsContainer.appendChild(p);
                });
            }

            function updateLyrics(currentTime) {
                if (lyrics.length === 0) return;
                let activeIndex = -1;
                for (let i = 0; i < lyrics.length; i++) {
                    if (lyrics[i].time <= currentTime) {
                        activeIndex = i;
                    } else {
                        break;
                    }
                }
                document.querySelectorAll('.lyric-line').forEach((line, i) => {
                    line.classList.toggle('active', i === activeIndex);
                    if (i === activeIndex) {
                        line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }



// æ›´æ–° CD å°é¢çš„å‡½æ•¸
function updateCdCover(songUrl) {
    const coverImage = document.getElementById('cdCoverImage');
    // æ ¹æ“šæ­Œæ›² URL ç²å–å°æ‡‰çš„å°é¢ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é»˜èªå°é¢
    const coverUrl = songCovers[songUrl] || songCovers["default"];
    coverImage.src = coverUrl;
    // å¯é¸ï¼šæ·»åŠ åŠ è¼‰éŒ¯èª¤çš„å›é€€
    coverImage.onerror = function() {
        this.src = songCovers["default"];
    };
}



            function updatePlayerUI() {
    document.querySelectorAll('.playlist-item').forEach((item, i) => {
        item.classList.toggle('active', i === currentPlaylistIndex);
    });
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–å•Ÿç”¨çš„æ­Œæ›²ä¾†æ±ºå®šæŒ‰éˆ•ç‹€æ…‹
    const hasPrev = findPrevEnabledSong(currentPlaylistIndex) !== -1;
    const hasNext = findNextEnabledSong(currentPlaylistIndex) !== -1;
    
    prevBtn.disabled = !hasPrev;
    nextBtn.disabled = !hasNext;
}

            // --- Event Listeners ---
            touchKeys.forEach(key => {
                key.addEventListener('touchstart', onTouchStart, { passive: false });
                key.addEventListener('touchend', onTouchEnd, { passive: false });
                key.addEventListener('touchcancel', onTouchEnd, { passive: false });
            });

            settingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
            closeSettings.addEventListener('click', () => settingsModal.classList.remove('active'));
            window.addEventListener('click', (e) => {
                if (e.target === settingsModal) settingsModal.classList.remove('active');
                if (e.target === personalHighScoreModal) personalHighScoreModal.classList.remove('active');
                if (e.target === unlockModal) unlockModal.classList.remove('active');
            });

         // ã€ä¿®è¨‚ã€‘ç‚ºéŸ³æ¨‚éŸ³é‡æ»‘æ¡¿æ·»åŠ äº‹ä»¶ç›£è½ï¼Œä¸¦å³æ™‚æ›´æ–°CSSè®Šæ•¸
            volumeControlModal.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                audio.volume = isNaN(value) ? 1.0 : value; // å°‡å¾Œå‚™å€¼å¾ 0.7 æ”¹ç‚º 1.0
                // æ›´æ–°CSSè®Šæ•¸ä¾†æ§åˆ¶èƒŒæ™¯å¡«å……
                const percent = value * 100;
                e.target.style.background = `linear-gradient(to right, #3b82f6 ${percent}%, #4a5568 ${percent}%)`;
            });

            // ã€ä¿®è¨‚ã€‘ç‚ºéŸ³æ•ˆéŸ³é‡æ»‘æ¡¿æ·»åŠ äº‹ä»¶ç›£è½ï¼Œä¸¦å³æ™‚æ›´æ–°CSSè®Šæ•¸
            sfxVolumeControl.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                sfxVolume = isNaN(value) ? 0.5 : value;
                // æ›´æ–°CSSè®Šæ•¸ä¾†æ§åˆ¶èƒŒæ™¯å¡«å……
                const percent = value * 100;
                e.target.style.background = `linear-gradient(to right, #3b82f6 ${percent}%, #4a5568 ${percent}%)`;
            });
            
            startBtn.addEventListener('click', startGame);
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            restartBtn.addEventListener('click', restartGame);
            // --- Handle Page Visibility to Prevent Ghost Notes ---
            document.addEventListener('visibilitychange', () => {
                // æˆ‘å€‘åªé—œå¿ƒé é¢å¾ã€Œéš±è—ã€è®Šç‚ºã€Œå¯è¦‹ã€çš„é‚£å€‹ç¬é–“
                // ä¸¦ä¸”åªæœ‰åœ¨éŠæˆ²æ­£åœ¨é€²è¡Œä¸­æ‰éœ€è¦è™•ç†
                if (!document.hidden && gameActive) {
                    const now = Date.now();
                    
                    // éæ­·æ‰€æœ‰ç•¶å‰åœ¨ç•«é¢ä¸Šçš„éŸ³ç¬¦
                    // æˆ‘å€‘å¾å¾Œå¾€å‰éæ­·ï¼Œé€™æ¨£åœ¨åˆªé™¤é™£åˆ—å…ƒç´ æ™‚æ‰ä¸æœƒå‡ºéŒ¯
                    for (let i = notes.length - 1; i >= 0; i--) {
                        const note = notes[i];
                        const timeAlive = now - note.creationTime;

                        // ã€æ ¸å¿ƒæ¸…ç†é‚è¼¯ã€‘
                        // å¦‚æœä¸€å€‹éŸ³ç¬¦çš„å­˜æ´»æ™‚é–“ï¼Œå·²ç¶“è¶…éäº†å®ƒè·‘å®Œæ•´å€‹è»Œé“æ‰€éœ€çš„æ™‚é–“ (noteSpeed)
                        // å†åŠ ä¸Šä¸€å€‹å°çš„ç·©è¡æ™‚é–“ï¼ˆä¾‹å¦‚ 500 æ¯«ç§’ï¼‰ï¼Œ
                        // æˆ‘å€‘å°±èªå®šå®ƒæ˜¯ä¸€å€‹åœ¨é é¢éš±è—æœŸé–“å°±æ‡‰è©²æ¶ˆå¤±çš„ã€Œå¹½éˆéŸ³ç¬¦ã€ã€‚
                        if (timeAlive > noteSpeed + 500) {
                            note.active = false;      // æ¨™è¨˜ç‚ºéä½œç”¨ä¸­
                            note.element.remove();    // å¾ç•«é¢ä¸­ç§»é™¤ DOM å…ƒç´ 
                            notes.splice(i, 1);       // å¾æˆ‘å€‘çš„éŠæˆ²é‚è¼¯é™£åˆ—ä¸­ç§»é™¤
                        }
                    }
                }
            });

            // New Event Listeners
            personalHighScoreBtn.addEventListener('click', () => {
                const selectedSong = musicSelect.value;
                populatePersonalHighScoreList(selectedSong);
                personalHighScoreModal.classList.add('active');
            });
            closePersonalHighScore.addEventListener('click', () => personalHighScoreModal.classList.remove('active'));

           musicPlayerBtn.addEventListener('click', () => {
    musicPlayerModal.classList.add('active');
    initMusicPlayer(); // Re-initialize playlist on open to reflect unlocks
    loadPlayerSettings(); // è¼‰å…¥å„²å­˜çš„è¨­å®š
    
    // æ¢å¾©ä¸Šæ¬¡çš„æ’­æ”¾ç‹€æ…‹
    if (playerSettings.currentSong && playlistItems.length > 0) {
        const songIndex = playlistItems.findIndex(item => item.url === playerSettings.currentSong);
        if (songIndex !== -1) {
            currentPlaylistIndex = songIndex;
            playerAudio.src = playerSettings.currentSong;
            playerAudio.currentTime = playerSettings.currentTime || 0;
            nowPlaying.textContent = `æ­£åœ¨æ’­æ”¾: ${playlistItems[songIndex].title}`;
            
            // æ¢å¾©æ­Œè©å’ŒUI
            const song = playlistItems[songIndex];
            lyrics = songLyrics[song.url] || [];
            updateLyricsContainer();
            updatePlayerUI();
            
            // å¦‚æœä¹‹å‰æ˜¯æ’­æ”¾ç‹€æ…‹ï¼Œå‰‡è‡ªå‹•ç¹¼çºŒæ’­æ”¾
            if (playerSettings.isPlaying) {
                playerAudio.play().catch(e => console.error("è‡ªå‹•æ’­æ”¾å¤±æ•—:", e));
            }
        }
    }
});
           closeMusicPlayer.addEventListener('click', () => {
    savePlayerSettings(); // ä¿å­˜ç•¶å‰ç‹€æ…‹å†é—œé–‰
    musicPlayerModal.classList.remove('active');
    playerAudio.pause();
});
            playPauseBtn.addEventListener('click', () => {
    if (playerAudio.src) {
        if (playerIsPlaying) {
            playerAudio.pause();
        } else {
            playerAudio.play();
        }
    } else {
        // å¦‚æœæ²’æœ‰éŸ³æºï¼Œæ’­æ”¾ç¬¬ä¸€é¦–å•Ÿç”¨çš„æ­Œæ›²
        const firstEnabledIndex = findNextEnabledSong(-1);
        if (firstEnabledIndex !== -1) {
            playSong(firstEnabledIndex);
        }
    }
});
          prevBtn.addEventListener('click', () => {
    const prevIndex = findPrevEnabledSong(currentPlaylistIndex);
    if (prevIndex !== -1) {
        playSong(prevIndex);
    }
});

nextBtn.addEventListener('click', () => {
    const nextIndex = findNextEnabledSong(currentPlaylistIndex);
    if (nextIndex !== -1) {
        playSong(nextIndex);
    }
});

            progressSlider.addEventListener('input', () => {
                isUpdatingSlider = true;
                playerAudio.currentTime = progressSlider.value;
                currentTimeDisplay.textContent = formatTime(progressSlider.value);
            });
            progressSlider.addEventListener('change', () => {
                 isUpdatingSlider = false;
            });

            // Fixed volume slider input listeners for player to use 'change' event for full range
            volumeSliderPlayer.addEventListener('change', () => {
    const value = parseFloat(volumeSliderPlayer.value);
    playerAudio.volume = isNaN(value) ? 0.7 : value;
    savePlayerSettings(); // ä¿å­˜éŸ³é‡è¨­å®š
});

            musicSelect.addEventListener('change', () => {
                const selectedSong = musicSelect.value;
                updateDifficultyOptions(selectedSong);
                populatePersonalHighScoreList(selectedSong); // Update personal score list on song change
            });

            difficultySelect.addEventListener('change', () => {
                // Optional: Add logic if difficulty change needs immediate UI update
            });

            closeUnlock.addEventListener('click', () => unlockModal.classList.remove('active'));

             // --- ã€æ–°å¢ã€‘æ’è¡Œæ¦œ Modal çš„äº‹ä»¶ç›£è½å™¨ ---
            leaderboardBtn.addEventListener('click', () => {
                leaderboardModal.classList.add('active');
                handlePlayerName(); // è™•ç†ç©å®¶åç¨±
                // é è¨­é¡¯ç¤ºç•¶å‰ä¸»ä»‹é¢é¸æ“‡çš„æ­Œæ›²å’Œé›£åº¦
                displayLeaderboard(musicSelect.value, difficultySelect.value);
            });

            closeLeaderboard.addEventListener('click', () => {
                leaderboardModal.classList.remove('active');
            });

            // ç•¶ä¸»ä»‹é¢çš„æ­Œæ›²æˆ–é›£åº¦æ”¹è®Šæ™‚ï¼Œå¦‚æœæ’è¡Œæ¦œæ˜¯é–‹å•Ÿçš„ï¼Œå°±åŒæ­¥æ›´æ–°
            musicSelect.addEventListener('change', () => {
                if (leaderboardModal.classList.contains('active')) {
                    displayLeaderboard(musicSelect.value, difficultySelect.value);
                }
                // é€™ä¸€æ®µæœƒèˆ‡ä¸Šé¢çš„ musicSelect.addEventListener é‡è¤‡ï¼Œä½†å½±éŸ¿ä¸å¤§ï¼Œå› ç‚ºå®ƒå€‘çš„åŠŸèƒ½ä¸è¡çª
                // ç‚ºäº†ç¨‹å¼ç¢¼ç°¡æ½”ï¼Œä½ å¯ä»¥è€ƒæ…®å°‡å…©å€‹ change äº‹ä»¶çš„é‚è¼¯åˆä½µï¼Œä½†åˆ†é–‹å¯«ä¹Ÿå®Œå…¨å¯ä»¥é‹ä½œ
            });

            difficultySelect.addEventListener('change', () => {
                if (leaderboardModal.classList.contains('active')) {
                    displayLeaderboard(musicSelect.value, difficultySelect.value);
                }
            });

            // --- Initialization ---
            const originalStartButtonSVG = startBtn.innerHTML;
            updateSongOptions(); // Apply unlock status on load
            populatePersonalHighScoreList(musicSelect.value); // Show scores for initially selected song
            initGame();

            // ã€æ–°å¢ã€‘ç¶å®šæ¸¬é©—è¦–çª—çš„æŒ‰éˆ•äº‹ä»¶
quizSubmitBtn.addEventListener('click', checkQuizAnswer);
quizAnswerInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault(); // é˜²æ­¢è¡¨å–®æäº¤çš„é è¨­è¡Œç‚º
        checkQuizAnswer();
    }
});
quizCloseBtn.addEventListener('click', () => {
    if (isQuizActive) {
        endQuiz(false); // ç©å®¶æ‰‹å‹•é—œé–‰è¦–çª—ï¼Œè¦–ç‚ºæ¸¬é©—å¤±æ•—
    }
});


// ç‚ºç‰ˆæ¬Šè²æ˜æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
const showDisclaimerBtn = document.getElementById('showDisclaimerBtn');
const disclaimerModal = document.getElementById('disclaimerModal');
const closeDisclaimer = document.getElementById('closeDisclaimer');

showDisclaimerBtn.addEventListener('click', () => {
    disclaimerModal.classList.add('active');
});

closeDisclaimer.addEventListener('click', () => {
    disclaimerModal.classList.remove('active');
});

// é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
disclaimerModal.addEventListener('click', (e) => {
    if (e.target === disclaimerModal) {
        disclaimerModal.classList.remove('active');
    }
});
});
    </script>


<!-- Copyright Disclaimer Modal -->
<div class="copyright-disclaimer-modal" id="disclaimerModal">
    <div class="disclaimer-content">
        <button class="close-disclaimer" id="closeDisclaimer">&times;</button>
        <h2 class="disclaimer-title">éŸ³æ¨‚ç‰ˆæ¬Šè²æ˜</h2>
        <div class="disclaimer-section">
            <h3>éŸ³æ¨‚ä¾†æº</h3>
            <p>æœ¬å°ˆæ¡ˆä¸­ä½¿ç”¨çš„éŸ³æ¨‚ç”± AI å·¥å…·ï¼ˆè±†åŒ…ï¼‰ç”Ÿæˆã€‚</p>
        </div>
        <div class="disclaimer-section">
            <h3>ä½¿ç”¨é™åˆ¶</h3>
            <p>æœ¬éŸ³æ¨‚åƒ…ç”¨æ–¼èªæ–‡æ•™è‚²ç”¨é€”ï¼Œç¦æ­¢ä»»ä½•ç”¨æˆ¶ä¸‹è¼‰å¾Œç”¨æ–¼å•†æ¥­ç­‰å…¶ä»–å ´æ™¯ã€‚</p>
        </div>
        <div class="disclaimer-section">
            <h3>å…è²¬è²æ˜</h3>
            <p>è‹¥éŸ³æ¨‚é•åä»»ä½•ç‰ˆæ¬Šï¼Œæœ¬äººå°‡ç«‹å³åˆªé™¤æœ‰é—œä½œå“ã€‚</p>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€æ–°å¢ã€‘æ­Œè©å¡«å……æ¸¬é©—è¦–çª— â–¼â–¼â–¼ -->
<div class="lyrics-quiz-modal" id="lyricsQuizModal">
    <div class="quiz-content">
        <h2 class="quiz-title">æ­Œè©å¡«å……æ¸¬é©—</h2>
        <p class="quiz-instructions">é€£çºŒç­”å°ä¸‰é¡Œå³å¯è§£é–æ–°å…§å®¹ï¼</p>
        <div class="quiz-progress" id="quizProgress">é€£çºŒç­”å°: 0 / 3</div>
        <div class="quiz-question-container">
            <p id="quizQuestionText"></p>
        </div>
        <input type="text" id="quizAnswerInput" class="quiz-answer-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ..." autocomplete="off">
        <button id="quizSubmitBtn" class="quiz-submit-btn">æäº¤ç­”æ¡ˆ</button>
        <button id="quizCloseBtn" class="quiz-close-btn">&times;</button>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–² -->

    <!-- ====== ã€æ–°å¢ã€‘æ’è¡Œæ¦œ Modal ====== -->
<div class="settings-modal" id="leaderboardModal">
    <div class="settings-content">
        <button class="close-settings" id="closeLeaderboard">&times;</button>
        <h2 class="settings-title">æ­Œæ›²æ’è¡Œæ¦œ</h2>
        
        <!-- ç©å®¶åç¨±è¨­å®š -->
        <div class="setting-group" id="playerNameGroup">
            <label class="setting-label" for="playerNameInput">ä½ çš„é¡¯ç¤ºåç¨±:</label>
            <input type="text" id="playerNameInput" class="setting-control" placeholder="è¼¸å…¥ä½ çš„åç¨±" maxlength="20">
            <button id="savePlayerNameBtn" class="restart-btn"></button>
        </div>

        <!-- æ’è¡Œæ¦œé¡¯ç¤ºå€åŸŸ -->
        <div class="leaderboard-display">
            <h3 id="leaderboardTitle" class="personal-high-score-title" style="margin-top: 20px;">è«‹é¸æ“‡æ­Œæ›²èˆ‡é›£åº¦</h3>
            <ol class="personal-high-score-list" id="leaderboardList">
                <!-- æ’è¡Œæ¦œè³‡æ–™æœƒç”± JS å‹•æ…‹å¡«å…¥ -->
            </ol>
            <p id="leaderboardLoading" style="display: none;">è®€å–ä¸­...</p>
        </div>
    </div>
</div>

</body>
</html>
