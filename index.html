

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>詞海拾心</title>

  <!-- ▼▼▼ 步驟 1：貼上或替換為這段新的 CSP 規則 ▼▼▼ -->
   <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://www.gstatic.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' https: data:;
    media-src 'self';
    connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com;
    object-src 'none';
    base-uri 'self';
    form-action 'none';
">


    
      <!-- ▼▼▼ 【核心修正】請將這三行 Google Fonts 連結加在這裡 ▼▼▼ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>

 /* ▼▼▼ 新增的樣式 ▼▼▼ */


       /* 遊戲進行中，顯示解鎖進度條 */
.game-running .unlock-progress-container {
    opacity: 1;
    transform: translateY(0); /* [修訂] 改為 Y 軸方向的滑入動畫 */
}

      .unlock-progress-container {
    position: absolute;
    /* [修訂] 重新計算 bottom 值：音樂進度條 bottom 10px + 高度 12px + 間距 5px = 27px */
    bottom: 27px; 
    left: 10px;
    right: 10px;
    width: auto;
    height: 12px;         /* [修訂] 加粗進度條 */
    transform: translateY(100%); 
    background: rgba(255, 255, 255, 0.1); /* [修訂] 將背景改為與歌曲進度條一致 */
    border-radius: 6px;   
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
    z-index: 50;
    opacity: 0;
    transition: opacity 0.5s ease, transform 0.5s ease;
    display: flex;
    align-items: center;
    flex-direction: row;
}

.unlock-progress-bar {
    height: 100%; /* [修訂] 高度填滿容器 */
    min-height: 12px; /* 確保即使 height=100% 時也有最小高度，避免容器塌陷 */
    width: 0%;    /* [修訂] 由 JS 控制寬度來顯示進度 */
    background: linear-gradient(90deg, #1D976C, #93F9B9); /* [修訂] 漸變方向改為 90 度 */
    transition: width 0.2s ease-out, box-shadow 0.3s ease; /* [修訂] 動畫屬性改為 width */
    box-shadow: 0 0 10px rgba(147, 249, 185, 0);
}

        /* 當進度超過門檻時的發光效果 */
        .unlock-progress-bar.glowing {
            box-shadow: 0 0 15px 5px rgba(147, 249, 185, 0.8);
        }

       .unlock-progress-marker {
            position: absolute;
            /* [刪除] left: 35%;  <-- 我們將完全由 JS 控制位置，可刪除此行 */
            top: -5px;
            bottom: -5px;
            width: 2px;
            height: auto;
            /* [刪除] 以下兩行關於顏色的定義將移至新的 class 中 */
            /* background: #FFD700; */
            /* box-shadow: 0 0 8px #FFD700; */
            z-index: 2;
        }

        /* ▼▼▼ 【新增】為不同類型的合格線設定專屬顏色 ▼▼▼ */
        .unlock-progress-marker.song-marker {
            background: #FFD700; /* 金黃色，代表解鎖歌曲 */
            box-shadow: 0 0 8px #FFD700;
        }

        .unlock-progress-marker.difficulty-marker {
            background: #F96666; /* 亮紅色，代表挑戰更高難度 */
            box-shadow: 0 0 8px #F96666;
        }
        
        body {
     
           background: #f0f4f8; /* 一個乾淨、柔和的淺灰色 */
           font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
            touch-action: manipulation; /* Prevent default touch actions like double-tap zoom */
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            /* Disable text selection and double-tap zoom */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(255, 200, 124, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(108, 99, 255, 0.1) 0%, transparent 20%);
            z-index: -1;
        }
        /* Background Image with 60% Opacity */
        .background-image {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://i.ibb.co/W4yhM5v0/image.png');
            background-size: cover;
            background-position: center;
            opacity: 0.6; /* 60% transparency */
            z-index: -2; /* Behind the main content */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px; /* Reduced padding */
            position: relative; /* Needed for z-index */
            z-index: 1; /* Above the background image */
        }
        /* Main game area container with border */
       /* 主要遊戲區域容器 */
.main-game-container {
     border: 2px solid rgba(0, 0, 0, 0.1); /* 邊框可以調淡一些 */
     border-radius: 15px;
     padding: 15px;
     background: rgba(255, 255, 255, 0.3); /* 【修改】從黑色透明變為白色透明 */
     box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); /* 陰影可以調淡 */
     margin-bottom: 20px;
}
        header {
            text-align: center;
            padding: 10px 0; /* Reduced padding */
            margin-bottom: 10px; /* Reduced margin */
        }
        h1 {
            font-size: 2.5rem; /* Adjusted for better responsiveness */
            margin-bottom: 5px;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .subtitle {
            font-size: 1rem; /* Adjusted */
            opacity: 0.8;
            margin-bottom: 10px; /* Reduced margin */
        }
        .game-container {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Reduced gap */
        }
      .game-ui {
    position: relative; 
    display: flex;
    flex-wrap: wrap; 
    justify-content: space-between;
    align-items: center; 
    gap: 8px; 
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px; 
    padding: 10px; 
    padding-bottom: 35px; /* [新增] 增加底部內邊距，為兩個進度條騰出空間 */
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); 
}
        .stats {
            display: flex;
            gap: 10px; /* Reduced gap */
        }
        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px; /* Reduced radius */
            padding: 8px 12px; /* Reduced padding */
            min-width: 90px; /* Reduced width */
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem; /* Adjusted */
            font-weight: bold;
            color: #ffcc00;
        }
        .stat-label {
    font-size: 1rem;
    color: #fff;
    opacity: 1;
}
        .controls {
            display: flex;
            gap: 8px; /* Reduced gap */
            align-items: center;
        }
        /* SVG Start Button Styles */
        .svg-button {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            width: 80px;
            height: 40px; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }
        .svg-button:hover {
            transform: translateY(-2px);
        }
        .svg-button:active {
            transform: translateY(1px);
        }
        .svg-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            transform: none;
        }
        .start-button-svg {
            width: 100%;
            height: 100%;
        }
        /* Music Selector SVG Icon */
        .music-selector {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping */
            gap: 8px; /* Reduced gap */
            align-items: center;
        }
        .music-select-wrapper {
            position: relative;
            display: inline-block;
        }
        .music-select-wrapper select {
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 35px 8px 12px; /* Extra padding on the right for the icon */
            border-radius: 50px;
            font-size: 0.9rem; /* Adjusted */
            min-width: 0; /* Allow shrinking */
            flex: 1; /* Allow growing/shrinking */
            appearance: none; /* Remove default arrow */
            cursor: pointer;
        }
        .music-select-wrapper select:disabled {
            color: #888;
            cursor: not-allowed;
        }
        .music-icon {
            position: absolute;
            right: 10px; /* Position icon inside the select box */
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none; /* Icon doesn't interfere with click */
            fill: white; /* Icon color */
            width: 16px;
            height: 16px;
        }

        /* Personal High Score Button */
        .personal-high-score-btn {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .personal-high-score-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .personal-high-score-icon {
            width: 18px;
            height: 18px;
            fill: white;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 5px; /* Reduced gap */
            font-size: 0.9rem; /* Adjusted */
        }
        input[type="range"] {
            width: 80px; /* Reduced width */
        }
        .difficulty-selector {
            display: flex;
            gap: 5px; /* Reduced gap */
            align-items: center;
            font-size: 0.9rem; /* Adjusted */
        }
        .difficulty-selector select {
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .difficulty-selector select:disabled {
            color: #888;
            cursor: not-allowed;
        }
      .progress-container {
    position: absolute;   /* [新增] 改為絕對定位 */
    bottom: 10px;         /* [新增] 定位在容器底部 */
    left: 10px;           /* [新增] 與父容器邊距對齊 */
    right: 10px;          /* [新增] 與父容器邊距對齊 */
    width: auto;          /* [修訂] 讓 left/right 決定寬度 */
    height: 12px;         /* [修訂] 加粗進度條 */
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;   /* [修訂] 配合新的高度調整圓角 */
    overflow: hidden;
    margin-top: 0;        /* [修訂] 移除 margin-top */
}
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff8a00, #e52e71);
            width: 0%;
            transition: width 0.1s linear;
        }
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Reduced gap */
        }
        .tracks {
    display: flex;
    justify-content: center;
    gap: 8px; /* Reduced gap */
    position: relative;
    height: 600px; /* Increased height */
    background: rgba(0, 0, 0, 0.2); /* 【修改這裡】將 0.05 增加到 0.2 或 0.25 試試看 */
    border-radius: 10px; /* Reduced radius */
    overflow: hidden;
    padding: 15px 0; /* Reduced padding */
    transition: box-shadow 0.3s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); /* 添加一個柔和、自然的陰影 */
}


        /* Combo Glow Effects */
        .tracks.combo-blue {
            box-shadow: 0 0 20px 5px rgba(30, 144, 255, 0.7); /* Softer blue */
        }
        .tracks.combo-orange {
            box-shadow: 0 0 25px 8px rgba(255, 165, 0, 0.7); /* Softer orange */
        }
        .tracks.combo-pink {
            box-shadow: 0 0 30px 10px rgba(255, 105, 180, 0.7); /* Softer pink */
        }
        .tracks.combo-purple {
            box-shadow: 0 0 35px 12px rgba(147, 112, 219, 0.7); /* Softer purple */
        }
        .tracks.combo-rainbow {
             box-shadow: 0 0 40px 15px;
             animation: rainbowGlow 1.5s infinite;
        }
        @keyframes rainbowGlow {
            0% { box-shadow-color: rgba(255, 0, 0, 0.7); }
            16.66% { box-shadow-color: rgba(255, 255, 0, 0.7); }
            33.33% { box-shadow-color: rgba(0, 255, 0, 0.7); }
            50% { box-shadow-color: rgba(0, 255, 255, 0.7); }
            66.66% { box-shadow-color: rgba(0, 0, 255, 0.7); }
            83.33% { box-shadow-color: rgba(255, 0, 255, 0.7); }
            100% { box-shadow-color: rgba(255, 0, 0, 0.7); }
        }
        /* 每個單獨的軌道 */
.track {
    width: 80px;
    height: 100%;
    background: rgba(0, 0, 0, 0.1); 
    border-radius: 8px; /* Reduced radius */
    position: relative;
}
        .track::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent 0%, rgba(255, 255, 255, 0.2) 100%);
            pointer-events: none;
        }
        .hit-line {
            position: absolute;
            bottom: 100px;
            left: 0;
            width: 100%;
            height: 4px; /* Reduced height */
            background: linear-gradient(90deg, #ff8a00, #e52e71);
            border-radius: 2px; /* Reduced radius */
            box-shadow: 0 0 10px rgba(229, 46, 113, 0.7); /* Reduced shadow */
            z-index: 10;
        }
        .note {
            position: absolute;
            width: 70px;
            height: 25px; /* Reduced height */
            background: linear-gradient(45deg, #00c9ff, #92fe9d);
            border-radius: 12px; /* Reduced radius */
            top: -50px;
            left: 5px;
            box-shadow: 0 0 10px rgba(0, 201, 255, 0.7); /* Reduced shadow */
            animation: fall linear;
            z-index: 5;
        }
        .long-note {
            position: absolute;
            width: 70px;
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            border-radius: 12px; /* Reduced radius */
            top: -50px;
            left: 5px;
            box-shadow: 0 0 10px rgba(255, 65, 108, 0.7); /* Reduced shadow */
            animation: fall linear;
            z-index: 5;
            transition: background 0.1s ease, box-shadow 0.1s ease; /* Added for smooth color change */
        }
        .long-note.held {
            background: linear-gradient(45deg, #ffdd4b, #ff8c4b); /* Yellow/Orange Gradient */
            box-shadow: 0 0 15px rgba(255, 221, 75, 0.9); /* Brighter Glow */
        }
        @keyframes fall {
            from { transform: translateY(-50px); }
            to { transform: translateY(650px); } /* Adjusted for increased track height */
        }
        .key-hint {
            position: absolute;
            bottom: 50px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 1.3rem; /* Adjusted */
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
        }
        .judgment {
            position: absolute;
            bottom: 150px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 1.5rem; /* Adjusted */
            font-weight: bold;
            opacity: 0;
            z-index: 20;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8); /* Reduced shadow */
            animation: judgmentFade 1s ease-out;
        }
        @keyframes judgmentFade {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-40px); } /* Reduced transform */
        }
        .perfect { color: #ffcc00; }
        .great { color: #00ccff; }
        .good { color: #00ff99; }
        .miss { color: #ff3366; }
        .combo-display {
            position: absolute;
            top: 20%; /* Moved up */
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem; /* Adjusted */
            font-weight: bold;
            /* [修訂] 移除固定的黃色，由下面的類別決定 */
            opacity: 0;
            z-index: 15;
            animation: comboFlash 0.5s ease-out;
            pointer-events: none; /* Ensure it doesn't block clicks */
        }
         /* [修訂] Combo Display Colors - 新增基礎顏色，並調整現有顏色 */
        .combo-display.combo-base { color: #e0e0e0; text-shadow: 0 0 10px rgba(224, 224, 224, 0.7); }
        .combo-display.combo-blue { color: #1e90ff; text-shadow: 0 0 15px rgba(30, 144, 255, 0.8); }
        .combo-display.combo-orange { color: #ffa500; text-shadow: 0 0 15px rgba(255, 165, 0, 0.8); }
        .combo-display.combo-pink { color: #ff69b4; text-shadow: 0 0 15px rgba(255, 105, 180, 0.8); }
        .combo-display.combo-purple { color: #9370db; text-shadow: 0 0 15px rgba(147, 112, 219, 0.8); }
        .combo-display.combo-rainbow {
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: comboFlashRainbow 0.5s ease-out, rainbowText 2s linear infinite;
        }
        @keyframes comboFlash {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); } /* Reduced scale */
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes comboFlashRainbow {
             0% { opacity: 1; transform: translate(-50%, -50%) scale(1.5); }
             100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes rainbowText {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        /* [修訂] 第二點：新增打擊感動畫 */
        .track.hit-effect {
            animation: trackFlash 0.2s ease-out;
        }
        @keyframes trackFlash {
            0% { background-color: rgba(255, 255, 255, 0.35); }
            100% { background-color: rgba(255, 255, 255, 0.15); }
        }
        .hit-line.pulse-effect {
    animation: hitLinePulse 0.2s ease-out; /* 延長到 0.2s */
}
@keyframes hitLinePulse {
    0% { transform: scaleX(1); box-shadow: 0 0 10px rgba(229, 46, 113, 0.7); }
    50% { transform: scaleX(1.1); box-shadow: 0 0 30px 8px rgba(255, 204, 0, 1); } /* 加強陰影與縮放 */
    100% { transform: scaleX(1); box-shadow: 0 0 10px rgba(229, 46, 113, 0.7); }
}
       
        /* ====== 【修訂後】粒子效果 CSS ====== */

/* --- Hit Particle (打擊線粒子) --- */
.hit-particle {
    position: absolute;
    bottom: 100px; /* 起始位置在打擊線 */
    width: var(--size, 10px);
    height: var(--size, 10px);
    border-radius: 50%;
    pointer-events: none;
    z-index: 30;
    opacity: 0; /* 預設完全透明，隱藏在池中 */
    /* 【優化】告知瀏覽器這些屬性將會變動，可以啟用硬體加速 */
    will-change: transform, opacity; 
}

/* 當粒子被激活時，添加 .animate class 來觸發動畫 */
.hit-particle.animate {
    animation: particleBurst 0.6s ease-out forwards;
}

@keyframes particleBurst {
    0% {
        transform: translateY(0) scale(1) rotate(var(--rot, 0deg));
        opacity: 1; /* 動畫開始時變為可見 */
    }
    100% {
        transform: translateY(var(--y)) translateX(var(--x)) scale(0) rotate(var(--rot-end, 360deg));
        opacity: 0; /* 動畫結束時淡出 */
    }
}


/* --- Note Particle (音符爆炸粒子) --- */
.note-particle {
    position: absolute;
    width: var(--size, 8px);
    height: var(--size, 8px);
    border-radius: 30%;
    pointer-events: none;
    z-index: 30;
    opacity: 0; /* 預設完全透明 */
    will-change: transform, opacity;
}

/* 當粒子被激活時，添加 .animate class 來觸發動畫 */
.note-particle.animate {
     animation: noteDecompose 0.5s ease-out forwards;
}

@keyframes noteDecompose {
    0% {
        transform: translate(0, 0) scale(1) rotate(0deg);
        opacity: 1;
    }
    100% {
        transform: translate(var(--x), var(--y)) scale(0.2) rotate(var(--rot-end, 360deg));
        opacity: 0;
    }
}

        
        /* Touch Controls - Positioned in flow, not fixed */
        .touch-controls {
            display: none; /* [修訂] 預設隱藏，由 JS 控制顯示 */
            justify-content: center;
            gap: 15px;
            margin-top: 15px; /* Added margin to separate from tracks */
            padding: 10px 0;
            width: 100%;
            z-index: 100;
        }
        /* [修訂] 第三點：更有質感的半透明按鍵設計 */
        .touch-key {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
            /* Glassmorphism / Translucent Texture */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
   /* ====== Final "Starlight Silver" Key Styles (Ultimate Palette) ====== */

/* --- 所有按鍵的統一基礎樣式 --- */
.touch-key {
    border: 2px solid;
    /* 過渡效果中加入 filter，讓提亮動畫更平滑 */
    transition: box-shadow 0.15s ease, transform 0.1s ease, filter 0.1s ease, background 0.15s ease;
}

/* A 鍵 - 宇宙青石 (Cosmic Teal) */
.touch-key[data-key="65"] {
    background: linear-gradient(135deg, rgba(0, 220, 220, 0.7), rgba(0, 100, 120, 0.8));
    border-color: rgba(80, 230, 230, 0.8);
    box-shadow: 0 0 15px rgba(0, 220, 220, 0.6);
}

/* S 鍵 - 藍寶石 (Sapphire) */
.touch-key[data-key="83"] {
    background: linear-gradient(135deg, rgba(0, 201, 255, 0.7), rgba(0, 123, 255, 0.75));
    border-color: rgba(100, 220, 255, 0.8);
    box-shadow: 0 0 15px rgba(0, 201, 255, 0.6);
}

/* D 鍵 - 冰晶石 (Ice Crystal) */
.touch-key[data-key="68"] {
    background: linear-gradient(135deg, rgba(210, 240, 255, 0.7), rgba(150, 210, 255, 0.8));
    border-color: rgba(220, 245, 255, 0.85);
    box-shadow: 0 0 18px rgba(180, 225, 255, 0.7);
}

/* F 鍵 - 星光銀 (Starlight Silver) - 明亮、高雅的中性色 */
.touch-key[data-key="70"] {
    background: linear-gradient(135deg, rgba(225, 230, 235, 0.7), rgba(170, 180, 190, 0.8));
    border-color: rgba(230, 235, 240, 0.8);
    box-shadow: 0 0 15px rgba(210, 215, 220, 0.7);
}


/* --- 按下時激活的效果 --- */
.touch-key:active, .touch-key.pressed {
    /* 使用 filter 大幅提亮和增加飽和度，產生晶石被激活的感覺 */
    filter: brightness(1.3) saturate(1.2);
    /* 同時光暈劇烈迸發 */
    box-shadow: 0 0 28px 5px;
}

/* 為每個按鍵的迸發光暈指定顏色 */
.touch-key[data-key="65"]:active, .touch-key[data-key="65"].pressed { box-shadow: 0 0 28px 5px rgba(0, 220, 220, 0.8); }
.touch-key[data-key="83"]:active, .touch-key[data-key="83"].pressed { box-shadow: 0 0 28px 5px rgba(0, 201, 255, 0.8); }
.touch-key[data-key="68"]:active, .touch-key[data-key="68"].pressed { box-shadow: 0 0 28px 5px rgba(180, 225, 255, 0.85); }
.touch-key[data-key="70"]:active, .touch-key[data-key="70"].pressed { box-shadow: 0 0 28px 5px rgba(225, 230, 235, 0.9); }
        /* [修訂] 第二點：移除原先的 Media Query，改由 JS 控制
        @media (hover: none) and (pointer: coarse) {
            .touch-controls {
                display: flex;
            }
            .key-hint {
                display: none;
            }
        }
        */
       /* ====== 【NEW DESIGN】Game Over Modal - "Hall of Fame" Theme ====== */
.game-over-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 20, 40, 0.7); /* A slightly tinted dark overlay */
    backdrop-filter: blur(5px); /* Frosted glass effect */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
}

.game-over-modal.active {
    opacity: 1;
    pointer-events: all;
}

/* The main container with 90% width */
.game-over-content {
    background: linear-gradient(160deg, #1d2b4a, #11182c); /* A deep, rewarding blue gradient */
    width: 90%;
    max-width: 450px; /* Max width for larger screens */
    padding: 30px 40px;
    border-radius: 20px; /* Softer, larger corners */
    text-align: center;
    border: 1px solid rgba(255, 204, 0, 0.3); /* Subtle gold border */
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5), 0 0 25px rgba(255, 204, 0, 0.2) inset; /* Outer depth and inner glow */
    transform: scale(0.8);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
    box-sizing: border-box;
}

.game-over-modal.active .game-over-content {
    transform: scale(1);
    opacity: 1;
}

.game-over-title {
    font-size: 2.8rem;
    margin-bottom: 20px;
    color: #ffcc00; /* Bright gold color */
    font-weight: 700;
    text-shadow: 0 0 15px rgba(255, 204, 0, 0.6); /* Stronger glow effect */
}

.game-over-stats {
    display: flex;
    justify-content: space-around;
    margin: 25px 0;
    gap: 15px;
}

.game-over-stat {
    background: rgba(255, 255, 255, 0.05); /* Very subtle background for contrast */
    padding: 15px;
    border-radius: 12px;
    flex: 1; /* Allow stats to grow equally */
    min-width: 100px;
}

.stat-label {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 8px;
    font-weight: 500;
}

.stat-number {
    font-size: 2.2rem;
    font-weight: bold;
    color: #ff8a00; /* Bright orange for the numbers */
}

/* A prominent, inviting call-to-action */
.restart-btn {
    background: linear-gradient(45deg, #00c9ff, #92fe9d);
    color: #fff;
    border: none;
    padding: 14px 35px;
    border-radius: 50px; /* Pill shape */
    font-size: 1.2rem;
    font-weight: bold;
    cursor: pointer;
    margin-top: 20px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    text-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.restart-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 201, 255, 0.3);
}

/* Responsive adjustments for Game Over Modal */
@media (max-width: 480px) {
    .game-over-content {
        padding: 25px 20px;
    }
    .game-over-title {
        font-size: 2.2rem;
    }
    .game-over-stats {
        flex-direction: column; /* Stack stats vertically */
    }
    .stat-number {
        font-size: 2rem;
    }
    .restart-btn {
        padding: 12px 30px;
        font-size: 1.1rem;
    }
}

        
        /* Settings Modal Styles */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .settings-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        .settings-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(255, 138, 0, 0.5);
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        .close-settings {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .settings-title {
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
            color: #ffcc00;
        }
        .setting-group {
            margin-bottom: 20px;
        }
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        .setting-control {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 1rem;
        }
       /* --- 1. 滑桿軌道的基礎樣式 --- */
.setting-slider {
    -webkit-appearance: none; /* 移除 Chrome/Safari 的預設樣式 */
    appearance: none;
    width: 100%;
    height: 8px; /* 軌道高度 */
    background: #4a5568; /* 軌道底色 (未填充部分) */
    border-radius: 5px;
    outline: none;
    transition: opacity .2s;
    cursor: pointer;
}

/* --- 2. 滑桿拖曳鈕 (Thumb) 的樣式 --- */
.setting-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px; /* 拖曳鈕寬度 */
    height: 20px; /* 拖曳鈕高度 */
    background: #e2e8f0; /* 拖曳鈕顏色 */
    border-radius: 50%;
    border: 2px solid #718096;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

.setting-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #e2e8f0;
    border-radius: 50%;
    border: 2px solid #718096;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

/* Copyright Disclaimer Modal Styles */
.copyright-disclaimer-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1005;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
}
.copyright-disclaimer-modal.active {
    opacity: 1;
    pointer-events: all;
}
.disclaimer-content {
    background: linear-gradient(135deg, #2c1810, #1a1a2e);
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
    max-width: 500px;
    width: 90%;
    position: relative;
    text-align: left;
    border: 1px solid rgba(255, 215, 0, 0.2);
    animation: modalPop 0.5s ease-out;
}
.close-disclaimer {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    color: #FFD700;
    font-size: 1.8rem;
    cursor: pointer;
    transition: color 0.3s ease, transform 0.2s ease;
}
.close-disclaimer:hover {
    color: #fff;
    transform: rotate(90deg);
}
.disclaimer-title {
    font-size: 2rem;
    margin-bottom: 30px;
    text-align: center;
    color: #FFD700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}
.disclaimer-section {
    margin-bottom: 25px;
    padding: 20px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 15px;
    border-left: 4px solid #FFD700;
}
.disclaimer-section h3 {
    color: #FFD700;
    margin-bottom: 10px;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}
.disclaimer-section p {
    color: #e0e0e0;
    line-height: 1.6;
    font-size: 1.1rem;
}




        /* Personal High Score Modal */
        .personal-high-score-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .personal-high-score-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        .personal-high-score-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(255, 138, 0, 0.5);
            max-width: 500px;
            width: 90%;
            position: relative;
            text-align: center;
        }
        .close-personal-high-score {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .personal-high-score-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #ffcc00;
        }
        .personal-high-score-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .personal-high-score-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .personal-high-score-label {
            font-weight: bold;
        }
        .personal-high-score-value {
            font-size: 1.2rem;
            color: #00c9ff;
        }

        /* Settings Button SVG */
        .settings-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .settings-icon {
            width: 100%;
            height: 100%;
            fill: white;
        }

        /* Music Player Button */
        .music-player-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px; /* Add some space */
        }
        .music-player-icon {
            width: 100%;
            height: 100%;
            fill: white;
        }

        /* Music Player Modal */
       .music-player-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* [修訂] 改用更明亮、有活力的漸變色 */
      background-color: #0b192f; 
    background-image: 
        /* [保留] 原有的藍綠色光暈 */
        radial-gradient(at 20% 80%, hsla(190, 80%, 50%, 0.3), transparent 50%),
        radial-gradient(at 80% 10%, hsla(170, 70%, 60%, 0.25), transparent 50%),
        /* [增強] 大幅提升右上角金色光暈的亮度和範圍 */
        radial-gradient(at 90% 20%, hsla(40, 90%, 70%, 0.35), transparent 60%),
        /* [修訂] 將橙色替換為更優雅、空靈的柔和品紅 (Rose Gold / Magenta) */
        radial-gradient(at 10% 40%, hsla(45, 80%, 75%, 0.25), transparent 70%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1003;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
}
        .music-player-modal.active {
            opacity: 1;
            pointer-events: all;
        }
       .music-player-content {
    width: 90%;
    max-width: 800px;
    text-align: center;
    padding: 30px;
    /* [修訂] 調整背景透明度與陰影，使其在亮色背景下更清晰 */
    background: rgba(255, 255, 255, 0.25); /* 提高亮度 */
    backdrop-filter: blur(30px); /* 增強模糊效果 */
    -webkit-backdrop-filter: blur(30px);
    border-radius: 20px;
    border: 1px solid rgba(230, 180, 80, 0.5);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2), 0 0 20px rgba(230, 180, 80, 0.2);
    /* ▼▼▼ 新增以下樣式以啟用滾動 ▼▼▼ */
    max-height: 90vh; /* 限制最大高度為視窗的90% */
    overflow-y: auto; /* 內容超出時顯示垂直滾動條 */
    display: flex;
    flex-direction: column; /* 將子元素垂直排列 */
    /* ▲▲▲ 新增結束 ▲▲▲ */
}
        .music-player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        /* Removed .music-player-title style */
        .close-music-player {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-music-player:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .close-music-player-icon {
             width: 100%;
             height: 100%;
             fill: white;
        }
        .now-playing {
    font-size: 1.5rem;
    margin-bottom: 20px;
    /* [修訂] 改為深灰色，增加易讀性 */
    color: #2c3e50; 
    font-weight: 600;
}
.lyric-line {
    margin: 10px 0;
    /* [修訂] 基礎文字顏色改為較深的灰色 */
    color: #a3a3a3;
    opacity: 0.7;
    transition: all 0.3s ease;
}
.lyric-line.active {
    opacity: 1;
    font-weight: bold;
    /* [修訂] 高亮顏色改為與新主題匹配的珊瑚紅 */
    color: #17a2b8;
    transform: scale(1.05);
    /* [修訂] 陰影改為更柔和的樣式 */
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
}
        .no-lyrics {
            color: #aaa;
            font-style: italic;
        }
        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .player-btn {
   background: rgba(255, 255, 255, 0.2); /* 稍微調亮背景 */
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #2c3e50; 
    font-size: 2rem;
    cursor: pointer;
    width: 55px; /* [新增] 固定大小 */
    height: 55px; /* [新增] 固定大小 */
    display: flex; /* [新增] 用於居中圖示 */
    align-items: center; /* [新增] */
    justify-content: center; /* [新增] */
    padding: 0; /* [修訂] 移除內邊距 */
    border-radius: 50%;
    transition: background 0.3s ease, transform 0.2s ease;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3); /* [新增] 圖示陰影 */
}
.player-btn:hover {
    background: rgba(255, 255, 255, 0.4); /* [修訂] 懸停時更亮 */
}

/* 進度條軌道 */
.progress-slider {
    width: 100%;
    height: 8px;
    -webkit-appearance: none;
    /* [修訂] 軌道使用更柔和的顏色 */
   background: rgba(140, 115, 70, 0.3); 
    border-radius: 4px;
    outline: none;
}

/* 進度條滑塊 */
.progress-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    /* [修訂] 滑塊改為高雅的米白色 */
    background: #17a2b8; 
    border: none; /* [修訂] 移除邊框 */
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.1); /* [新增] 增加細微邊框 */
}
        .time-display {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #ccc;
        }
        .volume-control-player {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }
        .volume-control-player input[type="range"] {
            width: 150px;
        }
       .playlist {
    list-style: none;
    padding: 0;
    margin-top: 30px;
    max-height: 200px; /* 預設值，適用於小屏幕 */
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    padding: 10px;
}

/* 在大屏幕上給播放列表更多空間 */
@media (min-width: 769px) {
    .playlist {
        max-height: 400px; /* 在電腦上顯示更多歌曲 */
    }
}
        .playlist-item {
    padding: 12px 15px; /* [修訂] 增加內邊距 */
    border-radius: 8px; /* [修訂] 圓角更柔和 */
    cursor: pointer;
    transition: background 0.3s ease;
    text-align: left;
    color: #e1d4dd; /* [新增] 設置基礎文字顏色 */
    border-bottom: 1px solid rgba(255, 255, 255, 0.05); /* [新增] 微妙的分隔線 */
}
.playlist-item:last-child {
    border-bottom: none; /* [新增] 最後一項不需要分隔線 */
}
.playlist-item:hover {
    background: rgba(255, 255, 255, 0.1);
}
.playlist-item.active {
    /* [修訂] 使用新的配色方案 */
    background: rgba(23, 162, 184, 0.2); /* 青色的半透明背景 */
    color: #2c3e50; /* 深灰藍色文字 */
    font-weight: bold;
}
        .playlist-item.locked {
             color: #888;
             cursor: not-allowed;
             opacity: 0.7;
        }
.playlist-item.disabled {
    opacity: 0.5;
    color: #888;
    text-decoration: line-through;
}

.playlist-item.disabled {
    opacity: 0.5;
    color: #888;
    text-decoration: line-through;
}

        /* Unlock Modal */
        .unlock-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1004;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .unlock-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        .unlock-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(255, 138, 0, 0.5);
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
        }
        .unlock-icon {
            font-size: 4rem;
            color: #ffcc00;
            margin-bottom: 20px;
        }
        .unlock-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        .unlock-requirement {
            font-size: 1rem;
            color: #00c9ff;
            margin-bottom: 30px;
        }
        .close-unlock {
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .close-unlock:hover {
            transform: translateY(-2px);
        }


        /* Responsive Design Adjustments */
       /* Responsive Design Adjustments for Tablets and Smaller Screens (Up to 1024px) */
@media (max-width: 1024px) {
    /* --- 基礎手機適配 (繼承自原來的 max-width: 768px) --- */
    h1 { font-size: 2rem; }
    .tracks { height: 500px; }
    .track { width: 60px; }
    .note, .long-note { width: 50px; }
    .hit-line { bottom: 90px; }
    .music-select-wrapper select { max-width: 150px; }
    .difficulty-selector select { max-width: 100px; }
    .music-player-content { padding: 15px; }
    .lyrics-container { height: 200px; font-size: 1rem; }
    .player-btn { font-size: 1.5rem; }
    .play-pause-btn { font-size: 2rem; }
    .playlist { max-height: 150px; }

    /* --- 新增/修改：針對平板尺寸 (769px - 1024px) 的優化 --- */
    @media (min-width: 769px) {
        /* 遊戲主頁優化 */
        h1 {
            font-size: 2.2rem; /* 稍微比手機大一點 */
        }
        .subtitle {
            font-size: 1.1rem;
        }
        .game-ui {
            flex-wrap: nowrap; /* 防止在中等屏幕上折行 */
            justify-content: space-between;
            gap: 15px; /* 增加一點間距 */
        }
        .stats {
            flex-wrap: nowrap;
            gap: 10px; /* 減少統計間的間距 */
        }
        .stat-box {
            padding: 8px 12px; /* 增加內邊距 */
            min-width: 90px; /* 增加最小寬度 */
        }
        .stat-value {
            font-size: 1.6rem; /* 稍微增大分數顯示 */
        }
        .controls {
            gap: 15px; /* 增加控制按鈕間距 */
        }
        .start-button-svg {
            width: 70px; /* 增大開始按鈕 */
            height: 35px;
        }
        .settings-btn {
            width: 45px; /* 增大設定按鈕 */
            height: 45px;
            font-size: 1.8rem;
        }

        /* 軌道和音符尺寸調整 */
        .tracks {
            height: 550px; /* 比手機高，比桌面低 */
            max-width: 600px; /* 限制最大寬度 */
            margin: 0 auto; /* 居中 */
        }
        .track {
            width: 70px; /* 增大軌道寬度 */
            margin: 0 5px; /* 軌道間距 */
        }
        .note, .long-note {
            width: 60px; /* 增大音符寬度 */
            height: 30px; /* 增大音符高度 */
        }
        .hit-line {
            bottom: 100px; /* 調整擊打線位置 */
            height: 5px;
        }
        .judgment {
            font-size: 2.2rem; /* 增大判定文字 */
            bottom: 170px; /* 調整判定文字位置 */
        }
        .combo-display {
            font-size: 3.2rem; /* 增大連擊數字 */
            top: 25%; /* 調整連擊數字位置 */
        }

        /* 下拉選單調整 */
        .music-select-wrapper select,
        .difficulty-selector select {
            font-size: 1rem; /* 增大字體 */
            padding: 8px 12px; /* 增大內邊距 */
            max-width: none; /* 移除最大寬度限制 */
        }
        .music-select-wrapper::after {
            right: 12px; /* 調整箭頭位置 */
        }

        /* CD 封面 */
.cd-cover-wrapper {
    max-width: 250px; /* 桌面版大小 */
}
/* 響應式設計：在小屏幕上縮小封面 */
/* 平板尺寸優化 */
@media (min-width: 769px) and (max-width: 1024px) {
     .cd-cover-wrapper {
         max-width: 230px; /* 平板版大小，介於手機和桌面之間 */
         margin-bottom: 20px; /* 可根據需要調整 */
     }
}
@media (max-width: 768px) { /* 手機版 */
    .cd-cover-wrapper {
        max-width: 220px;
    }
}
@media (max-width: 480px) { /* 小手機版 */
    .cd-cover-wrapper {
        max-width: 180px;
        margin-bottom: 15px;
    }
}

        /* 音樂播放器頁面優化 */
.music-player-content {
    width: 92%;
    max-width: 700px;
    padding: 25px 30px;
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    /* 修改: 移除 max-height 和 overflow-y，讓內部元素控制滾動 */
    /* max-height: 90vh; */
    /* overflow-y: auto; */
    /* 新增: 確保容器本身不會溢出視口，但允許內部滾動 */
    max-height: 90vh;
    overflow: hidden; /* 防止容器本身溢出 */
}

.lyrics-container {
    /* 保留原有樣式 */
    font-size: 1.3rem;
    margin-bottom: 20px;
    padding: 10px;
    /* 修改: 移除固定 height，依賴 flex 分配空間 */
    /* height: 250px; */
    /* 修改: flex 屬性調整，允許增長和收縮，但基礎大小為 0 */
    flex: 1 1 0; /* grow, shrink, basis */
    min-height: 120px; /* 保持最小高度 */
    overflow-y: auto; /* 內部滾動 */
    /* 手機版樣式保留 */
    font-size: 1.2rem;
    margin-bottom: 15px;
}

.playlist {
    list-style: none;
    padding: 0;
    margin-top: 30px; /* 可根據需要調整 */
    /* 修改: 移除固定 max-height，改為 flex 控制 */
    /* max-height: 200px; */
    /* max-height: 150px; */
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    padding: 10px;
    /* 修改: flex 屬性調整，允許增長和收縮，但基礎大小為 0 */
    flex: 1 1 0; /* grow, shrink, basis */
    /* 新增: 設置一個最小高度，確保至少能顯示一行 */
    min-height: 80px;
}

/* - 新增/修改：針對平板尺寸 (769px - 1024px) 的優化 - */
@media (min-width: 769px) and (max-width: 1024px) {
    .music-player-content {
        /* 在平板上可以稍微增加最大寬度和內邊距 */
        max-width: 800px;
        padding: 30px 40px;
    }
    .lyrics-container {
        /* 平板上可以增加歌詞區的高度偏好 */
        font-size: 1.4rem; /* 稍微增大字體 */
        min-height: 150px; /* 增加最小高度 */
    }
    .playlist {
        /* [關鍵修訂] 顯著增加播放清單在平板上的最大高度 */
        /* flex: 1 1 0; */ /* 可以保留 flex，但 max-height 更直接 */
        /* 移除 flex 或調整 basis，或者直接設置一個適合平板的高度 */
        flex: 0 1 auto; /* 不主動增長，可以收縮，根據內容 */
        max-height: 300px; /* 增大以顯示更多項目 */
        min-height: 150px; /* 增加最小高度 */
    }
    /* 確保內部滾動條在需要時出現 */
    .lyrics-container, .playlist {
        overflow-y: auto;
    }
}

/* 大屏幕優化保持不變 */
@media (min-width: 1025px) {
    .playlist {
        max-height: 400px;
    }
}
        .playlist-item {
            padding: 14px 18px; /* 增加內邊距 */
            border-radius: 10px; /* 增大圓角 */
        }

        /* --- 模態框 (Modal) 優化 --- */
        .game-over-content,
        .settings-content,
        .personal-high-score-content,
        .unlock-content,
        .disclaimer-content {
            width: 90%; /* 稍微增大寬度 */
            max-width: 500px; /* 設置最大寬度 */
            padding: 35px; /* 增加內邊距 */
            border-radius: 20px; /* 增大圓角 */
        }
        .game-over-title,
        .settings-title,
        .personal-high-score-title,
        .unlock-message,
        .disclaimer-title {
            font-size: 2rem; /* 增大標題 */
        }
        .game-over-stat {
            padding: 18px; /* 增加統計項內邊距 */
            min-width: 110px; /* 增加最小寬度 */
            margin: 10px; /* 調整外邊距 */
        }
        .stat-number {
            font-size: 2.2rem; /* 增大統計數字 */
        }
        .stat-label {
            font-size: 1.1rem; /* 增大統計標籤 */
        }
        .restart-btn,
        .close-settings,
        .close-personal-high-score,
        .close-unlock,
        .close-disclaimer {
            padding: 12px 25px; /* 增加按鈕內邊距 */
            font-size: 1.2rem; /* 增大按鈕文字 */
        }
        .setting-item {
            margin-bottom: 20px; /* 增加設定項間距 */
        }
        .setting-label {
            font-size: 1.1rem; /* 增大設定標籤 */
            margin-bottom: 8px; /* 增加下方間距 */
        }
        .setting-slider {
            width: 100%; /* 保持 100% 寬度 */
        }
        .disclaimer-section h3 {
            font-size: 1.4rem; /* 增大章節標題 */
        }
        .disclaimer-section p {
            font-size: 1.2rem; /* 增大段落文字 */
        }
    }
}

        
        @media (max-width: 480px) {
            h1 { font-size: 1.7rem; }
            .game-ui {
                justify-content: space-around;
                gap: 5px;
                flex-wrap: wrap;
            }
            .stats, .controls {
                flex-shrink: 1; 
                flex-wrap: wrap;
                justify-content: center;
            }
            .music-select-wrapper select {
                padding: 6px 30px 6px 10px;
                font-size: 0.8rem;
                max-width: 120px;
            }
            .stat-box {
                padding: 6px 10px;
                min-width: 80px;
            }
            .stat-value {
                font-size: 1.3rem;
            }
            .tracks { height: 400px; }
            .track { width: 50px; }
            .note, .long-note { width: 40px; }
            .hit-line { bottom: 80px; }
            .difficulty-selector select {
                max-width: 80px;
                font-size: 0.8rem;
                padding: 4px 6px;
            }
            .music-player-header {
                flex-direction: column;
                gap: 10px;
            }
            /* Removed .music-player-title style for small screens */
            .now-playing {
                font-size: 1.2rem;
            }
            .player-controls {
                gap: 10px;
            }
            .player-btn {
                font-size: 1.2rem;
                padding: 8px;
            }
            .play-pause-btn {
                font-size: 1.8rem;
            }
            .volume-control-player {
                flex-direction: column;
                gap: 5px;
            }
            .volume-control-player input[type="range"] {
                width: 100%;
            }
            .time-display {
                font-size: 0.8rem;
            }
            flex-shrink: 1; /* 允許在空間不足時被壓縮 */
    min-height: 100px; /* 設置一個最小高度 */
            .unlock-content {
                padding: 20px;
            }
            .unlock-icon {
                font-size: 3rem;
            }
            .unlock-message {
                font-size: 1rem;
            }
            .unlock-requirement {
                font-size: 0.9rem;
            }
.music-player-content {
    display: flex;
    flex-direction: column;
    /* [修訂] 將固定的 height 改為 max-height，讓容器有上下邊距 */
    max-height: 90vh; 
    overflow-y: auto;
    padding: 10px 15px; 
}


    .player-controls {
        gap: 15px; /* [修訂] 稍微拉開一點間距，避免誤觸 */
    }

    .player-btn {
        /* [修訂] 固定按鈕大小，讓佈局更穩定 */
        width: 45px;
        height: 45px;
        font-size: 1.2rem;
        padding: 0; /* 移除內邊距，因為已用 flex 居中 */
    }

    .play-pause-btn {
        width: 60px; /* [修訂] 讓播放鍵稍大，更突出 */
        height: 60px;
        font-size: 1.8rem;
    }

   .lyrics-container {
    flex: 1;
    min-height: 120px;
    overflow-y: auto;
    /* [修訂] 加大手機版面的歌詞字體，提升可讀性 */
    font-size: 1.2rem; 
    margin-bottom: 15px; 
}

.playlist {
    flex-shrink: 0;
    /* [修訂] 顯著增加播放清單的最大高度，使其在手機版面更易於滾動和查看 */
    max-height: 150px; 
}
        }

/* ====== 【NEW DESIGN】Notification Modal - "Heads-Up Display" Theme ====== */
.notification-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(25, 40, 60, 0.7);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
}

.notification-modal.active {
    opacity: 1;
    pointer-events: all;
}

/* The main container with 90% width */
.notification-content {
    background: #f0f4f8; /* A very light, clean, cool gray */
    color: #334155; /* Dark slate gray for high readability */
    width: 90%;
    max-width: 400px; /* Max width for larger screens */
    padding: 25px 30px;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); /* Soft, modern shadow */
    position: relative;
    border-left: 5px solid #64748b; /* Default border color */
    transform: scale(0.8);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
    box-sizing: border-box;
}

.notification-modal.active .notification-content {
    transform: scale(1);
    opacity: 1;
}

.close-notification {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    color: #94a3b8; /* Lighter gray for the 'x' */
    font-size: 2rem;
    cursor: pointer;
    transition: color 0.3s ease;
}

.close-notification:hover {
    color: #334155;
}

.notification-icon {
    font-size: 3.5rem;
    margin-bottom: 15px;
    animation: icon-pop 0.5s ease-out 0.3s backwards;
}

@keyframes icon-pop {
    0% { transform: scale(0); }
    80% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.notification-title {
    font-size: 1.6rem;
    margin-bottom: 8px;
    font-weight: 700;
}

.notification-message {
    font-size: 1rem;
    color: #64748b; /* Softer gray for the message body */
    line-height: 1.6;
}

.notification-message strong {
    font-weight: 700;
    color: #334155; /* Strong text matches the main text color */
}

/* --- Success Style --- */
.notification-content.success {
    border-left-color: #10b981; /* Bright green accent */
}
.notification-content.success .notification-icon {
    color: #10b981;
}
.notification-content.success .notification-title {
    color: #059669; /* Darker green for title */
}

/* --- Info/Failure Style --- */
.notification-content.info {
    border-left-color: #3b82f6; /* Bright blue accent */
}
.notification-content.info .notification-icon {
    color: #3b82f6;
}
.notification-content.info .notification-title {
    color: #2563eb; /* Darker blue for title */
}

/* Responsive adjustments for Notification Modal */
@media (max-width: 480px) {
    .notification-content {
        padding: 20px 25px;
    }
    .notification-title {
        font-size: 1.4rem;
    }
    .notification-message {
        font-size: 0.95rem;
    }
    .notification-icon {
        font-size: 3rem;
    }
}


/* ====== CD Cover Styles ====== */
.cd-cover-container {
    width: 100%;
    display: flex;
    justify-content: center;
    margin-bottom: 20px; /* 為 "正在播放" 文字留出空間 */
    padding: 0 10px; /* 兩側留白，避免貼邊 */
}

.cd-cover-wrapper {
    position: relative;
    width: 100%;
    max-width: 300px;
    aspect-ratio: 1 / 1;
    border-radius: 50%;  /* 改成 50% 變成圓形 */
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
}

.cd-cover-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
    border-radius: 50%;  /* 新增：確保圖片本身圓形，防止溢出 */
    transform-origin: center;  /* 新增：確保旋轉以中心為軸 */
}

/* CD 覆蓋層效果 - 模擬 CD 的反光 */
.cd-cover-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0) 0%, 
        rgba(255, 255, 255, 0.1) 50%, 
        rgba(255, 255, 255, 0) 100%);
    pointer-events: none; /* 確保不阻擋點擊 */
}

/* 播放時的旋轉動畫 */
.cd-cover-img.playing {
    animation: cdSpin 15s linear infinite;
}

@keyframes cdSpin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* 響應式設計：在小屏幕上縮小封面 */
@media (max-width: 768px) {
    .cd-cover-wrapper {
        max-width: 220px; /* 中等屏幕 */
    }
}

@media (max-width: 480px) {
    .cd-cover-wrapper {
        max-width: 180px; /* 小屏幕 */
        margin-bottom: 15px; /* 縮小間距 */
    }
    .now-playing {
        font-size: 1.1rem; /* 配合縮小的封面，稍微減小字體 */
    }
}

/* 調整 .game-ui 以預留更多底部空間，避免重疊 */
.game-ui {
    position: relative; 
    display: flex;
    flex-wrap: wrap; 
    justify-content: space-between;
    align-items: center; 
    gap: 8px; 
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px; 
    padding: 10px; 
    padding-bottom: 60px; /* [修訂] 增加底部內邊距，為兩個進度條和歌詞騰出空間（原 35px） */
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); 
}

/* 調整音樂進度條位置，避免與選擇器重疊 */
.progress-container {
    position: absolute;   
    bottom: 5px;         /* [修訂] 降低位置（原 10px） */
    left: 10px;           
    right: 10px;          
    width: auto;          
    height: 12px;         
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;   
    overflow: hidden;
    z-index: 10;         /* [修訂] 降低 z-index，確保在最底層 */
}

/* 調整解鎖進度條位置，避免與選擇器重疊 */
.unlock-progress-container {
    position: absolute;
    bottom: 22px;        /* [修訂] 重新計算位置：音樂進度條 bottom 5px + 高度 12px + 間距 5px = 22px */
    left: 10px;
    right: 10px;
    width: auto;
    height: 12px;         
    transform: translateY(100%); 
    background: rgba(0, 0, 0, 0.4);
    border-radius: 6px;   
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
    z-index: 10;         /* [修訂] 降低 z-index，確保在最底層 */
    opacity: 0;
    transition: opacity 0.5s ease, transform 0.5s ease;
    display: flex;
    align-items: center;
    flex-direction: row;
}

/* 【最終修訂】遊戲中歌詞顯示容器 */
.game-lyrics-container {
    /* 核心定位：保持精確的水平垂直置中 */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);

    /* 【關鍵修訂】直接設定高度，與 .tracks 元素的預設高度 600px 完全一致 */
    height: 600px;
    width: 90%;          /* 寬度保持響應式 */
    
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 15px;
    box-sizing: border-box;

    /* 視覺效果與互動性 */
    color: white;
    text-align: center;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.9);
    pointer-events: none;
    z-index: 4;

    /* 動畫與預設狀態 */
    opacity: 0;
    transition: opacity 0.5s ease;
}

/* 當遊戲進行時，才顯示歌詞容器 */
.game-running .game-lyrics-container {
    opacity: 0.85;
}

/* 【最終修訂】單行歌詞樣式 (此部分無需變更) */
.game-lyric-line {
    font-size: clamp(1.2rem, min(4vw, 7vh), 3rem); 
    font-weight: bold;
    line-height: 1.4;
    margin: 0;
    white-space: normal;
    overflow-wrap: break-word;
    width: 100%;
}

/* 
   【新增響應式調整】
   為了讓歌詞容器的高度始終與 .tracks 元素同步，
   我們需要為 .game-lyrics-container 複製 .tracks 的響應式高度設定。
*/

/* 平板尺寸 (769px - 1024px) */
@media (min-width: 769px) and (max-width: 1024px) {
    .game-lyrics-container {
        height: 550px; /* 與 .tracks 在此區間的高度一致 */
    }
}

/* 一般平板與手機尺寸 (寬度小於 768px) */
@media (max-width: 768px) {
    .game-lyrics-container {
        height: 500px; /* 與 .tracks 在此區間的高度一致 */
    }
}

/* 小型手機尺寸 (寬度小於 480px) */
@media (max-width: 480px) {
    .game-lyrics-container {
        height: 400px; /* 與 .tracks 在此區間的高度一致 */
    }
}

/* 遊戲運行中隱藏選擇器，避免重疊 */
.game-running .music-selector,
.game-running .difficulty-selector {
    display: none;       /* [修訂] 遊戲中隱藏選擇器，只顯示統計和進度 */
}

/* 響應式調整：小螢幕減少間距 */
@media (max-width: 768px) {
    .game-ui {
        padding-bottom: 50px; /* [修訂] 小螢幕減少空間 */
    }
    .game-lyrics-container {
        top: 5%;         /* [修訂] 小螢幕上移，避免擋軌道 */
        font-size: 1rem; /* [修訂] 縮小字體 */
    }
}        

 /* 遊戲中歌詞顯示：軌道兩側全透明垂直區域 */


        .track.flash-effect {
    animation: trackFlashStrong 0.3s ease-out; /* 新增強版閃光 */
}
.track.flash-perfect {
    animation: trackFlashPerfect 0.3s ease-out;
}
@keyframes trackFlashPerfect {
    0% { background-color: rgba(255, 204, 0, 0.5); } /* PERFECT 黃色閃爍 */
    100% { background-color: rgba(255, 255, 255, 0.15); }
}

.track.flash-great {
    animation: trackFlashGreat 0.3s ease-out;
}
@keyframes trackFlashGreat {
    0% { background-color: rgba(0, 204, 255, 0.5); } /* GREAT 藍色閃爍 */
    100% { background-color: rgba(255, 255, 255, 0.15); }
}

.track.flash-good {
    animation: trackFlashGood 0.3s ease-out;
}
@keyframes trackFlashGood {
    0% { background-color: rgba(0, 255, 153, 0.5); } /* GOOD 綠色閃爍 */
    100% { background-color: rgba(255, 255, 255, 0.15); }
}

        .hit-particle {
    width: 10px; /* 從 8px 增加到 10px */
    height: 10px;
    /* ... 其他樣式不變 */
}

        .hit-particle {
    position: absolute;
    bottom: 100px; /* Start at hit line */
    width: var(--size, 10px); /* 隨機尺寸，由 JS 設定 */
    height: var(--size, 10px);
    border-radius: 50%;
    pointer-events: none;
    z-index: 30;
    opacity: 1;
    animation: particleBurst 0.6s ease-out forwards; /* 延長到 0.6s，加強爆破 */
    transform: rotate(var(--rot, 0deg)); /* 新增：隨機旋轉 */
}

@keyframes particleBurst {
    0% {
        transform: translateY(0) scale(1) rotate(0deg);
        opacity: 1;
    }
    100% {
        transform: translateY(var(--y)) translateX(var(--x)) scale(0) rotate(var(--rot-end, 360deg)); /* 新增：結束時旋轉 */
        opacity: 0;
    }
}

/* ====== 【修訂後】歌詞填充測驗視窗樣式 ====== */
/* ====== 【再次修訂】歌詞填充測驗視窗樣式 ====== */
.lyrics-quiz-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(25, 40, 60, 0.85); /* 使用帶有色彩的深色背景 */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2500;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
    backdrop-filter: blur(8px); /* 增強毛玻璃效果 */
}

.lyrics-quiz-modal.active {
    opacity: 1;
    pointer-events: all;
}

/* 【修訂】容器寬度已設為 90% */
.quiz-content {
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    color: #343a40;
    padding: 30px 40px;
    border-radius: 20px;
    text-align: center;
    max-width: 500px;
    width: 90%; /* <--- 這行確保容器寬度為頁面的 90% */
    position: relative;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
    box-sizing: border-box; /* 確保 padding 不會導致寬度溢出 */
}

.lyrics-quiz-modal.active .quiz-content {
    transform: scale(1);
    opacity: 1;
}

.quiz-title {
    font-size: 2.2rem;
    color: #17a2b8;
    margin-bottom: 10px;
    font-weight: 700;
}

.quiz-instructions {
    font-size: 1rem;
    color: #6c757d;
    margin-bottom: 20px;
}

.quiz-progress {
    background: #17a2b820;
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 25px;
    font-size: 1.1rem;
    font-weight: bold;
    color: #17a2b8;
    transition: all 0.3s ease;
    border: 1px solid #17a2b880;
}

.quiz-question-container {
    margin: 25px 0;
    padding: 25px;
    background: #ffffff;
    border-radius: 15px;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #dee2e6;
}

#quizQuestionText {
    font-size: 1.6rem;
    color: #212529;
    line-height: 1.6;
    letter-spacing: 1px;
    font-weight: 500;
}

/* 【修正】處理填空底線的樣式 */
.quiz-blank {
    display: inline-block;
    width: 100px; /* 您可以依據平均答案長度調整此寬度 */
    border-bottom: 2px solid #6c757d;
    margin: 0 4px;
    /* 【核心修正】將 vertical-align 改為 baseline */
    vertical-align: baseline; /* 這會將元素的基線與文字的基線對齊，使底線位於正確位置 */
    /* 【核心修正】移除不再需要的微調屬性 */
    /* position: relative; (移除) */
    /* top: -4px; (移除) */
}

/* 【修訂】確保輸入框不會超出容器 */
.quiz-answer-input {
    width: 100%;
    padding: 15px;
    font-size: 1.2rem;
    border-radius: 12px;
    border: 2px solid #ced4da;
    background: #f8f9fa;
    color: #495057;
    text-align: center;
    transition: all 0.3s ease;
    box-sizing: border-box; /* <--- 這是確保輸入框寬度計算正確的關鍵 */
}

.quiz-answer-input:focus {
    outline: none;
    border-color: #17a2b8;
    box-shadow: 0 0 0 4px rgba(23, 162, 184, 0.25);
}

.quiz-answer-input.correct {
    border-color: #28a745;
    background-color: #e9f7ec;
}

.quiz-answer-input.incorrect {
    border-color: #dc3545;
    background-color: #fbebed;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
    20%, 40%, 60%, 80% { transform: translateX(8px); }
}

.quiz-submit-btn {
    width: 100%;
    padding: 15px 20px;
    font-size: 1.2rem;
    font-weight: bold;
    color: #fff;
    background: linear-gradient(45deg, #17a2b8, #138496);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.2s ease;
}

.quiz-submit-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
}

.quiz-submit-btn:disabled {
    background: #adb5bd;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.quiz-close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    background: none;
    border: none;
    color: #adb5bd;
    font-size: 2rem;
    cursor: pointer;
    transition: color 0.3s ease, transform 0.3s ease;
}

.quiz-close-btn:hover {
    color: #495057;
    transform: rotate(90deg);
}

/* 響應式設計 */
@media (max-width: 480px) {
    .quiz-content {
        padding: 20px;
    }
    .quiz-title {
        font-size: 1.8rem;
    }
    #quizQuestionText {
        font-size: 1.3rem;
    }
    .quiz-answer-input {
        font-size: 1.1rem;
        padding: 12px;
    }
    /* 【新增】調整小螢幕下的底線寬度 */
    .quiz-blank {
        width: 70px;
    }
}

        /* ====== 【新增】排行榜相關樣式 ====== */

/* 排行榜列表項目 */
.leaderboard-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 4px solid #ffcc00;
    transition: background 0.3s ease, transform 0.2s ease;
}

.leaderboard-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(5px);
}

/* 排名 */
.leaderboard-rank {
    font-size: 1.2rem;
    font-weight: bold;
    color: #ffcc00;
    flex-basis: 15%;
}

/* 玩家名稱 */
.leaderboard-name {
    font-size: 1.1rem;
    color: #f0f0f0;
    flex-basis: 55%;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 分數 */
.leaderboard-score {
    font-size: 1.3rem;
    font-weight: bold;
    color: #00c9ff;
    flex-basis: 30%;
    text-align: right;
}

/* 列表第一名的特殊樣式 */
.leaderboard-item:first-child {
    border-left-color: #ff8a00;
    box-shadow: 0 0 15px rgba(255, 138, 0, 0.3);
}
.leaderboard-item:first-child .leaderboard-rank {
    color: #ff8a00;
    transform: scale(1.1);
}

/* 響應式設計 */
@media (max-width: 480px) {
    .leaderboard-name {
        font-size: 1rem;
    }
    .leaderboard-score {
        font-size: 1.1rem;
    }
}

        /* =================================================================== */
/* ====== 【全新設計】所有彈出視窗的統一風格 (Clean HUD Theme) ====== */
/* =================================================================== */


/* ====== 1. 通知視窗 (Notification Modal) - 用於解鎖成功/失敗等提示 ====== */
.notification-modal .notification-content {
    /* 【核心】設定寬度為 90%，並有最大寬度限制 */
    width: 90%;
    max-width: 400px; 
    box-sizing: border-box; /* 確保 padding 不會撐大寬度 */
    
    /* 【設計】改為乾淨明亮的淺灰色背景 */
    background: #f0f4f8; 
    color: #334155; /* 使用深石板灰，確保文字清晰易讀 */
    
    /* 【設計】更柔和的圓角與陰影 */
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); 
    
    padding: 25px 30px;
    border-left: 5px solid #64748b; /* 預設的側邊強調色 */

    /* 【動畫】流暢的彈出動畫 */
    transform: scale(0.8) translateY(20px);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
}

.notification-modal.active .notification-content {
    transform: scale(1) translateY(0);
    opacity: 1;
}

.notification-title {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 8px;
}

.notification-message {
    font-size: 1rem;
    color: #64748b; /* 使用較柔和的灰色 */
    line-height: 1.6;
}

.notification-message strong {
    font-weight: 700;
    color: #334155;
}

/* --- 成功樣式 (綠色) --- */
.notification-content.success {
    border-left-color: #10b981; 
}
.notification-content.success .notification-icon {
    color: #10b981;
}
.notification-content.success .notification-title {
    color: #059669;
}

/* --- 資訊/失敗樣式 (藍色) --- */
.notification-content.info {
    border-left-color: #3b82f6; 
}
.notification-content.info .notification-icon {
    color: #3b82f6;
}
.notification-content.info .notification-title {
    color: #2563eb;
}


/* ====== 2. 遊戲結束畫面 (Game Over Modal) - "榮耀殿堂" 主題 ====== */
.game-over-modal .game-over-content {
    /* 【核心】設定寬度 */
    width: 90%;
    max-width: 450px;
    box-sizing: border-box;

    /* 【設計】維持深邃、有成就感的深藍漸層，但細節更精緻 */
    background: linear-gradient(160deg, #1d2b4a, #11182c);
    border: 1px solid rgba(255, 204, 0, 0.3); /* 細緻的金色邊框 */
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5), 0 0 25px rgba(255, 204, 0, 0.2) inset; /* 外部深度陰影 + 內部光暈 */
    border-radius: 20px;
    padding: 30px 40px;

    /* 【動畫】彈出動畫 */
    transform: scale(0.8);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
}

.game-over-modal.active .game-over-content {
    transform: scale(1);
    opacity: 1;
}

.game-over-title {
    font-size: 2.8rem;
    margin-bottom: 20px;
    color: #ffcc00; /* 明亮的金色 */
    text-shadow: 0 0 15px rgba(255, 204, 0, 0.6);
}


/* ====== 3. 歌詞填充測驗視窗 (Lyrics Quiz Modal) ====== */
.lyrics-quiz-modal .quiz-content {
    /* 【核心】設定寬度 */
    width: 90%;
    max-width: 500px;
    box-sizing: border-box;

    /* 【設計】採用與通知視窗一致的明亮風格，讓使用者專注於作答 */
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    color: #343a40;
    padding: 30px 40px;
    border-radius: 20px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);

    /* 【動畫】彈出動畫 */
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
}

.lyrics-quiz-modal.active .quiz-content {
    transform: scale(1);
    opacity: 1;
}

.quiz-title {
    font-size: 2.2rem;
    color: #17a2b8; /* 使用清爽的青色作為主題色 */
    margin-bottom: 10px;
    font-weight: 700;
}

.quiz-instructions {
    font-size: 1rem;
    color: #6c757d;
    margin-bottom: 20px;
}

.quiz-answer-input {
    width: 100%; /* 輸入框填滿容器 */
    box-sizing: border-box; /* 確保 padding 不會使其溢出 */
}

.quiz-submit-btn {
    width: 100%;
    box-sizing: border-box;
}

/* 修正小螢幕下的 quiz-blank 底線位置 */
#quizQuestionText {
    font-size: 1.6rem;
    line-height: 1.6;
}
.quiz-blank {
    display: inline-block;
    width: 100px; 
    border-bottom: 2px solid #6c757d;
    margin: 0 4px;
    /* 關鍵修正：讓底線與文字基線對齊 */
    vertical-align: baseline; 
}


/* ====== 4. 通用設定類型視窗 (Settings, Leaderboard, etc.) ====== */
/* 讓所有設定相關的視窗都採用新的深色主題 */
.settings-modal .settings-content,
.personal-high-score-modal .personal-high-score-content {
    /* 【核心】設定寬度 */
    width: 90%;
    max-width: 500px;
    box-sizing: border-box;

    /* 【設計】使用精緻的深藍色主題，並帶有光暈效果 */
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 0 40px rgba(0, 190, 255, 0.3); /* 改為科技感的藍色光暈 */
    border: 1px solid rgba(0, 190, 255, 0.2);

    /* 【動畫】彈出動畫 */
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.4s ease, opacity 0.3s ease;
}

.settings-modal.active .settings-content,
.personal-high-score-modal.active .personal-high-score-content {
    transform: scale(1);
    opacity: 1;
}

.settings-title, .personal-high-score-title {
    color: #00c9ff; /* 標題顏色改為亮藍色 */
}

/* 讓按鈕樣式更統一 */
.setting-group .restart-btn {
    background: linear-gradient(45deg, #00c9ff, #92fe9d);
}

/* ====== 5. 解鎖提示視窗 (Unlock Modal) ====== */
.unlock-modal .unlock-content {
    /* 【核心】設定寬度 */
    width: 90%;
    max-width: 400px;
    box-sizing: border-box;

    /* 【設計】與設定視窗共享深色主題 */
    background: linear-gradient(135deg, #2c1a2e, #161e3e);
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 0 40px rgba(255, 204, 0, 0.5);
    border: 1px solid rgba(255, 204, 0, 0.3);

    /* 【動畫】彈出動畫 */
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.4s ease, opacity 0.3s ease;
}

.unlock-modal.active .unlock-content {
    transform: scale(1);
    opacity: 1;
}

        /* =================================================================== */
/* ====== 【新增】彈出視窗響應式設計 (Mobile-First Adaptation) ====== */
/* =================================================================== */

/* 當螢幕寬度小於等於 480px 時 (適用於大多數手機直立模式)，套用以下樣式 */
@media (max-width: 480px) {

    /* --- 統一調整所有視窗的內邊距，減少留白，爭取更多內容空間 --- */
    .notification-content,
    .game-over-content,
    .quiz-content,
    .settings-content,
    .personal-high-score-content,
    .unlock-content {
        padding: 20px 15px; /* 上下 20px, 左右 15px */
    }

    /* --- 統一縮小所有視窗的標題字體大小 --- */
    .notification-title,
    .game-over-title,
    .quiz-title,
    .settings-title,
    .personal-high-score-title,
    .unlock-message { /* .unlock-message 在這裡是作為標題使用 */
        font-size: 1.8rem; /* 從 2.2rem 或 2.8rem 縮小 */
    }
    
    .game-over-title {
        font-size: 2.2rem; /* 遊戲結束標題可以稍微大一點，以示強調 */
    }

    /* --- 統一縮小內文/訊息的字體大小 --- */
    .notification-message,
    .quiz-instructions,
    .stat-label {
        font-size: 0.95rem;
    }

    /* ====== 針對「遊戲結束」畫面的特別調整 ====== */
    .game-over-stats {
        flex-direction: column; /* 將並排的「最終分數」和「最高連擊」改為垂直堆疊 */
        gap: 10px; /* 減少堆疊後的間距 */
    }
    .stat-number {
        font-size: 2rem; /* 縮小數字大小 */
    }
    .restart-btn {
        padding: 12px 30px;
        font-size: 1.1rem;
    }

    /* ====== 針對「歌詞測驗」畫面的特別調整 ====== */
    #quizQuestionText {
        font-size: 1.3rem; /* 縮小題目文字 */
        line-height: 1.5;
    }
    .quiz-answer-input, .quiz-submit-btn {
        font-size: 1.1rem;
        padding: 12px;
    }
    /* 縮小題目中的填空底線，避免因寬度不足而換行 */
    .quiz-blank {
        width: 70px;
    }
}

        /* ======================================================================== */
/* ====== 【全新獨立設計】"星光殿堂" 主題視窗 (Starlight Hall Theme) ====== */
/* ======================================================================== */

/* --- 1. 為主題定義一組顏色變數，方便未來統一修改 --- */
:root {
    --starlight-bg: linear-gradient(145deg, #fdfbfb 0%, #ebedee 100%); /* 溫暖的象牙白漸層背景 */
    --starlight-accent: #b48f5a;         /* 精緻、不刺眼的啞光金色，用於標題和重點 */
    --starlight-accent-glow: rgba(180, 143, 90, 0.35); /* 金色的柔和光暈效果 */
    --starlight-text-primary: #3a332a;   /* 溫暖的深棕黑色，比純黑更柔和且易讀 */
    --starlight-text-secondary: #8c7d6b; /* 用於次要說明的淺棕灰色 */
    --starlight-border: rgba(180, 143, 90, 0.4); /* 半透明的金色邊框 */
    --starlight-item-bg: rgba(255, 255, 255, 0.6); /* 列表項目的半透明背景 */
    --starlight-item-hover-bg: #ffffff;  /* 滑鼠懸停時變為不透明白色 */
}

/* --- 2. 應用新樣式到所有目標視窗的容器上 --- */
.settings-modal .settings-content,
.personal-high-score-modal .personal-high-score-content,
.unlock-modal .unlock-content {
    /* 【核心】寬度設定 */
    width: 90%;
    max-width: 500px;
    box-sizing: border-box;

    /* 【設計】套用全新的顏色和背景 */
    background: var(--starlight-bg);
    color: var(--starlight-text-primary);
    
    border-radius: 16px; /* 更大的圓角，顯得更現代 */
    border: 1px solid var(--starlight-border);
    /* 精緻的陰影：外部柔和陰影 + 內部金色光暈，營造高級感 */
    box-shadow: 0 10px 35px rgba(0, 0, 0, 0.08), 0 0 20px var(--starlight-accent-glow) inset;
    
    padding: 30px;
    
    /* 【動畫】保留流暢的彈出效果 */
    transform: scale(0.9);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
}

/* 視窗啟動時的動畫 */
.settings-modal.active .settings-content,
.personal-high-score-modal.active .personal-high-score-content,
.unlock-modal.active .unlock-content {
    transform: scale(1);
    opacity: 1;
}

/* --- 3. 美化視窗內部的元素 --- */

/* 標題樣式 */
.settings-title,
.personal-high-score-title,
.unlock-message { /* unlock-message 在此作為標題 */
    font-size: 2rem;
    color: var(--starlight-accent);
    font-weight: 700;
    /* 為標題文字添加細微的亮色陰影，使其更具立體感 */
    text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
    margin-bottom: 25px;
}

/* 解鎖視窗的圖示也套用主題色 */
.unlock-icon {
    color: var(--starlight-accent);
}

/* 表單元素 (設定頁) */
.setting-label {
    color: var(--starlight-text-secondary);
    font-weight: bold;
    font-size: 1.1rem;
}
.setting-control {
    background: #f0f2f5; /* 淺灰色背景，與主背景區分 */
    border: 1px solid #dde0e4;
    color: var(--starlight-text-primary);
    border-radius: 8px;
}
.setting-control::placeholder {
    color: #a0a8b1;
}

/* 列表樣式 (排行榜、個人分數) */
.personal-high-score-item, .leaderboard-item {
    background: var(--starlight-item-bg);
    border-left: 4px solid var(--starlight-accent);
    margin-bottom: 10px;
    border-radius: 8px;
    transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
}
.personal-high-score-item:hover, .leaderboard-item:hover {
    background: var(--starlight-item-hover-bg);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

/* 列表內的文字顏色 */
.personal-high-score-label, .leaderboard-rank, .leaderboard-name {
    color: var(--starlight-text-primary);
    font-weight: 500;
}
.personal-high-score-value, .leaderboard-score {
    color: var(--starlight-accent);
    font-weight: bold;
}
.leaderboard-rank {
    color: var(--starlight-text-secondary);
}

/* 按鈕樣式 (儲存名稱、關閉解鎖提示等) */
.setting-group .restart-btn, .close-unlock {
    background: var(--starlight-accent);
    color: white;
    border-radius: 50px; /* 圓潤的藥丸形狀 */
    border: none;
    text-shadow: none;
    box-shadow: 0 4px 15px var(--starlight-accent-glow);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.setting-group .restart-btn:hover, .close-unlock:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px var(--starlight-accent-glow);
}

/* --- 4. 響應式設計：確保在小螢幕上同樣出色 --- */
@media (max-width: 480px) {
    .settings-modal .settings-content,
    .personal-high-score-modal .personal-high-score-content,
    .unlock-modal .unlock-content {
        padding: 25px 15px; /* 在手機上使用更緊湊的邊距 */
    }
    
    .settings-title,
    .personal-high-score-title,
    .unlock-message {
        font-size: 1.8rem; /* 縮小標題以適應螢幕寬度 */
    }

    .leaderboard-name, .personal-high-score-label {
        font-size: 0.9rem; /* 縮小列表文字 */
    }
}

        /* =================================================================== */
/* ====== 【新增修訂】修正所有彈出視窗的關閉按鈕樣式 ====== */
/* =================================================================== */

/* --- 1. 為所有使用 '×' 的關閉按鈕，設定統一、清晰的基礎樣式 --- */
.close-settings,
.close-personal-high-score,
.close-disclaimer,
.close-notification,
.quiz-close-btn {
    position: absolute;
    top: 15px; /* 統一與頂部的距離 */
    right: 20px; /* 統一與右側的距離 */

    /* 移除不必要的背景和邊框 */
    background: transparent;
    border: none;
    
    /* 調整字體和大小，使其更清晰、更像一個圖標 */
    font-size: 2.2rem; 
    font-weight: 400; /* 使用適中的字重，避免 '×' 看起來太粗 */
    line-height: 1; /* 確保 '×' 垂直居中 */

    /* 【核心修正】設定一個在淺色背景下清晰可見的預設顏色 */
    /* 我們直接使用 "星光殿堂" 主題的次要文字顏色，這是一個溫和的棕灰色 */
    color: var(--starlight-text-secondary, #8c7d6b); 
    
    cursor: pointer;
    
    /* 【互動效果】為顏色和變換效果添加流暢的過渡動畫 */
    transition: color 0.3s ease, transform 0.3s ease;
}

/* --- 2. 設定統一的滑鼠懸停 (hover) 效果 --- */
.close-settings:hover,
.close-personal-high-score:hover,
.close-disclaimer:hover,
.close-notification:hover,
.quiz-close-btn:hover {
    /* 【核心修正】懸停時變為更深的主題文字顏色，提供明確反饋 */
    color: var(--starlight-text-primary, #3a332a);

    /* 【互動效果】添加一個優雅的90度旋轉動畫 */
    transform: rotate(90deg);
}

        /* ======================================================================== */
/* ====== 【全新獨立設計】"星塵榮耀" 排行榜主題 ========================== */
/* ======================================================================== */

/* --- 1. 定義排行榜專屬的顏色變數，方便未來統一修改 --- */
:root {
    --rank-gold: #D4AF37;   /* 榮耀金 (第一名) */
    --rank-silver: #C0C0C0; /* 典雅銀 (第二名) */
    --rank-bronze: #CD7F32; /* 沉穩銅 (第三名) */
    --rank-item-bg: rgba(235, 237, 238, 0.5); /* 列表項目背景，帶有輕微透明感 */
    --rank-item-hover-bg: rgba(255, 255, 255, 0.9); /* 懸停時的背景 */
    --rank-icon-shadow: 0 2px 4px rgba(0, 0, 0, 0.15); /* 圖示陰影 */
}

/* --- 2. 玩家名稱設定區域的宏觀佈局 --- */
#playerNameGroup {
    display: flex; /* 使用 Flexbox 佈局 */
    align-items: center; /* 垂直居中對齊 */
    gap: 12px; /* 元素之間的間距 */
    border: 1px solid var(--starlight-border); /* 沿用星光殿堂主題邊框 */
    padding: 10px;
    border-radius: 50px; /* 圓潤的膠囊形狀 */
    background: rgba(255, 255, 255, 0.5);
    margin-bottom: 25px; /* 與下方列表的間距 */
}

#playerNameGroup .setting-label {
    display: none; /* 隱藏文字標籤 "你的顯示名稱:"，讓版面更簡潔 */
}

#playerNameGroup .setting-control {
    flex-grow: 1; /* 讓輸入框佔據所有可用空間 */
    border: none; /* 移除內部輸入框的邊框 */
    background: transparent; /* 背景透明 */
    padding: 8px 15px; /* 調整內邊距 */
    font-size: 1.1rem;
    color: var(--starlight-text-primary);
}
#playerNameGroup .setting-control:focus {
    outline: none; /* 移除獲取焦點時的輪廓 */
}

/* --- 3. 【核心改造】圖示化的「儲存名稱」按鈕 --- */
#savePlayerNameBtn {
    /* 尺寸與形狀 */
    width: 48px;
    height: 48px;
    padding: 0;
    flex-shrink: 0; /* 防止按鈕被壓縮 */
    border-radius: 50%; /* 正圓形 */

    /* 顏色與外觀 */
    background: var(--starlight-accent); /* 沿用主題金色 */
    color: white;
    font-size: 1.5rem; /* 控制圖示大小 */
    border: none;
    box-shadow: 0 4px 12px var(--starlight-accent-glow);
    
    /* 佈局與過渡 */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
}

/* 使用 ::before 偽元素來創建圖示，完全取代文字 */
#savePlayerNameBtn::before {
    content: '✔'; /* 使用一個簡單的勾號作為圖示 */
    font-weight: bold;
}

#savePlayerNameBtn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 18px var(--starlight-accent-glow);
}

#savePlayerNameBtn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}
/* 當按鈕處於讀取狀態時，顯示載入動畫 */
#savePlayerNameBtn.loading::before {
    content: '';
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}


/* --- 4. 排行榜列表的整體美化 --- */
.leaderboard-display {
    margin-top: 20px;
}

.personal-high-score-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

/* --- 5. 【核心改造】列表項目設計 (分層次感) --- */
.leaderboard-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    margin-bottom: 12px;
    border-radius: 12px;
    background: var(--rank-item-bg);
    border: 1px solid transparent;
    border-left-width: 5px; /* 左側邊框加粗 */
    transition: all 0.3s ease;
    gap: 15px; /* 內部元素間距 */
}

.leaderboard-item:hover {
    background: var(--rank-item-hover-bg);
    transform: scale(1.03);
    border-color: var(--starlight-border);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
}

/* --- 6. 【核心改造】排名顯示優化 --- */
.leaderboard-rank {
    flex-basis: 50px; /* 固定寬度 */
    flex-shrink: 0;
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    color: var(--starlight-text-secondary);
}

/* 玩家名稱 */
.leaderboard-name {
    flex-grow: 1; /* 佔據剩餘空間 */
    font-size: 1.1rem;
    color: var(--starlight-text-primary);
    font-weight: 500;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 分數 */
.leaderboard-score {
    flex-basis: 100px; /* 固定寬度 */
    flex-shrink: 0;
    font-size: 1.4rem;
    font-weight: bold;
    color: var(--starlight-accent);
    text-align: right;
}

/* --- 7. 前三名特殊樣式，增加變化與榮譽感 --- */

/* 第一名：榮耀金 */
.leaderboard-item:nth-child(1) {
    background: linear-gradient(100deg, rgba(212, 175, 55, 0.15), transparent 70%);
    border-color: var(--rank-gold);
    box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
}
.leaderboard-item:nth-child(1) .leaderboard-rank {
    color: var(--rank-gold);
    text-shadow: 0 0 8px rgba(212, 175, 55, 0.7);
}
/* 使用偽元素添加皇冠圖示 */
.leaderboard-item:nth-child(1) .leaderboard-rank::before {
    content: '👑'; /* 皇冠 Emoji */
    position: absolute;
    font-size: 1.8rem;
    opacity: 0.9;
    filter: drop-shadow(var(--rank-icon-shadow));
}
.leaderboard-item:nth-child(1) .leaderboard-rank {
    font-size: 0; /* 隱藏原本的數字 #1 */
}


/* 第二名：典雅銀 */
.leaderboard-item:nth-child(2) {
    background: linear-gradient(100deg, rgba(192, 192, 192, 0.15), transparent 70%);
    border-color: var(--rank-silver);
}
.leaderboard-item:nth-child(2) .leaderboard-rank {
    color: var(--rank-silver);
    text-shadow: 0 0 6px rgba(192, 192, 192, 0.7);
}
/* 使用偽元素添加銀牌圖示 */
.leaderboard-item:nth-child(2) .leaderboard-rank::before {
    content: '🥈'; /* 銀牌 Emoji */
    position: absolute;
    font-size: 1.6rem;
    filter: drop-shadow(var(--rank-icon-shadow));
}
.leaderboard-item:nth-child(2) .leaderboard-rank {
    font-size: 0; /* 隱藏原本的數字 #2 */
}


/* 第三名：沉穩銅 */
.leaderboard-item:nth-child(3) {
    background: linear-gradient(100deg, rgba(205, 127, 50, 0.15), transparent 70%);
    border-color: var(--rank-bronze);
}
.leaderboard-item:nth-child(3) .leaderboard-rank {
    color: var(--rank-bronze);
    text-shadow: 0 0 5px rgba(205, 127, 50, 0.7);
}
/* 使用偽元素添加銅牌圖示 */
.leaderboard-item:nth-child(3) .leaderboard-rank::before {
    content: '🥉'; /* 銅牌 Emoji */
    position: absolute;
    font-size: 1.6rem;
    filter: drop-shadow(var(--rank-icon-shadow));
}
.leaderboard-item:nth-child(3) .leaderboard-rank {
    font-size: 0; /* 隱藏原本的數字 #3 */
}


/* --- 8. 響應式設計，確保小螢幕上同樣美觀 --- */
@media (max-width: 480px) {
    .leaderboard-item {
        padding: 10px;
        gap: 10px;
    }
    .leaderboard-rank {
        flex-basis: 40px;
        font-size: 1.2rem;
    }
    .leaderboard-name {
        font-size: 1rem;
    }
    .leaderboard-score {
        flex-basis: 80px;
        font-size: 1.2rem;
    }
    #playerNameGroup {
        flex-direction: column; /* 垂直堆疊 */
        border-radius: 20px;
        padding: 15px;
    }
    #playerNameInput {
        width: 100%;
        text-align: center;
    }
    #savePlayerNameBtn {
        width: 100%;
        border-radius: 25px; /* 膠囊形狀 */
    }
    #savePlayerNameBtn::before {
        content: '儲存'; /* 在小螢幕上恢復文字，因為按鈕變大了 */
    }
}

        /* ======================================================= */
/* ====== 【新增修訂】排行榜按鈕與標題顏色變更 ====== */
/* ======================================================= */

/* --- 1. 更改「儲存名稱」按鈕的顏色 --- */
#savePlayerNameBtn {
    background: #8db592; /* 新的顏色：淡雅的鼠尾草綠 */
    /* 同步更新按鈕光暈效果的顏色 */
    box-shadow: 0 4px 12px rgba(141, 181, 146, 0.4); 
}

#savePlayerNameBtn:hover {
    /* 同步更新滑鼠懸停時的光暈效果 */
    box-shadow: 0 8px 18px rgba(141, 181, 146, 0.4);
}

#savePlayerNameBtn:hover {
    /* 同步更新滑鼠懸停時的光暈效果 */
    box-shadow: 0 8px 18px rgba(106, 142, 174, 0.4);
}

/* --- 2. 更改排行榜標題 (歌曲名稱) 的顏色 --- */
#leaderboardTitle {
    color: #6a8eae; /* 與按鈕使用相同的新顏色，保持視覺統一 */
}
        
    </style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
</head>
<body>

    <!-- Background Image -->
    <div class="background-image"></div>
    <div class="container">
        <div class="main-game-container" id="mainGameContainer">
            <div class="game-container">
                <div class="game-ui">
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value" id="score">0</div>
                            <div class="stat-label">分數</div>
                        </div>


<!-- ▼▼▼ 【修訂】將原有的單一標記線改為兩個獨立的標記線 ▼▼▼ -->
<div id="unlockProgressContainer" class="unlock-progress-container">
    <!-- 歌曲解鎖線 (黃色) -->
    <div id="songUnlockMarker" class="unlock-progress-marker song-marker"></div>
    <!-- 難度解鎖線 (紅色) -->
    <div id="difficultyUnlockMarker" class="unlock-progress-marker difficulty-marker"></div>
    
    <div id="unlockProgressBar" class="unlock-progress-bar"></div>

</div>
<!-- ▲▲▲ 修訂結束 ▲▲▲ -->


                    </div>




                    <div class="controls">
                        <button class="svg-button" id="startBtn" title="開始遊戲">
                            <svg class="start-button-svg" viewBox="0 0 80 40">
                                <defs>
                                    <linearGradient id="startButtonGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#ff8a00;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#e52e71;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect x="0" y="0" width="80" height="40" rx="20" ry="20" fill="url(#startButtonGradient)" />
                                <path d="M30 12 L30 28 L50 20 Z" fill="white"/>
                            </svg>
                        </button>
                        <button class="settings-btn" id="settingsBtn" title="設定">
                            <svg class="settings-icon" viewBox="0 0 24 24">
                                <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                            </svg>
                        </button>


                        
                        <button class="music-player-btn" id="musicPlayerBtn" title="音樂播放器">
                             <svg class="music-player-icon" viewBox="0 0 24 24">
                                <path d="M12,3V13.55C11.41,13.21 10.73,13 10,13C7.79,13 6,14.79 6,17C6,19.21 7.79,21 10,21C12.21,21 14,19.21 14,17V7H18V3H12Z" />
                            </svg>
                        </button>
                    </div>
                    <div class="music-selector">
                        <div class="music-select-wrapper">
                            <select id="musicSelect">
                                <option value="白影.mp3">白影</option>
                                <option value="等待.mp3">等待</option>
                                <option value="下一枝的惆悵.mp3">下一枝的惆悵</option>
                                <option value="餘燼落入虛無.mp3">餘燼落入虛無</option>
                                <option value="老屋回憶.mp3">老屋回憶</option>
                                <option value="battle-abysswalker.mp3">The Abysswalker</option>
                                <option value="Battle-Rosemoon.mp3">都戰乙女</option>
                                <option value="Battle-deadly.mp3">五大罪</option>
                                <option value="Battle-rapier.mp3">繼承劍的少女</option>
                                <option value="Ariadne-Battle.mp3">不屈意志之刃</option>
                                <option value="battle-arms.mp3">西部戰鬥</option>
                                <option value="Battle.mp3">Battle Theme</option>
                                <option value="Wanderers-City.mp3">流浪城鎮</option>
                                <option value="Remotest-Liblary.mp3">沉睡的記憶</option>
                                <option value="Nostalgia.mp3">麥田懷舊</option>
                                <option value="sunbeams.mp3">放學後</option>
                                <option value="village.mp3">鄉村生活</option>
                                <option value="Take-a-Rest.mp3">休息一下</option>
                                <option value="winter-snow.mp3">雪鄉</option>
                                <option value="Forgotten-Place.mp3">被遺忘的地方</option>
                                <option value="Rest-in-Peace.mp3">安息</option>
                                <option value="Farewell.mp3">告別</option>
                                <option value="reminiscence.mp3">回憶</option>
                                <option value="starry-night.mp3">星夜</option>
                                <option value="last-wish.mp3">當思念傳到某人耳畔</option>
                                <option value="sorrow.mp3">超越悲傷</option>
                                <option value="hotarumichi.mp3">螢火蟲之路</option>
                                <option value="Sky-Airship.mp3">飛艇</option>
                                <option value="Voyage_SE.mp3">跨越神秘之海</option>
                                <option value="main-theme01.mp3">盼望</option>
                                <option value="saikai637.mp3">約定之地</option>
                            </select>
                            <svg class="music-icon" viewBox="0 0 24 24">
                                <path d="M12,3V13.55C11.41,13.21 10.73,13 10,13C7.79,13 6,14.79 6,17C6,19.21 7.79,21 10,21C12.21,21 14,19.21 14,17V7H18V3H12Z" />
                            </svg>
                        </div>
                        <button class="personal-high-score-btn" id="personalHighScoreBtn" title="查看個人最高分數">
                            <svg class="personal-high-score-icon" viewBox="0 0 24 24">
                                <path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" />
                            </svg>
                        </button>

<!-- 在 id="settingsBtn" 的按鈕後面加入這段 -->
<button class="personal-high-score-btn" id="leaderboardBtn" title="歌曲排行榜">
    <svg class="personal-high-score-icon" viewBox="0 0 24 24">
        <path d="M16 11V3H8V11H2V21H22V11H16M14 5H10V9H14V5M20 13H18V15H20V13M20 17H18V19H20V17M12 13H4V19H12V13Z" />
    </svg>
</button>



                        
                    </div>
                    <div class="difficulty-selector">
                        
                        <select id="difficultySelect">
                            <option value="easy">簡單</option>
                            <option value="normal" selected>普通</option>
                            <option value="hard">困難</option>
                            <option value="hell">地獄</option>
                        </select>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
               <div class="game-area">
    <div class="tracks" id="tracksContainer"></div>

                    <!-- ▼▼▼ 【新增】遊戲中歌詞顯示容器 ▼▼▼ -->
        <div class="game-lyrics-container" id="gameLyricsContainer">
            <!-- 歌詞將由 JavaScript 動態填入此處 -->
            <p class="game-lyric-line" id="currentGameLyricLine"></p>
        </div>
        <!-- ▲▲▲ 新增結束 ▲▲▲ -->
   
    
    <!-- 觸控按鍵 (僅在觸控裝置上顯示) -->
    <div class="touch-controls" id="touchControls">
        <div class="touch-key" data-key="65">A</div>
        <div class="touch-key" data-key="83">S</div>
        <div class="touch-key" data-key="68">D</div>
        <div class="touch-key" data-key="70">F</div>
    </div>
</div>
            </div>
        </div>
    </div>

<!-- Notification Modal -->
    <div class="notification-modal" id="notificationModal">
        <div class="notification-content">
            <button class="close-notification" id="closeNotification">&times;</button>
            <div class="notification-icon" id="notificationIcon"></div>
            <h2 class="notification-title" id="notificationTitle"></h2>
            <p class="notification-message" id="notificationMessage"></p>
        </div>
    </div>


    
    <div class="game-over-modal" id="gameOverModal">
        <div class="game-over-content">
            <h2 class="game-over-title">遊戲結束</h2>
            <div class="game-over-stats">
                <div class="game-over-stat">
                    <div class="stat-label">最終分數</div>
                    <div class="stat-number" id="finalScore">0</div>
                </div>
                <div class="game-over-stat">
                    <div class="stat-label">最高連擊</div>
                    <div class="stat-number" id="finalCombo">0</div>
                </div>
            </div>
            <button class="restart-btn" id="restartBtn">再玩一次</button>
        </div>
    </div>
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <button class="close-settings" id="closeSettings">&times;</button>
            <h2 class="settings-title">遊戲設定</h2>
           
            <div class="setting-group">
                <label class="setting-label" for="volumeControlModal">音樂音量:</label>
                <input type="range" class="setting-control setting-slider" id="volumeControlModal" min="0" max="1" step="0.01" value="0.7">
            </div>
            <div class="setting-group">
                <label class="setting-label" for="sfxVolumeControl">音效音量:</label>
                <input type="range" class="setting-control setting-slider" id="sfxVolumeControl" min="0" max="1" step="0.01" value="0.5">
            </div>

<div class="setting-group">
    <button class="setting-control" id="showDisclaimerBtn">查看音樂版權聲明</button>
</div>




        </div>
    </div>

    <!-- Personal High Score Modal -->
    <div class="personal-high-score-modal" id="personalHighScoreModal">
        <div class="personal-high-score-content">
            <button class="close-personal-high-score" id="closePersonalHighScore">&times;</button>
            <h2 class="personal-high-score-title">個人最高分數</h2>
            <ul class="personal-high-score-list" id="personalHighScoreList">
                <!-- Scores will be populated here -->
            </ul>
        </div>
    </div>

    <!-- Music Player Modal -->
    <div class="music-player-modal" id="musicPlayerModal">
        <div class="music-player-content">
            <div class="music-player-header">
                <!-- Removed <h1 class="music-player-title">音樂播放器</h1> -->
                <button class="close-music-player" id="closeMusicPlayer" title="返回">
                    <svg class="close-music-player-icon" viewBox="0 0 24 24">
                        <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
                    </svg>
                </button>
            </div>


<!-- CD Cover Container -->
<div class="cd-cover-container">
    <div class="cd-cover-wrapper">
        <img id="cdCoverImage" src="https://i.ibb.co/G4Rmgzjt/image.png" alt="CD Cover" class="cd-cover-img">
        <div class="cd-cover-overlay"></div>
    </div>
</div>


            <div class="now-playing" id="nowPlaying">正在播放: 無</div>
            <div class="lyrics-container" id="lyricsContainer">
                <div class="no-lyrics">無歌詞</div>
            </div>
            <div class="player-controls">
                <button class="player-btn" id="prevBtn" title="上一首" disabled>&#9664;&#9664;</button>
                <button class="player-btn play-pause-btn" id="playPauseBtn" title="播放/暫停">&#9658;</button>
                <button class="player-btn" id="nextBtn" title="下一首" disabled>&#9654;&#9654;</button>
            </div>
            <div class="progress-slider-container">
                <input type="range" class="progress-slider" id="progressSlider" min="0" max="100" value="0">
            </div>
            <div class="time-display">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
            </div>
            <div class="volume-control-player">
                <label for="volumeSliderPlayer">音量:</label>
                <input type="range" class="setting-slider" id="volumeSliderPlayer" min="0" max="1" step="0.01" value="0.7">
            </div>
            <ul class="playlist" id="playlist">
                <!-- Playlist items will be populated here -->
            </ul>
        </div>
    </div>

    <!-- Unlock Modal -->
    <div class="unlock-modal" id="unlockModal">
        <div class="unlock-content">
            <div class="unlock-icon">&#128274;</div> <!-- Lock Emoji -->
            <h2 class="unlock-message">此項目尚未解鎖</h2>
            <p class="unlock-requirement" id="unlockRequirement">在普通模式下達到 40000 分以解鎖。</p>
            <button class="close-unlock" id="closeUnlock">我知道了</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

// ==========================================================
// ====== 【新增】Firebase 初始化與排行榜相關設定 ======
// ==========================================================

// 你的 Firebase 設定物件
const firebaseConfig = {
  apiKey: "AIzaSyD0J56yq_QjjzAZuhAEqE3SVU0GePS2l-0",
  authDomain: "musicgame-7dad1.firebaseapp.com",
  projectId: "musicgame-7dad1",
  storageBucket: "musicgame-7dad1.firebasestorage.app",
  messagingSenderId: "720961310659",
  appId: "1:720961310659:web:4959c7269b0adbed5ab776"
};

// 初始化 Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// 髒話過濾列表 (可持續擴充)
const profanityList = [
    // 粵語
    "屌", "屌你", "仆街", "冚家剷", "on9", "撚", "鳩", "柒", "onL9",
    // 普通話
    "操", "草泥马", "傻逼", "肏", "媽的", "他媽的", "我靠", "尼玛"
];

// 玩家狀態變數
let playerName = localStorage.getItem('musicGamePlayerName') || '';

// ==========================================================
// ====== 【新增結束】 ========================================
// ==========================================================

            
           // --- Constants and Configuration ---
// [修訂] 歌曲解鎖條件：需要達到普通難度最高分的 80%
const SONG_UNLOCK_PERCENTAGE = 0.75; 
// [修訂] 難度解鎖條件：需要達到當前難度最高分的 100%
const DIFFICULTY_UNLOCK_PERCENTAGE = 0.85;

const difficultySettings = {
    // Easy 難度：長音符較長，音符間距大，遊玩體驗輕鬆
    easy: { 
        speedMultiplier: 0.9, longNoteChance: 0.2, noteDensity: 2.0, maxSimultaneous: 3, cooldown: 400,
        longNoteMinMultiplier: 2.5, // 長音符最短是 2.5 倍基礎間隔
        longNoteMaxMultiplier: 8,   // 長音符最長是 8 倍基礎間隔
        visualGap: 70               // 物理間隙 70 像素
    },
    // Normal 難度：標準設定
    normal: { 
        speedMultiplier: 1.1, longNoteChance: 0.25, noteDensity: 3.5, maxSimultaneous: 8, cooldown: 150,
        longNoteMinMultiplier: 2,
        longNoteMaxMultiplier: 6,
        visualGap: 50
    },
    // 【修訂】Hard 難度：進一步縮短長音符最大長度
    hard: { 
        speedMultiplier: 1.6, longNoteChance: 0.30, noteDensity: 4.5, maxSimultaneous: 4, cooldown: 100,
        longNoteMinMultiplier: 2,
        longNoteMaxMultiplier: 3.5,   // 從 4 縮短至 3.5
        visualGap: 25               
    },
    // 【修訂】Hell 難度：大幅縮短長音符最大長度，使其更像一個「稍長的短音符」
    hell: { 
        speedMultiplier: 2.2, longNoteChance: 0.35, noteDensity: 5.0, maxSimultaneous: 4, cooldown: 50,
        longNoteMinMultiplier: 1.5, 
        longNoteMaxMultiplier: 2.5,   // 從 3 大幅縮短至 2.5，接近您提到的 baseInterval * 2
        visualGap: 10               
    }
};
            // Max possible scores for each song and difficulty (for display purposes)
            const maxPossibleScores = {
                "Battle-Abysswalker.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle-Rosemoon.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle-deadly.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle-rapier.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Ariadne-Battle.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "battle-arms.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Battle.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Wanderers-City.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Remotest-Liblary.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Nostalgia.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "sunbeams.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "village.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Take-a-Rest.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "winter-snow.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Forgotten-Place.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Rest-in-Peace.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Farewell.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "reminiscence.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "starry-night.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "last-wish.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "sorrow.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "hotarumichi.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Sky-Airship.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "Voyage_SE.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "main-theme01.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                },
                "saikai637.mp3": {
                    easy: 150000, normal: 300000, hard: 450000, hell: 600000
                }
            };

           // 請用這段程式碼完整替換舊的 songLyrics 物件
// 請用下面這段擴充後的 songData 物件，完整替換掉您原本的 songData 物件
const songData = {
    "等待.mp3": {
        lyrics: [
            { "time": 9, "text": "月亮高掛在夜空之上" },
            { "time": 13, "text": "宛如不眠的眼睛一樣" },
            { "time": 17, "text": "靜靜注視著喧囂的人間" },
            { "time": 21, "text": "有多少悲歡離合在上演" },
            { "time": 27, "text": "它守望著夜的蒼茫" },
            { "time": 29, "text": "也守望著黎明的曙光" },
            { "time": 33, "text": "在漫長歲月裡等待著" },
            { "time": 36, "text": "等待著某個人的出現" },
            { "time": 49, "text": "她已經記不清你的模樣" },
            { "time": 54, "text": "卻依然在原地默默守望" },
            { "time": 58, "text": "那是一種怎樣的深情" },
            { "time": 61, "text": "才能如此執著又漫長" },
            { "time": 67, "text": "也許你早已把它遺忘" },
            { "time": 72, "text": "而她卻還在為你照亮" },
            { "time": 76, "text": "在這城市的喧囂之中" },
            { "time": 80, "text": "還有多少人在等待著" }
        ],
        quiz: [
            { "line": "月亮高掛在__之上", "answer": "夜空" },
            { "line": "宛如不眠的__一樣", "answer": "眼睛" },
            { "line": "靜靜注視著喧囂的__", "answer": "人間" },
            { "line": "有多少__在上演", "answer": "悲歡離合" },
            { "line": "也守望著黎明的__", "answer": "曙光" },
            { "line": "在漫長__裡等待著", "answer": "歲月" },
            { "line": "她已經記不清你的__", "answer": "模樣" },
            { "line": "卻依然在原地默默__", "answer": "守望" },
            { "line": "才能如此執著又__", "answer": "漫長" },
            { "line": "也許你早已把它__", "answer": "遺忘" },
            { "line": "在這城市的__之中", "answer": "喧囂" }
        ]
    },
    "白影.mp3": {
        lyrics: [
            { "time": 12, "text": "他走進了一個荒誕的夢境" },
            { "time": 18, "text": "夢裡有個重複出現的白影" },
            { "time": 24, "text": "白影微笑著準備登上" },
            { "time": 30, "text": "有獠牙的火車廂頂" },
            { "time": 35, "text": "黃昏一次次的把白影擄走" },
            { "time": 41, "text": "他一次次的站在原地目送" },
            { "time": 47, "text": "他沒有辦法挽留" },
            { "time": 51, "text": "他沒有辦法伸出手" },
            { "time": 71, "text": "多年後他還是會常常驚醒" },
            { "time": 77, "text": "枕邊總是濕潤的一片狼藉" },
            { "time": 83, "text": "白影像餃子皮一樣包裹著他" },
            { "time": 90, "text": "越掙扎越陷進去" },
            { "time": 95, "text": "黃昏一次次的把白影擄走" },
            { "time": 101, "text": "他一次次的站在原地目送" },
            { "time": 107, "text": "他只能默默地看" },
            { "time": 112, "text": "他只能默默地吐" }
        ],
        quiz: [
            { "line": "他走進了一個荒誕的__", "answer": "夢境" },
            { "line": "夢裡有個重複出現的__", "answer": "白影" },
            { "line": "有__的火車廂頂", "answer": "獠牙" },
            { "line": "__一次次的把白影擄走", "answer": "黃昏" },
            { "line": "他一次次的站在原地__", "answer": "目送" },
            { "line": "他沒有辦法__", "answer": "挽留" },
            { "line": "多年後他還是會常常__", "answer": "驚醒" },
            { "line": "枕邊總是濕潤的一片__", "answer": "狼藉" },
            { "line": "__像餃子皮一樣包裹著他", "answer": "白影" },
            { "line": "越__越陷進去", "answer": "掙扎" },
            { "line": "他只能默默地__", "answer": "吐" }
        ]
    },
    "下一枝的惆悵.mp3": {
        lyrics: [
            { "time": 16, "text": "北京的雨是" },
            { "time": 18, "text": "四月未停歇的傾訴" },
            { "time": 23, "text": "胡同的路是我" },
            { "time": 26, "text": "無法忘卻的孤獨" },
            { "time": 31, "text": "拆遷的通知" },
            { "time": 34, "text": "是我還未收拾的包袱" },
            { "time": 39, "text": "騎行的外賣" },
            { "time": 42, "text": "是我唯一能做的救贖" },
            { "time": 46, "text": "有那麼一刻我以為我" },
            { "time": 50, "text": "忘記了哭" },
            { "time": 53, "text": "直到又聞到中華牌香菸的溫度" },
            { "time": 59, "text": "有那麼一刻我以為我" },
            { "time": 62, "text": "習慣了哭" },
            { "time": 65, "text": "直到又看到中華牌香菸的閃爍" },
            { "time": 82, "text": "你說歲月漫長" },
            { "time": 86, "text": "八年風塵僕僕卻也轉眼一晃" },
            { "time": 89, "text": "我說光陰匆忙" },
            { "time": 91, "text": "我只是忘了我是誰的兒郎" },
            { "time": 97, "text": "你說未來長河" },
            { "time": 101, "text": "你又點起了下一支的惆悵" },
            { "time": 104, "text": "我說人生匆忙" },
            { "time": 106, "text": "可我又躲不過" },
            { "time": 108, "text": "歲月的蒼茫" }
        ],
        quiz: [
            { "line": "北京的雨是四月未停歇的__", "answer": "傾訴" },
            { "line": "__的路是我無法忘卻的孤獨", "answer": "胡同" },
            { "line": "拆遷的通知是我還未收拾的__", "answer": "包袱" },
            { "line": "騎行的__是我唯一能做的救贖", "answer": "外賣" },
            { "line": "直到又聞到__香菸的溫度", "answer": "中華牌" },
            { "line": "你說__漫長", "answer": "歲月" },
            { "line": "八年__卻也轉眼一晃", "answer": "風塵僕僕" },
            { "line": "我說__匆忙", "answer": "光陰" },
            { "line": "我只是忘了我是誰的__", "answer": "兒郎" },
            { "line": "你又點起了下一支的__", "answer": "惆悵" },
            { "line": "可我又躲不過歲月的__", "answer": "蒼茫" }
        ]
    },
    "餘燼落入虛無.mp3": {
        lyrics: [
            { "time": 11, "text": "火焰跳著靈動的舞蹈" },
            { "time": 16, "text": "灰燼飄落最後一遭" },
            { "time": 20, "text": "燒化的紙錢開始飛向雲霄" },
            { "time": 25, "text": "地獄的大門即將來到" },
            { "time": 30, "text": "就像那風中飄零的草" },
            { "time": 34, "text": "沒有根基只能隨風起" },
            { "time": 39, "text": "落飄搖你看那天空中瀰漫的煙" },
            { "time": 44, "text": "那是你我生命最終的樣貌" },
            { "time": 58, "text": "火焰跳著靈動的舞蹈" },
            { "time": 102, "text": "灰燼飄落最後一早" },
            { "time": 107, "text": "燒化的紙錢開始飛向雲霄" },
            { "time": 111, "text": "一切似乎就要結束了" },
            { "time": 116, "text": "就像那風中飄零的草" },
            { "time": 121, "text": "沒有根基只能隨風起" },
            { "time": 126, "text": "若飄搖你看那天空中瀰漫的煙" },
            { "time": 131, "text": "那是你我生命最終的樣貌" }
        ],
        quiz: [
            { "line": "火焰跳著靈動的__", "answer": "舞蹈" },
            { "line": "__飄落最後一遭", "answer": "灰燼" },
            { "line": "燒化的__開始飛向雲霄", "answer": "紙錢" },
            { "line": "__的大門即將來到", "answer": "地獄" },
            { "line": "就像那風中飄零的__", "answer": "草" },
            { "line": "沒有__只能隨風起", "answer": "根基" },
            { "line": "你看那天空中瀰漫的__", "answer": "煙" },
            { "line": "那是你我生命最終的__", "answer": "樣貌" },
            { "line": "一切似乎就要__了", "answer": "結束" }
        ]
    },
    "老屋回憶.mp3": {
        lyrics: [
            { "time": 16, "text": "老屋的木門常年虛掩" }, { "time": 22, "text": "門外種着一棵桂花樹" }, { "time": 28, "text": "秋深時節 花瓣零散一地" }, { "time": 35, "text": "我與爺爺用竹箕收集" }, { "time": 42, "text": "回憶的碎片" }, { "time": 44, "text": "那時的快樂" }, { "time": 46, "text": "是被捕捉後又放生的小魚" }, { "time": 55, "text": "是桂花糕出鍋時的蒸汽" }, { "time": 62, "text": "是一串串銀鈴般的蟲鳴鳥囀" }, { "time": 69, "text": "然而後來" }, { "time": 71, "text": "鈴聲中斷了我所邂逅的花鳥蟲魚" }, { "time": 79, "text": "已是活生生的標本" }
        ],
        quiz: [
            { "line": "老屋的木門常年__", "answer": "虛掩" },
            { "line": "門外種着一棵__樹", "answer": "桂花" },
            { "line": "__時節 花瓣零散一地", "answer": "秋深" },
            { "line": "我與爺爺用__收集", "answer": "竹箕" },
            { "line": "回憶的__", "answer": "碎片" },
            { "line": "是被捕捉後又放生的__", "answer": "小魚" },
            { "line": "是__出鍋時的蒸汽", "answer": "桂花糕" },
            { "line": "是一串串銀鈴般的__", "answer": "蟲鳴鳥囀" },
            { "line": "__中斷了我所邂逅的花鳥蟲魚", "answer": "鈴聲" },
            { "line": "已是活生生的__", "answer": "標本" }
        ]
    }
    // ... 如果還有其他歌曲，也可以按照這個模式擴充
};


// --- CD Cover Images ---
const songCovers = {

    "白影.mp3": "https://i.ibb.co/0pYsv0m1/image.png",
   
    // 為其他歌曲添加封面，格式為 "歌曲文件名.mp3": "圖片URL"
    // 如果沒有特定封面，可以使用一個通用的默認封面
    "default": "https://i.ibb.co/G4Rmgzjt/image.png" // 默認封面
};



            // --- DOM Elements ---

            const mainGameContainer = document.getElementById('mainGameContainer');
            const tracksContainer = document.getElementById('tracksContainer');
            const scoreDisplay = document.getElementById('score');
            const startBtn = document.getElementById('startBtn');
            const musicSelect = document.getElementById('musicSelect');
            const progressBar = document.getElementById('progressBar');
            const gameOverModal = document.getElementById('gameOverModal');
            const finalScoreDisplay = document.getElementById('finalScore');
            const finalComboDisplay = document.getElementById('finalCombo');
            const restartBtn = document.getElementById('restartBtn');
            const settingsModal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settingsBtn');
            const closeSettings = document.getElementById('closeSettings');
    
            const volumeControlModal = document.getElementById('volumeControlModal');
            const sfxVolumeControl = document.getElementById('sfxVolumeControl');
            const touchKeys = document.querySelectorAll('.touch-key');
            const difficultySelect = document.getElementById('difficultySelect');
            const audio = new Audio();
            audio.volume = 1.0;
            // --- 【新增】排行榜相關的 DOM 元素 ---
const leaderboardBtn = document.getElementById('leaderboardBtn');
const leaderboardModal = document.getElementById('leaderboardModal');
const closeLeaderboard = document.getElementById('closeLeaderboard');
const playerNameGroup = document.getElementById('playerNameGroup');
const playerNameInput = document.getElementById('playerNameInput');
const savePlayerNameBtn = document.getElementById('savePlayerNameBtn');
const leaderboardTitle = document.getElementById('leaderboardTitle');
const leaderboardList = document.getElementById('leaderboardList');
const leaderboardLoading = document.getElementById('leaderboardLoading');

            // New DOM Elements
            const personalHighScoreBtn = document.getElementById('personalHighScoreBtn');
            const personalHighScoreModal = document.getElementById('personalHighScoreModal');
            const closePersonalHighScore = document.getElementById('closePersonalHighScore');
            const personalHighScoreList = document.getElementById('personalHighScoreList');
            const musicPlayerBtn = document.getElementById('musicPlayerBtn');
            const musicPlayerModal = document.getElementById('musicPlayerModal');
            const closeMusicPlayer = document.getElementById('closeMusicPlayer');
            const nowPlaying = document.getElementById('nowPlaying');
            const lyricsContainer = document.getElementById('lyricsContainer');
            const prevBtn = document.getElementById('prevBtn');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const nextBtn = document.getElementById('nextBtn');
            const progressSlider = document.getElementById('progressSlider');
            const currentTimeDisplay = document.getElementById('currentTime');
            const durationDisplay = document.getElementById('duration');
            const volumeSliderPlayer = document.getElementById('volumeSliderPlayer');
            const playlist = document.getElementById('playlist');
            const unlockModal = document.getElementById('unlockModal');
            const closeUnlock = document.getElementById('closeUnlock');
            const unlockRequirement = document.getElementById('unlockRequirement');
             // ▼▼▼ 新增通知視窗的 DOM 元素 ▼▼▼
            const notificationModal = document.getElementById('notificationModal');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            const closeNotification = document.getElementById('closeNotification');

            // ▼▼▼ 新增的 DOM 元素 ▼▼▼
            const unlockProgressContainer = document.getElementById('unlockProgressContainer');
            const unlockProgressBar = document.getElementById('unlockProgressBar');
           // ▼▼▼ 【修訂】改為選取兩個新的標記線元素 ▼▼▼
            const songUnlockMarker = document.getElementById('songUnlockMarker');
            const difficultyUnlockMarker = document.getElementById('difficultyUnlockMarker');
            // ▲▲▲ 修訂結束 ▲▲▲
            // ▲▲▲ 新增結束 ▲▲▲


// ▼▼▼ 【修訂】測驗相關的狀態變數 ▼▼▼
let isQuizActive = false;
let quizQuestions = []; // 將儲存當前測驗的所有題目
let currentQuizQuestion = null; // 儲存當前的問題物件
let questionsAnsweredCorrectly = 0; // 追蹤已答對的題數
let totalQuestionsInQuiz = 0; // 測驗開始時的總題數
let quizUnlockTarget = null; // 用於儲存測驗成功後要解鎖的目標

// --- 【新增】獲取測驗視窗的 DOM 元素 ---
const lyricsQuizModal = document.getElementById('lyricsQuizModal');
const quizProgress = document.getElementById('quizProgress');
const quizQuestionText = document.getElementById('quizQuestionText');
const quizAnswerInput = document.getElementById('quizAnswerInput');
const quizSubmitBtn = document.getElementById('quizSubmitBtn');
const quizCloseBtn = document.getElementById('quizCloseBtn');
            
            // --- Game State Variables ---
            let gameActive = false;
let maxScoreForCurrentLevel = 0; // ▼▼▼ 新增狀態變數
            let unlockThresholdPercentage = 0; // ▼▼▼ 新增狀態變數
            let score = 0; // 總分，包含連擊獎勵
let pureHitScore = 0; // 新增：純擊打分數，用於解鎖計算
            let combo = 0;
            let notificationQueue = [];      // 我們的通知「待辦清單」
let isNotificationActive = false; // 一個旗標，用來判斷是否已有通知正在顯示
            let maxCombo = 0;
            let notes = [];
            let noteSpeed = 3000;
            let animationFrame;
            let gameStartTime = 0;
            let currentSongDuration = 0;
            let noteQueue = [];
            let generateNotesTimer = null;
            let progressInterval = null;
            const musicSelectorDiv = document.querySelector('.music-selector');
            const progressContainerDiv = document.querySelector('.progress-container');
            const tracks = 4;
            const keys = ['A', 'S', 'D', 'F'];
            const keyCodes = [65, 83, 68, 70];
            const keyStates = { 65: false, 83: false, 68: false, 70: false };
            let trackCooldownUntil = new Array(tracks).fill(0);
            let sfxVolume = 0.5;
            // ▼▼▼ 【新增】粒子池相關變數 ▼▼▼
const PARTICLE_POOL_SIZE = 100; // 池的大小，可以根據需要調整
let hitParticlePool = [];
let noteParticlePool = [];
let currentHitParticleIndex = 0;
let currentNoteParticleIndex = 0;
// ▲▲▲ 新增結束 ▲▲▲

            // Music Player State
            let playerAudio = new Audio();
            playerAudio.volume = 1.0;
            let playerIsPlaying = false;
            let playlistItems = [];
            let currentPlaylistIndex = 0;
            let lyrics = [];
            let lyricsInterval = null;
            let isUpdatingSlider = false; // Flag to prevent slider update conflicts

            // --- Audio Context for SFX ---
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let isAudioContextStarted = false;
            function startAudioContext() {
                if (!isAudioContextStarted) {
                    audioContext.resume().then(() => {
                        isAudioContextStarted = true;
                        console.log("AudioContext started");
                    }).catch(e => console.error("Failed to start AudioContext:", e));
                }
            }
            document.body.addEventListener('click', startAudioContext, { once: true });
            document.body.addEventListener('touchstart', startAudioContext, { once: true });


// ▼▼▼ 【新增】設定粒子池的函數 ▼▼▼
function setupParticlePools() {
    // 清空並重建 hitParticlePool
    hitParticlePool.forEach(p => p.remove());
    hitParticlePool = [];
    for (let i = 0; i < PARTICLE_POOL_SIZE; i++) {
        const particle = document.createElement('div');
        particle.className = 'hit-particle'; // 預設 class
        // 先將粒子附加到一個不會影響佈局的地方
        tracksContainer.appendChild(particle);
        hitParticlePool.push(particle);
    }
    currentHitParticleIndex = 0;

    // 清空並重建 noteParticlePool
    noteParticlePool.forEach(p => p.remove());
    noteParticlePool = [];
    for (let i = 0; i < PARTICLE_POOL_SIZE; i++) {
        const particle = document.createElement('div');
        particle.className = 'note-particle'; // 預設 class
        tracksContainer.appendChild(particle);
        noteParticlePool.push(particle);
    }
    currentNoteParticleIndex = 0;
}
// ▲▲▲ 新增結束 ▲▲▲

            
            function createSound(frequency, type = 'sine', duration = 0.1, baseVolume = 0.2) {
                return function() {
                    if (!isAudioContextStarted) return;
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.type = type;
                    oscillator.frequency.value = frequency;
                    gainNode.gain.value = baseVolume * sfxVolume;
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                };
            }
           const sounds = {
                perfect: createSound(523.25, 'sine', 0.15, 1.2), // 原為 0.7，強力放大
                great: createSound(392.00, 'sine', 0.15, 1.2),  // 原為 0.6，強力放大
                good: createSound(329.63, 'sine', 0.15, 1.2),   // 原為 0.5，放大至標準音量
                miss: createSound(220.00, 'square', 0.2, 1.2),  // 原為 0.4，顯著放大
                combo: createSound(659.25, 'triangle', 0.1, 1.2) // 原為 0.5，放大至標準音量
            };

            // --- Local Storage Management ---
           const STORAGE_KEY = 'musicGameSaveData';
const PLAYER_STORAGE_KEY = 'musicPlayerSettings';

let saveData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    unlockedSongs: ["白影.mp3"],
    unlockedDifficulties: {}, 
    personalHighScores: {} 
};

// 新增播放器設定的儲存結構
let playerSettings = JSON.parse(localStorage.getItem(PLAYER_STORAGE_KEY)) || {
    currentSong: null,
    currentTime: 0,
    volume: 0.7,
    isPlaying: false,
    playlistStates: {}, // 記錄每首歌的啟用/停用狀態
    currentPlaylistIndex: 0
};

            // Initialize unlocked difficulties for existing unlocked songs
            saveData.unlockedSongs.forEach(song => {
                if (!saveData.unlockedDifficulties[song]) {
                    saveData.unlockedDifficulties[song] = { normal: true, hard: false, hell: false };
                }
            });

           function saveGame() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
}

// 新增播放器設定保存函數
function savePlayerSettings() {
    // 更新當前播放狀態
    if (playlistItems.length > 0 && currentPlaylistIndex >= 0) {
        playerSettings.currentSong = playlistItems[currentPlaylistIndex]?.url || null;
        playerSettings.currentTime = playerAudio.currentTime || 0;
        playerSettings.volume = playerAudio.volume || 0.7;
        playerSettings.isPlaying = playerIsPlaying;
        playerSettings.currentPlaylistIndex = currentPlaylistIndex;
    }
    
    // 保存播放清單狀態
    const playlistElements = document.querySelectorAll('.playlist-item');
    playerSettings.playlistStates = {};
    playlistElements.forEach((item, index) => {
        if (playlistItems[index]) {
            playerSettings.playlistStates[playlistItems[index].url] = {
                enabled: item.dataset.enabled === 'true',
                index: index
            };
        }
    });
    
    localStorage.setItem(PLAYER_STORAGE_KEY, JSON.stringify(playerSettings));
}

// 載入播放器設定
function loadPlayerSettings() {
    // 恢復音量設定
    if (playerSettings.volume !== undefined) {
        playerAudio.volume = playerSettings.volume;
        volumeSliderPlayer.value = playerSettings.volume;
    }
}

            // --- Unlock System ---
            function isSongUnlocked(songUrl) {
                return saveData.unlockedSongs.includes(songUrl);
            }

            function isDifficultyUnlocked(songUrl, difficulty) {
                if (difficulty === 'easy' || difficulty === 'normal') return true; // Easy/Normal always unlocked for unlocked songs
                return saveData.unlockedDifficulties[songUrl] && saveData.unlockedDifficulties[songUrl][difficulty];
            }

         function unlockNextSong(songJustPlayed) {
                const allSongs = Array.from(musicSelect.options).map(opt => opt.value);
                const lastUnlockedSong = saveData.unlockedSongs[saveData.unlockedSongs.length - 1];

                if (songJustPlayed === lastUnlockedSong) {
                    const currentIndex = allSongs.indexOf(lastUnlockedSong);
                    if (currentIndex >= 0 && currentIndex < allSongs.length - 1) {
                        const nextSong = allSongs[currentIndex + 1];
                        if (!isSongUnlocked(nextSong)) {
                            saveData.unlockedSongs.push(nextSong);
                            saveData.unlockedDifficulties[nextSong] = { normal: true, hard: false, hell: false };
                            saveGame();
                            updateSongOptions();

                            const songDisplayName = Array.from(musicSelect.options).find(opt => opt.value === nextSong)?.textContent || nextSong;
                            showNotification('success', '新歌曲已解鎖！', `恭喜您！歌曲 <strong>${songDisplayName}</strong> 現在可以在播放清單中選擇了。`);
                            
                            return true; // 【新增】成功解鎖，回傳 true
                        }
                    }
                }
                return false; // 【新增】沒有發生解鎖，回傳 false
            }

           function unlockDifficulty(songUrl, difficulty) {
                if (!saveData.unlockedDifficulties[songUrl]) {
                    saveData.unlockedDifficulties[songUrl] = { normal: true, hard: false, hell: false };
                }
                if (!saveData.unlockedDifficulties[songUrl][difficulty]) {
                    saveData.unlockedDifficulties[songUrl][difficulty] = true;
                    saveGame();
                    updateSongOptions();
                    
                    const songTitle = Array.from(musicSelect.options).find(opt => opt.value === songUrl)?.textContent || songUrl;
                    const difficultyText = difficultySelect.querySelector(`option[value="${difficulty}"]`).textContent.replace(' (未解鎖)', '');
                    showNotification('success', '新難度已解鎖！', `<strong>${songTitle}</strong> 的 <strong>${difficultyText}</strong> 難度現已開放挑戰！`);

                    return true; // 【新增】成功解鎖，回傳 true
                }
                return false; // 【新增】沒有發生解鎖，回傳 false
            }

          // 修訂後的 checkAndUnlockDifficulties 函數
// 【修正後的版本】請用這段程式碼完整替換舊的 checkAndUnlockDifficulties 函數

function checkAndUnlockDifficulties(songUrl, difficulty, pureHitScore) {
    // 檢查是否可以從 "普通" 解鎖 "困難"
    if (difficulty === 'normal' && !isDifficultyUnlocked(songUrl, 'hard')) {
        // 使用與進度條完全相同的、準確的理論最高分來計算門檻
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        
        // 使用與進度條完全相同的純粹打擊分數來進行比較
        if (pureHitScore >= requiredScore) {
            unlockDifficulty(songUrl, 'hard');
        }
    }

    // 檢查是否可以從 "困難" 解鎖 "地獄"
    if (difficulty === 'hard' && !isDifficultyUnlocked(songUrl, 'hell')) {
        // 同樣，使用準確的理論最高分來計算門檻
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        
        // 同樣，使用純粹打擊分數來進行比較
        if (pureHitScore >= requiredScore) {
            unlockDifficulty(songUrl, 'hell');
        }
    }
}

            function showUnlockModal(message) {
                unlockRequirement.textContent = message;
                unlockModal.classList.add('active');
            }

            // --- UI Updates ---



function processNotificationQueue() {
    // 如果當前已有通知正在顯示，或者隊列是空的，就直接返回
    if (isNotificationActive || notificationQueue.length === 0) {
        return;
    }

    // 標記為「正在顯示通知」
    isNotificationActive = true;

    // 從隊列的頭部取出第一個通知
    const notification = notificationQueue.shift();

    // --- 以下是原 showNotification 函數的核心顯示邏輯 ---
    const content = notificationModal.querySelector('.notification-content');
    notificationTitle.textContent = notification.title;
    notificationMessage.innerHTML = notification.message;

    content.classList.remove('success', 'info');
    if (notification.type === 'success') {
        content.classList.add('success');
        notificationIcon.innerHTML = '&#127881;'; // 🎉
    } else {
        content.classList.add('info');
        notificationIcon.innerHTML = '&#128220;'; // 📌
    }
    
    notificationModal.classList.add('active');

    // 設定計時器，在通知結束後觸發下一個
    notificationTimer = setTimeout(() => {
        notificationModal.classList.remove('active');
        isNotificationActive = false; // 標記為「通知已結束」
        processNotificationQueue();   // 再次呼叫經理，檢查隊列中是否還有下一個
    }, notification.duration || 5000);
}
// ▲▲▲ 新增函數結束 ▲▲▲


            
// 【修改後的版本】請用這段程式碼完整替換舊的 showNotification 函數

let notificationTimer = null;

function showNotification(type, title, message, duration = 5000) {
    // 步驟 1: 將通知任務打包，添加到隊列的末尾
    notificationQueue.push({
        type: type,
        title: title,
        message: message,
        duration: duration
    });

    // 步驟 2: 呼叫我們的「經理」來處理隊列
    processNotificationQueue();
}

            // 為通知視窗的關閉按鈕添加點擊事件
           // 【修改後的樣子】
closeNotification.addEventListener('click', () => {
    if (notificationTimer) {
        clearTimeout(notificationTimer); // 清除當前的計時器
    }
    notificationModal.classList.remove('active');
    isNotificationActive = false;      // 立刻標記為「通知已結束」
    processNotificationQueue();        // 立刻呼叫經理，顯示下一個通知
});


            
            function updateSongOptions() {
                const selectedSong = musicSelect.value;
                const selectedDifficulty = difficultySelect.value;

                Array.from(musicSelect.options).forEach(option => {
                    const songUrl = option.value;
                    if (isSongUnlocked(songUrl)) {
                        option.disabled = false;
                        option.text = option.text.replace(' (未解鎖)', ''); // Remove unlock tag if present
                    } else {
                        option.disabled = true;
                        if (!option.text.includes('(未解鎖)')) {
                            option.text += ' (未解鎖)';
                        }
                    }
                });

                // Update difficulty options based on selected song
                updateDifficultyOptions(selectedSong);

                // Restore selection if it's still valid
                if (isSongUnlocked(selectedSong)) {
                    musicSelect.value = selectedSong;
                } else {
                    // Select the first unlocked song if current is locked
                    const firstUnlocked = saveData.unlockedSongs[0];
                    if (firstUnlocked) musicSelect.value = firstUnlocked;
                }
                if (!isDifficultyUnlocked(musicSelect.value, selectedDifficulty)) {
                    difficultySelect.value = 'normal'; // Default to normal if selected is locked
                }
            }

            function updateDifficultyOptions(songUrl) {
                const difficulties = ['easy', 'normal', 'hard', 'hell'];
                difficulties.forEach(diff => {
                    const option = difficultySelect.querySelector(`option[value="${diff}"]`);
                    if (isDifficultyUnlocked(songUrl, diff)) {
                        option.disabled = false;
                        option.text = option.text.replace(' (未解鎖)', '');
                    } else {
                        option.disabled = true;
                        if (!option.text.includes('(未解鎖)')) {
                            option.text += ' (未解鎖)';
                        }
                    }
                });
            }

            function updatePersonalHighScore(songUrl, difficulty, newScore) {
                 if (!saveData.personalHighScores[songUrl]) {
                    saveData.personalHighScores[songUrl] = {};
                 }
                 const currentHigh = saveData.personalHighScores[songUrl][difficulty] || 0;
                 if (newScore > currentHigh) {
                    saveData.personalHighScores[songUrl][difficulty] = newScore;
                    saveGame();
                 }
            }

            function populatePersonalHighScoreList(songUrl) {
                personalHighScoreList.innerHTML = '';
                const difficulties = ['easy', 'normal', 'hard', 'hell'];
                difficulties.forEach(diff => {
                    const li = document.createElement('li');
                    li.className = 'personal-high-score-item';

                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'personal-high-score-label';
                    labelSpan.textContent = `${diff.toUpperCase()}:`;

                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'personal-high-score-value';
                    const score = saveData.personalHighScores[songUrl] ? saveData.personalHighScores[songUrl][diff] : 0;
                    valueSpan.textContent = score ? score.toLocaleString() : '0';

                    li.appendChild(labelSpan);
                    li.appendChild(valueSpan);
                    personalHighScoreList.appendChild(li);
                });
            }

            function initGame() {
    tracksContainer.innerHTML = '';
    for (let i = 0; i < tracks; i++) {
        const track = document.createElement('div');
        track.className = 'track';
        track.dataset.track = i;
        const hitLine = document.createElement('div');
        hitLine.className = 'hit-line';
        track.appendChild(hitLine);
        const keyHint = document.createElement('div');
        keyHint.className = 'key-hint';
        keyHint.textContent = keys[i];
        track.appendChild(keyHint);
        tracksContainer.appendChild(track);
    }
                  setupParticlePools();
    score = 0;
    combo = 0;
    maxCombo = 0;
    // 新增：重設 pureHitScore 以確保每次遊戲開始時從0開始（避免累積BUG）
    pureHitScore = 0;
    notes = [];
    noteQueue = [];
    progressBar.style.width = '0%';
    updateUI();
    tracksContainer.className = 'tracks';
    const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    if (isMobile) {
        document.getElementById('touchControls').style.display = 'flex';
        document.querySelectorAll('.key-hint').forEach(hint => hint.style.display = 'none');
    }
}

            function updateUI() {
                scoreDisplay.textContent = score;
            }

           function updateProgress() {
    if (gameActive && currentSongDuration > 0) {
        const elapsed = (Date.now() - gameStartTime) / 1000;
        const progress = Math.min(100, (elapsed / currentSongDuration) * 100);
        progressBar.style.width = `${progress}%`;

        // 新增：呼叫遊戲歌詞更新邏輯
        updateGameLyrics(elapsed);
    }
}

            // ==============================================================
// ====== 【新增】排行榜核心功能函數 ==========================
// ==============================================================

/**
 * 將歌曲文件名轉換為可用於 Firebase key 的安全字串
 * @param {string} filename - 例如 "白影.mp3"
 * @returns {string} - 例如 "白影_mp3"
 */
function sanitizeFirebaseKey(filename) {
    return filename.replace(/\./g, '_').replace(/[#$\[\]]/g, '');
}

/**
 * 檢查名稱是否包含髒話
 * @param {string} name - 要檢查的名稱
 * @returns {boolean} - 如果包含髒話則回傳 true
 */
function isProfane(name) {
    const lowerCaseName = name.toLowerCase();
    return profanityList.some(word => lowerCaseName.includes(word));
}

/**
 * 處理玩家名稱的設定與儲存（修訂後版本）
 * - 增加 Firebase 全域名稱唯一性檢查
 */
async function handlePlayerName() {
    playerNameInput.value = playerName;
    if (!playerName) {
        showNotification('info', '設定名稱', '為了登上排行榜，請先設定你的專屬名稱！');
    }

    savePlayerNameBtn.onclick = async () => {
        const newName = playerNameInput.value.trim();
        const oldName = playerName; // 保存目前的（舊）名稱

        // --- 基本客戶端驗證 ---
        if (newName.length === 0) {
            showNotification('info', '名稱無效', '名稱不能為空！');
            return;
        }
        if (isProfane(newName)) {
            showNotification('info', '名稱不雅', '請勿使用不雅詞彙作為名稱。');
            return;
        }
        // 如果名稱沒有改變，則不需要執行任何操作
        if (newName === oldName) {
            showNotification('info', '提示', '名稱未變更。');
            return;
        }

        // --- Firebase 全域名稱唯一性檢查 ---

        // 為了讓檢查不分大小寫 (避免 Player 和 player 被視為不同)，我們統一用小寫來檢查和儲存
        const checkNameKey = newName.toLowerCase();
        const playerNamesRef = database.ref(`playerNames/${checkNameKey}`);
        
        savePlayerNameBtn.disabled = true; // 防止重複點擊
        savePlayerNameBtn.textContent = '檢查中...';

        try {
            const snapshot = await playerNamesRef.once('value');

            if (snapshot.exists()) {
                // 如果資料庫中存在這個名稱，代表已被佔用
                showNotification('info', '名稱已被使用', `名稱「<strong>${newName}</strong>」已被其他玩家註冊，請換一個吧！`);
            } else {
                // --- 名稱可用，執行儲存操作 ---

                // 建立一個物件來一次性更新多個資料路徑
                const updates = {};
                
                // 1. 在 playerNames 註冊新名稱
                updates[`/playerNames/${checkNameKey}`] = true;
                
                // 2. 如果是「更改」名稱，需要從 playerNames 中刪除舊名稱
                if (oldName) {
                    const oldNameKey = oldName.toLowerCase();
                    updates[`/playerNames/${oldNameKey}`] = null; // 在 Firebase 中，將值設為 null 等於刪除該節點
                }

                // 3. 執行原子性更新
                await database.ref().update(updates);

                // 4. 更新本地變數和 Local Storage
                playerName = newName;
                localStorage.setItem('musicGamePlayerName', playerName);
                
                showNotification('success', '儲存成功', `你的新名稱「<strong>${playerName}</strong>」已成功設定！`);
            }
        } catch (error) {
            console.error("檢查名稱時發生錯誤:", error);
            showNotification('info', '發生錯誤', '與伺服器連線時發生問題，請稍後再試。');
        } finally {
            // 無論成功或失敗，都恢復按鈕的狀態
            savePlayerNameBtn.disabled = false;
            savePlayerNameBtn.textContent = '儲存名稱';
        }
    };

    // 移除舊的 EventListener，避免重複綁定 (如果之前是用 addEventListener 的話)
    // 由於我們改用 onclick，這行可以省略，但保留是一種好習慣
    // savePlayerNameBtn.removeEventListener('click', ...);
}
/**
 * 顯示指定歌曲與難度的排行榜
 * @param {string} songUrl - 歌曲的 URL
 * @param {string} difficulty - 難度
 */
function displayLeaderboard(songUrl, difficulty) {
    const songDisplayName = Array.from(musicSelect.options).find(opt => opt.value === songUrl)?.textContent || '未知歌曲';
    const difficultyDisplayName = difficultySelect.querySelector(`option[value="${difficulty}"]`).textContent;
    
    leaderboardTitle.textContent = `${songDisplayName} - ${difficultyDisplayName}`;
    leaderboardList.innerHTML = '';
    leaderboardLoading.style.display = 'block';

    const songId = sanitizeFirebaseKey(songUrl);
    const leaderboardRef = database.ref(`leaderboards/${songId}/${difficulty}`);

    leaderboardRef.once('value', (snapshot) => {
        leaderboardLoading.style.display = 'none';
        const data = snapshot.val();

        if (data && data.length > 0) {
            data.forEach((entry, index) => {
                const li = document.createElement('li');
                li.className = 'leaderboard-item';
                li.innerHTML = `
                    <span class="leaderboard-rank">#${index + 1}</span>
                    <span class="leaderboard-name">${entry.name}</span>
                    <span class="leaderboard-score">${entry.score.toLocaleString()}</span>
                `;
                leaderboardList.appendChild(li);
            });
        } else {
            leaderboardList.innerHTML = '<li><p style="text-align: center; color: #aaa;">這個排行榜還沒有人挑戰過，快來成為第一名！</p></li>';
        }
    });
}

/**
 * 提交分數到 Firebase 排行榜（修訂後版本）
 * - 支援前三名上榜
 * - 阻止在同一榜單上使用重複的玩家名稱
 * @param {string} songUrl 
 * @param {string} difficulty 
 * @param {number} finalScore 
 */
async function submitScoreToLeaderboard(songUrl, difficulty, finalScore) {
    // 步驟 1: 確認玩家已設定名稱，否則不執行任何操作
    if (!playerName) {
        console.log("玩家未設定名稱，不提交分數至排行榜。");
        // 你也可以在這裡加上一個 showNotification() 來提醒玩家去設定名稱
        return;
    }

    const songId = sanitizeFirebaseKey(songUrl);
    const leaderboardRef = database.ref(`leaderboards/${songId}/${difficulty}`);

    // 步驟 2: 使用 Firebase 的 Transaction（交易）功能
    // 這是一個安全的操作，能防止多位玩家同時提交分數時造成資料錯亂。
    // 我們將「讀取、修改、寫回」這三個動作綁在一起，確保其原子性。
    try {
        const { committed, snapshot } = await leaderboardRef.transaction((currentData) => {
            // 如果資料庫中還沒有這個排行榜，就初始化為一個空陣列
            if (currentData === null) {
                currentData = [];
            }

            // ==========================================================
            // ====== 其二：避免玩家設定相同的名稱 (核心邏輯) ======
            // ==========================================================
            
            // 檢查這個名字是否已經被榜上「其他人」使用
            const isNameTakenByOther = currentData.some(entry => entry.name === playerName);

            // 尋找「自己」是否已經在榜上
            let selfIndex = -1;
            for (let i = 0; i < currentData.length; i++) {
                if (currentData[i].name === playerName) {
                    selfIndex = i;
                    break;
                }
            }

            // 【規則】如果名字被佔用，而且佔用者不是自己 -> 提交失敗
            if (isNameTakenByOther && selfIndex === -1) {
                // 返回 undefined 會安全地中止這次的 transaction，不會寫入任何資料
                console.warn(`提交失敗：名稱 "${playerName}" 已被此排行榜上的其他玩家使用。`);
                return; 
            }

            // ========================================================
            // ====== 其一：排行榜擴充至前三名 (核心邏輯) ======
            // ========================================================
            
            // 找出榜單上的最低分 (如果榜單未滿三人，則最低分為 0)
            const lowestScoreOnBoard = currentData.length < 3 ? 0 : currentData[currentData.length - 1].score;

            if (selfIndex !== -1) {
                // --- 情況 A: 我已經在榜上 ---
                // 只有在新分數更高時，才更新我的分數
                if (finalScore > currentData[selfIndex].score) {
                    currentData[selfIndex].score = finalScore;
                } else {
                    // 分數沒有更高，不需要更新，中止 transaction
                    return;
                }
            } else {
                // --- 情況 B: 我還沒上榜 ---
                // 如果分數不夠高 (且榜單已滿 3 人)，就無法上榜
                if (finalScore <= lowestScoreOnBoard && currentData.length >= 3) {
                    return; // 中止 transaction
                }
                // 分數夠高，將我的新紀錄加入陣列中
                currentData.push({ name: playerName, score: finalScore });
            }

            // 【關鍵步驟】對所有紀錄依分數由高到低重新排序
            currentData.sort((a, b) => b.score - a.score);
            
            // 【關鍵步驟】只保留排序後的前三名紀錄
            const newData = currentData.slice(0, 3);
            
            // 返回最終要寫入資料庫的新排行榜資料
            return newData;
        });

        // 步驟 3: 根據 transaction 的執行結果，給予玩家明確的回饋
        if (committed) {
            // Transaction 成功提交，代表資料已更新
            const finalBoard = snapshot.val() || [];
            // 再次確認自己是否真的在最終的榜單上
            const onFinalBoard = finalBoard.some(entry => entry.name === playerName && entry.score === finalScore);
            
            if (onFinalBoard) {
                // 只有成功上榜，才顯示成功通知
                const difficultyText = difficultySelect.querySelector(`option[value="${difficulty}"]`).textContent;
                showNotification('success', '登上排行榜！', `恭喜！你在「<strong>${difficultyText}</strong>」難度的分數已成功登上排行榜！`);
            } else {
                // 雖然提交成功，但因為分數不夠高而被擠出榜外
                showNotification('info', '再接再厲', '你的分數已成功提交，但未達到目前排行榜前三名的標準。');
            }
        } else {
            // Transaction 被中止，通常是因為我們在前面手動中止了它（例如名稱重複）
             showNotification('info', '提交失敗', '你的名稱可能已被此排行榜上的其他玩家使用，請更換名稱後再試一次。');
        }

    } catch (error) {
        // 如果發生網路錯誤等問題
        console.error("提交分數時發生錯誤: ", error);
        showNotification('info', '提交錯誤', '與伺服器連線時發生問題，請稍後再試。');
    }
}
// ==============================================================
// ====== 【新增函數結束】 ======================================
// ==============================================================

            // --- Game Logic ---
            function generateNote(noteData) {
    if (!gameActive) return;
    const trackIndex = noteData.track;
    const track = document.querySelector(`.track[data-track="${trackIndex}"]`);
    if (!track) return;
    const note = document.createElement('div');
    note.className = noteData.type === 'long' ? 'long-note' : 'note';
    note.dataset.track = trackIndex;
    note.style.animationDuration = `${noteSpeed}ms`;
    if (noteData.type === 'long') {
        const noteHeight = (noteData.duration / (noteSpeed / 1000)) * (tracksContainer.clientHeight + 50);
        note.style.height = `${Math.max(30, noteHeight)}px`;
    }
    track.appendChild(note);
    const noteObj = {
        element: note,
        track: trackIndex,
        type: noteData.type,
        duration: noteData.duration || 0,
        active: true,
        hitStarted: false,
        // ▼▼▼ 【優化】記錄音符被創造時的精確時間戳 ▼▼▼
        creationTime: Date.now(),
        // ▲▲▲ 優化結束 ▲▲▲
    };
    notes.push(noteObj);
}

          // ▼▼▼ 【修訂後】使用物件池的 createHitParticles 函數 ▼▼▼
function createHitParticles(trackIndex, judgment) {
    const track = document.querySelector(`.track[data-track="${trackIndex}"]`);
    if (!track) return;

    const particleCount = (judgment === 'perfect') ? 15 : (judgment === 'great' ? 10 : 7); // 稍微減少粒子數量以提升效能
    const maxOffset = (judgment === 'perfect') ? 100 : (judgment === 'great' ? 80 : 60);

    const colors = {
        perfect: '#ffcc00', great: '#00ccff', good: '#00ff99'
    };

    for (let i = 0; i < particleCount; i++) {
        // 從池中獲取一個粒子
        currentHitParticleIndex = (currentHitParticleIndex + 1) % PARTICLE_POOL_SIZE;
        const particle = hitParticlePool[currentHitParticleIndex];

        // 重設樣式並啟動動畫
        particle.style.background = colors[judgment] || '#fff';
        const size = Math.floor(8 + Math.random() * 8);
        particle.style.setProperty('--size', `${size}px`);
        const x = (Math.random() - 0.5) * maxOffset * 2;
        const y = (Math.random() * -maxOffset) - 20;
        particle.style.setProperty('--x', `${x}px`);
        particle.style.setProperty('--y', `${y}px`);
        const rot = Math.random() * 360;
        const rotEnd = rot + (Math.random() * 720 - 360);
        particle.style.setProperty('--rot', `${rot}deg`);
        particle.style.setProperty('--rot-end', `${rotEnd}deg`);
        particle.style.left = `calc(${track.offsetLeft}px + 50% - ${size / 2}px)`;
        
        // 移除舊的動畫類別，強制重啟動畫
        particle.classList.remove('animate');
        void particle.offsetWidth; // 強制瀏覽器重繪
        particle.classList.add('animate');
        
        // 使用 animationend 事件來回收粒子，比 setTimeout 更精準
        particle.onanimationend = () => {
            particle.classList.remove('animate');
            particle.onanimationend = null; // 清除事件監聽器
        };
    }
}

// ▼▼▼ 【修訂後】使用物件池的 explodeNote 函數 ▼▼▼
function explodeNote(noteElement, judgment) {
    if (!noteElement) return;

    const rect = noteElement.getBoundingClientRect();
    const trackRect = tracksContainer.getBoundingClientRect();
    const particleCount = (judgment === 'perfect') ? 15 : (judgment === 'great' ? 10 : 7); // 減少粒子數量
    const maxOffset = 80;

    const colors = {
        perfect: '#ffcc00', great: '#00ccff', good: '#00ff99'
    };

    for (let i = 0; i < particleCount; i++) {
        // 從池中獲取一個粒子
        currentNoteParticleIndex = (currentNoteParticleIndex + 1) % PARTICLE_POOL_SIZE;
        const particle = noteParticlePool[currentNoteParticleIndex];

        particle.style.background = colors[judgment] || '#fff';
        const size = Math.floor(4 + Math.random() * 9);
        particle.style.setProperty('--size', `${size}px`);
        const x = (Math.random() - 0.5) * maxOffset * 2;
        const y = (Math.random() - 0.5) * maxOffset * 2;
        particle.style.setProperty('--x', `${x}px`);
        particle.style.setProperty('--y', `${y}px`);
        const rot = Math.random() * 360;
        const rotEnd = rot + (Math.random() * 720 - 360);
        particle.style.setProperty('--rot', `${rot}deg`);
        particle.style.setProperty('--rot-end', `${rotEnd}deg`);
        particle.style.left = `${rect.left - trackRect.left + rect.width / 2 - size / 2}px`;
        particle.style.top = `${rect.top - trackRect.top + rect.height / 2 - size / 2}px`;

        particle.classList.remove('animate');
        void particle.offsetWidth;
        particle.classList.add('animate');

        particle.onanimationend = () => {
            particle.classList.remove('animate');
            particle.onanimationend = null;
        };
    }
}



            

     function judgeHit(trackIndex, type) {
                const track = document.querySelector(`.track[data-track="${trackIndex}"]`);
                if (sounds[type]) {
                    sounds[type]();
                }

                // 創建並顯示判定文字 (Perfect, Great, etc.)
                const judgment = document.createElement('div');
                judgment.className = `judgment ${type}`;
                judgment.textContent = `${type.toUpperCase()}!`;
                if (track) {
                    track.appendChild(judgment);
                    judgment.style.left = '0';
                    judgment.style.width = '100%';
                    judgment.style.textAlign = 'center';
                }
                setTimeout(() => {
                    if (judgment && judgment.parentNode) {
                        judgment.remove();
                    }
                }, 1000);

                // 處理非 'miss' 的成功打擊
                if (type !== 'miss') {
                    // 觸發粒子效果
                    createHitParticles(trackIndex, type);

                    // 觸發打擊線的脈衝動畫
                    const hitLine = track.querySelector('.hit-line');
                    if (hitLine) {
                        hitLine.classList.remove('pulse-effect');
                        void hitLine.offsetWidth; // 強制瀏覽器重繪
                        hitLine.classList.add('pulse-effect');
                    }

                    // 根據判定等級觸發不同的軌道閃光效果
                    if (track) {
                        track.classList.remove('flash-perfect', 'flash-great', 'flash-good');
                        void track.offsetWidth;
                        if (type === 'perfect') {
                            track.classList.add('flash-perfect');
                        } else if (type === 'great') {
                            track.classList.add('flash-great');
                        } else if (type === 'good') {
                            track.classList.add('flash-good');
                        }
                    }

                    // 觸發裝置震動回饋
                    if (navigator.vibrate) {
                        let vibrationPattern;
                        if (type === 'perfect') {
                            vibrationPattern = [55]; // 短促有力的震動
                        } else if (type === 'great') {
                            vibrationPattern = [55]; // 中等震動
                        } else if (type === 'good') {
                            vibrationPattern = [50]; // 輕微震動
                        }
                        if (vibrationPattern) {
                            navigator.vibrate(vibrationPattern);
                        }
                    }

                   // 【關鍵修復 1】在這裡根據判定類型，定義 baseScore 的值
let baseScore = 0;
if (type === 'perfect') baseScore = 100;
else if (type === 'great') baseScore = 70;
else if (type === 'good') baseScore = 40;
                    
                    // 【關鍵修復 2】將 addScore 移到這裡，確保無論裝置是否支援震動，都會計分
                    addScore(baseScore);

                } else {
                    // 處理 'miss' 的情況
                    combo = 0;
                    const difficulty = getCurrentDifficulty();
                    trackCooldownUntil[trackIndex] = Date.now() + difficulty.cooldown;
                }

                updateUI();
            }

          function addScore(baseScore) {
                combo++;
                if (combo > maxCombo) maxCombo = combo;
                
                // 核心修訂：分開計算總分與用於解鎖的純粹分數
                pureHitScore += baseScore; // 純擊打分數，用於解鎖條件判斷
                score += baseScore + Math.floor(baseScore * (Math.floor(combo / 10) * 0.1)); // 包含連擊獎勵的總分，用於顯示

                if (combo > 5) {
                    const comboEl = document.createElement('div');
                    comboEl.className = 'combo-display';
                    comboEl.textContent = `${combo} COMBO!`;
                    if (combo >= 1000) comboEl.classList.add('combo-rainbow');
                    else if (combo >= 500) comboEl.classList.add('combo-purple');
                    else if (combo >= 200) comboEl.classList.add('combo-pink');
                    else if (combo >= 100) comboEl.classList.add('combo-orange');
                    else if (combo >= 50) comboEl.classList.add('combo-blue');
                    else comboEl.classList.add('combo-base');
                    tracksContainer.appendChild(comboEl);
                    if (sounds.combo) sounds.combo();
                    setTimeout(() => comboEl.remove(), 500);
                }
                let trackComboClass = '';
                if (combo >= 1000) trackComboClass = 'combo-rainbow';
                else if (combo >= 500) trackComboClass = 'combo-purple';
                else if (combo >= 200) trackComboClass = 'combo-pink';
                else if (combo >= 100) trackComboClass = 'combo-orange';
                else if (combo >= 50) trackComboClass = 'combo-blue';
                tracksContainer.className = 'tracks';
                if (trackComboClass) tracksContainer.classList.add(trackComboClass);
                
                updateUnlockMeter(); // 在分數更新後，同步更新解鎖進度條
            }

 // ▼▼▼ 新增的函數 ▼▼▼
           // ▼▼▼ 修正後的函數 ▼▼▼
function updateUnlockMeter() {
                if (maxScoreForCurrentLevel <= 0) return; // 避免除以零的錯誤
                
                // 【核心修正】進度條的百分比應基於不含 COMBO 的純粹分數（pureHitScore）來計算
                const currentPercent = Math.min(100, (pureHitScore / maxScoreForCurrentLevel) * 100);
                
                unlockProgressBar.style.width = `${currentPercent}%`;

                // 檢查是否超過了任一條解鎖線，如果超過則添加發光效果
                const hasReachedSongUnlock = currentPercent >= SONG_UNLOCK_PERCENTAGE * 100;
                const hasReachedDifficultyUnlock = currentPercent >= DIFFICULTY_UNLOCK_PERCENTAGE * 100;
                
                if (hasReachedSongUnlock || hasReachedDifficultyUnlock) {
                    unlockProgressBar.classList.add('glowing');
                } else {
                    unlockProgressBar.classList.remove('glowing');
                }
            }
            // ▲▲▲ 新增結束 ▲▲▲

            async function getAudioDuration(src) {
                return new Promise((resolve) => {
                    const tempAudio = new Audio(src);
                    tempAudio.addEventListener('loadedmetadata', () => resolve(tempAudio.duration));
                    tempAudio.addEventListener('error', () => resolve(120));
                });
            }

            async function analyzeAudioForBeats(url) {
                try {
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    const channelData = audioBuffer.getChannelData(0);
                    const sampleRate = audioBuffer.sampleRate;
                    const beats = [];
                    const bufferSize = 1024;
                    const historySize = 43;
                    const C = 1.3;
                    const energyHistory = []; // <-- [修訂] 新增這一行


                    
                    const getEnergy = (buffer) => {
                        let sum = 0;
                        for (let i = 0; i < buffer.length; i++) {
                            sum += buffer[i] * buffer[i];
                        }
                        return Math.sqrt(sum / buffer.length);
                    };
                    for (let i = 0; i < channelData.length; i += bufferSize) {
                        const buffer = channelData.slice(i, i + bufferSize);
                        const currentEnergy = getEnergy(buffer);
                        let averageEnergy = energyHistory.length > 0 ?
                            energyHistory.reduce((a, b) => a + b, 0) / energyHistory.length : 0;
                        if (currentEnergy > averageEnergy * C) {
                            const beatTime = i / sampleRate;
                            if (beats.length === 0 || beatTime > beats[beats.length - 1] + 0.2) {
                                beats.push(beatTime);
                            }
                        }
                        energyHistory.push(currentEnergy);
                        if (energyHistory.length > historySize) {
                            energyHistory.shift();
                        }
                    }
                    console.log(`偵測到 ${beats.length} 個節拍。`);
                    return beats;
                } catch (error) {
                    console.error("音訊分析失敗（可能是 CORS 跨域問題）:", error);
                    return [];
                }
            }

            function getCurrentDifficulty() {
                return difficultySettings[difficultySelect.value] || difficultySettings.normal;
            }

          async function startGame() {
    const selectedSong = musicSelect.value;
    const selectedDifficulty = difficultySelect.value;

    if (!isSongUnlocked(selectedSong)) {
        showUnlockModal(`在普通模式下達到 ${SONG_UNLOCK_SCORE} 分以解鎖下一首歌曲。`);
        return;
    }
    if (!isDifficultyUnlocked(selectedSong, selectedDifficulty)) {
        let reqScore = 0;
        let reqDiff = '';
        if (selectedDifficulty === 'hard') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_NORMAL_TO_HARD;
            reqDiff = '普通';
        } else if (selectedDifficulty === 'hell') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_HARD_TO_HELL;
            reqDiff = '困難';
        }
        showUnlockModal(`在 ${reqDiff} 模式下達到 ${reqScore} 分以解鎖此難度。`);
        return;
    }

    if (gameActive) return;
    gameActive = true;
    startBtn.disabled = true;
    musicSelect.disabled = true;
    difficultySelect.disabled = true;

    // ▼▼▼ 【核心修訂】無條件設定兩條合格線的位置 ▼▼▼
    mainGameContainer.classList.add('game-running'); 
    
    // 根據預設的百分比常數，設定兩條線的 left 屬性
    songUnlockMarker.style.left = `${SONG_UNLOCK_PERCENTAGE * 100}%`;
    difficultyUnlockMarker.style.left = `${DIFFICULTY_UNLOCK_PERCENTAGE * 100}%`;
    // ▲▲▲ 修訂結束 ▲▲▲
    
    // 新增：初始化進度條高度和寬度，確保顯示正常（修復無法顯示的BUG）
    unlockProgressBar.style.height = '100%';
    unlockProgressBar.style.width = '0%';
    unlockProgressBar.classList.remove('glowing');

    startBtn.innerHTML = `<svg class="start-button-svg" viewBox="0 0 40 40" style="width:40px;height:40px;">
        <circle cx="20" cy="20" r="18" stroke="#ff8a00" stroke-width="3" fill="none" stroke-dasharray="89" stroke-dashoffset="20">
            <animateTransform attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="1s" repeatCount="indefinite" />
        </circle>
    </svg>`;
    
    const difficulty = getCurrentDifficulty();
    const beatTimestamps = await analyzeAudioForBeats(selectedSong);
    startBtn.innerHTML = originalStartButtonSVG;
 
    progressContainerDiv.style.display = 'block';
    trackCooldownUntil.fill(0); 
    audio.src = selectedSong;
    audio.volume = volumeControlModal.value;
    currentSongDuration = await getAudioDuration(selectedSong);
    noteSpeed = Math.floor(4000 / difficulty.speedMultiplier);
    // ▼▼▼ [修訂] 生成基於歌曲和難度的固定種子 ▼▼▼
const songAndDifficultyString = selectedSong + selectedDifficulty;
let seed = 0;
for (let i = 0; i < songAndDifficultyString.length; i++) {
    const char = songAndDifficultyString.charCodeAt(i);
    seed = ((seed << 5) - seed) + char;
    seed |= 0; // Convert to 32bit integer
}
// 確保種子為正數
seed = Math.abs(seed) || 1; // 避免種子為 0
console.log(`Generating notes for ${selectedSong} (${selectedDifficulty}) with seed: ${seed}`);
// ▲▲▲ [修訂結束] ▲▲▲

// ▼▼▼ [修訂] 傳入種子 ▼▼▼
noteQueue = generateSongData(currentSongDuration, difficulty, beatTimestamps, seed, noteSpeed); // 傳入 noteSpeed
// ▲▲▲ [修訂結束] ▲▲▲

    // ▼▼▼ 【修訂後的核心邏輯】 ▼▼▼
    // 在生成音符後，動態計算不含連擊獎勵的理論最高分
  const maxBaseScorePerNote = 100; // 修正為 "Perfect" 的實際基礎分數 55
maxScoreForCurrentLevel = noteQueue.length * maxBaseScorePerNote;

    // 如果計算結果為 0 (例如歌曲沒有音符)，則提供一個預設值以避免錯誤
    if (maxScoreForCurrentLevel === 0) {
        maxScoreForCurrentLevel = 300000; // 設置一個後備值
    }
    // ▲▲▲ 【修訂結束】 ▲▲▲

    await audio.play().catch(e => console.log("音訊播放失敗:", e));
    gameStartTime = Date.now();
    generateNotesContinuously();
    gameLoop();
    progressInterval = setInterval(updateProgress, 100);
    setTimeout(() => { if (gameActive) endGame(); }, currentSongDuration * 1000 + 2000);

    // 新增：載入並初始化遊戲歌詞顯示
    const lyricsLeft = document.querySelector('.lyrics-left');
    const lyricsRight = document.querySelector('.lyrics-right');
    if (lyricsLeft && lyricsRight) {
        lyricsLeft.classList.remove('hidden');
        lyricsRight.classList.remove('hidden');
    }
}


// 新增輔助函數：分析節拍間隔，估算基本時間單位（如十六分音符長度）
function analyzeBeatIntervals(beatTimestamps) {
    if (!beatTimestamps || beatTimestamps.length < 2) {
        console.warn("節拍數據不足，無法分析。");
        return { baseInterval: 0.5 }; // 返回一個默認值
    }

    const intervals = [];
    for (let i = 1; i < beatTimestamps.length; i++) {
        // 計算相鄰節拍之間的時間差
        const interval = beatTimestamps[i] - beatTimestamps[i - 1];
        // 過濾掉過於短或過於長的異常值（可選，根據實際數據調整）
        if (interval > 0.05 && interval < 5.0) {
             intervals.push(interval);
        }
    }

    if (intervals.length === 0) {
        console.warn("無有效節拍間隔數據。");
        return { baseInterval: 0.5 };
    }

    // 簡單方法：假設最小間隔對應於最短的音符（如十六分音符）
    // 更複雜的方法可以統計間隔的分佈，找出基頻
    const minInterval = Math.min(...intervals);
    // 四分音符間隔通常是這個最小間隔的倍數 (e.g., 4倍)
    // 我們可以估算一個基準間隔，這裡簡化為直接使用最小間隔或其一部分作為十六分音符長度
    // 假設最小間隔是十六分音符 (1/16) 的長度
    const baseInterval = minInterval; // 這代表 1/16 音符的長度

    console.log(`分析得出的基準間隔 (估計1/16音符長度): ${baseInterval.toFixed(3)} 秒`);
    return { baseInterval };
}


           // ▼▼▼ [新增] PRNG 函數 (確保這段代碼存在於你的腳本中) ▼▼▼
// Mulberry32 PRNG - https://gist.github.com/tommyettinger/46a874533244883189143505d203312c
function mulberry32(a) {
    return function() {
        a |= 0; a = a + 0x6D2B79F5 | 0;
        var t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
}
// ▲▲▲ [新增結束] ▲▲▲


function generateSongData(duration, difficulty, beatTimestamps, seed = 12345, noteSpeed) {
    console.log(`Generating notes with seed: ${seed}`);
    const seededRandom = mulberry32(seed);
    const tracks = 4;

    // --- 空間衛兵設定 ---
    const totalFallDistance = tracksContainer.clientHeight + 50;
    const pixelsPerSecond = totalFallDistance / (noteSpeed / 1000);
    const SHORT_NOTE_SAFE_HEIGHT = 40 + 10; // 【修訂】為短音符增加額外 10px 緩衝，防止視覺重疊
    const MIN_LONG_NOTE_SAFE_HEIGHT = 50;
    const VISUAL_COMFORT_GAP = difficulty.visualGap || 50;
    
    const data = [];
    // 空間衛兵：追蹤每個軌道在物理像素上的可用位置
    const trackFreeAtPixel = new Array(tracks).fill(0);
    
    // 時間衛兵：追蹤每個軌道在音樂時間上的可用時間點
    const trackFreeAtTime = new Array(tracks).fill(0);

    const baseIntervalAnalysis = analyzeBeatIntervals(beatTimestamps);
    const baseInterval = baseIntervalAnalysis.baseInterval;

    const rhythmPatterns = [
        { name: "十六分音符", duration: baseInterval, weight: 0.70 },
        { name: "三十二分音符", duration: baseInterval / 2, weight: 0.30 }
    ];
    const noteGenerationTypes = [
        { type: 'short', weight: 0.75 },
        { type: 'long', weight: 0.25 }
    ];

    const totalRhythmWeight = rhythmPatterns.reduce((sum, p) => sum + p.weight, 0);
    const totalTypeWeight = noteGenerationTypes.reduce((sum, t) => sum + t.weight, 0);

    let currentTime = 1.0;

    while (currentTime < duration - (2.0 + (noteSpeed / 1000))) {
        let randomRhythm = seededRandom() * totalRhythmWeight;
        let selectedRhythm = rhythmPatterns[0];
        for (const pattern of rhythmPatterns) {
            randomRhythm -= pattern.weight;
            if (randomRhythm <= 0) {
                selectedRhythm = pattern;
                break;
            }
        }
        const stepDuration = selectedRhythm.duration;

        // 【修訂】在遊戲開始前5秒，降低密度 20% 以減少密集生成
        let effectiveDensity = difficulty.noteDensity;
        if (currentTime < 5) {
            effectiveDensity *= 0.8; // 降低 20%
        }

        if (seededRandom() < effectiveDensity) {
            const availableTracks = [];
            for (let i = 0; i < tracks; i++) {
                availableTracks.push(i);
            }

            if (availableTracks.length > 0) {
                const trackIndex = availableTracks[Math.floor(seededRandom() * availableTracks.length)];

                const newNoteStartPixel = currentTime * pixelsPerSecond;
                // 【修訂】加強檢查：增加最小時間間隙 0.1 秒
                if (currentTime >= trackFreeAtTime[trackIndex] + 0.1 && newNoteStartPixel >= trackFreeAtPixel[trackIndex]) {

                    // 【修訂】在開始前5秒，降低長音符機率 50%
                    let effectiveLongWeight = 0.25;
                    if (currentTime < 5) {
                        effectiveLongWeight *= 0.5;
                    }
                    let randomType = seededRandom() * (0.75 + effectiveLongWeight); // 調整總權重
                    let selectedType = { type: 'short' };
                    if (randomType > 0.75) {
                        selectedType = { type: 'long' };
                    }

                    let finalNoteDuration = 0;
                    if (selectedType.type === 'long') {
                        const minMultiplier = difficulty.longNoteMinMultiplier || 2;
                        const maxMultiplier = difficulty.longNoteMaxMultiplier || 6;
                        const randomMultiplier = minMultiplier + seededRandom() * (maxMultiplier - minMultiplier);
                        finalNoteDuration = Math.min(baseInterval * randomMultiplier, 2.0);
                    }
                    
                    data.push({
                        time: currentTime,
                        track: trackIndex,
                        type: finalNoteDuration > 0 ? 'long' : 'short',
                        duration: finalNoteDuration
                    });

                    // --- 更新兩個衛兵的狀態 ---
                    
                    // 1. 更新空間衛兵
                    let currentNoteSafeHeight = (finalNoteDuration > 0)
                        ? Math.max(MIN_LONG_NOTE_SAFE_HEIGHT, finalNoteDuration * pixelsPerSecond)
                        : SHORT_NOTE_SAFE_HEIGHT;
                    trackFreeAtPixel[trackIndex] = newNoteStartPixel + currentNoteSafeHeight + VISUAL_COMFORT_GAP;

                    // 【修訂】更新時間衛兵，並為長音符後添加額外 0.2 秒冷卻
                    if (finalNoteDuration > 0) {
                        trackFreeAtTime[trackIndex] = currentTime + finalNoteDuration + 0.2; // 額外冷卻
                    } else {
                        trackFreeAtTime[trackIndex] = currentTime + stepDuration;
                    }
                }
            }
        }
        currentTime += stepDuration;
    }
    return data.sort((a, b) => a.time - b.time);
}

            function generateNotesContinuously() {
                if (!gameActive) return;
                const currentTime = (Date.now() - gameStartTime) / 1000;
                while (noteQueue.length > 0 && noteQueue[0].time < currentTime + (noteSpeed / 1000)) {
                    const noteData = noteQueue.shift();
                    if (trackCooldownUntil[noteData.track] > Date.now()) {
                        continue;
                    }
                    generateNote(noteData);
                }
                if (gameActive) {
                    generateNotesTimer = setTimeout(generateNotesContinuously, 50);
                }
            }


            // ▼▼▼ 【新增】所有與歌詞測驗相關的新函數 ▼▼▼

/**
 * 根據歌曲 URL 生成填充題
 * @param {string} songUrl - 歌曲的檔案名稱
 * @returns {Array} - 一個包含問題物件的陣列
 */
function generateQuizQuestions(songUrl) {
    const songLyricsForQuiz = songLyrics[songUrl];
    if (!songLyricsForQuiz || songLyricsForQuiz.length === 0) {
        return []; // 如果這首歌沒有歌詞，返回空陣列
    }

    const generatedQuestions = [];
    const usedLines = new Set(); // 確保不會重複使用同一句歌詞

    // 嘗試從歌詞中生成最多 10 個獨特的問題
    while (generatedQuestions.length < 10 && usedLines.size < songLyricsForQuiz.length) {
        let randomIndex;
        do {
            randomIndex = Math.floor(Math.random() * songLyricsForQuiz.length);
        } while (usedLines.has(randomIndex));
        
        const line = songLyricsForQuiz[randomIndex].text;
        usedLines.add(randomIndex);

        // 使用正則表達式找出歌詞中 2 到 4 個字的中文詞語作為答案選項
        const words = line.match(/[\u4e00-\u9fa5]{2,4}/g) || [];

        if (words.length > 0) {
            // 從找到的詞語中隨機選一個作為答案
            const answer = words[Math.floor(Math.random() * words.length)];
            const questionText = line.replace(answer, '____');
            
            // 確保問題已成功生成（替換前後文本不同）
            if (questionText !== line) {
                 generatedQuestions.push({
                    question: questionText,
                    answer: answer
                });
            }
        }
    }
    
    // 如果無法生成任何問題（例如歌詞太短），則創建一個備用問題
    if (generatedQuestions.length === 0 && songLyricsForQuiz.length > 0) {
         const fallbackLine = songLyricsForQuiz[0].text;
         if (fallbackLine.length > 2) {
             const answer = fallbackLine.substring(0, 2);
             const question = '____' + fallbackLine.substring(2);
             generatedQuestions.push({ question, answer });
         }
    }
    
    return generatedQuestions;
}

/**
 * 輔助函數：Fisher-Yates 洗牌演算法，用於打亂題庫順序
 * @param {Array} array - 要打亂的陣列
 * @returns {Array} - 打亂後的陣列
 */
function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

/**
 * 開始歌詞填充測驗
 * @param {string} unlockType - 解鎖類型 ('song' 或 'difficulty')
 * @param {any} unlockValue - 要解鎖的目標值
 * @param {string} songUrlForQuiz - 用於生成測驗題目的歌曲 URL
 */
function startLyricsQuiz(unlockType, unlockValue, songUrlForQuiz) {
    // 從 songData 中獲取預設的題目
    const predefinedQuestions = songData[songUrlForQuiz]?.quiz || [];

    if (predefinedQuestions.length === 0) {
        console.warn(`歌曲 ${songUrlForQuiz} 沒有預設題目，自動授予解鎖。`);
        showNotification('info', '自動解鎖', '由於此歌曲無歌詞可供測驗，已為您直接解鎖新內容！');
        if (unlockType === 'song') {
            unlockNextSong(unlockValue);
        } else if (unlockType === 'difficulty') {
            unlockDifficulty(unlockValue.song, unlockValue.difficulty);
        }
        return;
    }
    
    isQuizActive = true;
    quizUnlockTarget = { type: unlockType, value: unlockValue };
    questionsAnsweredCorrectly = 0;
    
    // 複製並打亂題庫，避免影響原始資料
    quizQuestions = shuffleArray([...predefinedQuestions]); 
    totalQuestionsInQuiz = quizQuestions.length;
    
    lyricsQuizModal.classList.add('active');
    displayNextQuizQuestion();
}
/**
 * 顯示下一個測驗問題
 */
function displayNextQuizQuestion() {
    // 如果題庫已空，代表全部答對
    if (quizQuestions.length === 0) {
        endQuiz(true); 
        return;
    }
    
    // 從題庫中取出下一題
    currentQuizQuestion = quizQuestions.pop();

    // ▼▼▼ 【核心修訂】將底線替換為帶有 class 的 span 元素 ▼▼▼
    const questionLine = currentQuizQuestion.line.replace(/__/g, '<span class="quiz-blank"></span>');
    quizQuestionText.innerHTML = questionLine;
    // ▲▲▲ 修訂結束 ▲▲▲

    quizProgress.textContent = `進度: ${questionsAnsweredCorrectly} / ${totalQuestionsInQuiz}`;
    quizAnswerInput.value = '';
    quizAnswerInput.classList.remove('correct', 'incorrect');
    quizAnswerInput.disabled = false;
    quizSubmitBtn.disabled = false;
    quizAnswerInput.focus();
}
/**
 * 檢查玩家提交的答案
 */
function checkQuizAnswer() {
    if (!isQuizActive || !currentQuizQuestion) return;

    const userAnswer = quizAnswerInput.value.trim();
    const correctAnswer = currentQuizQuestion.answer;

    quizAnswerInput.disabled = true;
    quizSubmitBtn.disabled = true;

    if (userAnswer === correctAnswer) {
        questionsAnsweredCorrectly++;
        quizAnswerInput.classList.add('correct');
        quizProgress.textContent = `進度: ${questionsAnsweredCorrectly} / ${totalQuestionsInQuiz}`;
        
        // 答對後，延遲一小段時間再進入下一題
        setTimeout(displayNextQuizQuestion, 800);
    } else {
        // 【核心規則】答錯，立即結束測驗並判定失敗
        quizAnswerInput.classList.add('incorrect');
        setTimeout(() => endQuiz(false), 1200); 
    }
}


/**
 * 結束測驗，並根據結果執行最終操作
 * @param {boolean} success - 測驗是否成功
 */
function endQuiz(success) {
    if (!isQuizActive) return; // 防止重複執行

    isQuizActive = false;
    lyricsQuizModal.classList.remove('active');

    if (success) {
        // 如果成功，則執行真正的解鎖操作
        const { type, value } = quizUnlockTarget;
        if (type === 'song') {
            unlockNextSong(value); 
        } else if (type === 'difficulty') {
            unlockDifficulty(value.song, value.difficulty);
        }
    } else {
        // 如果失敗或中途關閉，顯示提示訊息
        showNotification('info', '解鎖失敗', '歌詞測驗未通過，下次請再接再厲！');
    }

    // 重置測驗狀態以備下次使用
    quizQuestions = [];
    currentQuizQuestion = null;
    questionsAnsweredCorrectly = 0;
    totalQuestionsInQuiz = 0;
    quizUnlockTarget = null;
}

/**
 * 檢查解鎖條件並觸發測驗或顯示提示 (核心邏輯函數)
 * @param {string} songUrl - 當前歌曲 URL
 * @param {string} difficulty - 當前難度
 * @param {number} pureHitScore - 純粹的擊打分數 (不含 Combo 加成)
 */
function checkAndShowQuizOrInfo(songUrl, difficulty, pureHitScore) {
    // ▼▼▼ 【修訂處】檢查 songData 中是否有 quiz 屬性 ▼▼▼
    const hasQuiz = songData[songUrl]?.quiz && songData[songUrl].quiz.length > 0;
    // ▲▲▲ 修訂結束 ▲▲▲
    let potentialUnlock = null;

    // 檢查1: 是否滿足解鎖【新歌曲】的條件 (僅在普通難度下)
    if (difficulty === 'normal') {
        const allSongs = Array.from(musicSelect.options).map(opt => opt.value);
        const lastUnlockedSong = saveData.unlockedSongs[saveData.unlockedSongs.length - 1];
        
        // 必須玩的是當前已解鎖的最後一首歌
        if (songUrl === lastUnlockedSong) {
            const currentIndex = allSongs.indexOf(lastUnlockedSong);
            if (currentIndex >= 0 && currentIndex < allSongs.length - 1) {
                const nextSong = allSongs[currentIndex + 1];
                if (!isSongUnlocked(nextSong)) {
                    const requiredScore = maxScoreForCurrentLevel * SONG_UNLOCK_PERCENTAGE;
                    if (pureHitScore >= requiredScore) {
                        potentialUnlock = { type: 'song', value: songUrl, songForQuiz: songUrl };
                    } else {
                        const remainingScore = Math.ceil(requiredScore - pureHitScore);
                        showNotification('info', '目標差一點！', `您在「普通」難度下還差 <strong>${remainingScore.toLocaleString()}</strong> 分就能挑戰解鎖下一首歌曲了。再加把勁！`, 6000);
                    }
                }
            }
        }
    }

    // 如果已滿足解鎖歌曲條件，則優先處理，並終止後續檢查
    if (potentialUnlock) {
        if (hasQuiz) {
            startLyricsQuiz(potentialUnlock.type, potentialUnlock.value, potentialUnlock.songForQuiz);
        } else {
            console.warn(`歌曲 ${potentialUnlock.songForQuiz} 無法觸發測驗，因為沒有預設題目。將直接解鎖。`);
            unlockNextSong(potentialUnlock.value);
        }
        return; 
    }

    // 檢查2: 是否滿足解鎖【困難】難度的條件 (從普通難度挑戰)
    if (difficulty === 'normal' && !isDifficultyUnlocked(songUrl, 'hard')) {
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        if (pureHitScore >= requiredScore) {
            potentialUnlock = { type: 'difficulty', value: { song: songUrl, difficulty: 'hard' }, songForQuiz: songUrl };
        }
    }

    // 檢查3: 是否滿足解鎖【地獄】難度的條件 (從困難難度挑戰)
    if (difficulty === 'hard' && !isDifficultyUnlocked(songUrl, 'hell')) {
        const requiredScore = maxScoreForCurrentLevel * DIFFICULTY_UNLOCK_PERCENTAGE;
        if (pureHitScore >= requiredScore) {
            potentialUnlock = { type: 'difficulty', value: { song: songUrl, difficulty: 'hell' }, songForQuiz: songUrl };
        }
    }
    
    // 如果滿足解鎖難度的條件，觸發相應操作
    if (potentialUnlock) {
         if (hasQuiz) {
            startLyricsQuiz(potentialUnlock.type, potentialUnlock.value, potentialUnlock.songForQuiz);
         } else {
            console.warn(`歌曲 ${potentialUnlock.songForQuiz} 無法觸發測驗，因為沒有預設題目。將直接解鎖。`);
            unlockDifficulty(potentialUnlock.value.song, potentialUnlock.value.difficulty);
         }
    }
}


            



function updateGameLyrics(currentTime) {
    const selectedSong = musicSelect.value;
    
    // ▼▼▼ 【修訂處】從 songData 獲取歌詞 ▼▼▼
    const lyrics = songData[selectedSong]?.lyrics || [];
    // ▲▲▲ 修訂結束 ▲▲▲
    
    if (lyrics.length === 0) return; // 無歌詞，直接返回

    let currentIndex = -1;
    for (let i = 0; i < lyrics.length; i++) {
        if (lyrics[i].time <= currentTime) {
            currentIndex = i;
        } else {
            break;
        }
    }

    const lyricsBackground = document.getElementById('lyricsBackground');
    if (lyricsBackground) {
        lyricsBackground.innerHTML = ''; // 清空舊內容
        const currentLyric = (currentIndex >= 0 && lyrics[currentIndex]) ? lyrics[currentIndex].text : '';
        if (currentLyric) {
            // 動態計算需要的 span 數量，以填滿整個畫面
            const fontSize = parseFloat(getComputedStyle(lyricsBackground).fontSize); // 獲取當前 font-size (單位 px)
            const approxCharWidth = fontSize * 0.6; // 估計每個字元的寬度（約 0.6 * font-size）
            const lineHeight = fontSize * 1.2; // 估計行高（基於 line-height: 1.2）
            
            const lyricWidth = currentLyric.length * approxCharWidth; // 估計單個 span 的寬度
            const spanWidth = Math.max(lyricWidth, window.innerWidth * 0.1); // 最小 10% 寬，防止太窄
            const spanHeight = lineHeight; // 單個 span 的高度
            
            const horizontalCount = Math.ceil(window.innerWidth / spanWidth); // 水平能放多少個
            const verticalCount = Math.ceil(window.innerHeight / spanHeight); // 垂直能放多少個
            
            const densityFactor = 1.2; // 略多 20% 以確保完全覆蓋（可調整 1.0-1.5）
            const totalSpans = Math.ceil(horizontalCount * verticalCount * densityFactor); // 總數
            
            for (let i = 0; i < totalSpans; i++) {
                const span = document.createElement('span');
                span.textContent = currentLyric;
                lyricsBackground.appendChild(span);
            }
        }
    }
}

// 修訂：startGame（顯示新背景容器）
async function startGame() {
    const selectedSong = musicSelect.value;
    const selectedDifficulty = difficultySelect.value;

    if (!isSongUnlocked(selectedSong)) {
        showUnlockModal(`在普通模式下達到 ${SONG_UNLOCK_SCORE} 分以解鎖下一首歌曲。`);
        return;
    }
    if (!isDifficultyUnlocked(selectedSong, selectedDifficulty)) {
        let reqScore = 0;
        let reqDiff = '';
        if (selectedDifficulty === 'hard') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_NORMAL_TO_HARD;
            reqDiff = '普通';
        } else if (selectedDifficulty === 'hell') {
            reqScore = DIFFICULTY_UNLOCK_SCORE_HARD_TO_HELL;
            reqDiff = '困難';
        }
        showUnlockModal(`在 ${reqDiff} 模式下達到 ${reqScore} 分以解鎖此難度。`);
        return;
    }

    if (gameActive) return;
    gameActive = true;
    startBtn.disabled = true;
    musicSelect.disabled = true;
    difficultySelect.disabled = true;

    // ▼▼▼ 【核心修訂】無條件設定兩條合格線的位置 ▼▼▼
    mainGameContainer.classList.add('game-running'); 
    // 初始化進度條高度和寬度，確保顯示正常
unlockProgressBar.style.height = '100%';
unlockProgressBar.style.width = '0%';
unlockProgressBar.classList.remove('glowing');
    
    // 根據預設的百分比常數，設定兩條線的 left 屬性
    songUnlockMarker.style.left = `${SONG_UNLOCK_PERCENTAGE * 100}%`;
    difficultyUnlockMarker.style.left = `${DIFFICULTY_UNLOCK_PERCENTAGE * 100}%`;
    // ▲▲▲ 修訂結束 ▲▲▲
    
    startBtn.innerHTML = `<svg class="start-button-svg" viewBox="0 0 40 40" style="width:40px;height:40px;">
        <circle cx="20" cy="20" r="18" stroke="#ff8a00" stroke-width="3" fill="none" stroke-dasharray="89" stroke-dashoffset="20">
            <animateTransform attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="1s" repeatCount="indefinite" />
        </circle>
    </svg>`;
    
    const difficulty = getCurrentDifficulty();
    const beatTimestamps = await analyzeAudioForBeats(selectedSong);
    startBtn.innerHTML = originalStartButtonSVG;
 
    progressContainerDiv.style.display = 'block';
    trackCooldownUntil.fill(0); 
    audio.src = selectedSong;
    audio.volume = volumeControlModal.value;
    currentSongDuration = await getAudioDuration(selectedSong);
    noteSpeed = Math.floor(4000 / difficulty.speedMultiplier);
    // ▼▼▼ [修訂] 生成基於歌曲和難度的固定種子 ▼▼▼
const songAndDifficultyString = selectedSong + selectedDifficulty;
let seed = 0;
for (let i = 0; i < songAndDifficultyString.length; i++) {
    const char = songAndDifficultyString.charCodeAt(i);
    seed = ((seed << 5) - seed) + char;
    seed |= 0; // Convert to 32bit integer
}
// 確保種子為正數
seed = Math.abs(seed) || 1; // 避免種子為 0
console.log(`Generating notes for ${selectedSong} (${selectedDifficulty}) with seed: ${seed}`);
// ▲▲▲ [修訂結束] ▲▲▲

// ▼▼▼ [修訂] 傳入種子 ▼▼▼
noteQueue = generateSongData(currentSongDuration, difficulty, beatTimestamps, seed, noteSpeed); // 傳入 noteSpeed
// ▲▲▲ [修訂結束] ▲▲▲

    // ▼▼▼ 【修訂後的核心邏輯】 ▼▼▼
    // 在生成音符後，動態計算不含連擊獎勵的理論最高分
    const maxBaseScorePerNote = 100; // "Perfect" 的基礎分數是 100
    maxScoreForCurrentLevel = noteQueue.length * maxBaseScorePerNote;

    // 如果計算結果為 0 (例如歌曲沒有音符)，則提供一個預設值以避免錯誤
    if (maxScoreForCurrentLevel === 0) {
        maxScoreForCurrentLevel = 300000; // 設置一個後備值
    }
    // ▲▲▲ 【修訂結束】 ▲▲▲

    await audio.play().catch(e => console.log("音訊播放失敗:", e));
    gameStartTime = Date.now();
    generateNotesContinuously();
    gameLoop();
    progressInterval = setInterval(updateProgress, 100);
    setTimeout(() => { if (gameActive) endGame(); }, currentSongDuration * 1000 + 2000);

    // 新增：顯示背景歌詞容器
    const lyricsBackground = document.getElementById('lyricsBackground');
    if (lyricsBackground) {
        lyricsBackground.style.display = 'grid';
    }
}

function endGame() {
    if (!gameActive) return; // 防止重複觸發

    gameActive = false;
    audio.pause();
    audio.currentTime = 0;
    clearTimeout(generateNotesTimer);
    clearInterval(progressInterval);
    cancelAnimationFrame(animationFrame);
    startBtn.disabled = false;
    musicSelect.disabled = false;
    difficultySelect.disabled = false;

    // 隱藏遊戲中的 UI 元素
    mainGameContainer.classList.remove('game-running'); 
    unlockProgressBar.style.width = '0%';
    unlockProgressBar.classList.remove('glowing');
    progressBar.style.width = '0%';
    notes.forEach(note => note.element.remove());
    notes = [];

    const lyricsBackground = document.getElementById('lyricsBackground');
    if (lyricsBackground) {
        lyricsBackground.style.display = 'none';
        lyricsBackground.innerHTML = '';
    }

    // --- 遊戲後結算 ---
    const selectedSong = musicSelect.value;
    const selectedDifficulty = difficultySelect.value;
    updatePersonalHighScore(selectedSong, selectedDifficulty, score);

    // 【核心修訂】
    // 將所有解鎖判斷統一交給 checkAndShowQuizOrInfo 函數。
    checkAndShowQuizOrInfo(selectedSong, selectedDifficulty, pureHitScore);
    
    // ====== 【新增】提交分數到全球排行榜 ======
    submitScoreToLeaderboard(selectedSong, selectedDifficulty, score);
    // ==========================================

    // 顯示遊戲結束畫面
    showGameOver();
}

            function showGameOver() {
                finalScoreDisplay.textContent = score.toLocaleString();
                finalComboDisplay.textContent = maxCombo;
                gameOverModal.classList.add('active');
            }

            function restartGame() {
                gameOverModal.classList.remove('active');
                initGame();
            }

          function gameLoop() {
    if (!gameActive) return;

    // --- 核心優化：在迴圈外快取不會變動的數值 ---
    // 獲取軌道總高度，音符需要移動的總距離
    const fallDistance = tracksContainer.clientHeight; 
    // 計算判定線的 Y 座標 (相對於軌道頂部)
    const hitLineY = fallDistance - 100; 
    // 計算音符每毫秒移動的像素距離
    const pixelsPerMillisecond = fallDistance / noteSpeed;

    const now = Date.now();

    for (let i = notes.length - 1; i >= 0; i--) {
        const note = notes[i];
        if (!note.active) continue;

        // --- 核心優化：用數學公式「計算」音符的當前位置 ---
        const timeElapsed = now - note.creationTime;
        // 音符頂部的 Y 座標 = 已過時間 * 每毫秒移動距離 - 音符自身高度(動畫是從-50px開始的)
        const noteTopY = (timeElapsed * pixelsPerMillisecond) - 50;

        // --- 使用計算出的位置來進行判斷 ---
        // 如果音符頂部已經超過了判定線加一個緩衝區 (20px)
        if (noteTopY > hitLineY + 20) {
            const isTrackInvincible = notes.some(n =>
                n.track === note.track &&
                n.type === 'long' &&
                n.hitStarted
            );

            if (!isTrackInvincible) {
                judgeHit(note.track, 'miss');
            }
            
            note.active = false;
            note.element.remove(); // 這裡的 remove 是必要的，因為 miss 了
            notes.splice(i, 1);
        }
    }

    animationFrame = requestAnimationFrame(gameLoop);
}

         function handleKeyDown(e) {
                if (!gameActive) return;
                const keyCode = e.keyCode;
                if (keyStates[keyCode]) return;
                keyStates[keyCode] = true;
                const trackIndex = keyCodes.indexOf(keyCode);
                if (trackIndex !== -1) {
                    const trackEl = document.querySelector(`.track[data-track="${trackIndex}"]`);
                    if (trackEl) {
                        trackEl.classList.remove('hit-effect');
                        void trackEl.offsetWidth;
                        trackEl.classList.add('hit-effect');
                    }
                    const trackRect = tracksContainer.getBoundingClientRect();
                    const hitLineY = trackRect.top + trackRect.height - 100;
                    let hitNote = null;
                    let minDistance = Infinity;
                    let hitIndex = -1;
                    notes.forEach((note, index) => {
                        if (note.track === trackIndex && note.active && !note.hitStarted) {
                            const rect = note.element.getBoundingClientRect();
                            const distance = Math.abs(rect.bottom - hitLineY);
                            if (distance < minDistance) {
                                minDistance = distance;
                                hitNote = note;
                                hitIndex = index;
                            }
                        }
                    });
                   if (hitNote && minDistance < 50) {
    let judgment;
    if (minDistance < 15) judgment = 'perfect';
    else if (minDistance < 30) judgment = 'great';
    else judgment = 'good';
    if (hitNote.type === 'long') {
        hitNote.hitStarted = true;
        hitNote.element.classList.add('held');
        judgeHit(trackIndex, judgment);
        explodeNote(hitNote.element, judgment); // 新增：長音符按下時分解粒子
    } else {
        hitNote.active = false;
        explodeNote(hitNote.element, judgment); // 新增：短音符擊中時分解粒子
        hitNote.element.remove();
        notes.splice(hitIndex, 1);
        judgeHit(trackIndex, judgment);
    }
} else {
                        // 如果按下時，沒有任何音符在可擊中範圍內，則判定為 MISS
                        judgeHit(trackIndex, 'miss');

                        // ▼▼▼ 修訂的關鍵之處 ▼▼▼
                        // 並且，如果軌道上確實有一個最近的音符（只是太遠了），
                        // 則將該音符移除，以懲罰提早按鍵的行為。
                        if (hitNote) {
                            hitNote.active = false;
                            hitNote.element.remove();
                            notes.splice(hitIndex, 1);
                        }
                        // ▲▲▲ 修訂結束 ▲▲▲
                    }
                }
            }

         function handleKeyUp(e) {
    if (!gameActive) return;
    const keyCode = e.keyCode;
    keyStates[keyCode] = false;
    const trackIndex = keyCodes.indexOf(keyCode);
    if (trackIndex !== -1) {
        const heldNoteIndex = notes.findIndex(note =>
            note.track === trackIndex && note.type === 'long' && note.hitStarted
        );
        if (heldNoteIndex !== -1) {
            const note = notes[heldNoteIndex];
            const trackRect = tracksContainer.getBoundingClientRect();
            const hitLineY = trackRect.top + trackRect.height - 100;
            const rect = note.element.getBoundingClientRect();
            const noteTailY = rect.top;
            const distance = Math.abs(noteTailY - hitLineY);
            let type = 'miss';  // 預設為 MISS
if (distance < 50) {
    if (distance < 15) type = 'perfect';
    else if (distance < 30) type = 'great';
    else type = 'good';
}

// 修訂：無論 MISS 或非 MISS，都呼叫 judgeHit，讓它處理所有效果（包括粒子/震動）
judgeHit(trackIndex, type);
if (type !== 'miss') {
    explodeNote(note.element, type); // 新增：長音符釋放成功時分解粒子
}

note.active = false;
note.element.remove();
notes.splice(heldNoteIndex, 1);
        }
    }
}
            function onTouchStart(e) {
                e.preventDefault();
                const keyElement = e.target.closest('.touch-key');
                if (keyElement) {
                    keyElement.classList.add('pressed');
                    handleKeyDown({ keyCode: parseInt(keyElement.dataset.key) });
                }
            }

            function onTouchEnd(e) {
                e.preventDefault();
                const changedTouches = e.changedTouches || [e];
                for (const touch of changedTouches) {
                    const originalKeyElement = e.target.closest('.touch-key');
                    if (originalKeyElement) {
                        originalKeyElement.classList.remove('pressed');
                        handleKeyUp({ keyCode: parseInt(originalKeyElement.dataset.key) });
                    }
                }
            }


// 尋找下一首啟用的歌曲
function findNextEnabledSong(currentIndex) {
    for (let i = currentIndex + 1; i < playlistItems.length; i++) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // 沒有找到下一首啟用的歌曲
}

// 尋找上一首啟用的歌曲
function findPrevEnabledSong(currentIndex) {
    for (let i = currentIndex - 1; i >= 0; i--) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // 沒有找到上一首啟用的歌曲
}


            // --- Music Player Logic ---
            function initMusicPlayer() {
                // Filter playlist items to only include unlocked songs
                const unlockedSongsSet = new Set(saveData.unlockedSongs);
                playlistItems = Array.from(musicSelect.options)
                    .filter(opt => unlockedSongsSet.has(opt.value)) // Only unlocked songs
                    .map((opt, index) => ({
                        url: opt.value,
                        title: opt.textContent.replace(' (未解鎖)', ''),
                        index: index
                    }));

                playlist.innerHTML = '';
playlistItems.forEach(item => {
    const li = document.createElement('li');
    li.className = 'playlist-item';
    li.textContent = item.title;
    li.dataset.index = item.index;
    
    // 從儲存的設定中恢復歌曲狀態
    const savedState = playerSettings.playlistStates[item.url];
    const isEnabled = savedState ? savedState.enabled : true;
    li.dataset.enabled = isEnabled ? 'true' : 'false';
    
    if (!isEnabled) {
        li.classList.add('disabled');
    }
    
    let clickCount = 0;
    let clickTimer = null;
    
    li.addEventListener('click', () => {
        clickCount++;
        
        if (clickTimer) {
            clearTimeout(clickTimer);
        }
        
       clickTimer = setTimeout(() => {
    if (clickCount === 1) {
        // 單擊：播放該歌曲或啟用該歌曲
        li.dataset.enabled = 'true';
        li.classList.remove('disabled');
        playSong(item.index);
        savePlayerSettings(); // 保存設定
    } else if (clickCount === 2) {
        // 雙擊：停用該歌曲，不播放
        li.dataset.enabled = 'false';
        li.classList.add('disabled');
        savePlayerSettings(); // 保存設定
                
                // 如果當前正在播放這首歌，則暫停並尋找下一首啟用的歌曲
                if (currentPlaylistIndex === item.index && playerIsPlaying) {
                    const nextIndex = findNextEnabledSong(currentPlaylistIndex);
                    if (nextIndex !== -1) {
                        playSong(nextIndex);
                    } else {
                        playerAudio.pause();
                    }
                }
            }
            clickCount = 0;
        }, 300); // 300毫秒內的點擊視為雙擊
    });
    
    playlist.appendChild(li);
});

                playerAudio.addEventListener('loadedmetadata', () => {
                    durationDisplay.textContent = formatTime(playerAudio.duration);
                    progressSlider.max = playerAudio.duration;
                });

               playerAudio.addEventListener('timeupdate', () => {
    if (!isUpdatingSlider) {
        currentTimeDisplay.textContent = formatTime(playerAudio.currentTime);
        progressSlider.value = playerAudio.currentTime;
        updateLyrics(playerAudio.currentTime);
        
        // 每5秒自動保存播放進度
        if (Math.floor(playerAudio.currentTime) % 5 === 0) {
            savePlayerSettings();
        }
    }
});

playerAudio.addEventListener('play', () => {
    playerIsPlaying = true;
    playPauseBtn.textContent = '\u275A\u275A';
    updatePlayerUI();
    savePlayerSettings(); // 保存播放狀態
});

playerAudio.addEventListener('pause', () => {
    playerIsPlaying = false;
    playPauseBtn.textContent = '\u25B6';
    updatePlayerUI();
    savePlayerSettings(); // 保存暫停狀態
});
               playerAudio.addEventListener('ended', () => {
    playerIsPlaying = false;
    playPauseBtn.textContent = '\u25B6'; // Play icon
ocument.getElementById('cdCoverImage').classList.remove('playing'); // 新增：停止旋轉
    
    // 尋找下一首啟用的歌曲
    const nextIndex = findNextEnabledSong(currentPlaylistIndex);
    if (nextIndex !== -1) {
        playSong(nextIndex);
    }
    updatePlayerUI();
});

                playerAudio.addEventListener('play', () => {
                    playerIsPlaying = true;
                    playPauseBtn.textContent = '\u275A\u275A'; // Pause icon
                    updatePlayerUI();
                });

                playerAudio.addEventListener('pause', () => {
                    playerIsPlaying = false;
                    playPauseBtn.textContent = '\u25B6'; // Play icon
                    updatePlayerUI();
// 新增：停止 CD 旋轉
    document.getElementById('cdCoverImage').classList.remove('playing');
                });
            }

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }

           function playSong(index) {
    if (index < 0 || index >= playlistItems.length) return;
    
    // 檢查歌曲是否被停用
    const playlistItem = playlist.children[index];
    if (playlistItem && playlistItem.dataset.enabled === 'false') {
        console.log('歌曲已被停用，跳過播放');
        return;
    }
    
    // Check if the song is unlocked before playing
    const songToPlay = playlistItems[index];
    if (!isSongUnlocked(songToPlay.url)) {
        console.warn(`嘗試播放未解鎖的歌曲: ${songToPlay.title}`);
        return; // Do not play if not unlocked
    }

    currentPlaylistIndex = index;
    const song = playlistItems[index];
    playerAudio.src = song.url;
    playerAudio.volume = volumeSliderPlayer.value;
    nowPlaying.textContent = `正在播放: ${song.title}`;
    updateCdCover(song.url); // 更新 CD 封面
    
    // ▼▼▼ 【修訂處】從 songData 獲取歌詞 ▼▼▼
    lyrics = songData[song.url]?.lyrics || [];
    // ▲▲▲ 修訂結束 ▲▲▲

    updateLyricsContainer();
    updatePlayerUI();
    document.getElementById('cdCoverImage').classList.add('playing'); // 開始旋轉
    playerAudio.play().catch(e => console.error("播放器播放失敗:", e));
    savePlayerSettings(); // 保存當前播放狀態
}

// 在現有函數之前新增這兩個輔助函數
function findNextEnabledSong(currentIndex) {
    for (let i = currentIndex + 1; i < playlistItems.length; i++) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // 沒有找到下一首啟用的歌曲
}

function findPrevEnabledSong(currentIndex) {
    for (let i = currentIndex - 1; i >= 0; i--) {
        const playlistItem = playlist.children[i];
        if (playlistItem && playlistItem.dataset.enabled === 'true') {
            return i;
        }
    }
    return -1; // 沒有找到上一首啟用的歌曲
}

            function updateLyricsContainer() {
                lyricsContainer.innerHTML = '';
                if (lyrics.length === 0) {
                    lyricsContainer.innerHTML = '<div class="no-lyrics">無歌詞</div>';
                    return;
                }
                lyrics.forEach((line, i) => {
                    const p = document.createElement('p');
                    p.className = 'lyric-line';
                    p.textContent = line.text;
                    p.dataset.time = line.time;
                    lyricsContainer.appendChild(p);
                });
            }

            function updateLyrics(currentTime) {
                if (lyrics.length === 0) return;
                let activeIndex = -1;
                for (let i = 0; i < lyrics.length; i++) {
                    if (lyrics[i].time <= currentTime) {
                        activeIndex = i;
                    } else {
                        break;
                    }
                }
                document.querySelectorAll('.lyric-line').forEach((line, i) => {
                    line.classList.toggle('active', i === activeIndex);
                    if (i === activeIndex) {
                        line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }



// 更新 CD 封面的函數
function updateCdCover(songUrl) {
    const coverImage = document.getElementById('cdCoverImage');
    // 根據歌曲 URL 獲取對應的封面，如果沒有則使用默認封面
    const coverUrl = songCovers[songUrl] || songCovers["default"];
    coverImage.src = coverUrl;
    // 可選：添加加載錯誤的回退
    coverImage.onerror = function() {
        this.src = songCovers["default"];
    };
}



            function updatePlayerUI() {
    document.querySelectorAll('.playlist-item').forEach((item, i) => {
        item.classList.toggle('active', i === currentPlaylistIndex);
    });
    
    // 檢查是否有上一首/下一首啟用的歌曲來決定按鈕狀態
    const hasPrev = findPrevEnabledSong(currentPlaylistIndex) !== -1;
    const hasNext = findNextEnabledSong(currentPlaylistIndex) !== -1;
    
    prevBtn.disabled = !hasPrev;
    nextBtn.disabled = !hasNext;
}

            // --- Event Listeners ---
            touchKeys.forEach(key => {
                key.addEventListener('touchstart', onTouchStart, { passive: false });
                key.addEventListener('touchend', onTouchEnd, { passive: false });
                key.addEventListener('touchcancel', onTouchEnd, { passive: false });
            });

            settingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
            closeSettings.addEventListener('click', () => settingsModal.classList.remove('active'));
            window.addEventListener('click', (e) => {
                if (e.target === settingsModal) settingsModal.classList.remove('active');
                if (e.target === personalHighScoreModal) personalHighScoreModal.classList.remove('active');
                if (e.target === unlockModal) unlockModal.classList.remove('active');
            });

         // 【修訂】為音樂音量滑桿添加事件監聽，並即時更新CSS變數
            volumeControlModal.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                audio.volume = isNaN(value) ? 1.0 : value; // 將後備值從 0.7 改為 1.0
                // 更新CSS變數來控制背景填充
                const percent = value * 100;
                e.target.style.background = `linear-gradient(to right, #3b82f6 ${percent}%, #4a5568 ${percent}%)`;
            });

            // 【修訂】為音效音量滑桿添加事件監聽，並即時更新CSS變數
            sfxVolumeControl.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                sfxVolume = isNaN(value) ? 0.5 : value;
                // 更新CSS變數來控制背景填充
                const percent = value * 100;
                e.target.style.background = `linear-gradient(to right, #3b82f6 ${percent}%, #4a5568 ${percent}%)`;
            });
            
            startBtn.addEventListener('click', startGame);
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            restartBtn.addEventListener('click', restartGame);
            // --- Handle Page Visibility to Prevent Ghost Notes ---
            document.addEventListener('visibilitychange', () => {
                // 我們只關心頁面從「隱藏」變為「可見」的那個瞬間
                // 並且只有在遊戲正在進行中才需要處理
                if (!document.hidden && gameActive) {
                    const now = Date.now();
                    
                    // 遍歷所有當前在畫面上的音符
                    // 我們從後往前遍歷，這樣在刪除陣列元素時才不會出錯
                    for (let i = notes.length - 1; i >= 0; i--) {
                        const note = notes[i];
                        const timeAlive = now - note.creationTime;

                        // 【核心清理邏輯】
                        // 如果一個音符的存活時間，已經超過了它跑完整個軌道所需的時間 (noteSpeed)
                        // 再加上一個小的緩衝時間（例如 500 毫秒），
                        // 我們就認定它是一個在頁面隱藏期間就應該消失的「幽靈音符」。
                        if (timeAlive > noteSpeed + 500) {
                            note.active = false;      // 標記為非作用中
                            note.element.remove();    // 從畫面中移除 DOM 元素
                            notes.splice(i, 1);       // 從我們的遊戲邏輯陣列中移除
                        }
                    }
                }
            });

            // New Event Listeners
            personalHighScoreBtn.addEventListener('click', () => {
                const selectedSong = musicSelect.value;
                populatePersonalHighScoreList(selectedSong);
                personalHighScoreModal.classList.add('active');
            });
            closePersonalHighScore.addEventListener('click', () => personalHighScoreModal.classList.remove('active'));

           musicPlayerBtn.addEventListener('click', () => {
    musicPlayerModal.classList.add('active');
    initMusicPlayer(); // Re-initialize playlist on open to reflect unlocks
    loadPlayerSettings(); // 載入儲存的設定
    
    // 恢復上次的播放狀態
    if (playerSettings.currentSong && playlistItems.length > 0) {
        const songIndex = playlistItems.findIndex(item => item.url === playerSettings.currentSong);
        if (songIndex !== -1) {
            currentPlaylistIndex = songIndex;
            playerAudio.src = playerSettings.currentSong;
            playerAudio.currentTime = playerSettings.currentTime || 0;
            nowPlaying.textContent = `正在播放: ${playlistItems[songIndex].title}`;
            
            // 恢復歌詞和UI
            const song = playlistItems[songIndex];
            lyrics = songLyrics[song.url] || [];
            updateLyricsContainer();
            updatePlayerUI();
            
            // 如果之前是播放狀態，則自動繼續播放
            if (playerSettings.isPlaying) {
                playerAudio.play().catch(e => console.error("自動播放失敗:", e));
            }
        }
    }
});
           closeMusicPlayer.addEventListener('click', () => {
    savePlayerSettings(); // 保存當前狀態再關閉
    musicPlayerModal.classList.remove('active');
    playerAudio.pause();
});
            playPauseBtn.addEventListener('click', () => {
    if (playerAudio.src) {
        if (playerIsPlaying) {
            playerAudio.pause();
        } else {
            playerAudio.play();
        }
    } else {
        // 如果沒有音源，播放第一首啟用的歌曲
        const firstEnabledIndex = findNextEnabledSong(-1);
        if (firstEnabledIndex !== -1) {
            playSong(firstEnabledIndex);
        }
    }
});
          prevBtn.addEventListener('click', () => {
    const prevIndex = findPrevEnabledSong(currentPlaylistIndex);
    if (prevIndex !== -1) {
        playSong(prevIndex);
    }
});

nextBtn.addEventListener('click', () => {
    const nextIndex = findNextEnabledSong(currentPlaylistIndex);
    if (nextIndex !== -1) {
        playSong(nextIndex);
    }
});

            progressSlider.addEventListener('input', () => {
                isUpdatingSlider = true;
                playerAudio.currentTime = progressSlider.value;
                currentTimeDisplay.textContent = formatTime(progressSlider.value);
            });
            progressSlider.addEventListener('change', () => {
                 isUpdatingSlider = false;
            });

            // Fixed volume slider input listeners for player to use 'change' event for full range
            volumeSliderPlayer.addEventListener('change', () => {
    const value = parseFloat(volumeSliderPlayer.value);
    playerAudio.volume = isNaN(value) ? 0.7 : value;
    savePlayerSettings(); // 保存音量設定
});

            musicSelect.addEventListener('change', () => {
                const selectedSong = musicSelect.value;
                updateDifficultyOptions(selectedSong);
                populatePersonalHighScoreList(selectedSong); // Update personal score list on song change
            });

            difficultySelect.addEventListener('change', () => {
                // Optional: Add logic if difficulty change needs immediate UI update
            });

            closeUnlock.addEventListener('click', () => unlockModal.classList.remove('active'));

             // --- 【新增】排行榜 Modal 的事件監聽器 ---
            leaderboardBtn.addEventListener('click', () => {
                leaderboardModal.classList.add('active');
                handlePlayerName(); // 處理玩家名稱
                // 預設顯示當前主介面選擇的歌曲和難度
                displayLeaderboard(musicSelect.value, difficultySelect.value);
            });

            closeLeaderboard.addEventListener('click', () => {
                leaderboardModal.classList.remove('active');
            });

            // 當主介面的歌曲或難度改變時，如果排行榜是開啟的，就同步更新
            musicSelect.addEventListener('change', () => {
                if (leaderboardModal.classList.contains('active')) {
                    displayLeaderboard(musicSelect.value, difficultySelect.value);
                }
                // 這一段會與上面的 musicSelect.addEventListener 重複，但影響不大，因為它們的功能不衝突
                // 為了程式碼簡潔，你可以考慮將兩個 change 事件的邏輯合併，但分開寫也完全可以運作
            });

            difficultySelect.addEventListener('change', () => {
                if (leaderboardModal.classList.contains('active')) {
                    displayLeaderboard(musicSelect.value, difficultySelect.value);
                }
            });

            // --- Initialization ---
            const originalStartButtonSVG = startBtn.innerHTML;
            updateSongOptions(); // Apply unlock status on load
            populatePersonalHighScoreList(musicSelect.value); // Show scores for initially selected song
            initGame();

            // 【新增】綁定測驗視窗的按鈕事件
quizSubmitBtn.addEventListener('click', checkQuizAnswer);
quizAnswerInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault(); // 防止表單提交的預設行為
        checkQuizAnswer();
    }
});
quizCloseBtn.addEventListener('click', () => {
    if (isQuizActive) {
        endQuiz(false); // 玩家手動關閉視窗，視為測驗失敗
    }
});


// 為版權聲明按鈕添加事件監聽器
const showDisclaimerBtn = document.getElementById('showDisclaimerBtn');
const disclaimerModal = document.getElementById('disclaimerModal');
const closeDisclaimer = document.getElementById('closeDisclaimer');

showDisclaimerBtn.addEventListener('click', () => {
    disclaimerModal.classList.add('active');
});

closeDisclaimer.addEventListener('click', () => {
    disclaimerModal.classList.remove('active');
});

// 點擊模態框外部關閉
disclaimerModal.addEventListener('click', (e) => {
    if (e.target === disclaimerModal) {
        disclaimerModal.classList.remove('active');
    }
});
});
    </script>


<!-- Copyright Disclaimer Modal -->
<div class="copyright-disclaimer-modal" id="disclaimerModal">
    <div class="disclaimer-content">
        <button class="close-disclaimer" id="closeDisclaimer">&times;</button>
        <h2 class="disclaimer-title">音樂版權聲明</h2>
        <div class="disclaimer-section">
            <h3>音樂來源</h3>
            <p>本專案中使用的音樂由 AI 工具（豆包）生成。</p>
        </div>
        <div class="disclaimer-section">
            <h3>使用限制</h3>
            <p>本音樂僅用於語文教育用途，禁止任何用戶下載後用於商業等其他場景。</p>
        </div>
        <div class="disclaimer-section">
            <h3>免責聲明</h3>
            <p>若音樂違反任何版權，本人將立即刪除有關作品。</p>
        </div>
    </div>
</div>

<!-- ▼▼▼ 【新增】歌詞填充測驗視窗 ▼▼▼ -->
<div class="lyrics-quiz-modal" id="lyricsQuizModal">
    <div class="quiz-content">
        <h2 class="quiz-title">歌詞填充測驗</h2>
        <p class="quiz-instructions">連續答對五題即可解鎖新內容！</p>
        <div class="quiz-progress" id="quizProgress">連續答對: 0 / 3</div>
        <div class="quiz-question-container">
            <p id="quizQuestionText"></p>
        </div>
        <input type="text" id="quizAnswerInput" class="quiz-answer-input" placeholder="請在此輸入答案..." autocomplete="off">
        <button id="quizSubmitBtn" class="quiz-submit-btn">提交答案</button>
        <button id="quizCloseBtn" class="quiz-close-btn">&times;</button>
    </div>
</div>
<!-- ▲▲▲ 新增結束 ▲▲▲ -->

    <!-- ====== 【新增】排行榜 Modal ====== -->
<div class="settings-modal" id="leaderboardModal">
    <div class="settings-content">
        <button class="close-settings" id="closeLeaderboard">&times;</button>
        <h2 class="settings-title">歌曲排行榜</h2>
        
        <!-- 玩家名稱設定 -->
        <div class="setting-group" id="playerNameGroup">
            <label class="setting-label" for="playerNameInput">你的顯示名稱:</label>
            <input type="text" id="playerNameInput" class="setting-control" placeholder="輸入你的名稱" maxlength="20">
            <button id="savePlayerNameBtn" class="restart-btn"></button>
        </div>

        <!-- 排行榜顯示區域 -->
        <div class="leaderboard-display">
            <h3 id="leaderboardTitle" class="personal-high-score-title" style="margin-top: 20px;">請選擇歌曲與難度</h3>
            <ol class="personal-high-score-list" id="leaderboardList">
                <!-- 排行榜資料會由 JS 動態填入 -->
            </ol>
            <p id="leaderboardLoading" style="display: none;">讀取中...</p>
        </div>
    </div>
</div>

</body>
</html>
